<?xml version="1.0" encoding="utf-8"?>
<DataSchemaModel FileFormatVersion="1.2" SchemaVersion="3.3" DspName="Microsoft.Data.Tools.Schema.Sql.SqlAzureV12DatabaseSchemaProvider" CollationLcid="1033" CollationCaseSensitive="False" xmlns="http://schemas.microsoft.com/sqlserver/dac/Serialization/2012/02">
	<Header>
		<CustomData Category="AnsiNulls">
			<Metadata Name="AnsiNulls" Value="True" />
		</CustomData>
		<CustomData Category="QuotedIdentifier">
			<Metadata Name="QuotedIdentifier" Value="True" />
		</CustomData>
		<CustomData Category="CompatibilityMode">
			<Metadata Name="CompatibilityMode" Value="150" />
		</CustomData>
		<CustomData Category="Reference" Type="SqlSchema">
			<Metadata Name="FileName" Value="c:\Users\SixGo\.vscode\extensions\ms-mssql.sql-database-projects-vscode-1.4.1\BuildDirectory\SystemDacpacs\AzureV12\master.dacpac" />
			<Metadata Name="LogicalName" Value="master.dacpac" />
			<Metadata Name="ExternalParts" Value="[master]" />
			<Metadata Name="SuppressMissingDependenciesErrors" Value="False" />
		</CustomData>
		<CustomData Category="Reference" Type="Assembly">
			<Metadata Name="LogicalName" Value="ADFMetadataDBSQLProj.dll" />
			<Metadata Name="FileName" Value="d:\project\azure-adf-framework\adf_metadata_db_sql_proj\obj\Debug\ADFMetadataDBSQLProj.dll" />
			<Metadata Name="AssemblyName" Value="ADFMetadataDBSQLProj" />
			<Metadata Name="PermissionSet" Value="SAFE" />
			<Metadata Name="Owner" Value="" />
			<Metadata Name="GenerateSqlClrDdl" Value="True" />
			<Metadata Name="IsVisible" Value="True" />
			<Metadata Name="IsModelAware" Value="True" />
			<Metadata Name="SkipCreationIfEmpty" Value="True" />
			<Metadata Name="AssemblySymbolsName" Value="d:\project\azure-adf-framework\adf_metadata_db_sql_proj\obj\Debug\ADFMetadataDBSQLProj.pdb" />
		</CustomData>
		<CustomData Category="SqlCmdVariables" Type="SqlCmdVariable" />
	</Header>
	<Model>
		<Element Type="SqlDatabaseOptions">
			<Property Name="Collation" Value="SQL_Latin1_General_CP1_CI_AS" />
			<Property Name="IsAnsiNullDefaultOn" Value="True" />
			<Property Name="IsAnsiNullsOn" Value="True" />
			<Property Name="IsAnsiWarningsOn" Value="True" />
			<Property Name="IsArithAbortOn" Value="True" />
			<Property Name="IsConcatNullYieldsNullOn" Value="True" />
			<Property Name="IsTornPageProtectionOn" Value="False" />
			<Property Name="IsFullTextEnabled" Value="True" />
			<Property Name="PageVerifyMode" Value="3" />
			<Property Name="DefaultLanguage" Value="" />
			<Property Name="DefaultFullTextLanguage" Value="" />
			<Property Name="QueryStoreDesiredState" Value="0" />
			<Property Name="QueryStoreCaptureMode" Value="1" />
			<Property Name="QueryStoreStaleQueryThreshold" Value="367" />
			<Property Name="MaxDop" Value="0" />
		</Element>
		<Element Type="SqlDefaultConstraint">
			<Property Name="DefaultExpressionScript">
				<Value><![CDATA[(NEWID())]]></Value>
			</Property>
			<Relationship Name="DefiningTable">
				<Entry>
					<References Name="[metadata].[Batches]" />
				</Entry>
			</Relationship>
			<Relationship Name="ForColumn">
				<Entry>
					<References Name="[metadata].[Batches].[BatchId]" />
				</Entry>
			</Relationship>
			<Annotation Type="SqlInlineConstraintAnnotation" Disambiguator="4" />
		</Element>
		<Element Type="SqlDefaultConstraint">
			<Property Name="DefaultExpressionScript">
				<Value><![CDATA[('TO')]]></Value>
			</Property>
			<Relationship Name="DefiningTable">
				<Entry>
					<References Name="[metadata].[Recipients]" />
				</Entry>
			</Relationship>
			<Relationship Name="ForColumn">
				<Entry>
					<References Name="[metadata].[Recipients].[MessagePreference]" />
				</Entry>
			</Relationship>
			<Annotation Type="SqlInlineConstraintAnnotation" Disambiguator="5" />
		</Element>
		<Element Type="SqlDefaultConstraint">
			<Property Name="DefaultExpressionScript">
				<Value><![CDATA[('N/A')]]></Value>
			</Property>
			<Relationship Name="DefiningTable">
				<Entry>
					<References Name="[metadata].[ExecutionLog]" />
				</Entry>
			</Relationship>
			<Relationship Name="ForColumn">
				<Entry>
					<References Name="[metadata].[ExecutionLog].[OrchestratorType]" />
				</Entry>
			</Relationship>
			<Annotation Type="SqlInlineConstraintAnnotation" Disambiguator="6" />
		</Element>
		<Element Type="SqlDefaultConstraint">
			<Property Name="DefaultExpressionScript">
				<Value><![CDATA[1]]></Value>
			</Property>
			<Relationship Name="DefiningTable">
				<Entry>
					<References Name="[metadata].[Recipients]" />
				</Entry>
			</Relationship>
			<Relationship Name="ForColumn">
				<Entry>
					<References Name="[metadata].[Recipients].[Enabled]" />
				</Entry>
			</Relationship>
			<Annotation Type="SqlInlineConstraintAnnotation" Disambiguator="7" />
		</Element>
		<Element Type="SqlDefaultConstraint">
			<Property Name="DefaultExpressionScript">
				<Value><![CDATA[(0)]]></Value>
			</Property>
			<Relationship Name="DefiningTable">
				<Entry>
					<References Name="[metadata].[Batches]" />
				</Entry>
			</Relationship>
			<Relationship Name="ForColumn">
				<Entry>
					<References Name="[metadata].[Batches].[Enabled]" />
				</Entry>
			</Relationship>
			<Annotation Type="SqlInlineConstraintAnnotation" Disambiguator="8" />
		</Element>
		<Element Type="SqlDefaultConstraint">
			<Property Name="DefaultExpressionScript">
				<Value><![CDATA[('None')]]></Value>
			</Property>
			<Relationship Name="DefiningTable">
				<Entry>
					<References Name="[metadata].[ExecutionLog]" />
				</Entry>
			</Relationship>
			<Relationship Name="ForColumn">
				<Entry>
					<References Name="[metadata].[ExecutionLog].[PipelineParamsUsed]" />
				</Entry>
			</Relationship>
			<Annotation Type="SqlInlineConstraintAnnotation" Disambiguator="9" />
		</Element>
		<Element Type="SqlDefaultConstraint">
			<Property Name="DefaultExpressionScript">
				<Value><![CDATA[('Unknown')]]></Value>
			</Property>
			<Relationship Name="DefiningTable">
				<Entry>
					<References Name="[metadata].[ExecutionLog]" />
				</Entry>
			</Relationship>
			<Relationship Name="ForColumn">
				<Entry>
					<References Name="[metadata].[ExecutionLog].[ResourceGroupName]" />
				</Entry>
			</Relationship>
			<Annotation Type="SqlInlineConstraintAnnotation" Disambiguator="10" />
		</Element>
		<Element Type="SqlDefaultConstraint">
			<Property Name="DefaultExpressionScript">
				<Value><![CDATA[(0)]]></Value>
			</Property>
			<Relationship Name="DefiningTable">
				<Entry>
					<References Name="[metadata].[Orchestrators]" />
				</Entry>
			</Relationship>
			<Relationship Name="ForColumn">
				<Entry>
					<References Name="[metadata].[Orchestrators].[IsFrameworkOrchestrator]" />
				</Entry>
			</Relationship>
			<Annotation Type="SqlInlineConstraintAnnotation" Disambiguator="11" />
		</Element>
		<Element Type="SqlDefaultConstraint">
			<Property Name="DefaultExpressionScript">
				<Value><![CDATA[1]]></Value>
			</Property>
			<Relationship Name="DefiningTable">
				<Entry>
					<References Name="[metadata].[PipelineAlertLink]" />
				</Entry>
			</Relationship>
			<Relationship Name="ForColumn">
				<Entry>
					<References Name="[metadata].[PipelineAlertLink].[Enabled]" />
				</Entry>
			</Relationship>
			<Annotation Type="SqlInlineConstraintAnnotation" Disambiguator="12" />
		</Element>
		<Element Type="SqlDefaultConstraint">
			<Property Name="DefaultExpressionScript">
				<Value><![CDATA[('Unknown')]]></Value>
			</Property>
			<Relationship Name="DefiningTable">
				<Entry>
					<References Name="[metadata].[ExecutionLog]" />
				</Entry>
			</Relationship>
			<Relationship Name="ForColumn">
				<Entry>
					<References Name="[metadata].[ExecutionLog].[OrchestratorName]" />
				</Entry>
			</Relationship>
			<Annotation Type="SqlInlineConstraintAnnotation" Disambiguator="13" />
		</Element>
		<Element Type="SqlDefaultConstraint">
			<Property Name="DefaultExpressionScript">
				<Value><![CDATA[0]]></Value>
			</Property>
			<Relationship Name="DefiningTable">
				<Entry>
					<References Name="[metadata].[CurrentExecution]" />
				</Entry>
			</Relationship>
			<Relationship Name="ForColumn">
				<Entry>
					<References Name="[metadata].[CurrentExecution].[IsBlocked]" />
				</Entry>
			</Relationship>
			<Annotation Type="SqlInlineConstraintAnnotation" Disambiguator="14" />
		</Element>
		<Element Type="SqlDefaultConstraint">
			<Property Name="DefaultExpressionScript">
				<Value><![CDATA[('Unknown')]]></Value>
			</Property>
			<Relationship Name="DefiningTable">
				<Entry>
					<References Name="[metadata].[ExecutionLog]" />
				</Entry>
			</Relationship>
			<Relationship Name="ForColumn">
				<Entry>
					<References Name="[metadata].[ExecutionLog].[CallingOrchestratorName]" />
				</Entry>
			</Relationship>
			<Annotation Type="SqlInlineConstraintAnnotation" Disambiguator="15" />
		</Element>
		<Element Type="SqlProcedure" Name="[dbo].[DemoModePrecursor]">
			<Property Name="BodyScript">
				<Value><![CDATA[
BEGIN

	--quick win
	IF ([metadata].[GetPropertyValueInternal]('ExecutionPrecursorProc')) <> '[dbo].[DemoModePrecursor]'
	BEGIN
		EXEC [metadataHelpers].[AddProperty]
			@PropertyName = N'ExecutionPrecursorProc',
			@PropertyValue = N'[dbo].[DemoModePrecursor]';
	END;

	--reduce wait times
	;WITH cte AS
		(
		SELECT 
			[PipelineId],
			LEFT(ABS(CAST(CAST(NEWID() AS VARBINARY(192)) AS INT)),1) AS NewValue
		FROM 
			[metadata].[PipelineParameters]
		)
	UPDATE
		pp
	SET
		pp.[ParameterValue] = cte.[NewValue]
	FROM
		[metadata].[PipelineParameters] pp
		INNER JOIN cte
			ON pp.[PipelineId] = cte.[PipelineId]
		INNER JOIN [metadata].[Pipelines] p
			ON pp.[PipelineId] = p.[PipelineId]
	WHERE
		pp.[ParameterName] LIKE 'Wait%'
		AND p.[Enabled] = 1;


	--for intentional error
	IF NOT EXISTS
		(
		SELECT * FROM [metadata].[CurrentExecution]
		)
		BEGIN
			UPDATE
				pp
			SET
				pp.[ParameterValue] = 'true'
			FROM
				[metadata].[PipelineParameters] pp
				INNER JOIN [metadata].[Pipelines] p
					ON pp.[PipelineId] = p.[PipelineId]
			WHERE
				p.[PipelineName] = 'Intentional Error'
				AND pp.[ParameterName] = 'RaiseErrors';
		END;
		ELSE
		BEGIN
			UPDATE
				pp
			SET
				pp.[ParameterValue] = 'false'
			FROM
				[metadata].[PipelineParameters] pp
				INNER JOIN [metadata].[Pipelines] p
					ON pp.[PipelineId] = p.[PipelineId]
			WHERE
				p.[PipelineName] = 'Intentional Error'
				AND pp.[ParameterName] = 'RaiseErrors';
		END;

	--dependency chain failure handling
	IF ([metadata].[GetPropertyValueInternal]('FailureHandling')) <> 'DependencyChain'
	BEGIN
		EXEC [metadataHelpers].[AddProperty]
			@PropertyName = N'FailureHandling',
			@PropertyValue = N'DependencyChain';
	END;


	--short infant iterations
	IF ([metadata].[GetPropertyValueInternal]('PipelineStatusCheckDuration')) <> '5'
	BEGIN
		EXEC [metadataHelpers].[AddProperty]
			@PropertyName = N'PipelineStatusCheckDuration',
			@PropertyValue = N'5';
		END;
END;]]></Value>
			</Property>
			<Property Name="IsAnsiNullsOn" Value="True" />
			<Relationship Name="BodyDependencies">
				<Entry>
					<References Name="[metadata].[GetPropertyValueInternal]" />
				</Entry>
				<Entry>
					<References Name="[metadataHelpers].[AddProperty]" />
				</Entry>
				<Entry>
					<References Name="[metadataHelpers].[AddProperty].[@PropertyName]" />
				</Entry>
				<Entry>
					<References Name="[metadataHelpers].[AddProperty].[@PropertyValue]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[PipelineParameters]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[PipelineParameters].[PipelineId]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[int]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[varbinary]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[PipelineParameters].[PipelineId]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[PipelineParameters].[PipelineId]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[Pipelines]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[PipelineParameters].[PipelineId]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[Pipelines].[PipelineId]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[PipelineParameters].[ParameterValue]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[PipelineParameters].[ParameterName]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[Pipelines].[Enabled]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[CurrentExecution]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[Pipelines].[PipelineName]" />
				</Entry>
			</Relationship>
			<Relationship Name="DynamicObjects">
				<Entry>
					<Element Type="SqlDynamicColumnSource" Name="[dbo].[DemoModePrecursor].[CTE1].[cte]">
						<Relationship Name="Columns">
							<Entry>
								<Element Type="SqlComputedColumn" Name="[dbo].[DemoModePrecursor].[CTE1].[cte].[PipelineId]">
									<Relationship Name="ExpressionDependencies">
										<Entry>
											<References Name="[metadata].[PipelineParameters].[PipelineId]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
							<Entry>
								<Element Type="SqlComputedColumn" Name="[dbo].[DemoModePrecursor].[CTE1].[cte].[NewValue]" />
							</Entry>
						</Relationship>
					</Element>
				</Entry>
			</Relationship>
			<Relationship Name="Schema">
				<Entry>
					<References ExternalSource="BuiltIns" Name="[dbo]" />
				</Entry>
			</Relationship>
			<Annotation Type="SysCommentsObjectAnnotation">
				<Property Name="Length" Value="2080" />
				<Property Name="StartLine" Value="1" />
				<Property Name="StartColumn" Value="1" />
				<Property Name="HeaderContents" Value="CREATE PROCEDURE [dbo].[DemoModePrecursor]&#xD;&#xA;AS" />
			</Annotation>
		</Element>
		<Element Type="SqlProcedure" Name="[dbo].[ExampleCustomExecutionPrecursor]">
			<Property Name="BodyScript">
				<Value><![CDATA[
BEGIN
	
	--set random Worker pipeline parameter wait times for development environment
	;WITH cte AS
		(
		SELECT 
			[PipelineId],
			LEFT(ABS(CAST(CAST(NEWID() AS VARBINARY(192)) AS INT)),2) AS NewValue
		FROM 
			[metadata].[PipelineParameters]
		)
	UPDATE
		pp
	SET
		pp.[ParameterValue] = cte.[NewValue]
	FROM
		[metadata].[PipelineParameters] pp
		INNER JOIN cte
			ON pp.[PipelineId] = cte.[PipelineId]
		INNER JOIN [metadata].[Pipelines] p
			ON pp.[PipelineId] = p.[PipelineId]
	WHERE
		pp.[ParameterName] LIKE 'Wait%'
		AND p.[Enabled] = 1;


	--disable certain Workers if running at the weekend...
	-- YOUR CODE HERE

	--enable certain Workers if running on the 10th day of the month...
	-- YOUR CODE HERE

	--disable certain Stages if running on Friday...
	-- YOUR CODE HERE

	--set Worker pipeline parameters to new value based on ______ ....
	-- YOUR CODE HERE
	
	--etc
END;]]></Value>
			</Property>
			<Property Name="IsAnsiNullsOn" Value="True" />
			<Relationship Name="BodyDependencies">
				<Entry>
					<References Name="[metadata].[PipelineParameters]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[PipelineParameters].[PipelineId]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[int]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[varbinary]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[PipelineParameters].[PipelineId]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[PipelineParameters].[PipelineId]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[Pipelines]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[PipelineParameters].[PipelineId]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[Pipelines].[PipelineId]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[PipelineParameters].[ParameterValue]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[PipelineParameters].[ParameterName]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[Pipelines].[Enabled]" />
				</Entry>
			</Relationship>
			<Relationship Name="DynamicObjects">
				<Entry>
					<Element Type="SqlDynamicColumnSource" Name="[dbo].[ExampleCustomExecutionPrecursor].[CTE1].[cte]">
						<Relationship Name="Columns">
							<Entry>
								<Element Type="SqlComputedColumn" Name="[dbo].[ExampleCustomExecutionPrecursor].[CTE1].[cte].[PipelineId]">
									<Relationship Name="ExpressionDependencies">
										<Entry>
											<References Name="[metadata].[PipelineParameters].[PipelineId]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
							<Entry>
								<Element Type="SqlComputedColumn" Name="[dbo].[ExampleCustomExecutionPrecursor].[CTE1].[cte].[NewValue]" />
							</Entry>
						</Relationship>
					</Element>
				</Entry>
			</Relationship>
			<Relationship Name="Schema">
				<Entry>
					<References ExternalSource="BuiltIns" Name="[dbo]" />
				</Entry>
			</Relationship>
			<Annotation Type="SysCommentsObjectAnnotation">
				<Property Name="Length" Value="989" />
				<Property Name="StartLine" Value="1" />
				<Property Name="StartColumn" Value="1" />
				<Property Name="HeaderContents" Value="CREATE PROCEDURE [dbo].[ExampleCustomExecutionPrecursor]&#xD;&#xA;AS" />
			</Annotation>
		</Element>
		<Element Type="SqlProcedure" Name="[dbo].[FailProcedure]">
			<Property Name="BodyScript">
				<Value><![CDATA[
BEGIN
	IF(@RaiseError = 'true')
	BEGIN
		RAISERROR('The Stored Procedure intentionally failed.',16,1);
		RETURN 0;
	END
END;]]></Value>
			</Property>
			<Property Name="IsAnsiNullsOn" Value="True" />
			<Relationship Name="BodyDependencies">
				<Entry>
					<References Name="[dbo].[FailProcedure].[@RaiseError]" />
				</Entry>
			</Relationship>
			<Relationship Name="Parameters">
				<Entry>
					<Element Type="SqlSubroutineParameter" Name="[dbo].[FailProcedure].[@RaiseError]">
						<Relationship Name="Type">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Property Name="Length" Value="50" />
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[varchar]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
			</Relationship>
			<Relationship Name="Schema">
				<Entry>
					<References ExternalSource="BuiltIns" Name="[dbo]" />
				</Entry>
			</Relationship>
			<Annotation Type="SysCommentsObjectAnnotation">
				<Property Name="Length" Value="208" />
				<Property Name="StartLine" Value="1" />
				<Property Name="StartColumn" Value="1" />
				<Property Name="HeaderContents" Value="CREATE PROCEDURE [dbo].[FailProcedure]&#xD;&#xA;&#x9;(&#xD;&#xA;&#x9;@RaiseError VARCHAR(50)&#xD;&#xA;&#x9;)&#xD;&#xA;AS" />
			</Annotation>
		</Element>
		<Element Type="SqlPrimaryKeyConstraint" Name="[dbo].[PK_ServicePrincipals]">
			<Relationship Name="ColumnSpecifications">
				<Entry>
					<Element Type="SqlIndexedColumnSpecification">
						<Relationship Name="Column">
							<Entry>
								<References Name="[dbo].[ServicePrincipals].[CredentialId]" />
							</Entry>
						</Relationship>
					</Element>
				</Entry>
			</Relationship>
			<Relationship Name="DefiningTable">
				<Entry>
					<References Name="[dbo].[ServicePrincipals]" />
				</Entry>
			</Relationship>
			<Annotation Type="SqlInlineConstraintAnnotation" Disambiguator="16" />
		</Element>
		<Element Type="SqlTable" Name="[dbo].[ServicePrincipals]">
			<Property Name="IsAnsiNullsOn" Value="True" />
			<Relationship Name="Columns">
				<Entry>
					<Element Type="SqlSimpleColumn" Name="[dbo].[ServicePrincipals].[CredentialId]">
						<Property Name="IsNullable" Value="False" />
						<Property Name="IsIdentity" Value="True" />
						<Relationship Name="TypeSpecifier">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[int]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlSimpleColumn" Name="[dbo].[ServicePrincipals].[PrincipalName]">
						<Relationship Name="TypeSpecifier">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Property Name="Length" Value="256" />
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[nvarchar]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlSimpleColumn" Name="[dbo].[ServicePrincipals].[PrincipalId]">
						<Relationship Name="TypeSpecifier">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[uniqueidentifier]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlSimpleColumn" Name="[dbo].[ServicePrincipals].[PrincipalSecret]">
						<Relationship Name="TypeSpecifier">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Property Name="Length" Value="256" />
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[varbinary]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlSimpleColumn" Name="[dbo].[ServicePrincipals].[PrincipalIdUrl]">
						<Relationship Name="TypeSpecifier">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Property Name="IsMax" Value="True" />
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[nvarchar]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlSimpleColumn" Name="[dbo].[ServicePrincipals].[PrincipalSecretUrl]">
						<Relationship Name="TypeSpecifier">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Property Name="IsMax" Value="True" />
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[nvarchar]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
			</Relationship>
			<Relationship Name="Schema">
				<Entry>
					<References ExternalSource="BuiltIns" Name="[dbo]" />
				</Entry>
			</Relationship>
			<AttachedAnnotation Disambiguator="16" />
		</Element>
		<Element Type="SqlPermissionStatement" Name="[Grant.Alter.Schema].[metadatauser].[dbo].[metadata]">
			<Property Name="Permission" Value="1001" />
			<Relationship Name="Grantee">
				<Entry>
					<References Name="[metadatauser]" />
				</Entry>
			</Relationship>
			<Relationship Name="SecuredObject">
				<Entry>
					<References Name="[metadata]" />
				</Entry>
			</Relationship>
		</Element>
		<Element Type="SqlPermissionStatement" Name="[Grant.Control.Schema].[metadatauser].[dbo].[metadata]">
			<Property Name="Permission" Value="1038" />
			<Relationship Name="Grantee">
				<Entry>
					<References Name="[metadatauser]" />
				</Entry>
			</Relationship>
			<Relationship Name="SecuredObject">
				<Entry>
					<References Name="[metadata]" />
				</Entry>
			</Relationship>
		</Element>
		<Element Type="SqlPermissionStatement" Name="[Grant.Execute.Schema].[metadatauser].[dbo].[metadata]">
			<Property Name="Permission" Value="1070" />
			<Relationship Name="Grantee">
				<Entry>
					<References Name="[metadatauser]" />
				</Entry>
			</Relationship>
			<Relationship Name="SecuredObject">
				<Entry>
					<References Name="[metadata]" />
				</Entry>
			</Relationship>
		</Element>
		<Element Type="SqlPermissionStatement" Name="[Grant.Select.Schema].[metadatauser].[dbo].[metadata]">
			<Property Name="Permission" Value="2" />
			<Relationship Name="Grantee">
				<Entry>
					<References Name="[metadatauser]" />
				</Entry>
			</Relationship>
			<Relationship Name="SecuredObject">
				<Entry>
					<References Name="[metadata]" />
				</Entry>
			</Relationship>
		</Element>
		<Element Type="SqlSchema" Name="[metadata]">
			<Relationship Name="Authorizer">
				<Entry>
					<References ExternalSource="BuiltIns" Name="[dbo]" />
				</Entry>
			</Relationship>
		</Element>
		<Element Type="SqlSynonym" Name="[metadata].[AddPipelineDependant]">
			<Property Name="ForObjectScript">
				<Value><![CDATA[[metadataHelpers].[AddPipelineDependant]]]></Value>
			</Property>
			<Relationship Name="ForObject">
				<Entry>
					<References Name="[metadataHelpers].[AddPipelineDependant]" />
					<Annotation Type="PersistedResolvableAnnotation" Name="[metadataHelpers].[AddPipelineDependant]">
						<Property Name="TargetTypeStorage" Value="ISqlSynonymTarget" />
						<Property Name="Length" Value="40" />
						<Property Name="Offset" Value="53" />
					</Annotation>
				</Entry>
			</Relationship>
			<Relationship Name="Schema">
				<Entry>
					<References Name="[metadata]" />
				</Entry>
			</Relationship>
		</Element>
		<Element Type="SqlSynonym" Name="[metadata].[AddProperty]">
			<Property Name="ForObjectScript">
				<Value><![CDATA[[metadataHelpers].[AddProperty]]]></Value>
			</Property>
			<Relationship Name="ForObject">
				<Entry>
					<References Name="[metadataHelpers].[AddProperty]" />
					<Annotation Type="PersistedResolvableAnnotation" Name="[metadataHelpers].[AddProperty]">
						<Property Name="TargetTypeStorage" Value="ISqlSynonymTarget" />
						<Property Name="Length" Value="31" />
						<Property Name="Offset" Value="44" />
					</Annotation>
				</Entry>
			</Relationship>
			<Relationship Name="Schema">
				<Entry>
					<References Name="[metadata]" />
				</Entry>
			</Relationship>
		</Element>
		<Element Type="SqlSynonym" Name="[metadata].[AddRecipientPipelineAlerts]">
			<Property Name="ForObjectScript">
				<Value><![CDATA[[metadataHelpers].[AddRecipientPipelineAlerts]]]></Value>
			</Property>
			<Relationship Name="ForObject">
				<Entry>
					<References Name="[metadataHelpers].[AddRecipientPipelineAlerts]" />
					<Annotation Type="PersistedResolvableAnnotation" Name="[metadataHelpers].[AddRecipientPipelineAlerts]">
						<Property Name="TargetTypeStorage" Value="ISqlSynonymTarget" />
						<Property Name="Length" Value="46" />
						<Property Name="Offset" Value="59" />
					</Annotation>
				</Entry>
			</Relationship>
			<Relationship Name="Schema">
				<Entry>
					<References Name="[metadata]" />
				</Entry>
			</Relationship>
		</Element>
		<Element Type="SqlSynonym" Name="[metadata].[AddServicePrincipal]">
			<Property Name="ForObjectScript">
				<Value><![CDATA[[metadataHelpers].[AddServicePrincipal]]]></Value>
			</Property>
			<Relationship Name="ForObject">
				<Entry>
					<References Name="[metadataHelpers].[AddServicePrincipal]" />
					<Annotation Type="PersistedResolvableAnnotation" Name="[metadataHelpers].[AddServicePrincipal]">
						<Property Name="TargetTypeStorage" Value="ISqlSynonymTarget" />
						<Property Name="Length" Value="39" />
						<Property Name="Offset" Value="52" />
					</Annotation>
				</Entry>
			</Relationship>
			<Relationship Name="Schema">
				<Entry>
					<References Name="[metadata]" />
				</Entry>
			</Relationship>
		</Element>
		<Element Type="SqlSynonym" Name="[metadata].[AddServicePrincipalUrls]">
			<Property Name="ForObjectScript">
				<Value><![CDATA[[metadataHelpers].[AddServicePrincipalUrls]]]></Value>
			</Property>
			<Relationship Name="ForObject">
				<Entry>
					<References Name="[metadataHelpers].[AddServicePrincipalUrls]" />
					<Annotation Type="PersistedResolvableAnnotation" Name="[metadataHelpers].[AddServicePrincipalUrls]">
						<Property Name="TargetTypeStorage" Value="ISqlSynonymTarget" />
						<Property Name="Length" Value="43" />
						<Property Name="Offset" Value="57" />
					</Annotation>
				</Entry>
			</Relationship>
			<Relationship Name="Schema">
				<Entry>
					<References Name="[metadata]" />
				</Entry>
			</Relationship>
		</Element>
		<Element Type="SqlSynonym" Name="[metadata].[AddServicePrincipalWrapper]">
			<Property Name="ForObjectScript">
				<Value><![CDATA[[metadataHelpers].[AddServicePrincipalWrapper]]]></Value>
			</Property>
			<Relationship Name="ForObject">
				<Entry>
					<References Name="[metadataHelpers].[AddServicePrincipalWrapper]" />
					<Annotation Type="PersistedResolvableAnnotation" Name="[metadataHelpers].[AddServicePrincipalWrapper]">
						<Property Name="TargetTypeStorage" Value="ISqlSynonymTarget" />
						<Property Name="Length" Value="46" />
						<Property Name="Offset" Value="60" />
					</Annotation>
				</Entry>
			</Relationship>
			<Relationship Name="Schema">
				<Entry>
					<References Name="[metadata]" />
				</Entry>
			</Relationship>
		</Element>
		<Element Type="SqlTable" Name="[metadata].[AlertOutcomes]">
			<Property Name="IsAnsiNullsOn" Value="True" />
			<Relationship Name="Columns">
				<Entry>
					<Element Type="SqlSimpleColumn" Name="[metadata].[AlertOutcomes].[OutcomeBitPosition]">
						<Property Name="IsNullable" Value="False" />
						<Property Name="IsIdentity" Value="True" />
						<Property Name="IdentitySeed" Value="0" />
						<Relationship Name="TypeSpecifier">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[int]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlSimpleColumn" Name="[metadata].[AlertOutcomes].[PipelineOutcomeStatus]">
						<Property Name="IsNullable" Value="False" />
						<Relationship Name="TypeSpecifier">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Property Name="Length" Value="200" />
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[nvarchar]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlComputedColumn" Name="[metadata].[AlertOutcomes].[BitValue]">
						<Property Name="ExpressionScript">
							<Value><![CDATA[(POWER((2),[OutcomeBitPosition]))]]></Value>
						</Property>
						<Relationship Name="ExpressionDependencies">
							<Entry>
								<References Name="[metadata].[AlertOutcomes].[OutcomeBitPosition]" />
							</Entry>
						</Relationship>
					</Element>
				</Entry>
			</Relationship>
			<Relationship Name="Schema">
				<Entry>
					<References Name="[metadata]" />
				</Entry>
			</Relationship>
			<Annotation Type="SqlInlineConstraintAnnotation" Disambiguator="17" />
			<Annotation Type="SqlInlineConstraintAnnotation" Disambiguator="18" />
		</Element>
		<Element Type="SqlSynonym" Name="[metadata].[AverageStageDuration]">
			<Property Name="ForObjectScript">
				<Value><![CDATA[[metadataReporting].[AverageStageDuration]]]></Value>
			</Property>
			<Relationship Name="ForObject">
				<Entry>
					<References Name="[metadataReporting].[AverageStageDuration]" />
					<Annotation Type="PersistedResolvableAnnotation" Name="[metadataReporting].[AverageStageDuration]">
						<Property Name="TargetTypeStorage" Value="ISqlSynonymTarget" />
						<Property Name="Length" Value="42" />
						<Property Name="Offset" Value="54" />
					</Annotation>
				</Entry>
			</Relationship>
			<Relationship Name="Schema">
				<Entry>
					<References Name="[metadata]" />
				</Entry>
			</Relationship>
		</Element>
		<Element Type="SqlTable" Name="[metadata].[Batches]">
			<Property Name="IsAnsiNullsOn" Value="True" />
			<Relationship Name="Columns">
				<Entry>
					<Element Type="SqlSimpleColumn" Name="[metadata].[Batches].[BatchId]">
						<Property Name="IsNullable" Value="False" />
						<Relationship Name="TypeSpecifier">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[uniqueidentifier]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
						<AttachedAnnotation Disambiguator="4" />
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlSimpleColumn" Name="[metadata].[Batches].[BatchName]">
						<Property Name="IsNullable" Value="False" />
						<Relationship Name="TypeSpecifier">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Property Name="Length" Value="255" />
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[varchar]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlSimpleColumn" Name="[metadata].[Batches].[BatchDescription]">
						<Relationship Name="TypeSpecifier">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Property Name="Length" Value="4000" />
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[varchar]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlSimpleColumn" Name="[metadata].[Batches].[Enabled]">
						<Property Name="IsNullable" Value="False" />
						<Relationship Name="TypeSpecifier">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[bit]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
						<AttachedAnnotation Disambiguator="8" />
					</Element>
				</Entry>
			</Relationship>
			<Relationship Name="Schema">
				<Entry>
					<References Name="[metadata]" />
				</Entry>
			</Relationship>
			<Annotation Type="SqlInlineConstraintAnnotation" Disambiguator="19" />
		</Element>
		<Element Type="SqlTable" Name="[metadata].[BatchExecution]">
			<Property Name="IsAnsiNullsOn" Value="True" />
			<Relationship Name="Columns">
				<Entry>
					<Element Type="SqlSimpleColumn" Name="[metadata].[BatchExecution].[BatchId]">
						<Property Name="IsNullable" Value="False" />
						<Relationship Name="TypeSpecifier">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[uniqueidentifier]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlSimpleColumn" Name="[metadata].[BatchExecution].[ExecutionId]">
						<Property Name="IsNullable" Value="False" />
						<Relationship Name="TypeSpecifier">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[uniqueidentifier]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlSimpleColumn" Name="[metadata].[BatchExecution].[BatchName]">
						<Property Name="IsNullable" Value="False" />
						<Relationship Name="TypeSpecifier">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Property Name="Length" Value="255" />
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[varchar]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlSimpleColumn" Name="[metadata].[BatchExecution].[BatchStatus]">
						<Property Name="IsNullable" Value="False" />
						<Relationship Name="TypeSpecifier">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Property Name="Length" Value="200" />
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[nvarchar]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlSimpleColumn" Name="[metadata].[BatchExecution].[StartDateTime]">
						<Property Name="IsNullable" Value="False" />
						<Relationship Name="TypeSpecifier">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[datetime]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlSimpleColumn" Name="[metadata].[BatchExecution].[EndDateTime]">
						<Relationship Name="TypeSpecifier">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[datetime]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
			</Relationship>
			<Relationship Name="Schema">
				<Entry>
					<References Name="[metadata]" />
				</Entry>
			</Relationship>
			<Annotation Type="SqlInlineConstraintAnnotation" Disambiguator="20" />
		</Element>
		<Element Type="SqlTable" Name="[metadata].[BatchStageLink]">
			<Property Name="IsAnsiNullsOn" Value="True" />
			<Relationship Name="Columns">
				<Entry>
					<Element Type="SqlSimpleColumn" Name="[metadata].[BatchStageLink].[BatchId]">
						<Property Name="IsNullable" Value="False" />
						<Relationship Name="TypeSpecifier">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[uniqueidentifier]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlSimpleColumn" Name="[metadata].[BatchStageLink].[StageId]">
						<Property Name="IsNullable" Value="False" />
						<Relationship Name="TypeSpecifier">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[int]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
			</Relationship>
			<Relationship Name="Schema">
				<Entry>
					<References Name="[metadata]" />
				</Entry>
			</Relationship>
			<Annotation Type="SqlInlineConstraintAnnotation" Disambiguator="21" />
			<Annotation Type="SqlInlineConstraintAnnotation" Disambiguator="22" />
			<Annotation Type="SqlInlineConstraintAnnotation" Disambiguator="23" />
		</Element>
		<Element Type="SqlProcedure" Name="[metadata].[BatchWrapper]">
			<Property Name="BodyScript">
				<Value><![CDATA[
BEGIN
	SET NOCOUNT ON;

	DECLARE @RestartStatus BIT

	--get restart overide property	
	SELECT @RestartStatus = [metadata].[GetPropertyValueInternal]('OverideRestart')

	--check for running batch execution
	IF EXISTS
		(
		SELECT 1 FROM [metadata].[BatchExecution] WHERE [BatchId] = @BatchId AND ISNULL([BatchStatus],'') = 'Running'
		)
		BEGIN
			SELECT
				@LocalExecutionId = [ExecutionId]
			FROM
				[metadata].[BatchExecution]
			WHERE
				[BatchId] = @BatchId;
			
			--should never actually be called as handled within Orchestrator pipelines using the Pipeline Run Check utility
			RAISERROR('There is already an batch execution run in progress. Stop the related parent pipeline via the Orchestrator first.',16,1);
			RETURN 0;
		END
	ELSE IF EXISTS
		(
		SELECT 1 FROM [metadata].[BatchExecution] WHERE [BatchId] = @BatchId AND ISNULL([BatchStatus],'') = 'Stopped'
		)
		AND @RestartStatus = 0
		BEGIN
			SELECT
				@LocalExecutionId = [ExecutionId]
			FROM
				[metadata].[BatchExecution]
			WHERE
				[BatchId] = @BatchId
				AND ISNULL([BatchStatus],'') = 'Stopped';

			RETURN 0;
		END
	ELSE IF EXISTS
		(
		SELECT 1 FROM [metadata].[BatchExecution] WHERE [BatchId] = @BatchId AND ISNULL([BatchStatus],'') = 'Stopped'
		)
		AND @RestartStatus = 1
		BEGIN
			--clean up current execution table and abandon batch
			SELECT
				@LocalExecutionId = [ExecutionId]
			FROM
				[metadata].[BatchExecution]
			WHERE
				[BatchId] = @BatchId
				AND ISNULL([BatchStatus],'') = 'Stopped';
			
			EXEC [metadata].[UpdateExecutionLog]
				@PerformErrorCheck = 0, --Special case when OverideRestart = 1;
				@ExecutionId = @LocalExecutionId;
			
			--abandon previous batch execution
			UPDATE
				[metadata].[BatchExecution]
			SET
				[BatchStatus] = 'Abandoned'
			WHERE
				[BatchId] = @BatchId 
				AND ISNULL([BatchStatus],'') = 'Stopped';
	
			SET @LocalExecutionId = NEWID();

			--create new batch run record
			INSERT INTO [metadata].[BatchExecution]
				(
				[BatchId],
				[ExecutionId],
				[BatchName],
				[BatchStatus],
				[StartDateTime]
				)
			SELECT
				[BatchId],
				@LocalExecutionId,
				[BatchName],
				'Running',
				GETUTCDATE()
			FROM
				[metadata].[Batches]
			WHERE
				[BatchId] = @BatchId;			
		END
	ELSE
		BEGIN
			SET @LocalExecutionId = NEWID();

			--create new batch run record
			INSERT INTO [metadata].[BatchExecution]
				(
				[BatchId],
				[ExecutionId],
				[BatchName],
				[BatchStatus],
				[StartDateTime]
				)
			SELECT
				[BatchId],
				@LocalExecutionId,
				[BatchName],
				'Running',
				GETUTCDATE()
			FROM
				[metadata].[Batches]
			WHERE
				[BatchId] = @BatchId;
		END;
END;]]></Value>
			</Property>
			<Property Name="IsAnsiNullsOn" Value="True" />
			<Relationship Name="BodyDependencies">
				<Entry>
					<References ExternalSource="BuiltIns" Name="[bit]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[GetPropertyValueInternal]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[BatchExecution]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[BatchExecution].[BatchId]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[BatchWrapper].[@BatchId]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[BatchExecution].[BatchStatus]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[BatchWrapper].[@LocalExecutionId]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[BatchExecution].[ExecutionId]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[BatchExecution].[BatchId]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[BatchExecution].[BatchStatus]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[UpdateExecutionLog]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[UpdateExecutionLog].[@PerformErrorCheck]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[UpdateExecutionLog].[@ExecutionId]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[BatchExecution].[BatchName]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[BatchExecution].[StartDateTime]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[Batches]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[Batches].[BatchId]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[Batches].[BatchName]" />
				</Entry>
			</Relationship>
			<Relationship Name="Parameters">
				<Entry>
					<Element Type="SqlSubroutineParameter" Name="[metadata].[BatchWrapper].[@BatchId]">
						<Relationship Name="Type">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[uniqueidentifier]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlSubroutineParameter" Name="[metadata].[BatchWrapper].[@LocalExecutionId]">
						<Property Name="IsOutput" Value="True" />
						<Relationship Name="Type">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[uniqueidentifier]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
			</Relationship>
			<Relationship Name="Schema">
				<Entry>
					<References Name="[metadata]" />
				</Entry>
			</Relationship>
			<Annotation Type="SysCommentsObjectAnnotation">
				<Property Name="Length" Value="2885" />
				<Property Name="StartLine" Value="1" />
				<Property Name="StartColumn" Value="1" />
				<Property Name="HeaderContents" Value="CREATE PROCEDURE [metadata].[BatchWrapper]&#xD;&#xA;&#x9;(&#xD;&#xA;&#x9;@BatchId UNIQUEIDENTIFIER,&#xD;&#xA;&#x9;@LocalExecutionId UNIQUEIDENTIFIER OUTPUT&#xD;&#xA;&#x9;)&#xD;&#xA;AS" />
			</Annotation>
		</Element>
		<Element Type="SqlProcedure" Name="[metadata].[CheckForBlockedPipelines]">
			<Property Name="BodyScript">
				<Value><![CDATA[
BEGIN
	SET NOCOUNT ON;

	-- If any pipelines still have a status of running, mark as failed to block downstream processing, and add an error log
	IF EXISTS
		(
		SELECT 
			*
		FROM 
			[metadata].[CurrentExecution]
		WHERE 
			[LocalExecutionId] = @ExecutionId
			AND [StageId] < @StageId
			AND [PipelineStatus] = 'Running'
		)
		BEGIN		
			DECLARE @RunningPipelineId INT;
			DECLARE @RunningPipelineStageId INT;
			DECLARE @RunId UNIQUEIDENTIFIER;
			DECLARE @ErrorJson NVARCHAR(MAX);
			DECLARE @RunningCursor CURSOR ;

			SET @RunningCursor = CURSOR FOR 
									        SELECT 
										        [PipelineId],
										        [StageId],
										        [PipelineRunId]
									        FROM 
										        [metadata].[CurrentExecution]
									        WHERE 
										        [LocalExecutionId] = @ExecutionId
										        AND [StageId] < @StageId
										        AND [PipelineStatus] = 'Running'

			OPEN @RunningCursor
			FETCH NEXT FROM @RunningCursor INTO @RunningPipelineId, @RunningPipelineStageId, @RunId
					
			WHILE @@FETCH_STATUS = 0
			BEGIN 
				EXEC [metadata].SetLogPipelineFailed
					@ExecutionId = @ExecutionId,
					@StageId = @RunningPipelineStageId,
					@PipelineId = @RunningPipelineId,
					@RunId = @RunId;

				SET @ErrorJson = '{ "RunId": "' + Cast(@RunId AS CHAR(36)) + '", "Errors": [ { "ActivityRunId": "00000000-0000-0000-0000-000000000000", "ActivityName": "Set Pipeline Result", "ActivityType": "Switch", "ErrorCode": "Unknown", "ErrorType": "Framework Error", "ErrorMessage": "Framework pipeline ''04-Infant'' failed to set the pipeline result, most likely due to a timeout or azure connectivity issue. Check the framework Data Factory monitor for more information." } ] }'
				EXEC metadata.SetErrorLogDetails @LocalExecutionId = @ExecutionId,
                                        @JsonErrorDetails = @ErrorJson;
						
				FETCH NEXT FROM @RunningCursor INTO @RunningPipelineId, @RunningPipelineStageId, @RunId;
			END;
			CLOSE @RunningCursor;
			DEALLOCATE @RunningCursor;
		END;


	IF ([metadata].[GetPropertyValueInternal]('FailureHandling')) = 'None'
		BEGIN
			--do nothing allow processing to carry on regardless
			RETURN 0;
		END;
		
	ELSE IF ([metadata].[GetPropertyValueInternal]('FailureHandling')) = 'Simple'
		BEGIN
			IF EXISTS
				(
				SELECT 
					*
				FROM 
					[metadata].[CurrentExecution]
				WHERE 
					[LocalExecutionId] = @ExecutionId
					AND [StageId] = @StageId
					AND [IsBlocked] = 1
				)
				BEGIN		
					UPDATE
						[metadata].[BatchExecution]
					SET
						[EndDateTime] = GETUTCDATE(),
						[BatchStatus] = 'Stopped'
					WHERE
						[ExecutionId] = @ExecutionId;
					
					--Saves the infant pipeline and activities being called throwing the exception at this level.
					RAISERROR('All pipelines are blocked. Stopping processing.',16,1); 
					--If not thrown here, the proc [metadata].[UpdateExecutionLog] would eventually throw an exception.
					RETURN 0;
				END			
		END;
	
	ELSE IF ([metadata].[GetPropertyValueInternal]('FailureHandling')) = 'DependencyChain'
		BEGIN
			IF EXISTS
				(
				SELECT 
					*
				FROM 
					[metadata].[CurrentExecution]
				WHERE 
					[LocalExecutionId] = @ExecutionId
					AND [StageId] = @StageId
					AND [IsBlocked] = 1
				)
				BEGIN		
					DECLARE @PipelineId INT;
					DECLARE @Cursor CURSOR ;

					SET @Cursor = CURSOR FOR 
											SELECT 
												[PipelineId] 
											FROM 
												[metadata].[CurrentExecution]
											WHERE 
												[LocalExecutionId] = @ExecutionId
												AND [StageId] = @StageId 
												AND [IsBlocked] = 1

					OPEN @Cursor
					FETCH NEXT FROM @Cursor INTO @PipelineId
					
					WHILE @@FETCH_STATUS = 0
					BEGIN 
						EXEC [metadata].[SetExecutionBlockDependants]
							@ExecutionId = @ExecutionId,
							@PipelineId = @PipelineId;
						
						FETCH NEXT FROM @Cursor INTO @PipelineId;
					END;
					CLOSE @Cursor;
					DEALLOCATE @Cursor;
				END;
		END;
	ELSE
		BEGIN
			RAISERROR('Unknown failure handling state.',16,1);
			RETURN 0;
		END;
END;]]></Value>
			</Property>
			<Property Name="IsAnsiNullsOn" Value="True" />
			<Relationship Name="BodyDependencies">
				<Entry>
					<References ExternalSource="BuiltIns" Name="[int]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[int]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[uniqueidentifier]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[nvarchar]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[cursor]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[int]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[cursor]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[CurrentExecution]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[CurrentExecution].[LocalExecutionId]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[CheckForBlockedPipelines].[@ExecutionId]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[CurrentExecution].[StageId]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[CheckForBlockedPipelines].[@StageId]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[CurrentExecution].[PipelineStatus]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[CurrentExecution].[PipelineId]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[CurrentExecution].[StageId]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[CurrentExecution].[PipelineRunId]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[CurrentExecution].[LocalExecutionId]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[CurrentExecution].[PipelineStatus]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[SetLogPipelineFailed]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[SetLogPipelineFailed].[@ExecutionId]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[SetLogPipelineFailed].[@StageId]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[SetLogPipelineFailed].[@PipelineId]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[SetLogPipelineFailed].[@RunId]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[char]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[SetErrorLogDetails]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[SetErrorLogDetails].[@LocalExecutionId]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[SetErrorLogDetails].[@JsonErrorDetails]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[GetPropertyValueInternal]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[CurrentExecution].[IsBlocked]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[BatchExecution]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[BatchExecution].[EndDateTime]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[BatchExecution].[BatchStatus]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[BatchExecution].[ExecutionId]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[CurrentExecution].[IsBlocked]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[SetExecutionBlockDependants]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[SetExecutionBlockDependants].[@ExecutionId]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[SetExecutionBlockDependants].[@PipelineId]" />
				</Entry>
			</Relationship>
			<Relationship Name="Parameters">
				<Entry>
					<Element Type="SqlSubroutineParameter" Name="[metadata].[CheckForBlockedPipelines].[@ExecutionId]">
						<Relationship Name="Type">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[uniqueidentifier]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlSubroutineParameter" Name="[metadata].[CheckForBlockedPipelines].[@StageId]">
						<Relationship Name="Type">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[int]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
			</Relationship>
			<Relationship Name="Schema">
				<Entry>
					<References Name="[metadata]" />
				</Entry>
			</Relationship>
			<Annotation Type="SysCommentsObjectAnnotation">
				<Property Name="Length" Value="4327" />
				<Property Name="StartLine" Value="1" />
				<Property Name="StartColumn" Value="1" />
				<Property Name="HeaderContents" Value="CREATE PROCEDURE [metadata].[CheckForBlockedPipelines]&#xD;&#xA;&#x9;(&#xD;&#xA;&#x9;@ExecutionId UNIQUEIDENTIFIER,&#xD;&#xA;&#x9;@StageId INT&#xD;&#xA;&#x9;)&#xD;&#xA;AS" />
			</Annotation>
		</Element>
		<Element Type="SqlProcedure" Name="[metadata].[CheckForEmailAlerts]">
			<Property Name="BodyScript">
				<Value><![CDATA[
BEGIN
	SET NOCOUNT ON;

	DECLARE @SendAlerts BIT
	DECLARE @AlertingEnabled BIT

	--get property
	SELECT
		@AlertingEnabled = [metadata].[GetPropertyValueInternal]('UseFrameworkEmailAlerting');

	--based on global property
	IF (@AlertingEnabled = 1)
		BEGIN
			--based on piplines to recipients link
			IF EXISTS
				(
				SELECT pal.AlertId
				FROM metadata.CurrentExecution AS ce
				INNER JOIN metadata.AlertOutcomes AS ao
					ON ao.PipelineOutcomeStatus = ce.PipelineStatus
				INNER JOIN metadata.PipelineAlertLink AS pal
					ON pal.PipelineId = ce.PipelineId
				INNER JOIN metadata.Recipients AS r
					ON r.RecipientId = pal.RecipientId
				WHERE ce.PipelineId = @PipelineId
					   AND (
						ao.BitValue & pal.OutcomesBitValue <> 0
						OR pal.OutcomesBitValue & 1 <> 0 --all
						)
					  AND pal.[Enabled] = 1
					  AND r.[Enabled] = 1
				)
				BEGIN
					SET @SendAlerts = 1;
				END;
			ELSE
				BEGIN
					SET @SendAlerts = 0;
				END;
		END
	ELSE
		BEGIN
			SET @SendAlerts = 0;
		END;

	SELECT @SendAlerts AS SendAlerts
END;]]></Value>
			</Property>
			<Property Name="IsAnsiNullsOn" Value="True" />
			<Relationship Name="BodyDependencies">
				<Entry>
					<References ExternalSource="BuiltIns" Name="[bit]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[bit]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[GetPropertyValueInternal]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[CurrentExecution]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[AlertOutcomes]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[AlertOutcomes].[PipelineOutcomeStatus]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[CurrentExecution].[PipelineStatus]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[PipelineAlertLink]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[PipelineAlertLink].[PipelineId]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[CurrentExecution].[PipelineId]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[Recipients]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[Recipients].[RecipientId]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[PipelineAlertLink].[RecipientId]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[PipelineAlertLink].[AlertId]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[CurrentExecution].[PipelineId]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[CheckForEmailAlerts].[@PipelineId]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[AlertOutcomes].[BitValue]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[PipelineAlertLink].[OutcomesBitValue]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[PipelineAlertLink].[Enabled]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[Recipients].[Enabled]" />
				</Entry>
			</Relationship>
			<Relationship Name="Parameters">
				<Entry>
					<Element Type="SqlSubroutineParameter" Name="[metadata].[CheckForEmailAlerts].[@PipelineId]">
						<Relationship Name="Type">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[int]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
			</Relationship>
			<Relationship Name="Schema">
				<Entry>
					<References Name="[metadata]" />
				</Entry>
			</Relationship>
			<Annotation Type="SysCommentsObjectAnnotation">
				<Property Name="Length" Value="1175" />
				<Property Name="StartLine" Value="1" />
				<Property Name="StartColumn" Value="1" />
				<Property Name="HeaderContents" Value="CREATE PROCEDURE [metadata].[CheckForEmailAlerts]&#xD;&#xA;&#x9;(&#xD;&#xA;&#x9;@PipelineId INT&#xD;&#xA;&#x9;)&#xD;&#xA;AS" />
			</Annotation>
		</Element>
		<Element Type="SqlSynonym" Name="[metadata].[CheckForValidURL]">
			<Property Name="ForObjectScript">
				<Value><![CDATA[[metadataHelpers].[CheckForValidURL]]]></Value>
			</Property>
			<Relationship Name="ForObject">
				<Entry>
					<References Name="[metadataHelpers].[CheckForValidURL]" />
					<Annotation Type="PersistedResolvableAnnotation" Name="[metadataHelpers].[CheckForValidURL]">
						<Property Name="TargetTypeStorage" Value="ISqlSynonymTarget" />
						<Property Name="Length" Value="36" />
						<Property Name="Offset" Value="50" />
					</Annotation>
				</Entry>
			</Relationship>
			<Relationship Name="Schema">
				<Entry>
					<References Name="[metadata]" />
				</Entry>
			</Relationship>
		</Element>
		<Element Type="SqlProcedure" Name="[metadata].[CheckMetadataIntegrity]">
			<Property Name="BodyScript">
				<Value><![CDATA[
BEGIN
	SET NOCOUNT ON;
	
	/*
	Check 1 - Are there execution stages enabled in the metadata?
	Check 2 - Are there pipelines enabled in the metadata?
	Check 3 - Are there any service principals available to run the processing pipelines?
	Check 4 - Is there at least one TenantId available?
	Check 5 - Is there at least one SubscriptionId available?
	Check 6 - Is there a current OverideRestart property available?
	Check 7 - Are there any enabled pipelines configured without a service principal?
	Check 8 - Are any Orchestrators set to use the default subscription value?
	Check 9 - Are any Subscription set to use the default tenant value?
	Check 10 - Is there a current PipelineStatusCheckDuration property available?
	Check 11 - Is there a current UseFrameworkEmailAlerting property available?
	Check 12 - Is there a current EmailAlertBodyTemplate property available?
	Check 13 - Does the total size of the request body for the pipeline parameters added exceed the Azure Functions size limit when the Worker execute pipeline body is created?
	Check 14 - Is there a current FailureHandling property available?
	Check 15 - Does the FailureHandling property have a valid value?
	Check 16 - When using DependencyChain failure handling, are there any dependants in the same execution stage of the predecessor?
	Check 17 - Does the SPNHandlingMethod property have a valid value?
	Check 18 - Does the Service Principal table contain both types of SPN handling for a single credential?
	Check 19 - Is there a current UseExecutionBatches property available?
	Check 20 - Is there a current FrameworkFactoryResourceGroup property available?
	Check 21 - Is there a current PreviousPipelineRunsQueryRange property available?
	
	--Batch execution checks:
	Check 22 - If using batch executions, is the requested batch name enabled?
	Check 23 - If using batch executions, does the requested batch have links to execution stages?
	Check 24 - Have batch executions been enabled after a none batch execution run?

	Check 25 - Has the execution failed due to an invalid pipeline name? If so, attend to update this before the next run.
	Check 26 - Is there more than one framework orchestrator set?
	Check 27 - Has a framework orchestrator been set for any orchestrators?
	*/

	DECLARE @BatchId UNIQUEIDENTIFIER
	DECLARE @ErrorDetails VARCHAR(500)
	DECLARE @MetadataIntegrityIssues TABLE
		(
		[CheckNumber] INT NOT NULL,
		[IssuesFound] VARCHAR(MAX) NOT NULL
		)

	/*
	Checks:
	*/

	--Check 1:
	IF NOT EXISTS
		(
		SELECT 1 FROM [metadata].[Stages] WHERE [Enabled] = 1
		)
		BEGIN
			INSERT INTO @MetadataIntegrityIssues
			VALUES
				( 
				1,
				'No execution stages are enabled within the metadatabase. Orchestrator has nothing to run.'
				)
		END;

	--Check 2:
	IF NOT EXISTS
		(
		SELECT 1 FROM [metadata].[Pipelines] WHERE [Enabled] = 1
		)
		BEGIN
			INSERT INTO @MetadataIntegrityIssues
			VALUES
				( 
				2,
				'No execution pipelines are enabled within the metadatabase. Orchestrator has nothing to run.'
				)
		END;

	--Check 3: Disable ServicePrincipals check as there is no azure function and cross account functions.
	-- IF NOT EXISTS 
	-- 	(
	-- 	SELECT 1 FROM [dbo].[ServicePrincipals]
	-- 	)
	-- 	BEGIN
	-- 		INSERT INTO @MetadataIntegrityIssues
	-- 		VALUES
	-- 			( 
	-- 			3,
	-- 			'No service principal details have been added to the metadata. Orchestrator cannot authorise pipeline executions.'
	-- 			)		
	-- 	END;

	--Check 4:
	IF NOT EXISTS
		(
		SELECT * FROM [metadata].[Tenants]
		)
		BEGIN
			INSERT INTO @MetadataIntegrityIssues
			VALUES
				( 
				4,
				'TenantId value is missing from the [metadata].[Tenants] table.'
				)		
		END;

	--Check 5:
	IF NOT EXISTS
		(
		SELECT * FROM [metadata].[Subscriptions]
		)
		BEGIN
			INSERT INTO @MetadataIntegrityIssues
			VALUES
				( 
				5,
				'SubscriptionId value is missing from the [metadata].[Subscriptions] table.'
				)		
		END;

	--Check 6:
	IF NOT EXISTS
		(
		SELECT * FROM [metadata].[CurrentProperties] WHERE [PropertyName] = 'OverideRestart'
		)
		BEGIN
			INSERT INTO @MetadataIntegrityIssues
			VALUES
				( 
				6,
				'A current OverideRestart value is missing from the properties table.'
				)		
		END;

	--Check 7: Disable PipelineAuthLink check as there is no azure function and cross account functions.
	-- IF EXISTS
	-- 	( 
	-- 	SELECT 
	-- 		* 
	-- 	FROM 
	-- 		[metadata].[Pipelines] p
	-- 		LEFT OUTER JOIN [metadata].[PipelineAuthLink] al
	-- 			ON p.[PipelineId] = al.[PipelineId]
	-- 	WHERE
	-- 		p.[Enabled] = 1
	-- 		AND al.[PipelineId] IS NULL
	-- 	)
	-- 	BEGIN
	-- 		INSERT INTO @MetadataIntegrityIssues
	-- 		VALUES
	-- 			( 
	-- 			7,
	-- 			'Enabled pipelines are missing a valid Service Principal link.'
	-- 			)		
	-- 	END;

	--Check 8:
	IF EXISTS
		(
		SELECT * FROM [metadata].[Orchestrators] WHERE [SubscriptionId] = '12345678-1234-1234-1234-012345678910'
		)
		BEGIN
			INSERT INTO @MetadataIntegrityIssues
			VALUES
				( 
				8,
				'Orchestrator still set to use the default subscription value of 12345678-1234-1234-1234-012345678910.'
				)		
		END;

	--Check 9:
	IF EXISTS
		(
		SELECT * FROM [metadata].[Subscriptions] WHERE [TenantId] = '12345678-1234-1234-1234-012345678910' AND [SubscriptionId] <> '12345678-1234-1234-1234-012345678910'
		)
		BEGIN
			INSERT INTO @MetadataIntegrityIssues
			VALUES
				( 
				9,
				'None default subscription still set to use the default tenant value of 12345678-1234-1234-1234-012345678910.'
				)		
		END;

	--Check 10:
	IF NOT EXISTS
		(
		SELECT * FROM [metadata].[CurrentProperties] WHERE [PropertyName] = 'PipelineStatusCheckDuration'
		)
		BEGIN
			INSERT INTO @MetadataIntegrityIssues
			VALUES
				( 
				10,
				'A current PipelineStatusCheckDuration value is missing from the properties table.'
				)		
		END;

	--Check 11:
	IF NOT EXISTS
		(
		SELECT * FROM [metadata].[CurrentProperties] WHERE [PropertyName] = 'UseFrameworkEmailAlerting'
		)
		BEGIN
			INSERT INTO @MetadataIntegrityIssues
			VALUES
				( 
				11,
				'A current UseFrameworkEmailAlerting value is missing from the properties table.'
				)		
		END;

	--Check 12:
	IF (
		SELECT
			[PropertyValue]
		FROM
			[metadata].[CurrentProperties]
		WHERE
			[PropertyName] = 'UseFrameworkEmailAlerting'
		) = 1
		BEGIN
			IF NOT EXISTS
				(
				SELECT * FROM [metadata].[CurrentProperties] WHERE [PropertyName] = 'EmailAlertBodyTemplate'
				)
				BEGIN
					INSERT INTO @MetadataIntegrityIssues
					VALUES
						( 
						12,
						'A current EmailAlertBodyTemplate value is missing from the properties table.'
						)		
				END;
		END;

	--Check 13:
	IF EXISTS
		(
		SELECT * FROM [metadata].[PipelineParameterDataSizes] WHERE [Size] > 9
		/*
		Azure Function request limit is 10MB.
		https://docs.microsoft.com/en-us/azure/azure-functions/functions-scale
		9MB to allow for other content in execute pipeline body request.
		*/
		)
		BEGIN
			INSERT INTO @MetadataIntegrityIssues
			VALUES
				( 
				13,
				'The pipeline parameters entered exceed the Azure Function request body maximum of 10MB. Query view [metadata].[PipelineParameterDataSizes] for details.'
				)	
		END;

	--Check 14:
	IF NOT EXISTS
		(
		SELECT * FROM [metadata].[CurrentProperties] WHERE [PropertyName] = 'FailureHandling'
		)
		BEGIN
			INSERT INTO @MetadataIntegrityIssues
			VALUES
				( 
				14,
				'A current FailureHandling value is missing from the properties table.'
				)		
		END;

	--Check 15:
	IF NOT EXISTS
		(
		SELECT 
			*
		FROM
			[metadata].[CurrentProperties]
		WHERE 
			[PropertyName] = 'FailureHandling' 
			AND [PropertyValue] IN ('None','Simple','DependencyChain')
		)
		BEGIN
			INSERT INTO @MetadataIntegrityIssues
			VALUES
				( 
				15,
				'The property FailureHandling does not have a supported value.'
				)	
		END;

	--Check 16:
	IF ([metadata].[GetPropertyValueInternal]('FailureHandling')) = 'DependencyChain'
	BEGIN
		IF EXISTS
		(
		SELECT 
			pd.[DependencyId]
		FROM 
			[metadata].[PipelineDependencies] pd
			INNER JOIN [metadata].[Pipelines] pp
				ON pd.[PipelineId] = pp.[PipelineId]
			INNER JOIN [metadata].[Pipelines] dp
				ON pd.[DependantPipelineId] = dp.[PipelineId]
		WHERE
			pp.[StageId] = dp.[StageId]
		)	
		BEGIN
			INSERT INTO @MetadataIntegrityIssues
			VALUES
				( 
				16,
				'A dependant pipeline and its upstream predecessor exist in the same execution stage. Fix this dependency chain to allow correct failure handling.'
				)	
		END;
	END;

	--Check 17:
	IF NOT EXISTS
		(
		SELECT 
			*
		FROM
			[metadata].[CurrentProperties]
		WHERE 
			[PropertyName] = 'SPNHandlingMethod' 
			AND [PropertyValue] IN ('StoreInDatabase','StoreInKeyVault')
		)
		BEGIN
			INSERT INTO @MetadataIntegrityIssues
			VALUES
				( 
				17,
				'The property SPNHandlingMethod does not have a supported value.'
				)	
		END;

	--Check 18:
	IF EXISTS
		(
		SELECT
			*
		FROM
			[dbo].[ServicePrincipals]
		WHERE
			(
			[PrincipalId] IS NOT NULL
			OR [PrincipalSecret] IS NOT NULL
			)
			AND 
			(
			[PrincipalIdUrl] IS NOT NULL
			OR [PrincipalSecretUrl] IS NOT NULL
			)
		)
		BEGIN
			INSERT INTO @MetadataIntegrityIssues
			VALUES
				( 
				18,
				'The table [dbo].[ServicePrincipals] can only have one method of SPN details sorted per credential ID.'
				)	
		END;
	
	--Check 19:
	IF NOT EXISTS
		(
		SELECT * FROM [metadata].[CurrentProperties] WHERE [PropertyName] = 'UseExecutionBatches'
		)
		BEGIN
			INSERT INTO @MetadataIntegrityIssues
			VALUES
				( 
				19,
				'A current UseExecutionBatches value is missing from the properties table.'
				)		
		END;

	--Check 20:
	IF NOT EXISTS
		(
		SELECT * FROM [metadata].[CurrentProperties] WHERE [PropertyName] = 'FrameworkFactoryResourceGroup'
		)
		BEGIN
			INSERT INTO @MetadataIntegrityIssues
			VALUES
				( 
				20,
				'A current FrameworkFactoryResourceGroup value is missing from the properties table.'
				)		
		END;

	--Check 21:
	IF NOT EXISTS
		(
		SELECT * FROM [metadata].[CurrentProperties] WHERE [PropertyName] = 'PreviousPipelineRunsQueryRange'
		)
		BEGIN
			INSERT INTO @MetadataIntegrityIssues
			VALUES
				( 
				21,
				'A current PreviousPipelineRunsQueryRange value is missing from the properties table.'
				)		
		END;

	--batch execution checks
	IF ([metadata].[GetPropertyValueInternal]('UseExecutionBatches')) = '1'
		BEGIN			
			IF @BatchName IS NULL
				BEGIN
					RAISERROR('A NULL batch name cannot be passed when the UseExecutionBatches property is set to 1 (true).',16,1);
					RETURN 0;
				END

			SELECT 
				@BatchId = [BatchId]
			FROM
				[metadata].[Batches]
			WHERE
				[BatchName] = @BatchName;

			--Check 22:
			IF EXISTS
				(
				SELECT 1 FROM [metadata].[Batches] WHERE [BatchId] = @BatchId AND [Enabled] = 0
				)
				BEGIN
					INSERT INTO @MetadataIntegrityIssues
					VALUES
						( 
						22,
						'The requested execution batch is currently disabled. Enable the batch before proceeding.'
						)
				END;

			--Check 23:
			IF NOT EXISTS
				(
				SELECT 1 FROM [metadata].[BatchStageLink] WHERE [BatchId] = @BatchId
				)
				BEGIN
					INSERT INTO @MetadataIntegrityIssues
					VALUES
						( 
						23,
						'The requested execution batch does not have any linked execution stages. See table [metadata].[BatchStageLink] for details.'
						)
				END;

			--Check 24:
			IF EXISTS
				(
				SELECT
					*
				FROM
					[metadata].[CurrentExecution] c
					LEFT OUTER JOIN [metadata].[BatchExecution] b
						ON c.[LocalExecutionId] = b.[ExecutionId]
				WHERE
					b.[ExecutionId] IS NULL
				)
				BEGIN
					INSERT INTO @MetadataIntegrityIssues
					VALUES
						( 
						24,
						'Execution records exist in the [metadata].[CurrentExecution] table that do not have a record in [metadata].[BatchExecution] table. Has batch excutions been enabed after an incomplete none batch run?'
						)
				END;			
		END; --end batch checks
	
	--Check 25: 
	IF EXISTS
		(
		SELECT 1 FROM [metadata].[CurrentExecution] WHERE [PipelineStatus] = 'InvalidPipelineNameError'
		)
		BEGIN
			UPDATE
				ce
			SET
				ce.[PipelineName] = p.[PipelineName]
			FROM
				[metadata].[CurrentExecution] ce
				INNER JOIN [metadata].[Pipelines] p
					ON ce.[PipelineId] = p.[PipelineId]
						AND ce.[StageId] = p.[StageId]
			WHERE
				ce.[PipelineStatus] = 'InvalidPipelineNameError'
		END;
	
	--Check 26:
	IF (SELECT COUNT(0) FROM [metadata].[Orchestrators] WHERE [IsFrameworkOrchestrator] = 1) > 1
	BEGIN
		INSERT INTO @MetadataIntegrityIssues
		VALUES
			( 
			26,
			'There is more than one FrameworkOrchestrator set in the table [metadata].[Orchestrators]. Only one is supported.'
			)		
	END

	--Check 27:
	IF NOT EXISTS
		(
		SELECT 1 FROM [metadata].[Orchestrators] WHERE [IsFrameworkOrchestrator] = 1
		)
		BEGIN
			INSERT INTO @MetadataIntegrityIssues
			VALUES
				( 
				27,
				'A FrameworkOrchestrator has not been set in the table [metadata].[Orchestrators]. Only one is supported.'
				)		
		END

	/*
	Integrity Checks Outcome:
	*/
	
	--throw runtime error if checks fail
	IF EXISTS
		(
		SELECT * FROM @MetadataIntegrityIssues
		)
		AND @DebugMode = 0
		BEGIN
			SET @ErrorDetails = 'Metadata integrity checks failed. Run EXEC [metadata].[CheckMetadataIntegrity] @DebugMode = 1; for details.'

			RAISERROR(@ErrorDetails, 16, 1);
			RETURN 0;
		END;

	--report issues when in debug mode
	IF @DebugMode = 1
	BEGIN
		IF NOT EXISTS
			(
			SELECT * FROM @MetadataIntegrityIssues
			)
			BEGIN
				PRINT 'No data integrity issues found in metadata.'
				RETURN 0;
			END
		ELSE		
			BEGIN
				SELECT * FROM @MetadataIntegrityIssues;
			END;
	END;
END;]]></Value>
			</Property>
			<Property Name="IsAnsiNullsOn" Value="True" />
			<Relationship Name="BodyDependencies">
				<Entry>
					<References ExternalSource="BuiltIns" Name="[uniqueidentifier]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[varchar]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[Stages]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[Stages].[Enabled]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[Pipelines]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[Pipelines].[Enabled]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[Tenants]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[Subscriptions]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[CurrentProperties]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[CurrentProperties].[PropertyName]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[Orchestrators]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[Orchestrators].[SubscriptionId]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[Subscriptions].[TenantId]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[Subscriptions].[SubscriptionId]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[CurrentProperties].[PropertyValue]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[PipelineParameterDataSizes]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[PipelineParameterDataSizes].[Size]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[GetPropertyValueInternal]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[PipelineDependencies]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[PipelineDependencies].[PipelineId]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[Pipelines].[PipelineId]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[PipelineDependencies].[DependantPipelineId]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[Pipelines].[PipelineId]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[PipelineDependencies].[DependencyId]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[Pipelines].[StageId]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[Pipelines].[StageId]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[ServicePrincipals]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[ServicePrincipals].[PrincipalId]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[ServicePrincipals].[PrincipalSecret]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[ServicePrincipals].[PrincipalIdUrl]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[ServicePrincipals].[PrincipalSecretUrl]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[CheckMetadataIntegrity].[@BatchName]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[Batches]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[Batches].[BatchId]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[Batches].[BatchName]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[Batches].[BatchId]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[Batches].[Enabled]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[BatchStageLink]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[BatchStageLink].[BatchId]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[CurrentExecution]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[BatchExecution]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[CurrentExecution].[LocalExecutionId]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[BatchExecution].[ExecutionId]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[CurrentExecution].[PipelineStatus]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[CurrentExecution].[PipelineId]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[Pipelines].[PipelineId]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[CurrentExecution].[StageId]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[Pipelines].[StageId]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[CurrentExecution].[PipelineName]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[Pipelines].[PipelineName]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[CurrentExecution].[PipelineStatus]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[Orchestrators].[IsFrameworkOrchestrator]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[CheckMetadataIntegrity].[@DebugMode]" />
				</Entry>
			</Relationship>
			<Relationship Name="DynamicObjects">
				<Entry>
					<Element Type="SqlDynamicColumnSource" Name="[metadata].[CheckMetadataIntegrity].[@MetadataIntegrityIssues]">
						<Relationship Name="Columns">
							<Entry>
								<Element Type="SqlSimpleColumn" Name="[metadata].[CheckMetadataIntegrity].[@MetadataIntegrityIssues].[CheckNumber]">
									<Property Name="IsNullable" Value="False" />
									<Relationship Name="TypeSpecifier">
										<Entry>
											<Element Type="SqlTypeSpecifier">
												<Relationship Name="Type">
													<Entry>
														<References ExternalSource="BuiltIns" Name="[int]" />
													</Entry>
												</Relationship>
											</Element>
										</Entry>
									</Relationship>
								</Element>
							</Entry>
							<Entry>
								<Element Type="SqlSimpleColumn" Name="[metadata].[CheckMetadataIntegrity].[@MetadataIntegrityIssues].[IssuesFound]">
									<Property Name="IsNullable" Value="False" />
									<Relationship Name="TypeSpecifier">
										<Entry>
											<Element Type="SqlTypeSpecifier">
												<Property Name="IsMax" Value="True" />
												<Relationship Name="Type">
													<Entry>
														<References ExternalSource="BuiltIns" Name="[varchar]" />
													</Entry>
												</Relationship>
											</Element>
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
			</Relationship>
			<Relationship Name="Parameters">
				<Entry>
					<Element Type="SqlSubroutineParameter" Name="[metadata].[CheckMetadataIntegrity].[@DebugMode]">
						<Property Name="DefaultExpressionScript">
							<Value><![CDATA[0]]></Value>
						</Property>
						<Relationship Name="Type">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[bit]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlSubroutineParameter" Name="[metadata].[CheckMetadataIntegrity].[@BatchName]">
						<Property Name="DefaultExpressionScript">
							<Value><![CDATA[NULL]]></Value>
						</Property>
						<Relationship Name="Type">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Property Name="Length" Value="255" />
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[varchar]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
			</Relationship>
			<Relationship Name="Schema">
				<Entry>
					<References Name="[metadata]" />
				</Entry>
			</Relationship>
			<Annotation Type="SysCommentsObjectAnnotation">
				<Property Name="Length" Value="14181" />
				<Property Name="StartLine" Value="1" />
				<Property Name="StartColumn" Value="1" />
				<Property Name="HeaderContents" Value="CREATE PROCEDURE [metadata].[CheckMetadataIntegrity]&#xD;&#xA;&#x9;(&#xD;&#xA;&#x9;@DebugMode BIT = 0,&#xD;&#xA;&#x9;@BatchName VARCHAR(255) = NULL&#xD;&#xA;&#x9;)&#xD;&#xA;AS" />
			</Annotation>
		</Element>
		<Element Type="SqlProcedure" Name="[metadata].[CheckPreviousExeuction]">
			<Property Name="BodyScript">
				<Value><![CDATA[
BEGIN
	SET NOCOUNT ON;
	/*
	Check A: - Are there any Running pipelines that need to be cleaned up?
	*/

	DECLARE @BatchId UNIQUEIDENTIFIER
	DECLARE @LocalExecutionId UNIQUEIDENTIFIER

	--Check A:
	IF ([metadata].[GetPropertyValueInternal]('UseExecutionBatches')) = '0'
		BEGIN
			IF EXISTS
				(
				SELECT 
					1 
				FROM 
					[metadata].[CurrentExecution]
				WHERE 
					[PipelineStatus] NOT IN ('Success','Failed','Blocked', 'Cancelled') 
					AND [PipelineRunId] IS NOT NULL
				)
				BEGIN
					--return pipelines details that require a clean up
					SELECT 
						[ResourceGroupName],
						[OrchestratorType],
						[OrchestratorName],
						[PipelineName],
						[PipelineRunId],
						[LocalExecutionId],
						[StageId],
						[PipelineId]
					FROM 
						[metadata].[CurrentExecution]
					WHERE 
						[PipelineStatus] NOT IN ('Success','Failed','Blocked','Cancelled') 
						AND [PipelineRunId] IS NOT NULL
				END;
			ELSE
				GOTO LookUpReturnEmptyResult;
		END
	ELSE IF ([metadata].[GetPropertyValueInternal]('UseExecutionBatches')) = '1'
		BEGIN
			IF @BatchName IS NULL
				BEGIN
					RAISERROR('A NULL batch name cannot be passed when the UseExecutionBatches property is set to 1 (true).',16,1);
					RETURN 0;
				END
			
			IF EXISTS
				(
				SELECT 
					1 
				FROM 
					[metadata].[CurrentExecution] ce
					INNER JOIN [metadata].[BatchExecution] be
						ON ce.[LocalExecutionId] = be.[ExecutionId]
					INNER JOIN [metadata].[Batches] b
						ON be.[BatchId] = b.[BatchId]
				WHERE 
					b.[BatchName] = @BatchName
					AND ce.[PipelineStatus] NOT IN ('Success','Failed','Blocked','Cancelled') 
					AND ce.[PipelineRunId] IS NOT NULL
				)
				BEGIN
					--return pipelines details that require a clean up
					SELECT 
						ce.[ResourceGroupName],
						ce.[OrchestratorType],
						ce.[OrchestratorName],
						ce.[PipelineName],
						ce.[PipelineRunId],
						ce.[LocalExecutionId],
						ce.[StageId],
						ce.[PipelineId]
					FROM 
						[metadata].[CurrentExecution] ce
						INNER JOIN [metadata].[BatchExecution] be
							ON ce.[LocalExecutionId] = be.[ExecutionId]
						INNER JOIN [metadata].[Batches] b
							ON be.[BatchId] = b.[BatchId]
					WHERE 
						b.[BatchName] = @BatchName
						AND ce.[PipelineStatus] NOT IN ('Success','Failed','Blocked','Cancelled') 
						AND ce.[PipelineRunId] IS NOT NULL
				END;
			ELSE
				GOTO LookUpReturnEmptyResult;
		END
	
	LookUpReturnEmptyResult:
	--lookup activity must return something, even if just an empty dataset
	SELECT 
		NULL AS ResourceGroupName,
		NULL AS OrchestratorType,
		NULL AS OrchestratorName,
		NULL AS PipelineName,
		NULL AS PipelineRunId,
		NULL AS LocalExecutionId,
		NULL AS StageId,
		NULL AS PipelineId
	FROM
		[metadata].[CurrentExecution]
	WHERE
		1 = 2; --ensure no results
END;]]></Value>
			</Property>
			<Property Name="IsAnsiNullsOn" Value="True" />
			<Relationship Name="BodyDependencies">
				<Entry>
					<References ExternalSource="BuiltIns" Name="[uniqueidentifier]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[uniqueidentifier]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[GetPropertyValueInternal]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[CurrentExecution]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[CurrentExecution].[PipelineStatus]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[CurrentExecution].[PipelineRunId]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[CurrentExecution].[ResourceGroupName]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[CurrentExecution].[OrchestratorType]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[CurrentExecution].[OrchestratorName]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[CurrentExecution].[PipelineName]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[CurrentExecution].[PipelineRunId]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[CurrentExecution].[LocalExecutionId]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[CurrentExecution].[StageId]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[CurrentExecution].[PipelineId]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[CurrentExecution].[PipelineStatus]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[CheckPreviousExeuction].[@BatchName]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[BatchExecution]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[CurrentExecution].[LocalExecutionId]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[BatchExecution].[ExecutionId]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[Batches]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[BatchExecution].[BatchId]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[Batches].[BatchId]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[Batches].[BatchName]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[CurrentExecution].[PipelineStatus]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[CurrentExecution].[PipelineRunId]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[CurrentExecution].[LocalExecutionId]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[BatchExecution].[ExecutionId]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[BatchExecution].[BatchId]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[Batches].[BatchId]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[CurrentExecution].[ResourceGroupName]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[CurrentExecution].[OrchestratorType]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[CurrentExecution].[OrchestratorName]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[CurrentExecution].[PipelineName]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[CurrentExecution].[PipelineRunId]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[CurrentExecution].[LocalExecutionId]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[CurrentExecution].[StageId]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[CurrentExecution].[PipelineId]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[Batches].[BatchName]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[CurrentExecution].[PipelineStatus]" />
				</Entry>
			</Relationship>
			<Relationship Name="Parameters">
				<Entry>
					<Element Type="SqlSubroutineParameter" Name="[metadata].[CheckPreviousExeuction].[@BatchName]">
						<Property Name="DefaultExpressionScript">
							<Value><![CDATA[NULL]]></Value>
						</Property>
						<Relationship Name="Type">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Property Name="Length" Value="255" />
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[varchar]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
			</Relationship>
			<Relationship Name="Schema">
				<Entry>
					<References Name="[metadata]" />
				</Entry>
			</Relationship>
			<Annotation Type="SysCommentsObjectAnnotation">
				<Property Name="Length" Value="3008" />
				<Property Name="StartLine" Value="1" />
				<Property Name="StartColumn" Value="1" />
				<Property Name="HeaderContents" Value="CREATE PROCEDURE [metadata].[CheckPreviousExeuction]&#xD;&#xA;&#x9;(&#xD;&#xA;&#x9;@BatchName VARCHAR(255) = NULL&#xD;&#xA;&#x9;)&#xD;&#xA;AS" />
			</Annotation>
		</Element>
		<Element Type="SqlSynonym" Name="[metadata].[CheckStageAndPiplineIntegrity]">
			<Property Name="ForObjectScript">
				<Value><![CDATA[[metadataHelpers].[CheckStageAndPiplineIntegrity]]]></Value>
			</Property>
			<Relationship Name="ForObject">
				<Entry>
					<References Name="[metadataHelpers].[CheckStageAndPiplineIntegrity]" />
					<Annotation Type="PersistedResolvableAnnotation" Name="[metadataHelpers].[CheckStageAndPiplineIntegrity]">
						<Property Name="TargetTypeStorage" Value="ISqlSynonymTarget" />
						<Property Name="Length" Value="49" />
						<Property Name="Offset" Value="63" />
					</Annotation>
				</Entry>
			</Relationship>
			<Relationship Name="Schema">
				<Entry>
					<References Name="[metadata]" />
				</Entry>
			</Relationship>
		</Element>
		<Element Type="SqlSynonym" Name="[metadata].[CompleteExecutionErrorLog]">
			<Property Name="ForObjectScript">
				<Value><![CDATA[[metadataReporting].[CompleteExecutionErrorLog]]]></Value>
			</Property>
			<Relationship Name="ForObject">
				<Entry>
					<References Name="[metadataReporting].[CompleteExecutionErrorLog]" />
					<Annotation Type="PersistedResolvableAnnotation" Name="[metadataReporting].[CompleteExecutionErrorLog]">
						<Property Name="TargetTypeStorage" Value="ISqlSynonymTarget" />
						<Property Name="Length" Value="47" />
						<Property Name="Offset" Value="59" />
					</Annotation>
				</Entry>
			</Relationship>
			<Relationship Name="Schema">
				<Entry>
					<References Name="[metadata]" />
				</Entry>
			</Relationship>
		</Element>
		<Element Type="SqlSynonym" Name="[metadata].[CompleteExecutionLog]">
			<Property Name="ForObjectScript">
				<Value><![CDATA[[metadataReporting].[CompleteExecutionLog]]]></Value>
			</Property>
			<Relationship Name="ForObject">
				<Entry>
					<References Name="[metadataReporting].[CompleteExecutionLog]" />
					<Annotation Type="PersistedResolvableAnnotation" Name="[metadataReporting].[CompleteExecutionLog]">
						<Property Name="TargetTypeStorage" Value="ISqlSynonymTarget" />
						<Property Name="Length" Value="42" />
						<Property Name="Offset" Value="54" />
					</Annotation>
				</Entry>
			</Relationship>
			<Relationship Name="Schema">
				<Entry>
					<References Name="[metadata]" />
				</Entry>
			</Relationship>
		</Element>
		<Element Type="SqlProcedure" Name="[metadata].[CreateNewExecution]">
			<Property Name="BodyScript">
				<Value><![CDATA[
BEGIN
	SET NOCOUNT ON;

	DECLARE @BatchId UNIQUEIDENTIFIER;

	IF([metadata].[GetPropertyValueInternal]('UseExecutionBatches')) = '0'
		BEGIN
			SET @LocalExecutionId = NEWID();

			TRUNCATE TABLE [metadata].[CurrentExecution];

			--defensive check
			IF NOT EXISTS
				(
				SELECT
					1
				FROM
					[metadata].[Pipelines] p
					INNER JOIN [metadata].[Stages] s
						ON p.[StageId] = s.[StageId]
					INNER JOIN [metadata].[Orchestrators] d
						ON p.[OrchestratorId] = d.[OrchestratorId]
				WHERE
					p.[Enabled] = 1
					AND s.[Enabled] = 1
				)
				BEGIN
					RAISERROR('Requested execution run does not contain any enabled stages/pipelines.',16,1);
					RETURN 0;
				END;

			INSERT INTO [metadata].[CurrentExecution]
				(
				[LocalExecutionId],
				[StageId],
				[PipelineId],
				[CallingOrchestratorName],
				[ResourceGroupName],
				[OrchestratorType],
				[OrchestratorName],
				[PipelineName]
				)
			SELECT
				@LocalExecutionId,
				p.[StageId],
				p.[PipelineId],
				@CallingOrchestratorName,
				d.[ResourceGroupName],
				d.[OrchestratorType],
				d.[OrchestratorName],
				p.[PipelineName]
			FROM
				[metadata].[Pipelines] p
				INNER JOIN [metadata].[Stages] s
					ON p.[StageId] = s.[StageId]
				INNER JOIN [metadata].[Orchestrators] d
					ON p.[OrchestratorId] = d.[OrchestratorId]
			WHERE
				p.[Enabled] = 1
				AND s.[Enabled] = 1;

			SELECT
				@LocalExecutionId AS ExecutionId;
		END
	ELSE IF ([metadata].[GetPropertyValueInternal]('UseExecutionBatches')) = '1'
		BEGIN
			DELETE FROM 
				[metadata].[CurrentExecution]
			WHERE
				[LocalExecutionId] = @LocalExecutionId;

			SELECT
				@BatchId = [BatchId]
			FROM
				[metadata].[BatchExecution]
			WHERE
				[ExecutionId] = @LocalExecutionId;
			
			--defensive check
			IF NOT EXISTS
				(
				SELECT
					1
				FROM
					[metadata].[Pipelines] p
					INNER JOIN [metadata].[Stages] s
						ON p.[StageId] = s.[StageId]
					INNER JOIN [metadata].[Orchestrators] d
						ON p.[OrchestratorId] = d.[OrchestratorId]
					INNER JOIN [metadata].[BatchStageLink] b
						ON b.[StageId] = s.[StageId]
				WHERE
					b.[BatchId] = @BatchId
					AND p.[Enabled] = 1
					AND s.[Enabled] = 1
				)
				BEGIN
					RAISERROR('Requested execution run does not contain any enabled stages/pipelines.',16,1);
					RETURN 0;
				END;

			INSERT INTO [metadata].[CurrentExecution]
				(
				[LocalExecutionId],
				[StageId],
				[PipelineId],
				[CallingOrchestratorName],
				[ResourceGroupName],
				[OrchestratorType],
				[OrchestratorName],
				[PipelineName]
				)
			SELECT
				@LocalExecutionId,
				p.[StageId],
				p.[PipelineId],
				@CallingOrchestratorName,
				d.[ResourceGroupName],
				d.[OrchestratorType],
				d.[OrchestratorName],
				p.[PipelineName]
			FROM
				[metadata].[Pipelines] p
				INNER JOIN [metadata].[Stages] s
					ON p.[StageId] = s.[StageId]
				INNER JOIN [metadata].[Orchestrators] d
					ON p.[OrchestratorId] = d.[OrchestratorId]
				INNER JOIN [metadata].[BatchStageLink] b
					ON b.[StageId] = s.[StageId]
			WHERE
				b.[BatchId] = @BatchId
				AND p.[Enabled] = 1
				AND s.[Enabled] = 1;
				
			SELECT
				@LocalExecutionId AS ExecutionId;
		END;

	ALTER INDEX [IDX_GetPipelinesInStage] ON [metadata].[CurrentExecution]
	REBUILD;
END;]]></Value>
			</Property>
			<Property Name="IsAnsiNullsOn" Value="True" />
			<Relationship Name="BodyDependencies">
				<Entry>
					<References ExternalSource="BuiltIns" Name="[uniqueidentifier]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[GetPropertyValueInternal]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[CreateNewExecution].[@LocalExecutionId]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[CurrentExecution]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[Pipelines]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[Stages]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[Pipelines].[StageId]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[Stages].[StageId]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[Orchestrators]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[Pipelines].[OrchestratorId]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[Orchestrators].[OrchestratorId]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[Pipelines].[Enabled]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[Stages].[Enabled]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[CurrentExecution].[LocalExecutionId]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[CurrentExecution].[StageId]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[CurrentExecution].[PipelineId]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[CurrentExecution].[CallingOrchestratorName]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[CurrentExecution].[ResourceGroupName]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[CurrentExecution].[OrchestratorType]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[CurrentExecution].[OrchestratorName]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[CurrentExecution].[PipelineName]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[Pipelines].[StageId]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[Stages].[StageId]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[Pipelines].[OrchestratorId]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[Orchestrators].[OrchestratorId]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[Pipelines].[StageId]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[Pipelines].[PipelineId]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[CreateNewExecution].[@CallingOrchestratorName]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[Orchestrators].[ResourceGroupName]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[Orchestrators].[OrchestratorType]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[Orchestrators].[OrchestratorName]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[Pipelines].[PipelineName]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[Pipelines].[Enabled]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[Stages].[Enabled]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[BatchExecution]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[BatchExecution].[BatchId]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[BatchExecution].[ExecutionId]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[BatchStageLink]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[BatchStageLink].[StageId]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[Stages].[StageId]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[BatchStageLink].[BatchId]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[Pipelines].[Enabled]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[Stages].[Enabled]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[BatchStageLink].[StageId]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[Stages].[StageId]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[Pipelines].[StageId]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[Pipelines].[PipelineId]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[Orchestrators].[ResourceGroupName]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[Orchestrators].[OrchestratorType]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[Orchestrators].[OrchestratorName]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[Pipelines].[PipelineName]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[BatchStageLink].[BatchId]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[Pipelines].[Enabled]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[Stages].[Enabled]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[CurrentExecution].[IDX_GetPipelinesInStage]" />
				</Entry>
			</Relationship>
			<Relationship Name="Parameters">
				<Entry>
					<Element Type="SqlSubroutineParameter" Name="[metadata].[CreateNewExecution].[@CallingOrchestratorName]">
						<Relationship Name="Type">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Property Name="Length" Value="200" />
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[nvarchar]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlSubroutineParameter" Name="[metadata].[CreateNewExecution].[@LocalExecutionId]">
						<Property Name="DefaultExpressionScript">
							<Value><![CDATA[NULL]]></Value>
						</Property>
						<Relationship Name="Type">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[uniqueidentifier]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
			</Relationship>
			<Relationship Name="Schema">
				<Entry>
					<References Name="[metadata]" />
				</Entry>
			</Relationship>
			<Annotation Type="SysCommentsObjectAnnotation">
				<Property Name="Length" Value="3560" />
				<Property Name="StartLine" Value="1" />
				<Property Name="StartColumn" Value="1" />
				<Property Name="HeaderContents" Value="CREATE PROCEDURE [metadata].[CreateNewExecution]&#xD;&#xA;&#x9;(&#xD;&#xA;&#x9;@CallingOrchestratorName NVARCHAR(200),&#xD;&#xA;&#x9;@LocalExecutionId UNIQUEIDENTIFIER = NULL&#xD;&#xA;&#x9;)&#xD;&#xA;AS" />
			</Annotation>
		</Element>
		<Element Type="SqlTable" Name="[metadata].[CurrentExecution]">
			<Property Name="IsAnsiNullsOn" Value="True" />
			<Relationship Name="Columns">
				<Entry>
					<Element Type="SqlSimpleColumn" Name="[metadata].[CurrentExecution].[LocalExecutionId]">
						<Property Name="IsNullable" Value="False" />
						<Relationship Name="TypeSpecifier">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[uniqueidentifier]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlSimpleColumn" Name="[metadata].[CurrentExecution].[StageId]">
						<Property Name="IsNullable" Value="False" />
						<Relationship Name="TypeSpecifier">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[int]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlSimpleColumn" Name="[metadata].[CurrentExecution].[PipelineId]">
						<Property Name="IsNullable" Value="False" />
						<Relationship Name="TypeSpecifier">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[int]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlSimpleColumn" Name="[metadata].[CurrentExecution].[CallingOrchestratorName]">
						<Property Name="IsNullable" Value="False" />
						<Relationship Name="TypeSpecifier">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Property Name="Length" Value="200" />
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[nvarchar]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlSimpleColumn" Name="[metadata].[CurrentExecution].[ResourceGroupName]">
						<Property Name="IsNullable" Value="False" />
						<Relationship Name="TypeSpecifier">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Property Name="Length" Value="200" />
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[nvarchar]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlSimpleColumn" Name="[metadata].[CurrentExecution].[OrchestratorType]">
						<Property Name="IsNullable" Value="False" />
						<Relationship Name="TypeSpecifier">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Property Name="Length" Value="3" />
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[char]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlSimpleColumn" Name="[metadata].[CurrentExecution].[OrchestratorName]">
						<Property Name="IsNullable" Value="False" />
						<Relationship Name="TypeSpecifier">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Property Name="Length" Value="200" />
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[nvarchar]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlSimpleColumn" Name="[metadata].[CurrentExecution].[PipelineName]">
						<Property Name="IsNullable" Value="False" />
						<Relationship Name="TypeSpecifier">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Property Name="Length" Value="200" />
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[nvarchar]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlSimpleColumn" Name="[metadata].[CurrentExecution].[StartDateTime]">
						<Relationship Name="TypeSpecifier">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[datetime]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlSimpleColumn" Name="[metadata].[CurrentExecution].[PipelineStatus]">
						<Relationship Name="TypeSpecifier">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Property Name="Length" Value="200" />
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[nvarchar]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlSimpleColumn" Name="[metadata].[CurrentExecution].[LastStatusCheckDateTime]">
						<Relationship Name="TypeSpecifier">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[datetime]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlSimpleColumn" Name="[metadata].[CurrentExecution].[EndDateTime]">
						<Relationship Name="TypeSpecifier">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[datetime]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlSimpleColumn" Name="[metadata].[CurrentExecution].[IsBlocked]">
						<Property Name="IsNullable" Value="False" />
						<Relationship Name="TypeSpecifier">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[bit]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
						<AttachedAnnotation Disambiguator="14" />
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlSimpleColumn" Name="[metadata].[CurrentExecution].[PipelineRunId]">
						<Relationship Name="TypeSpecifier">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[uniqueidentifier]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlSimpleColumn" Name="[metadata].[CurrentExecution].[PipelineParamsUsed]">
						<Relationship Name="TypeSpecifier">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Property Name="IsMax" Value="True" />
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[nvarchar]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
			</Relationship>
			<Relationship Name="Schema">
				<Entry>
					<References Name="[metadata]" />
				</Entry>
			</Relationship>
			<Annotation Type="SqlInlineConstraintAnnotation" Disambiguator="24" />
		</Element>
		<Element Type="SqlIndex" Name="[metadata].[CurrentExecution].[IDX_GetPipelinesInStage]">
			<Relationship Name="ColumnSpecifications">
				<Entry>
					<Element Type="SqlIndexedColumnSpecification">
						<Relationship Name="Column">
							<Entry>
								<References Name="[metadata].[CurrentExecution].[LocalExecutionId]" />
							</Entry>
						</Relationship>
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlIndexedColumnSpecification">
						<Relationship Name="Column">
							<Entry>
								<References Name="[metadata].[CurrentExecution].[StageId]" />
							</Entry>
						</Relationship>
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlIndexedColumnSpecification">
						<Relationship Name="Column">
							<Entry>
								<References Name="[metadata].[CurrentExecution].[PipelineStatus]" />
							</Entry>
						</Relationship>
					</Element>
				</Entry>
			</Relationship>
			<Relationship Name="IncludedColumns">
				<Entry>
					<References Name="[metadata].[CurrentExecution].[PipelineId]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[CurrentExecution].[PipelineName]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[CurrentExecution].[OrchestratorType]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[CurrentExecution].[OrchestratorName]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[CurrentExecution].[ResourceGroupName]" />
				</Entry>
			</Relationship>
			<Relationship Name="IndexedObject">
				<Entry>
					<References Name="[metadata].[CurrentExecution]" />
				</Entry>
			</Relationship>
		</Element>
		<Element Type="SqlSynonym" Name="[metadata].[CurrentExecutionSummary]">
			<Property Name="ForObjectScript">
				<Value><![CDATA[[metadataReporting].[CurrentExecutionSummary]]]></Value>
			</Property>
			<Relationship Name="ForObject">
				<Entry>
					<References Name="[metadataReporting].[CurrentExecutionSummary]" />
					<Annotation Type="PersistedResolvableAnnotation" Name="[metadataReporting].[CurrentExecutionSummary]">
						<Property Name="TargetTypeStorage" Value="ISqlSynonymTarget" />
						<Property Name="Length" Value="45" />
						<Property Name="Offset" Value="57" />
					</Annotation>
				</Entry>
			</Relationship>
			<Relationship Name="Schema">
				<Entry>
					<References Name="[metadata]" />
				</Entry>
			</Relationship>
		</Element>
		<Element Type="SqlView" Name="[metadata].[CurrentProperties]">
			<Property Name="QueryScript">
				<Value><![CDATA[

SELECT
	[PropertyName],
	[PropertyValue]
FROM
	[metadata].[Properties]
WHERE
	[ValidTo] IS NULL]]></Value>
			</Property>
			<Property Name="IsAnsiNullsOn" Value="True" />
			<Relationship Name="Columns">
				<Entry>
					<Element Type="SqlComputedColumn" Name="[metadata].[CurrentProperties].[PropertyName]">
						<Relationship Name="ExpressionDependencies">
							<Entry>
								<References Name="[metadata].[Properties].[PropertyName]" />
							</Entry>
						</Relationship>
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlComputedColumn" Name="[metadata].[CurrentProperties].[PropertyValue]">
						<Relationship Name="ExpressionDependencies">
							<Entry>
								<References Name="[metadata].[Properties].[PropertyValue]" />
							</Entry>
						</Relationship>
					</Element>
				</Entry>
			</Relationship>
			<Relationship Name="QueryDependencies">
				<Entry>
					<References Name="[metadata].[Properties]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[Properties].[PropertyName]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[Properties].[PropertyValue]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[Properties].[ValidTo]" />
				</Entry>
			</Relationship>
			<Relationship Name="Schema">
				<Entry>
					<References Name="[metadata]" />
				</Entry>
			</Relationship>
			<Annotation Type="SysCommentsObjectAnnotation">
				<Property Name="Length" Value="152" />
				<Property Name="StartLine" Value="1" />
				<Property Name="StartColumn" Value="1" />
				<Property Name="HeaderContents" Value="CREATE VIEW [metadata].[CurrentProperties]&#xD;&#xA;AS" />
				<Property Name="FooterContents" Value=";" />
			</Annotation>
		</Element>
		<Element Type="SqlSynonym" Name="[metadata].[DataFactoryDetails]">
			<Property Name="ForObjectScript">
				<Value><![CDATA[[metadata].[Orchestrators]]]></Value>
			</Property>
			<Relationship Name="ForObject">
				<Entry>
					<References Name="[metadata].[Orchestrators]" />
					<Annotation Type="PersistedResolvableAnnotation" Name="[metadata].[Orchestrators]">
						<Property Name="TargetTypeStorage" Value="ISqlSynonymTarget" />
						<Property Name="Length" Value="26" />
						<Property Name="Offset" Value="52" />
					</Annotation>
				</Entry>
			</Relationship>
			<Relationship Name="Schema">
				<Entry>
					<References Name="[metadata]" />
				</Entry>
			</Relationship>
		</Element>
		<Element Type="SqlSynonym" Name="[metadata].[DeleteRecipientAlerts]">
			<Property Name="ForObjectScript">
				<Value><![CDATA[[metadataHelpers].[DeleteRecipientAlerts]]]></Value>
			</Property>
			<Relationship Name="ForObject">
				<Entry>
					<References Name="[metadataHelpers].[DeleteRecipientAlerts]" />
					<Annotation Type="PersistedResolvableAnnotation" Name="[metadataHelpers].[DeleteRecipientAlerts]">
						<Property Name="TargetTypeStorage" Value="ISqlSynonymTarget" />
						<Property Name="Length" Value="41" />
						<Property Name="Offset" Value="55" />
					</Annotation>
				</Entry>
			</Relationship>
			<Relationship Name="Schema">
				<Entry>
					<References Name="[metadata]" />
				</Entry>
			</Relationship>
		</Element>
		<Element Type="SqlSynonym" Name="[metadata].[DeleteServicePrincipal]">
			<Property Name="ForObjectScript">
				<Value><![CDATA[[metadataHelpers].[DeleteServicePrincipal]]]></Value>
			</Property>
			<Relationship Name="ForObject">
				<Entry>
					<References Name="[metadataHelpers].[DeleteServicePrincipal]" />
					<Annotation Type="PersistedResolvableAnnotation" Name="[metadataHelpers].[DeleteServicePrincipal]">
						<Property Name="TargetTypeStorage" Value="ISqlSynonymTarget" />
						<Property Name="Length" Value="42" />
						<Property Name="Offset" Value="56" />
					</Annotation>
				</Entry>
			</Relationship>
			<Relationship Name="Schema">
				<Entry>
					<References Name="[metadata]" />
				</Entry>
			</Relationship>
		</Element>
		<Element Type="SqlDefaultConstraint" Name="[metadata].[DF_Pipelines_Enabled]">
			<Property Name="DefaultExpressionScript">
				<Value><![CDATA[((1))]]></Value>
			</Property>
			<Relationship Name="DefiningTable">
				<Entry>
					<References Name="[metadata].[Pipelines]" />
				</Entry>
			</Relationship>
			<Relationship Name="ForColumn">
				<Entry>
					<References Name="[metadata].[Pipelines].[Enabled]" />
				</Entry>
			</Relationship>
			<Annotation Type="SqlInlineConstraintAnnotation" Disambiguator="25" />
		</Element>
		<Element Type="SqlDefaultConstraint" Name="[metadata].[DF_Properties_ValidFrom]">
			<Property Name="DefaultExpressionScript">
				<Value><![CDATA[(GETDATE())]]></Value>
			</Property>
			<Relationship Name="DefiningTable">
				<Entry>
					<References Name="[metadata].[Properties]" />
				</Entry>
			</Relationship>
			<Relationship Name="ForColumn">
				<Entry>
					<References Name="[metadata].[Properties].[ValidFrom]" />
				</Entry>
			</Relationship>
			<Annotation Type="SqlInlineConstraintAnnotation" Disambiguator="26" />
		</Element>
		<Element Type="SqlDefaultConstraint" Name="[metadata].[DF_Stages_Enabled]">
			<Property Name="DefaultExpressionScript">
				<Value><![CDATA[((1))]]></Value>
			</Property>
			<Relationship Name="DefiningTable">
				<Entry>
					<References Name="[metadata].[Stages]" />
				</Entry>
			</Relationship>
			<Relationship Name="ForColumn">
				<Entry>
					<References Name="[metadata].[Stages].[Enabled]" />
				</Entry>
			</Relationship>
			<Annotation Type="SqlInlineConstraintAnnotation" Disambiguator="27" />
		</Element>
		<Element Type="SqlCheckConstraint" Name="[metadata].[EQ_PipelineIdDependantPipelineId]">
			<Property Name="CheckExpressionScript">
				<Value><![CDATA[[PipelineId] <> [DependantPipelineId]]]></Value>
			</Property>
			<Relationship Name="CheckExpressionDependencies">
				<Entry>
					<References Name="[metadata].[PipelineDependencies].[PipelineId]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[PipelineDependencies].[DependantPipelineId]" />
				</Entry>
			</Relationship>
			<Relationship Name="DefiningTable">
				<Entry>
					<References Name="[metadata].[PipelineDependencies]" />
				</Entry>
			</Relationship>
			<Annotation Type="SqlInlineConstraintAnnotation" Disambiguator="28" />
		</Element>
		<Element Type="SqlTable" Name="[metadata].[ErrorLog]">
			<Property Name="IsAnsiNullsOn" Value="True" />
			<Relationship Name="Columns">
				<Entry>
					<Element Type="SqlSimpleColumn" Name="[metadata].[ErrorLog].[LogId]">
						<Property Name="IsNullable" Value="False" />
						<Property Name="IsIdentity" Value="True" />
						<Relationship Name="TypeSpecifier">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[int]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlSimpleColumn" Name="[metadata].[ErrorLog].[LocalExecutionId]">
						<Property Name="IsNullable" Value="False" />
						<Relationship Name="TypeSpecifier">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[uniqueidentifier]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlSimpleColumn" Name="[metadata].[ErrorLog].[PipelineRunId]">
						<Property Name="IsNullable" Value="False" />
						<Relationship Name="TypeSpecifier">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[uniqueidentifier]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlSimpleColumn" Name="[metadata].[ErrorLog].[ActivityRunId]">
						<Property Name="IsNullable" Value="False" />
						<Relationship Name="TypeSpecifier">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[uniqueidentifier]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlSimpleColumn" Name="[metadata].[ErrorLog].[ActivityName]">
						<Property Name="IsNullable" Value="False" />
						<Relationship Name="TypeSpecifier">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Property Name="Length" Value="100" />
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[varchar]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlSimpleColumn" Name="[metadata].[ErrorLog].[ActivityType]">
						<Property Name="IsNullable" Value="False" />
						<Relationship Name="TypeSpecifier">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Property Name="Length" Value="100" />
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[varchar]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlSimpleColumn" Name="[metadata].[ErrorLog].[ErrorCode]">
						<Property Name="IsNullable" Value="False" />
						<Relationship Name="TypeSpecifier">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Property Name="Length" Value="100" />
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[varchar]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlSimpleColumn" Name="[metadata].[ErrorLog].[ErrorType]">
						<Property Name="IsNullable" Value="False" />
						<Relationship Name="TypeSpecifier">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Property Name="Length" Value="100" />
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[varchar]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlSimpleColumn" Name="[metadata].[ErrorLog].[ErrorMessage]">
						<Relationship Name="TypeSpecifier">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Property Name="IsMax" Value="True" />
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[nvarchar]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
			</Relationship>
			<Relationship Name="Schema">
				<Entry>
					<References Name="[metadata]" />
				</Entry>
			</Relationship>
			<Annotation Type="SqlInlineConstraintAnnotation" Disambiguator="29" />
		</Element>
		<Element Type="SqlProcedure" Name="[metadata].[ExecutePrecursorProcedure]">
			<Property Name="BodyScript">
				<Value><![CDATA[
BEGIN
	DECLARE @SQL VARCHAR(MAX) 
	DECLARE @ErrorDetail NVARCHAR(MAX)

	IF OBJECT_ID([metadata].[GetPropertyValueInternal]('ExecutionPrecursorProc')) IS NOT NULL
		BEGIN
			BEGIN TRY
				SET @SQL = [metadata].[GetPropertyValueInternal]('ExecutionPrecursorProc');
				EXEC(@SQL);
			END TRY
			BEGIN CATCH
				SELECT
					@ErrorDetail = 'Precursor procedure failed with error: ' + ERROR_MESSAGE();

				RAISERROR(@ErrorDetail,16,1);
			END CATCH
		END;
	ELSE
		BEGIN
			PRINT 'Precursor object not found in database.';
		END;
END;]]></Value>
			</Property>
			<Property Name="IsAnsiNullsOn" Value="True" />
			<Relationship Name="BodyDependencies">
				<Entry>
					<References ExternalSource="BuiltIns" Name="[varchar]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[nvarchar]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[GetPropertyValueInternal]" />
				</Entry>
			</Relationship>
			<Relationship Name="Schema">
				<Entry>
					<References Name="[metadata]" />
				</Entry>
			</Relationship>
			<Annotation Type="SysCommentsObjectAnnotation">
				<Property Name="Length" Value="611" />
				<Property Name="StartLine" Value="1" />
				<Property Name="StartColumn" Value="1" />
				<Property Name="HeaderContents" Value="CREATE PROCEDURE [metadata].[ExecutePrecursorProcedure]&#xD;&#xA;AS" />
			</Annotation>
		</Element>
		<Element Type="SqlTable" Name="[metadata].[ExecutionLog]">
			<Property Name="IsAnsiNullsOn" Value="True" />
			<Relationship Name="Columns">
				<Entry>
					<Element Type="SqlSimpleColumn" Name="[metadata].[ExecutionLog].[LogId]">
						<Property Name="IsNullable" Value="False" />
						<Property Name="IsIdentity" Value="True" />
						<Relationship Name="TypeSpecifier">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[int]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlSimpleColumn" Name="[metadata].[ExecutionLog].[LocalExecutionId]">
						<Property Name="IsNullable" Value="False" />
						<Relationship Name="TypeSpecifier">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[uniqueidentifier]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlSimpleColumn" Name="[metadata].[ExecutionLog].[StageId]">
						<Property Name="IsNullable" Value="False" />
						<Relationship Name="TypeSpecifier">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[int]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlSimpleColumn" Name="[metadata].[ExecutionLog].[PipelineId]">
						<Property Name="IsNullable" Value="False" />
						<Relationship Name="TypeSpecifier">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[int]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlSimpleColumn" Name="[metadata].[ExecutionLog].[CallingOrchestratorName]">
						<Property Name="IsNullable" Value="False" />
						<Relationship Name="TypeSpecifier">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Property Name="Length" Value="200" />
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[nvarchar]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
						<AttachedAnnotation Disambiguator="15" />
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlSimpleColumn" Name="[metadata].[ExecutionLog].[ResourceGroupName]">
						<Property Name="IsNullable" Value="False" />
						<Relationship Name="TypeSpecifier">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Property Name="Length" Value="200" />
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[nvarchar]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
						<AttachedAnnotation Disambiguator="10" />
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlSimpleColumn" Name="[metadata].[ExecutionLog].[OrchestratorType]">
						<Property Name="IsNullable" Value="False" />
						<Relationship Name="TypeSpecifier">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Property Name="Length" Value="3" />
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[char]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
						<AttachedAnnotation Disambiguator="6" />
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlSimpleColumn" Name="[metadata].[ExecutionLog].[OrchestratorName]">
						<Property Name="IsNullable" Value="False" />
						<Relationship Name="TypeSpecifier">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Property Name="Length" Value="200" />
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[nvarchar]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
						<AttachedAnnotation Disambiguator="13" />
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlSimpleColumn" Name="[metadata].[ExecutionLog].[PipelineName]">
						<Property Name="IsNullable" Value="False" />
						<Relationship Name="TypeSpecifier">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Property Name="Length" Value="200" />
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[nvarchar]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlSimpleColumn" Name="[metadata].[ExecutionLog].[StartDateTime]">
						<Relationship Name="TypeSpecifier">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[datetime]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlSimpleColumn" Name="[metadata].[ExecutionLog].[PipelineStatus]">
						<Relationship Name="TypeSpecifier">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Property Name="Length" Value="200" />
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[nvarchar]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlSimpleColumn" Name="[metadata].[ExecutionLog].[EndDateTime]">
						<Relationship Name="TypeSpecifier">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[datetime]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlSimpleColumn" Name="[metadata].[ExecutionLog].[PipelineRunId]">
						<Relationship Name="TypeSpecifier">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[uniqueidentifier]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlSimpleColumn" Name="[metadata].[ExecutionLog].[PipelineParamsUsed]">
						<Relationship Name="TypeSpecifier">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Property Name="IsMax" Value="True" />
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[nvarchar]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
						<AttachedAnnotation Disambiguator="9" />
					</Element>
				</Entry>
			</Relationship>
			<Relationship Name="Schema">
				<Entry>
					<References Name="[metadata]" />
				</Entry>
			</Relationship>
			<Annotation Type="SqlInlineConstraintAnnotation" Disambiguator="30" />
		</Element>
		<Element Type="SqlProcedure" Name="[metadata].[ExecutionWrapper]">
			<Property Name="BodyScript">
				<Value><![CDATA[
BEGIN
	SET NOCOUNT ON;

	DECLARE @RestartStatus BIT
	DECLARE @BatchId UNIQUEIDENTIFIER
	DECLARE @BLocalExecutionId UNIQUEIDENTIFIER --declared here for batches

	IF @CallingOrchestratorName IS NULL
		SET @CallingOrchestratorName = 'Unknown';

	--get restart overide property	
	SELECT @RestartStatus = [metadata].[GetPropertyValueInternal]('OverideRestart')

	IF([metadata].[GetPropertyValueInternal]('UseExecutionBatches')) = '0'
		BEGIN
			SET @BatchId = NULL;

			--check for running execution
			IF EXISTS
				(
				SELECT * FROM [metadata].[CurrentExecution] WHERE ISNULL([PipelineStatus],'') = 'Running'
				)
				BEGIN
					RAISERROR('There is already an execution run in progress. Stop this via the Orchestrator before restarting.',16,1);
					RETURN 0;
				END;	

			--reset and restart execution
			IF EXISTS
				(
				SELECT 1 FROM [metadata].[CurrentExecution] WHERE ISNULL([PipelineStatus],'') <> 'Success'
				) 
				AND @RestartStatus = 0
				BEGIN
					EXEC [metadata].[ResetExecution]
				END
			--capture failed execution and run new anyway
			ELSE IF EXISTS
				(
				SELECT 1 FROM [metadata].[CurrentExecution]
				)
				AND @RestartStatus = 1
				BEGIN
					EXEC [metadata].[UpdateExecutionLog]
						@PerformErrorCheck = 0; --Special case when OverideRestart = 1;

					EXEC [metadata].[CreateNewExecution]
						@CallingOrchestratorName = @CallingOrchestratorName
				END
			--no restart considerations, just create new execution
			ELSE
				BEGIN
					EXEC [metadata].[CreateNewExecution]
						@CallingOrchestratorName = @CallingOrchestratorName
				END
		END
	ELSE IF ([metadata].[GetPropertyValueInternal]('UseExecutionBatches')) = '1'
		BEGIN						
			IF @BatchName IS NULL
				BEGIN
					RAISERROR('A NULL batch name cannot be passed when the UseExecutionBatches property is set to 1 (true).',16,1);
					RETURN 0;
				END;
			
			SELECT 
				@BatchId = [BatchId]
			FROM
				[metadata].[Batches]
			WHERE
				[BatchName] = @BatchName;
			
			--create local execution id now for the batch
			EXEC [metadata].[BatchWrapper]
				@BatchId = @BatchId,
				@LocalExecutionId = @BLocalExecutionId OUTPUT;
				
			--reset and restart execution
			IF EXISTS
				(
				SELECT 1 
				FROM 
					[metadata].[CurrentExecution]
				WHERE 
					[LocalExecutionId] = @BLocalExecutionId 
					AND ISNULL([PipelineStatus],'') <> 'Success'
				) 
				AND @RestartStatus = 0
				BEGIN
					EXEC [metadata].[ResetExecution]
						@LocalExecutionId = @BLocalExecutionId;
				END
			--capture failed execution and run new anyway
			ELSE IF EXISTS
				(
				SELECT 1 
				FROM 
					[metadata].[CurrentExecution]
				WHERE
					[LocalExecutionId] = @BLocalExecutionId 
				)
				AND @RestartStatus = 1
				BEGIN
					EXEC [metadata].[UpdateExecutionLog]
						@PerformErrorCheck = 0, --Special case when OverideRestart = 1;
						@ExecutionId = @BLocalExecutionId;

					EXEC [metadata].[CreateNewExecution]
						@CallingOrchestratorName = @CallingOrchestratorName,
						@LocalExecutionId = @BLocalExecutionId;
				END
			--no restart considerations, just create new execution
			ELSE
				BEGIN
					EXEC [metadata].[CreateNewExecution]
						@CallingOrchestratorName = @CallingOrchestratorName,
						@LocalExecutionId = @BLocalExecutionId;
				END
			
		END
	ELSE
		BEGIN
			--metadata integrity checks should mean this condition is never hit
			RAISERROR('Unknown batch handling configuration. Update properties with UseExecutionBatches value and try again.',16,1);
			RETURN 0;
		END
END;]]></Value>
			</Property>
			<Property Name="IsAnsiNullsOn" Value="True" />
			<Relationship Name="BodyDependencies">
				<Entry>
					<References ExternalSource="BuiltIns" Name="[bit]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[uniqueidentifier]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[uniqueidentifier]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[ExecutionWrapper].[@CallingOrchestratorName]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[GetPropertyValueInternal]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[CurrentExecution]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[CurrentExecution].[PipelineStatus]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[ResetExecution]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[UpdateExecutionLog]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[UpdateExecutionLog].[@PerformErrorCheck]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[CreateNewExecution]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[CreateNewExecution].[@CallingOrchestratorName]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[ExecutionWrapper].[@BatchName]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[Batches]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[Batches].[BatchId]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[Batches].[BatchName]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[BatchWrapper]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[BatchWrapper].[@BatchId]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[BatchWrapper].[@LocalExecutionId]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[CurrentExecution].[LocalExecutionId]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[ResetExecution].[@LocalExecutionId]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[UpdateExecutionLog].[@ExecutionId]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[CreateNewExecution].[@LocalExecutionId]" />
				</Entry>
			</Relationship>
			<Relationship Name="Parameters">
				<Entry>
					<Element Type="SqlSubroutineParameter" Name="[metadata].[ExecutionWrapper].[@CallingOrchestratorName]">
						<Property Name="DefaultExpressionScript">
							<Value><![CDATA[NULL]]></Value>
						</Property>
						<Relationship Name="Type">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Property Name="Length" Value="200" />
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[nvarchar]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlSubroutineParameter" Name="[metadata].[ExecutionWrapper].[@BatchName]">
						<Property Name="DefaultExpressionScript">
							<Value><![CDATA[NULL]]></Value>
						</Property>
						<Relationship Name="Type">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Property Name="Length" Value="255" />
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[varchar]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
			</Relationship>
			<Relationship Name="Schema">
				<Entry>
					<References Name="[metadata]" />
				</Entry>
			</Relationship>
			<Annotation Type="SysCommentsObjectAnnotation">
				<Property Name="Length" Value="3766" />
				<Property Name="StartLine" Value="1" />
				<Property Name="StartColumn" Value="1" />
				<Property Name="HeaderContents" Value="CREATE PROCEDURE [metadata].[ExecutionWrapper]&#xD;&#xA;&#x9;(&#xD;&#xA;&#x9;@CallingOrchestratorName NVARCHAR(200) = NULL,&#xD;&#xA;&#x9;@BatchName VARCHAR(255) = NULL&#xD;&#xA;&#x9;)&#xD;&#xA;AS" />
			</Annotation>
		</Element>
		<Element Type="SqlForeignKeyConstraint" Name="[metadata].[FK_BatchStageLink_Batches]">
			<Relationship Name="Columns">
				<Entry>
					<References Name="[metadata].[BatchStageLink].[BatchId]" />
				</Entry>
			</Relationship>
			<Relationship Name="DefiningTable">
				<Entry>
					<References Name="[metadata].[BatchStageLink]" />
				</Entry>
			</Relationship>
			<Relationship Name="ForeignColumns">
				<Entry>
					<References Name="[metadata].[Batches].[BatchId]" />
				</Entry>
			</Relationship>
			<Relationship Name="ForeignTable">
				<Entry>
					<References Name="[metadata].[Batches]" />
				</Entry>
			</Relationship>
			<AttachedAnnotation Disambiguator="22" />
		</Element>
		<Element Type="SqlForeignKeyConstraint" Name="[metadata].[FK_BatchStageLink_Stages]">
			<Relationship Name="Columns">
				<Entry>
					<References Name="[metadata].[BatchStageLink].[StageId]" />
				</Entry>
			</Relationship>
			<Relationship Name="DefiningTable">
				<Entry>
					<References Name="[metadata].[BatchStageLink]" />
				</Entry>
			</Relationship>
			<Relationship Name="ForeignColumns">
				<Entry>
					<References Name="[metadata].[Stages].[StageId]" />
				</Entry>
			</Relationship>
			<Relationship Name="ForeignTable">
				<Entry>
					<References Name="[metadata].[Stages]" />
				</Entry>
			</Relationship>
			<AttachedAnnotation Disambiguator="23" />
		</Element>
		<Element Type="SqlForeignKeyConstraint" Name="[metadata].[FK_Orchestrators_Subscriptions]">
			<Relationship Name="Columns">
				<Entry>
					<References Name="[metadata].[Orchestrators].[SubscriptionId]" />
				</Entry>
			</Relationship>
			<Relationship Name="DefiningTable">
				<Entry>
					<References Name="[metadata].[Orchestrators]" />
				</Entry>
			</Relationship>
			<Relationship Name="ForeignColumns">
				<Entry>
					<References Name="[metadata].[Subscriptions].[SubscriptionId]" />
				</Entry>
			</Relationship>
			<Relationship Name="ForeignTable">
				<Entry>
					<References Name="[metadata].[Subscriptions]" />
				</Entry>
			</Relationship>
			<Annotation Type="SqlInlineConstraintAnnotation" Disambiguator="31" />
		</Element>
		<Element Type="SqlForeignKeyConstraint" Name="[metadata].[FK_PipelineAlertLink_Pipelines]">
			<Relationship Name="Columns">
				<Entry>
					<References Name="[metadata].[PipelineAlertLink].[PipelineId]" />
				</Entry>
			</Relationship>
			<Relationship Name="DefiningTable">
				<Entry>
					<References Name="[metadata].[PipelineAlertLink]" />
				</Entry>
			</Relationship>
			<Relationship Name="ForeignColumns">
				<Entry>
					<References Name="[metadata].[Pipelines].[PipelineId]" />
				</Entry>
			</Relationship>
			<Relationship Name="ForeignTable">
				<Entry>
					<References Name="[metadata].[Pipelines]" />
				</Entry>
			</Relationship>
			<Annotation Type="SqlInlineConstraintAnnotation" Disambiguator="32" />
		</Element>
		<Element Type="SqlForeignKeyConstraint" Name="[metadata].[FK_PipelineAlertLink_Recipients]">
			<Relationship Name="Columns">
				<Entry>
					<References Name="[metadata].[PipelineAlertLink].[RecipientId]" />
				</Entry>
			</Relationship>
			<Relationship Name="DefiningTable">
				<Entry>
					<References Name="[metadata].[PipelineAlertLink]" />
				</Entry>
			</Relationship>
			<Relationship Name="ForeignColumns">
				<Entry>
					<References Name="[metadata].[Recipients].[RecipientId]" />
				</Entry>
			</Relationship>
			<Relationship Name="ForeignTable">
				<Entry>
					<References Name="[metadata].[Recipients]" />
				</Entry>
			</Relationship>
			<Annotation Type="SqlInlineConstraintAnnotation" Disambiguator="33" />
		</Element>
		<Element Type="SqlForeignKeyConstraint" Name="[metadata].[FK_PipelineAuthLink_Orchestrators]">
			<Relationship Name="Columns">
				<Entry>
					<References Name="[metadata].[PipelineAuthLink].[OrchestratorId]" />
				</Entry>
			</Relationship>
			<Relationship Name="DefiningTable">
				<Entry>
					<References Name="[metadata].[PipelineAuthLink]" />
				</Entry>
			</Relationship>
			<Relationship Name="ForeignColumns">
				<Entry>
					<References Name="[metadata].[Orchestrators].[OrchestratorId]" />
				</Entry>
			</Relationship>
			<Relationship Name="ForeignTable">
				<Entry>
					<References Name="[metadata].[Orchestrators]" />
				</Entry>
			</Relationship>
			<Annotation Type="SqlInlineConstraintAnnotation" Disambiguator="34" />
		</Element>
		<Element Type="SqlForeignKeyConstraint" Name="[metadata].[FK_PipelineAuthLink_Pipelines]">
			<Relationship Name="Columns">
				<Entry>
					<References Name="[metadata].[PipelineAuthLink].[PipelineId]" />
				</Entry>
			</Relationship>
			<Relationship Name="DefiningTable">
				<Entry>
					<References Name="[metadata].[PipelineAuthLink]" />
				</Entry>
			</Relationship>
			<Relationship Name="ForeignColumns">
				<Entry>
					<References Name="[metadata].[Pipelines].[PipelineId]" />
				</Entry>
			</Relationship>
			<Relationship Name="ForeignTable">
				<Entry>
					<References Name="[metadata].[Pipelines]" />
				</Entry>
			</Relationship>
			<Annotation Type="SqlInlineConstraintAnnotation" Disambiguator="35" />
		</Element>
		<Element Type="SqlForeignKeyConstraint" Name="[metadata].[FK_PipelineAuthLink_ServicePrincipals]">
			<Relationship Name="Columns">
				<Entry>
					<References Name="[metadata].[PipelineAuthLink].[CredentialId]" />
				</Entry>
			</Relationship>
			<Relationship Name="DefiningTable">
				<Entry>
					<References Name="[metadata].[PipelineAuthLink]" />
				</Entry>
			</Relationship>
			<Relationship Name="ForeignColumns">
				<Entry>
					<References Name="[dbo].[ServicePrincipals].[CredentialId]" />
				</Entry>
			</Relationship>
			<Relationship Name="ForeignTable">
				<Entry>
					<References Name="[dbo].[ServicePrincipals]" />
				</Entry>
			</Relationship>
			<Annotation Type="SqlInlineConstraintAnnotation" Disambiguator="36" />
		</Element>
		<Element Type="SqlForeignKeyConstraint" Name="[metadata].[FK_PipelineDependencies_Pipelines]">
			<Relationship Name="Columns">
				<Entry>
					<References Name="[metadata].[PipelineDependencies].[PipelineId]" />
				</Entry>
			</Relationship>
			<Relationship Name="DefiningTable">
				<Entry>
					<References Name="[metadata].[PipelineDependencies]" />
				</Entry>
			</Relationship>
			<Relationship Name="ForeignColumns">
				<Entry>
					<References Name="[metadata].[Pipelines].[PipelineId]" />
				</Entry>
			</Relationship>
			<Relationship Name="ForeignTable">
				<Entry>
					<References Name="[metadata].[Pipelines]" />
				</Entry>
			</Relationship>
			<Annotation Type="SqlInlineConstraintAnnotation" Disambiguator="37" />
		</Element>
		<Element Type="SqlForeignKeyConstraint" Name="[metadata].[FK_PipelineDependencies_Pipelines1]">
			<Relationship Name="Columns">
				<Entry>
					<References Name="[metadata].[PipelineDependencies].[DependantPipelineId]" />
				</Entry>
			</Relationship>
			<Relationship Name="DefiningTable">
				<Entry>
					<References Name="[metadata].[PipelineDependencies]" />
				</Entry>
			</Relationship>
			<Relationship Name="ForeignColumns">
				<Entry>
					<References Name="[metadata].[Pipelines].[PipelineId]" />
				</Entry>
			</Relationship>
			<Relationship Name="ForeignTable">
				<Entry>
					<References Name="[metadata].[Pipelines]" />
				</Entry>
			</Relationship>
			<Annotation Type="SqlInlineConstraintAnnotation" Disambiguator="38" />
		</Element>
		<Element Type="SqlForeignKeyConstraint" Name="[metadata].[FK_PipelineParameters_Pipelines]">
			<Relationship Name="Columns">
				<Entry>
					<References Name="[metadata].[PipelineParameters].[PipelineId]" />
				</Entry>
			</Relationship>
			<Relationship Name="DefiningTable">
				<Entry>
					<References Name="[metadata].[PipelineParameters]" />
				</Entry>
			</Relationship>
			<Relationship Name="ForeignColumns">
				<Entry>
					<References Name="[metadata].[Pipelines].[PipelineId]" />
				</Entry>
			</Relationship>
			<Relationship Name="ForeignTable">
				<Entry>
					<References Name="[metadata].[Pipelines]" />
				</Entry>
			</Relationship>
			<Annotation Type="SqlInlineConstraintAnnotation" Disambiguator="39" />
		</Element>
		<Element Type="SqlForeignKeyConstraint" Name="[metadata].[FK_Pipelines_Orchestrators]">
			<Relationship Name="Columns">
				<Entry>
					<References Name="[metadata].[Pipelines].[OrchestratorId]" />
				</Entry>
			</Relationship>
			<Relationship Name="DefiningTable">
				<Entry>
					<References Name="[metadata].[Pipelines]" />
				</Entry>
			</Relationship>
			<Relationship Name="ForeignColumns">
				<Entry>
					<References Name="[metadata].[Orchestrators].[OrchestratorId]" />
				</Entry>
			</Relationship>
			<Relationship Name="ForeignTable">
				<Entry>
					<References Name="[metadata].[Orchestrators]" />
				</Entry>
			</Relationship>
			<Annotation Type="SqlInlineConstraintAnnotation" Disambiguator="40" />
		</Element>
		<Element Type="SqlForeignKeyConstraint" Name="[metadata].[FK_Pipelines_Pipelines]">
			<Relationship Name="Columns">
				<Entry>
					<References Name="[metadata].[Pipelines].[LogicalPredecessorId]" />
				</Entry>
			</Relationship>
			<Relationship Name="DefiningTable">
				<Entry>
					<References Name="[metadata].[Pipelines]" />
				</Entry>
			</Relationship>
			<Relationship Name="ForeignColumns">
				<Entry>
					<References Name="[metadata].[Pipelines].[PipelineId]" />
				</Entry>
			</Relationship>
			<Relationship Name="ForeignTable">
				<Entry>
					<References Name="[metadata].[Pipelines]" />
				</Entry>
			</Relationship>
			<Annotation Type="SqlInlineConstraintAnnotation" Disambiguator="41" />
		</Element>
		<Element Type="SqlForeignKeyConstraint" Name="[metadata].[FK_Pipelines_Stages]">
			<Relationship Name="Columns">
				<Entry>
					<References Name="[metadata].[Pipelines].[StageId]" />
				</Entry>
			</Relationship>
			<Relationship Name="DefiningTable">
				<Entry>
					<References Name="[metadata].[Pipelines]" />
				</Entry>
			</Relationship>
			<Relationship Name="ForeignColumns">
				<Entry>
					<References Name="[metadata].[Stages].[StageId]" />
				</Entry>
			</Relationship>
			<Relationship Name="ForeignTable">
				<Entry>
					<References Name="[metadata].[Stages]" />
				</Entry>
			</Relationship>
			<Annotation Type="SqlInlineConstraintAnnotation" Disambiguator="42" />
		</Element>
		<Element Type="SqlForeignKeyConstraint" Name="[metadata].[FK_Subscriptions_Tenants]">
			<Relationship Name="Columns">
				<Entry>
					<References Name="[metadata].[Subscriptions].[TenantId]" />
				</Entry>
			</Relationship>
			<Relationship Name="DefiningTable">
				<Entry>
					<References Name="[metadata].[Subscriptions]" />
				</Entry>
			</Relationship>
			<Relationship Name="ForeignColumns">
				<Entry>
					<References Name="[metadata].[Tenants].[TenantId]" />
				</Entry>
			</Relationship>
			<Relationship Name="ForeignTable">
				<Entry>
					<References Name="[metadata].[Tenants]" />
				</Entry>
			</Relationship>
			<Annotation Type="SqlInlineConstraintAnnotation" Disambiguator="43" />
		</Element>
		<Element Type="SqlProcedure" Name="[metadata].[GetEmailAlertParts]">
			<Property Name="BodyScript">
				<Value><![CDATA[
BEGIN
	SET NOCOUNT ON;

	DECLARE @ToRecipients NVARCHAR(MAX) = ''
	DECLARE @CcRecipients NVARCHAR(MAX) = ''
	DECLARE @BccRecipients NVARCHAR(MAX) = ''
	DECLARE @EmailSubject NVARCHAR(500)
	DECLARE	@EmailBody NVARCHAR(MAX)
	DECLARE @EmailImportance VARCHAR(5)
	DECLARE @OutcomeBitValue INT

	--map pipeline status to alert outcome bit value
	SELECT
		@OutcomeBitValue = ao.[BitValue]
	FROM
		[metadata].[CurrentExecution] ce
		INNER JOIN [metadata].[AlertOutcomes] ao
			ON ce.[PipelineStatus] = ao.[PipelineOutcomeStatus]
	WHERE
		ce.[PipelineId] = @PipelineId;

	--get to recipients
	SELECT
		@ToRecipients += r.[EmailAddress] + ','
	FROM
		[metadata].[PipelineAlertLink] al
		INNER JOIN [metadata].[Recipients] r
			ON al.[RecipientId] = r.[RecipientId]
	WHERE
		al.[PipelineId] = @PipelineId
		AND al.[Enabled] = 1
		AND r.[Enabled] = 1
		AND UPPER(r.[MessagePreference]) = 'TO'
		AND (
			al.[OutcomesBitValue] & @OutcomeBitValue <> 0
			OR al.[OutcomesBitValue] & 1 <> 0 --all
			);

	IF (@ToRecipients <> '') SET @ToRecipients = LEFT(@ToRecipients,LEN(@ToRecipients)-1);

	--get cc recipients
	SELECT
		@CcRecipients += r.[EmailAddress] + ','
	FROM
		[metadata].[PipelineAlertLink] al
		INNER JOIN [metadata].[Recipients] r
			ON al.[RecipientId] = r.[RecipientId]
	WHERE
		al.[PipelineId] = @PipelineId
		AND al.[Enabled] = 1
		AND r.[Enabled] = 1
		AND UPPER(r.[MessagePreference]) = 'CC'
		AND (
			al.[OutcomesBitValue] & @OutcomeBitValue <> 0
			OR al.[OutcomesBitValue] & 1 <> 0 --all
			);
	
	IF (@CcRecipients <> '') SET @CcRecipients = LEFT(@CcRecipients,LEN(@CcRecipients)-1);

	--get bcc recipients
	SELECT
		@BccRecipients += r.[EmailAddress] + ','
	FROM
		[metadata].[PipelineAlertLink] al
		INNER JOIN [metadata].[Recipients] r
			ON al.[RecipientId] = r.[RecipientId]
	WHERE
		al.[PipelineId] = @PipelineId
		AND al.[Enabled] = 1
		AND r.[Enabled] = 1
		AND UPPER(r.[MessagePreference]) = 'BCC'
		AND (
			al.[OutcomesBitValue] & @OutcomeBitValue <> 0
			OR al.[OutcomesBitValue] & 1 <> 0 --all
			);

	IF (@BccRecipients <> '') SET @BccRecipients = LEFT(@BccRecipients,LEN(@BccRecipients)-1);
	
	--get email template
	SELECT
		@EmailBody = [PropertyValue]
	FROM
		[metadata].[CurrentProperties]
	WHERE
		[PropertyName] = 'EmailAlertBodyTemplate';

	--set subject, body and importance
	SELECT TOP (1)
		--subject
		@EmailSubject = 'metadata Alert: ' + [PipelineName] + ' - ' + [PipelineStatus],
	
		--body
		@EmailBody = REPLACE(@EmailBody,'##PipelineName###',[PipelineName]),
		@EmailBody = REPLACE(@EmailBody,'##Status###',[PipelineStatus]),
		@EmailBody = REPLACE(@EmailBody,'##ExecId###',CAST([LocalExecutionId] AS VARCHAR(36))),
		@EmailBody = REPLACE(@EmailBody,'##RunId###',CAST([PipelineRunId] AS VARCHAR(36))),
		@EmailBody = REPLACE(@EmailBody,'##StartDateTime###',CONVERT(VARCHAR(30), [StartDateTime], 120)),
		@EmailBody = CASE
						WHEN [EndDateTime] IS NULL THEN REPLACE(@EmailBody,'##EndDateTime###','N/A')
						ELSE REPLACE(@EmailBody,'##EndDateTime###',CONVERT(VARCHAR(30), [EndDateTime], 120))
					END,
		@EmailBody = CASE
						WHEN [EndDateTime] IS NULL THEN REPLACE(@EmailBody,'##Duration###','N/A')
						ELSE REPLACE(@EmailBody,'##Duration###',CAST(DATEDIFF(MINUTE, [StartDateTime], [EndDateTime]) AS VARCHAR(30)))
					END,
		@EmailBody = REPLACE(@EmailBody,'##CalledByOrc###',[CallingOrchestratorName]),
		@EmailBody = REPLACE(@EmailBody,'##ExecutedByOrcType###',[OrchestratorType]),
		@EmailBody = REPLACE(@EmailBody,'##ExecutedByOrc###',[OrchestratorName]),

		--importance
		@EmailImportance = 
			CASE [PipelineStatus] 
				WHEN 'Success' THEN 'Low'
				WHEN 'Failed' THEN 'High'
				ELSE 'Normal'
			END
	FROM
		[metadata].[CurrentExecution]
	WHERE
		[PipelineId] = @PipelineId
	ORDER BY
		[StartDateTime] DESC;
	
	--precaution
	IF @EmailBody IS NULL
		SET @EmailBody = 'Internal error. Failed to create profwk email alert body. Execute procedure [metadata].[GetEmailAlertParts] with pipeline Id: ' + CAST(@PipelineId AS VARCHAR(30)) + ' to debug.';

	--return email parts
	SELECT
		@ToRecipients AS emailRecipients,
		@CcRecipients AS emailCcRecipients,
		@BccRecipients AS emailBccRecipients,
		@EmailSubject AS emailSubject,
		@EmailBody AS emailBody,
		@EmailImportance AS emailImportance;
END;]]></Value>
			</Property>
			<Property Name="IsAnsiNullsOn" Value="True" />
			<Relationship Name="BodyDependencies">
				<Entry>
					<References ExternalSource="BuiltIns" Name="[nvarchar]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[nvarchar]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[nvarchar]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[nvarchar]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[nvarchar]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[varchar]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[int]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[CurrentExecution]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[AlertOutcomes]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[CurrentExecution].[PipelineStatus]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[AlertOutcomes].[PipelineOutcomeStatus]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[AlertOutcomes].[BitValue]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[CurrentExecution].[PipelineId]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[GetEmailAlertParts].[@PipelineId]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[PipelineAlertLink]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[Recipients]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[PipelineAlertLink].[RecipientId]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[Recipients].[RecipientId]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[Recipients].[EmailAddress]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[PipelineAlertLink].[PipelineId]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[PipelineAlertLink].[Enabled]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[Recipients].[Enabled]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[Recipients].[MessagePreference]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[PipelineAlertLink].[OutcomesBitValue]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[CurrentProperties]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[CurrentProperties].[PropertyValue]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[CurrentProperties].[PropertyName]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[CurrentExecution].[PipelineName]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[CurrentExecution].[PipelineStatus]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[varchar]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[CurrentExecution].[LocalExecutionId]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[varchar]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[CurrentExecution].[PipelineRunId]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[varchar]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[CurrentExecution].[StartDateTime]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[CurrentExecution].[EndDateTime]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[varchar]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[varchar]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[CurrentExecution].[CallingOrchestratorName]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[CurrentExecution].[OrchestratorType]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[CurrentExecution].[OrchestratorName]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[CurrentExecution].[PipelineId]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[varchar]" />
				</Entry>
			</Relationship>
			<Relationship Name="Parameters">
				<Entry>
					<Element Type="SqlSubroutineParameter" Name="[metadata].[GetEmailAlertParts].[@PipelineId]">
						<Relationship Name="Type">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[int]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
			</Relationship>
			<Relationship Name="Schema">
				<Entry>
					<References Name="[metadata]" />
				</Entry>
			</Relationship>
			<Annotation Type="SysCommentsObjectAnnotation">
				<Property Name="Length" Value="4467" />
				<Property Name="StartLine" Value="1" />
				<Property Name="StartColumn" Value="1" />
				<Property Name="HeaderContents" Value="CREATE PROCEDURE [metadata].[GetEmailAlertParts]&#xD;&#xA;&#x9;(&#xD;&#xA;&#x9;@PipelineId INT&#xD;&#xA;&#x9;)&#xD;&#xA;AS" />
			</Annotation>
		</Element>
		<Element Type="SqlSynonym" Name="[metadata].[GetExecutionDetails]">
			<Property Name="ForObjectScript">
				<Value><![CDATA[[metadataHelpers].[GetExecutionDetails]]]></Value>
			</Property>
			<Relationship Name="ForObject">
				<Entry>
					<References Name="[metadataHelpers].[GetExecutionDetails]" />
					<Annotation Type="PersistedResolvableAnnotation" Name="[metadataHelpers].[GetExecutionDetails]">
						<Property Name="TargetTypeStorage" Value="ISqlSynonymTarget" />
						<Property Name="Length" Value="39" />
						<Property Name="Offset" Value="53" />
					</Annotation>
				</Entry>
			</Relationship>
			<Relationship Name="Schema">
				<Entry>
					<References Name="[metadata]" />
				</Entry>
			</Relationship>
		</Element>
		<Element Type="SqlProcedure" Name="[metadata].[GetFrameworkOrchestratorDetails]">
			<Property Name="BodyScript">
				<Value><![CDATA[
BEGIN
	SET NOCOUNT ON;

	DECLARE @FrameworkOrchestrator NVARCHAR(200)

	--defensive check
	SELECT
		@FrameworkOrchestrator = UPPER([OrchestratorName]),
		@CallingOrchestratorName = UPPER(@CallingOrchestratorName)
	FROM
		[metadata].[Orchestrators]
	WHERE
		[IsFrameworkOrchestrator] = 1;

	IF(@FrameworkOrchestrator <> @CallingOrchestratorName)
	BEGIN
		RAISERROR('Orchestrator mismatch. Calling orchestrator does not match expected IsFrameworkOrchestrator name.',16,1);
		RETURN 0;
	END

	--orchestrator detials
	SELECT
		[SubscriptionId],
		[ResourceGroupName],
		[OrchestratorName],
		[OrchestratorType]
	FROM
		[metadata].[Orchestrators]
	WHERE
		[IsFrameworkOrchestrator] = 1;
END;]]></Value>
			</Property>
			<Property Name="IsAnsiNullsOn" Value="True" />
			<Relationship Name="BodyDependencies">
				<Entry>
					<References ExternalSource="BuiltIns" Name="[nvarchar]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[Orchestrators]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[Orchestrators].[OrchestratorName]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[GetFrameworkOrchestratorDetails].[@CallingOrchestratorName]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[Orchestrators].[IsFrameworkOrchestrator]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[Orchestrators].[SubscriptionId]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[Orchestrators].[ResourceGroupName]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[Orchestrators].[OrchestratorType]" />
				</Entry>
			</Relationship>
			<Relationship Name="Parameters">
				<Entry>
					<Element Type="SqlSubroutineParameter" Name="[metadata].[GetFrameworkOrchestratorDetails].[@CallingOrchestratorName]">
						<Relationship Name="Type">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Property Name="Length" Value="200" />
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[nvarchar]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
			</Relationship>
			<Relationship Name="Schema">
				<Entry>
					<References Name="[metadata]" />
				</Entry>
			</Relationship>
			<Annotation Type="SysCommentsObjectAnnotation">
				<Property Name="Length" Value="832" />
				<Property Name="StartLine" Value="1" />
				<Property Name="StartColumn" Value="1" />
				<Property Name="HeaderContents" Value="CREATE PROCEDURE [metadata].[GetFrameworkOrchestratorDetails]&#xD;&#xA;&#x9;(&#xD;&#xA;&#x9;@CallingOrchestratorName NVARCHAR(200)&#xD;&#xA;&#x9;)&#xD;&#xA;AS" />
			</Annotation>
		</Element>
		<Element Type="SqlProcedure" Name="[metadata].[GetPipelineParameters]">
			<Property Name="BodyScript">
				<Value><![CDATA[
BEGIN
	SET NOCOUNT ON;

	DECLARE @Json VARCHAR(MAX) = ''

	--get parameters if required for worker pipeline
	IF NOT EXISTS
		(
		SELECT 
			[ParameterId] 
		FROM 
			[metadata].[PipelineParameters]
		WHERE 
			[PipelineId] = @PipelineId
		)
		BEGIN
			SET @Json = '' --Can't return NULL. Would break ADF expression.
		END
	ELSE
		BEGIN
			SELECT
				@Json += 
						CASE
							WHEN [ParameterValue] IS NULL THEN '' --don't add pair so ADF uses default
							ELSE '"' + [ParameterName] + '": "' + STRING_ESCAPE([ParameterValue],'json') + '",'
						END
			FROM
				[metadata].[PipelineParameters]
			WHERE
				[PipelineId] = @PipelineId;
			
			--handle parameter(s) with a NULL values
			IF LEN(@Json) > 0
			BEGIN
				--JSON snippet gets injected into Azure Function body request via Orchestrator expressions.
				--Comma used to support Orchestrator expression.
				SET @Json = ',"pipelineParameters": {' + LEFT(@Json,LEN(@Json)-1) + '}'

				--update current execution log if this is a runtime request
				UPDATE
					[metadata].[CurrentExecution]
				SET
					--add extra braces to make JSON string valid in logs
					[PipelineParamsUsed] = '{ ' + RIGHT(@Json,LEN(@Json)-1) + ' }'
				WHERE
					[PipelineId] = @PipelineId;

				--set last values values
				UPDATE
					[metadata].[PipelineParameters]
				SET
					[ParameterValueLastUsed] = [ParameterValue]
				WHERE
					[PipelineId] = @PipelineId;
			END;
		END;

	--return JSON snippet
	SELECT @Json AS Params
END;]]></Value>
			</Property>
			<Property Name="IsAnsiNullsOn" Value="True" />
			<Relationship Name="BodyDependencies">
				<Entry>
					<References ExternalSource="BuiltIns" Name="[varchar]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[PipelineParameters]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[PipelineParameters].[ParameterId]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[PipelineParameters].[PipelineId]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[GetPipelineParameters].[@PipelineId]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[PipelineParameters].[ParameterValue]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[PipelineParameters].[ParameterName]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[PipelineParameters].[PipelineId]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[CurrentExecution]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[CurrentExecution].[PipelineParamsUsed]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[CurrentExecution].[PipelineId]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[PipelineParameters].[ParameterValueLastUsed]" />
				</Entry>
			</Relationship>
			<Relationship Name="Parameters">
				<Entry>
					<Element Type="SqlSubroutineParameter" Name="[metadata].[GetPipelineParameters].[@PipelineId]">
						<Relationship Name="Type">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[int]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
			</Relationship>
			<Relationship Name="Schema">
				<Entry>
					<References Name="[metadata]" />
				</Entry>
			</Relationship>
			<Annotation Type="SysCommentsObjectAnnotation">
				<Property Name="Length" Value="1617" />
				<Property Name="StartLine" Value="1" />
				<Property Name="StartColumn" Value="1" />
				<Property Name="HeaderContents" Value="CREATE PROCEDURE [metadata].[GetPipelineParameters]&#xD;&#xA;&#x9;(&#xD;&#xA;&#x9;@PipelineId INT&#xD;&#xA;&#x9;)&#xD;&#xA;AS" />
			</Annotation>
		</Element>
		<Element Type="SqlProcedure" Name="[metadata].[GetPipelinesInStage]">
			<Property Name="BodyScript">
				<Value><![CDATA[
BEGIN
	SET NOCOUNT ON;

	SELECT 
		[PipelineId],
		[PipelineName]
	FROM 
		[metadata].[CurrentExecution]
	WHERE 
		[LocalExecutionId] = @ExecutionId
		AND [StageId] = @StageId
		AND ISNULL([PipelineStatus],'') <> 'Success'
		AND [IsBlocked] <> 1
	ORDER BY
		[PipelineId] ASC;
END;]]></Value>
			</Property>
			<Property Name="IsAnsiNullsOn" Value="True" />
			<Relationship Name="BodyDependencies">
				<Entry>
					<References Name="[metadata].[CurrentExecution]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[CurrentExecution].[PipelineId]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[CurrentExecution].[PipelineName]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[CurrentExecution].[LocalExecutionId]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[GetPipelinesInStage].[@ExecutionId]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[CurrentExecution].[StageId]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[GetPipelinesInStage].[@StageId]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[CurrentExecution].[PipelineStatus]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[CurrentExecution].[IsBlocked]" />
				</Entry>
			</Relationship>
			<Relationship Name="Parameters">
				<Entry>
					<Element Type="SqlSubroutineParameter" Name="[metadata].[GetPipelinesInStage].[@ExecutionId]">
						<Relationship Name="Type">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[uniqueidentifier]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlSubroutineParameter" Name="[metadata].[GetPipelinesInStage].[@StageId]">
						<Relationship Name="Type">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[int]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
			</Relationship>
			<Relationship Name="Schema">
				<Entry>
					<References Name="[metadata]" />
				</Entry>
			</Relationship>
			<Annotation Type="SysCommentsObjectAnnotation">
				<Property Name="Length" Value="406" />
				<Property Name="StartLine" Value="1" />
				<Property Name="StartColumn" Value="1" />
				<Property Name="HeaderContents" Value="CREATE PROCEDURE [metadata].[GetPipelinesInStage]&#xD;&#xA;&#x9;(&#xD;&#xA;&#x9;@ExecutionId UNIQUEIDENTIFIER,&#xD;&#xA;&#x9;@StageId INT&#xD;&#xA;&#x9;)&#xD;&#xA;AS" />
			</Annotation>
		</Element>
		<Element Type="SqlProcedure" Name="[metadata].[GetPropertyValue]">
			<Property Name="BodyScript">
				<Value><![CDATA[
BEGIN	
	DECLARE @ErrorDetail NVARCHAR(4000) = ''

	--defensive checks
	IF NOT EXISTS
		(
		SELECT * FROM [metadata].[Properties] WHERE [PropertyName] = @PropertyName
		)
		BEGIN
			SET @ErrorDetail = 'Invalid property name provided. Property does not exist.'
			RAISERROR(@ErrorDetail, 16, 1);
			RETURN 0;
		END
	ELSE IF NOT EXISTS
		(
		SELECT * FROM [metadata].[Properties] WHERE [PropertyName] = @PropertyName AND [ValidTo] IS NULL
		)
		BEGIN
			SET @ErrorDetail = 'Property name provided does not have a current valid version of the required value.'
			RAISERROR(@ErrorDetail, 16, 1);
			RETURN 0;
		END
	--get valid property value
	ELSE
		BEGIN
			SELECT
				[PropertyValue]
			FROM
				[metadata].[CurrentProperties]
			WHERE
				[PropertyName] = @PropertyName
		END
END;]]></Value>
			</Property>
			<Property Name="IsAnsiNullsOn" Value="True" />
			<Relationship Name="BodyDependencies">
				<Entry>
					<References ExternalSource="BuiltIns" Name="[nvarchar]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[Properties]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[Properties].[PropertyName]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[GetPropertyValue].[@PropertyName]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[Properties].[ValidTo]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[CurrentProperties]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[CurrentProperties].[PropertyValue]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[CurrentProperties].[PropertyName]" />
				</Entry>
			</Relationship>
			<Relationship Name="Parameters">
				<Entry>
					<Element Type="SqlSubroutineParameter" Name="[metadata].[GetPropertyValue].[@PropertyName]">
						<Relationship Name="Type">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Property Name="Length" Value="128" />
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[varchar]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
			</Relationship>
			<Relationship Name="Schema">
				<Entry>
					<References Name="[metadata]" />
				</Entry>
			</Relationship>
			<Annotation Type="SysCommentsObjectAnnotation">
				<Property Name="Length" Value="900" />
				<Property Name="StartLine" Value="1" />
				<Property Name="StartColumn" Value="1" />
				<Property Name="HeaderContents" Value="CREATE PROCEDURE [metadata].[GetPropertyValue]&#xD;&#xA;&#x9;(&#xD;&#xA;&#x9;@PropertyName VARCHAR(128)&#xD;&#xA;&#x9;)&#xD;&#xA;AS" />
			</Annotation>
		</Element>
		<Element Type="SqlScalarFunction" Name="[metadata].[GetPropertyValueInternal]">
			<Property Name="IsAnsiNullsOn" Value="True" />
			<Relationship Name="BodyDependencies">
				<Entry>
					<References ExternalSource="BuiltIns" Name="[nvarchar]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[CurrentProperties]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[CurrentProperties].[PropertyValue]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[CurrentProperties].[PropertyName]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[GetPropertyValueInternal].[@PropertyName]" />
				</Entry>
			</Relationship>
			<Relationship Name="FunctionBody">
				<Entry>
					<Element Type="SqlScriptFunctionImplementation">
						<Property Name="BodyScript">
							<Value><![CDATA[
BEGIN
	DECLARE @PropertyValue NVARCHAR(MAX)

	SELECT
		@PropertyValue = ISNULL([PropertyValue],'')
	FROM
		[metadata].[CurrentProperties]
	WHERE
		[PropertyName] = @PropertyName

    RETURN @PropertyValue
END;]]></Value>
						</Property>
						<Annotation Type="SysCommentsObjectAnnotation">
							<Property Name="Length" Value="339" />
							<Property Name="StartLine" Value="1" />
							<Property Name="StartColumn" Value="1" />
							<Property Name="HeaderContents" Value="CREATE FUNCTION [metadata].[GetPropertyValueInternal]&#xD;&#xA;&#x9;(&#xD;&#xA;&#x9;@PropertyName VARCHAR(128)&#xD;&#xA;&#x9;)&#xD;&#xA;RETURNS NVARCHAR(MAX)&#xD;&#xA;AS" />
						</Annotation>
					</Element>
				</Entry>
			</Relationship>
			<Relationship Name="Parameters">
				<Entry>
					<Element Type="SqlSubroutineParameter" Name="[metadata].[GetPropertyValueInternal].[@PropertyName]">
						<Relationship Name="Type">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Property Name="Length" Value="128" />
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[varchar]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
			</Relationship>
			<Relationship Name="Schema">
				<Entry>
					<References Name="[metadata]" />
				</Entry>
			</Relationship>
			<Relationship Name="Type">
				<Entry>
					<Element Type="SqlTypeSpecifier">
						<Property Name="IsMax" Value="True" />
						<Relationship Name="Type">
							<Entry>
								<References ExternalSource="BuiltIns" Name="[nvarchar]" />
							</Entry>
						</Relationship>
					</Element>
				</Entry>
			</Relationship>
		</Element>
		<Element Type="SqlProcedure" Name="[metadata].[GetStages]">
			<Property Name="BodyScript">
				<Value><![CDATA[
BEGIN
	SET NOCOUNT ON;

	--defensive check
	IF NOT EXISTS 
		( 
		SELECT
			1
		FROM 
			[metadata].[CurrentExecution]
		WHERE
			[LocalExecutionId] = @ExecutionId
			AND ISNULL([PipelineStatus],'') <> 'Success'
		)
		BEGIN
			RAISERROR('Requested execution run does not contain any enabled stages/pipelines.',16,1);
			RETURN 0;
		END;

	SELECT DISTINCT 
		[StageId] 
	FROM 
		[metadata].[CurrentExecution]
	WHERE
		[LocalExecutionId] = @ExecutionId
		AND ISNULL([PipelineStatus],'') <> 'Success'
	ORDER BY 
		[StageId] ASC
END;]]></Value>
			</Property>
			<Property Name="IsAnsiNullsOn" Value="True" />
			<Relationship Name="BodyDependencies">
				<Entry>
					<References Name="[metadata].[CurrentExecution]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[CurrentExecution].[LocalExecutionId]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[GetStages].[@ExecutionId]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[CurrentExecution].[PipelineStatus]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[CurrentExecution].[StageId]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[CurrentExecution].[LocalExecutionId]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[CurrentExecution].[PipelineStatus]" />
				</Entry>
			</Relationship>
			<Relationship Name="Parameters">
				<Entry>
					<Element Type="SqlSubroutineParameter" Name="[metadata].[GetStages].[@ExecutionId]">
						<Relationship Name="Type">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[uniqueidentifier]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
			</Relationship>
			<Relationship Name="Schema">
				<Entry>
					<References Name="[metadata]" />
				</Entry>
			</Relationship>
			<Annotation Type="SysCommentsObjectAnnotation">
				<Property Name="Length" Value="642" />
				<Property Name="StartLine" Value="1" />
				<Property Name="StartColumn" Value="1" />
				<Property Name="HeaderContents" Value="CREATE PROCEDURE [metadata].[GetStages]&#xD;&#xA;&#x9;(&#xD;&#xA;&#x9;@ExecutionId UNIQUEIDENTIFIER&#xD;&#xA;&#x9;)&#xD;&#xA;AS" />
			</Annotation>
		</Element>
		<Element Type="SqlProcedure" Name="[metadata].[GetWorkerAuthDetails]">
			<Property Name="BodyScript">
				<Value><![CDATA[
BEGIN
	SET NOCOUNT ON;

	DECLARE @TenId NVARCHAR(MAX)
	DECLARE @SubId NVARCHAR(MAX)
	DECLARE @AppId NVARCHAR(MAX)
	DECLARE @AppSecret NVARCHAR(MAX)

	DECLARE @OrchestratorName NVARCHAR(200)
	DECLARE @OrchestratorType CHAR(3)
	DECLARE @PipelineName NVARCHAR(200)

	SELECT 
		@PipelineName = [PipelineName],
		@OrchestratorName = [OrchestratorName],
		@OrchestratorType = [OrchestratorType]
	FROM 
		[metadata].[CurrentExecution]
	WHERE 
		[LocalExecutionId] = @ExecutionId
		AND [StageId] = @StageId
		AND [PipelineId] = @PipelineId;
		

	IF ([metadata].[GetPropertyValueInternal]('SPNHandlingMethod')) = 'StoreInDatabase'
		BEGIN
			--get auth details regardless of being pipeline specific and regardless of a pipeline param being passed
			;WITH cte AS
				(
				SELECT DISTINCT
					Sub.[TenantId],
					Sub.[SubscriptionId],
					S.[PrincipalId] AS AppId,
					CAST(DECRYPTBYPASSPHRASE(CONCAT(@OrchestratorName, @OrchestratorType, @PipelineName), S.[PrincipalSecret]) AS NVARCHAR(MAX)) AS AppSecret
				FROM
					[dbo].[ServicePrincipals] S
					INNER JOIN  [metadata].[PipelineAuthLink] L
						ON S.[CredentialId] = L.[CredentialId]
					INNER JOIN [metadata].[Pipelines] P
						ON L.[PipelineId] = P.[PipelineId]
					INNER JOIN [metadata].[Orchestrators] D
						ON P.[OrchestratorId] = D.[OrchestratorId]
							AND L.[OrchestratorId] = D.[OrchestratorId]
					INNER JOIN [metadata].[Subscriptions] Sub
						ON D.[SubscriptionId] = Sub.[SubscriptionId]
				WHERE
					P.[PipelineName] = @PipelineName
					AND D.[OrchestratorName] = @OrchestratorName
					AND D.[OrchestratorType] = @OrchestratorType
			
				UNION

				SELECT DISTINCT
					Sub.[TenantId],
					Sub.[SubscriptionId],					
					S.[PrincipalId] AS AppId,
					CAST(DECRYPTBYPASSPHRASE(CONCAT(@OrchestratorName, @OrchestratorType), S.[PrincipalSecret]) AS NVARCHAR(MAX)) AS AppSecret
				FROM
					[dbo].[ServicePrincipals] S
					INNER JOIN  [metadata].[PipelineAuthLink] L
						ON S.[CredentialId] = L.[CredentialId]
					INNER JOIN [metadata].[Orchestrators] D
						ON L.[OrchestratorId] = D.[OrchestratorId]
					INNER JOIN [metadata].[Subscriptions] Sub
						ON D.[SubscriptionId] = Sub.[SubscriptionId]
				WHERE
					D.[OrchestratorName] = @OrchestratorName
					AND D.[OrchestratorType] = @OrchestratorType
				)
			SELECT TOP 1
				@TenId = [TenantId],
				@SubId = [SubscriptionId],
				@AppId = [AppId],
				@AppSecret = [AppSecret]
			FROM
				cte
			WHERE
				[AppSecret] IS NOT NULL
		END
	ELSE IF ([metadata].[GetPropertyValueInternal]('SPNHandlingMethod')) = 'StoreInKeyVault'
		BEGIN
			
			--get auth details regardless of being pipeline specific and regardless of a pipeline param being passed
			;WITH cte AS
				(
				SELECT DISTINCT
					Sub.[TenantId],
					Sub.[SubscriptionId],						
					S.[PrincipalIdUrl] AS AppId,
					S.[PrincipalSecretUrl] AS AppSecret
				FROM
					[dbo].[ServicePrincipals] S
					INNER JOIN  [metadata].[PipelineAuthLink] L
						ON S.[CredentialId] = L.[CredentialId]
					INNER JOIN [metadata].[Pipelines] P
						ON L.[PipelineId] = P.[PipelineId]
					INNER JOIN [metadata].[Orchestrators] D
						ON P.[OrchestratorId] = D.[OrchestratorId]
							AND L.[OrchestratorId] = D.[OrchestratorId]
					INNER JOIN [metadata].[Subscriptions] Sub
						ON D.[SubscriptionId] = Sub.[SubscriptionId]
				WHERE
					P.[PipelineName] = @PipelineName
					AND D.[OrchestratorName] = @OrchestratorName
					AND D.[OrchestratorType] = @OrchestratorType
			
				UNION

				SELECT DISTINCT
					Sub.[TenantId],
					Sub.[SubscriptionId],					
					S.[PrincipalIdUrl] AS AppId,
					S.[PrincipalSecretUrl] AS AppSecret
				FROM
					[dbo].[ServicePrincipals] S
					INNER JOIN  [metadata].[PipelineAuthLink] L
						ON S.[CredentialId] = L.[CredentialId]
					INNER JOIN [metadata].[Orchestrators] D
						ON L.[OrchestratorId] = D.[OrchestratorId]
					INNER JOIN [metadata].[Subscriptions] Sub
						ON D.[SubscriptionId] = Sub.[SubscriptionId]
				WHERE
					D.[OrchestratorName] = @OrchestratorName
					AND D.[OrchestratorType] = @OrchestratorType
				)
			SELECT TOP 1
				@TenId = [TenantId],
				@SubId = [SubscriptionId],
				@AppId = [AppId],
				@AppSecret = [AppSecret]
			FROM
				cte
			WHERE
				[AppSecret] IS NOT NULL
		END
	ELSE
		BEGIN
			RAISERROR('Unknown SPN retrieval method.',16,1);
			RETURN 0;
		END

	--return usable values
	SELECT
		@TenId AS TenantId,
		@SubId AS SubscriptionId,
		@AppId AS AppId,
		@AppSecret AS AppSecret
END;]]></Value>
			</Property>
			<Property Name="IsAnsiNullsOn" Value="True" />
			<Relationship Name="BodyDependencies">
				<Entry>
					<References ExternalSource="BuiltIns" Name="[nvarchar]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[nvarchar]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[nvarchar]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[nvarchar]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[nvarchar]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[char]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[nvarchar]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[CurrentExecution]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[CurrentExecution].[PipelineName]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[CurrentExecution].[OrchestratorName]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[CurrentExecution].[OrchestratorType]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[CurrentExecution].[LocalExecutionId]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[GetWorkerAuthDetails].[@ExecutionId]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[CurrentExecution].[StageId]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[GetWorkerAuthDetails].[@StageId]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[CurrentExecution].[PipelineId]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[GetWorkerAuthDetails].[@PipelineId]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[GetPropertyValueInternal]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[ServicePrincipals]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[PipelineAuthLink]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[ServicePrincipals].[CredentialId]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[PipelineAuthLink].[CredentialId]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[Pipelines]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[PipelineAuthLink].[PipelineId]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[Pipelines].[PipelineId]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[Orchestrators]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[Pipelines].[OrchestratorId]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[Orchestrators].[OrchestratorId]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[PipelineAuthLink].[OrchestratorId]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[Subscriptions]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[Orchestrators].[SubscriptionId]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[Subscriptions].[SubscriptionId]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[Subscriptions].[TenantId]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[ServicePrincipals].[PrincipalId]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[nvarchar]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[ServicePrincipals].[PrincipalSecret]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[Pipelines].[PipelineName]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[Orchestrators].[OrchestratorName]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[Orchestrators].[OrchestratorType]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[PipelineAuthLink].[OrchestratorId]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[Orchestrators].[OrchestratorId]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[Orchestrators].[SubscriptionId]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[Subscriptions].[SubscriptionId]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[Subscriptions].[TenantId]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[ServicePrincipals].[PrincipalId]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[nvarchar]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[ServicePrincipals].[PrincipalSecret]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[Orchestrators].[OrchestratorName]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[Orchestrators].[OrchestratorType]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[Subscriptions].[TenantId]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[Subscriptions].[SubscriptionId]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[ServicePrincipals].[PrincipalId]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[ServicePrincipals].[PrincipalIdUrl]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[ServicePrincipals].[PrincipalSecretUrl]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[ServicePrincipals].[PrincipalIdUrl]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[ServicePrincipals].[PrincipalSecretUrl]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[ServicePrincipals].[PrincipalIdUrl]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[ServicePrincipals].[PrincipalSecretUrl]" />
				</Entry>
			</Relationship>
			<Relationship Name="DynamicObjects">
				<Entry>
					<Element Type="SqlDynamicColumnSource" Name="[metadata].[GetWorkerAuthDetails].[CTE1].[cte]">
						<Relationship Name="Columns">
							<Entry>
								<Element Type="SqlComputedColumn" Name="[metadata].[GetWorkerAuthDetails].[CTE1].[cte].[TenantId]">
									<Relationship Name="ExpressionDependencies">
										<Entry>
											<References Name="[metadata].[Subscriptions].[TenantId]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
							<Entry>
								<Element Type="SqlComputedColumn" Name="[metadata].[GetWorkerAuthDetails].[CTE1].[cte].[SubscriptionId]">
									<Relationship Name="ExpressionDependencies">
										<Entry>
											<References Name="[metadata].[Subscriptions].[SubscriptionId]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
							<Entry>
								<Element Type="SqlComputedColumn" Name="[metadata].[GetWorkerAuthDetails].[CTE1].[cte].[AppId]">
									<Relationship Name="ExpressionDependencies">
										<Entry>
											<References Name="[dbo].[ServicePrincipals].[PrincipalId]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
							<Entry>
								<Element Type="SqlComputedColumn" Name="[metadata].[GetWorkerAuthDetails].[CTE1].[cte].[AppSecret]" />
							</Entry>
						</Relationship>
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlDynamicColumnSource" Name="[metadata].[GetWorkerAuthDetails].[CTE2].[cte]">
						<Relationship Name="Columns">
							<Entry>
								<Element Type="SqlComputedColumn" Name="[metadata].[GetWorkerAuthDetails].[CTE2].[cte].[TenantId]">
									<Relationship Name="ExpressionDependencies">
										<Entry>
											<References Name="[metadata].[Subscriptions].[TenantId]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
							<Entry>
								<Element Type="SqlComputedColumn" Name="[metadata].[GetWorkerAuthDetails].[CTE2].[cte].[SubscriptionId]">
									<Relationship Name="ExpressionDependencies">
										<Entry>
											<References Name="[metadata].[Subscriptions].[SubscriptionId]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
							<Entry>
								<Element Type="SqlComputedColumn" Name="[metadata].[GetWorkerAuthDetails].[CTE2].[cte].[AppId]">
									<Relationship Name="ExpressionDependencies">
										<Entry>
											<References Name="[dbo].[ServicePrincipals].[PrincipalIdUrl]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
							<Entry>
								<Element Type="SqlComputedColumn" Name="[metadata].[GetWorkerAuthDetails].[CTE2].[cte].[AppSecret]">
									<Relationship Name="ExpressionDependencies">
										<Entry>
											<References Name="[dbo].[ServicePrincipals].[PrincipalSecretUrl]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
			</Relationship>
			<Relationship Name="Parameters">
				<Entry>
					<Element Type="SqlSubroutineParameter" Name="[metadata].[GetWorkerAuthDetails].[@ExecutionId]">
						<Relationship Name="Type">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[uniqueidentifier]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlSubroutineParameter" Name="[metadata].[GetWorkerAuthDetails].[@StageId]">
						<Relationship Name="Type">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[int]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlSubroutineParameter" Name="[metadata].[GetWorkerAuthDetails].[@PipelineId]">
						<Relationship Name="Type">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[int]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
			</Relationship>
			<Relationship Name="Schema">
				<Entry>
					<References Name="[metadata]" />
				</Entry>
			</Relationship>
			<Annotation Type="SysCommentsObjectAnnotation">
				<Property Name="Length" Value="4750" />
				<Property Name="StartLine" Value="1" />
				<Property Name="StartColumn" Value="1" />
				<Property Name="HeaderContents" Value="CREATE PROCEDURE [metadata].[GetWorkerAuthDetails]&#xD;&#xA;&#x9;(&#xD;&#xA;&#x9;@ExecutionId UNIQUEIDENTIFIER,&#xD;&#xA;&#x9;@StageId INT,&#xD;&#xA;&#x9;@PipelineId INT&#xD;&#xA;&#x9;)&#xD;&#xA;AS" />
			</Annotation>
		</Element>
		<Element Type="SqlProcedure" Name="[metadata].[GetWorkerDetailsWrapper]">
			<Property Name="BodyScript">
				<Value><![CDATA[
BEGIN
	/*
	Created this proc just to reduce and refactor the number of pipeline activity 
	calls needed due to the Microsoft enforced limit of 40 activities per pipeline.
	*/
	SET NOCOUNT ON;

	DECLARE @WorkerAuthDetails TABLE
		(
		[tenantId] UNIQUEIDENTIFIER NULL,
		[applicationId] NVARCHAR(MAX) NULL,
		[authenticationKey] NVARCHAR(MAX) NULL,
		[subscriptionId] UNIQUEIDENTIFIER NULL
		)

	DECLARE @WorkerDetails TABLE
		(
		[resourceGroupName] NVARCHAR(200) NULL,
		[orchestratorName] NVARCHAR(200) NULL,
		[orchestratorType] CHAR(3) NULL,
		[pipelineName] NVARCHAR(200) NULL
		)

	--get work auth details
	INSERT INTO @WorkerAuthDetails
		(
		[tenantId],
		[subscriptionId],
		[applicationId],
		[authenticationKey]
		)
	EXEC [metadata].[GetWorkerAuthDetails]
		@ExecutionId = @ExecutionId,
		@StageId = @StageId,
		@PipelineId = @PipelineId;
	
	--get main worker details
	INSERT INTO @WorkerDetails
		(
		[pipelineName],
		[orchestratorName],
		[orchestratorType],
		[resourceGroupName]
		)
	EXEC [metadata].[GetWorkerPipelineDetails]
		@ExecutionId = @ExecutionId,
		@StageId = @StageId,
		@PipelineId = @PipelineId;		
	
	--return all details
	SELECT  
		ad.[tenantId],
		ad.[applicationId],
		ad.[authenticationKey],		
		ad.[subscriptionId],
		d.[resourceGroupName],
		d.[orchestratorName],
		d.[orchestratorType],
		d.[pipelineName]
	FROM 
		@WorkerDetails d 
		CROSS JOIN @WorkerAuthDetails ad;
END;]]></Value>
			</Property>
			<Property Name="IsAnsiNullsOn" Value="True" />
			<Relationship Name="BodyDependencies">
				<Entry>
					<References Name="[metadata].[GetWorkerDetailsWrapper].[@WorkerAuthDetails].[tenantId]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[GetWorkerDetailsWrapper].[@WorkerAuthDetails].[subscriptionId]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[GetWorkerDetailsWrapper].[@WorkerAuthDetails].[applicationId]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[GetWorkerDetailsWrapper].[@WorkerAuthDetails].[authenticationKey]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[GetWorkerAuthDetails]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[GetWorkerAuthDetails].[@ExecutionId]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[GetWorkerDetailsWrapper].[@ExecutionId]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[GetWorkerAuthDetails].[@StageId]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[GetWorkerDetailsWrapper].[@StageId]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[GetWorkerAuthDetails].[@PipelineId]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[GetWorkerDetailsWrapper].[@PipelineId]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[GetWorkerDetailsWrapper].[@WorkerDetails].[pipelineName]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[GetWorkerDetailsWrapper].[@WorkerDetails].[orchestratorName]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[GetWorkerDetailsWrapper].[@WorkerDetails].[orchestratorType]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[GetWorkerDetailsWrapper].[@WorkerDetails].[resourceGroupName]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[GetWorkerPipelineDetails]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[GetWorkerPipelineDetails].[@ExecutionId]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[GetWorkerPipelineDetails].[@StageId]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[GetWorkerPipelineDetails].[@PipelineId]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[GetWorkerDetailsWrapper].[@WorkerAuthDetails].[tenantId]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[GetWorkerDetailsWrapper].[@WorkerAuthDetails].[applicationId]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[GetWorkerDetailsWrapper].[@WorkerAuthDetails].[authenticationKey]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[GetWorkerDetailsWrapper].[@WorkerAuthDetails].[subscriptionId]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[GetWorkerDetailsWrapper].[@WorkerDetails].[resourceGroupName]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[GetWorkerDetailsWrapper].[@WorkerDetails].[orchestratorName]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[GetWorkerDetailsWrapper].[@WorkerDetails].[orchestratorType]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[GetWorkerDetailsWrapper].[@WorkerDetails].[pipelineName]" />
				</Entry>
			</Relationship>
			<Relationship Name="DynamicObjects">
				<Entry>
					<Element Type="SqlDynamicColumnSource" Name="[metadata].[GetWorkerDetailsWrapper].[@WorkerAuthDetails]">
						<Relationship Name="Columns">
							<Entry>
								<Element Type="SqlSimpleColumn" Name="[metadata].[GetWorkerDetailsWrapper].[@WorkerAuthDetails].[tenantId]">
									<Relationship Name="TypeSpecifier">
										<Entry>
											<Element Type="SqlTypeSpecifier">
												<Relationship Name="Type">
													<Entry>
														<References ExternalSource="BuiltIns" Name="[uniqueidentifier]" />
													</Entry>
												</Relationship>
											</Element>
										</Entry>
									</Relationship>
								</Element>
							</Entry>
							<Entry>
								<Element Type="SqlSimpleColumn" Name="[metadata].[GetWorkerDetailsWrapper].[@WorkerAuthDetails].[applicationId]">
									<Relationship Name="TypeSpecifier">
										<Entry>
											<Element Type="SqlTypeSpecifier">
												<Property Name="IsMax" Value="True" />
												<Relationship Name="Type">
													<Entry>
														<References ExternalSource="BuiltIns" Name="[nvarchar]" />
													</Entry>
												</Relationship>
											</Element>
										</Entry>
									</Relationship>
								</Element>
							</Entry>
							<Entry>
								<Element Type="SqlSimpleColumn" Name="[metadata].[GetWorkerDetailsWrapper].[@WorkerAuthDetails].[authenticationKey]">
									<Relationship Name="TypeSpecifier">
										<Entry>
											<Element Type="SqlTypeSpecifier">
												<Property Name="IsMax" Value="True" />
												<Relationship Name="Type">
													<Entry>
														<References ExternalSource="BuiltIns" Name="[nvarchar]" />
													</Entry>
												</Relationship>
											</Element>
										</Entry>
									</Relationship>
								</Element>
							</Entry>
							<Entry>
								<Element Type="SqlSimpleColumn" Name="[metadata].[GetWorkerDetailsWrapper].[@WorkerAuthDetails].[subscriptionId]">
									<Relationship Name="TypeSpecifier">
										<Entry>
											<Element Type="SqlTypeSpecifier">
												<Relationship Name="Type">
													<Entry>
														<References ExternalSource="BuiltIns" Name="[uniqueidentifier]" />
													</Entry>
												</Relationship>
											</Element>
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlDynamicColumnSource" Name="[metadata].[GetWorkerDetailsWrapper].[@WorkerDetails]">
						<Relationship Name="Columns">
							<Entry>
								<Element Type="SqlSimpleColumn" Name="[metadata].[GetWorkerDetailsWrapper].[@WorkerDetails].[resourceGroupName]">
									<Relationship Name="TypeSpecifier">
										<Entry>
											<Element Type="SqlTypeSpecifier">
												<Property Name="Length" Value="200" />
												<Relationship Name="Type">
													<Entry>
														<References ExternalSource="BuiltIns" Name="[nvarchar]" />
													</Entry>
												</Relationship>
											</Element>
										</Entry>
									</Relationship>
								</Element>
							</Entry>
							<Entry>
								<Element Type="SqlSimpleColumn" Name="[metadata].[GetWorkerDetailsWrapper].[@WorkerDetails].[orchestratorName]">
									<Relationship Name="TypeSpecifier">
										<Entry>
											<Element Type="SqlTypeSpecifier">
												<Property Name="Length" Value="200" />
												<Relationship Name="Type">
													<Entry>
														<References ExternalSource="BuiltIns" Name="[nvarchar]" />
													</Entry>
												</Relationship>
											</Element>
										</Entry>
									</Relationship>
								</Element>
							</Entry>
							<Entry>
								<Element Type="SqlSimpleColumn" Name="[metadata].[GetWorkerDetailsWrapper].[@WorkerDetails].[orchestratorType]">
									<Relationship Name="TypeSpecifier">
										<Entry>
											<Element Type="SqlTypeSpecifier">
												<Property Name="Length" Value="3" />
												<Relationship Name="Type">
													<Entry>
														<References ExternalSource="BuiltIns" Name="[char]" />
													</Entry>
												</Relationship>
											</Element>
										</Entry>
									</Relationship>
								</Element>
							</Entry>
							<Entry>
								<Element Type="SqlSimpleColumn" Name="[metadata].[GetWorkerDetailsWrapper].[@WorkerDetails].[pipelineName]">
									<Relationship Name="TypeSpecifier">
										<Entry>
											<Element Type="SqlTypeSpecifier">
												<Property Name="Length" Value="200" />
												<Relationship Name="Type">
													<Entry>
														<References ExternalSource="BuiltIns" Name="[nvarchar]" />
													</Entry>
												</Relationship>
											</Element>
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
			</Relationship>
			<Relationship Name="Parameters">
				<Entry>
					<Element Type="SqlSubroutineParameter" Name="[metadata].[GetWorkerDetailsWrapper].[@ExecutionId]">
						<Relationship Name="Type">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[uniqueidentifier]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlSubroutineParameter" Name="[metadata].[GetWorkerDetailsWrapper].[@StageId]">
						<Relationship Name="Type">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[int]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlSubroutineParameter" Name="[metadata].[GetWorkerDetailsWrapper].[@PipelineId]">
						<Relationship Name="Type">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[int]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
			</Relationship>
			<Relationship Name="Schema">
				<Entry>
					<References Name="[metadata]" />
				</Entry>
			</Relationship>
			<Annotation Type="SysCommentsObjectAnnotation">
				<Property Name="Length" Value="1606" />
				<Property Name="StartLine" Value="1" />
				<Property Name="StartColumn" Value="1" />
				<Property Name="HeaderContents" Value="CREATE PROCEDURE [metadata].[GetWorkerDetailsWrapper]&#xD;&#xA;&#x9;(&#xD;&#xA;&#x9;@ExecutionId UNIQUEIDENTIFIER,&#xD;&#xA;&#x9;@StageId INT,&#xD;&#xA;&#x9;@PipelineId INT&#xD;&#xA;&#x9;)&#xD;&#xA;AS" />
			</Annotation>
		</Element>
		<Element Type="SqlProcedure" Name="[metadata].[GetWorkerPipelineDetails]">
			<Property Name="BodyScript">
				<Value><![CDATA[
BEGIN
	SET NOCOUNT ON;

	SELECT 
		[PipelineName],
		[OrchestratorName],
		[OrchestratorType],
		[ResourceGroupName]
	FROM 
		[metadata].[CurrentExecution]
	WHERE 
		[LocalExecutionId] = @ExecutionId
		AND [StageId] = @StageId
		AND [PipelineId] = @PipelineId;
END;]]></Value>
			</Property>
			<Property Name="IsAnsiNullsOn" Value="True" />
			<Relationship Name="BodyDependencies">
				<Entry>
					<References Name="[metadata].[CurrentExecution]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[CurrentExecution].[PipelineName]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[CurrentExecution].[OrchestratorName]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[CurrentExecution].[OrchestratorType]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[CurrentExecution].[ResourceGroupName]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[CurrentExecution].[LocalExecutionId]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[GetWorkerPipelineDetails].[@ExecutionId]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[CurrentExecution].[StageId]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[GetWorkerPipelineDetails].[@StageId]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[CurrentExecution].[PipelineId]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[GetWorkerPipelineDetails].[@PipelineId]" />
				</Entry>
			</Relationship>
			<Relationship Name="Parameters">
				<Entry>
					<Element Type="SqlSubroutineParameter" Name="[metadata].[GetWorkerPipelineDetails].[@ExecutionId]">
						<Relationship Name="Type">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[uniqueidentifier]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlSubroutineParameter" Name="[metadata].[GetWorkerPipelineDetails].[@StageId]">
						<Relationship Name="Type">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[int]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlSubroutineParameter" Name="[metadata].[GetWorkerPipelineDetails].[@PipelineId]">
						<Relationship Name="Type">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[int]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
			</Relationship>
			<Relationship Name="Schema">
				<Entry>
					<References Name="[metadata]" />
				</Entry>
			</Relationship>
			<Annotation Type="SysCommentsObjectAnnotation">
				<Property Name="Length" Value="414" />
				<Property Name="StartLine" Value="1" />
				<Property Name="StartColumn" Value="1" />
				<Property Name="HeaderContents" Value="CREATE PROCEDURE [metadata].[GetWorkerPipelineDetails]&#xD;&#xA;&#x9;(&#xD;&#xA;&#x9;@ExecutionId UNIQUEIDENTIFIER,&#xD;&#xA;&#x9;@StageId INT,&#xD;&#xA;&#x9;@PipelineId INT&#xD;&#xA;&#x9;)&#xD;&#xA;AS" />
			</Annotation>
		</Element>
		<Element Type="SqlSynonym" Name="[metadata].[LastExecution]">
			<Property Name="ForObjectScript">
				<Value><![CDATA[[metadataReporting].[LastExecution]]]></Value>
			</Property>
			<Relationship Name="ForObject">
				<Entry>
					<References Name="[metadataReporting].[LastExecution]" />
					<Annotation Type="PersistedResolvableAnnotation" Name="[metadataReporting].[LastExecution]">
						<Property Name="TargetTypeStorage" Value="ISqlSynonymTarget" />
						<Property Name="Length" Value="35" />
						<Property Name="Offset" Value="47" />
					</Annotation>
				</Entry>
			</Relationship>
			<Relationship Name="Schema">
				<Entry>
					<References Name="[metadata]" />
				</Entry>
			</Relationship>
		</Element>
		<Element Type="SqlSynonym" Name="[metadata].[LastExecutionSummary]">
			<Property Name="ForObjectScript">
				<Value><![CDATA[[metadataReporting].[LastExecutionSummary]]]></Value>
			</Property>
			<Relationship Name="ForObject">
				<Entry>
					<References Name="[metadataReporting].[LastExecutionSummary]" />
					<Annotation Type="PersistedResolvableAnnotation" Name="[metadataReporting].[LastExecutionSummary]">
						<Property Name="TargetTypeStorage" Value="ISqlSynonymTarget" />
						<Property Name="Length" Value="42" />
						<Property Name="Offset" Value="54" />
					</Annotation>
				</Entry>
			</Relationship>
			<Relationship Name="Schema">
				<Entry>
					<References Name="[metadata]" />
				</Entry>
			</Relationship>
		</Element>
		<Element Type="SqlCheckConstraint" Name="[metadata].[MessagePreferenceValue]">
			<Property Name="CheckExpressionScript">
				<Value><![CDATA[[MessagePreference] IN ('TO','CC','BCC')]]></Value>
			</Property>
			<Relationship Name="CheckExpressionDependencies">
				<Entry>
					<References Name="[metadata].[Recipients].[MessagePreference]" />
				</Entry>
			</Relationship>
			<Relationship Name="DefiningTable">
				<Entry>
					<References Name="[metadata].[Recipients]" />
				</Entry>
			</Relationship>
			<Annotation Type="SqlInlineConstraintAnnotation" Disambiguator="44" />
		</Element>
		<Element Type="SqlTable" Name="[metadata].[Orchestrators]">
			<Property Name="IsAnsiNullsOn" Value="True" />
			<Relationship Name="Columns">
				<Entry>
					<Element Type="SqlSimpleColumn" Name="[metadata].[Orchestrators].[OrchestratorId]">
						<Property Name="IsNullable" Value="False" />
						<Property Name="IsIdentity" Value="True" />
						<Relationship Name="TypeSpecifier">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[int]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlSimpleColumn" Name="[metadata].[Orchestrators].[OrchestratorName]">
						<Property Name="IsNullable" Value="False" />
						<Relationship Name="TypeSpecifier">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Property Name="Length" Value="200" />
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[nvarchar]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlSimpleColumn" Name="[metadata].[Orchestrators].[OrchestratorType]">
						<Property Name="IsNullable" Value="False" />
						<Relationship Name="TypeSpecifier">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Property Name="Length" Value="3" />
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[char]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlSimpleColumn" Name="[metadata].[Orchestrators].[IsFrameworkOrchestrator]">
						<Property Name="IsNullable" Value="False" />
						<Relationship Name="TypeSpecifier">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[bit]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
						<AttachedAnnotation Disambiguator="11" />
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlSimpleColumn" Name="[metadata].[Orchestrators].[ResourceGroupName]">
						<Property Name="IsNullable" Value="False" />
						<Relationship Name="TypeSpecifier">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Property Name="Length" Value="200" />
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[nvarchar]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlSimpleColumn" Name="[metadata].[Orchestrators].[SubscriptionId]">
						<Property Name="IsNullable" Value="False" />
						<Relationship Name="TypeSpecifier">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[uniqueidentifier]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlSimpleColumn" Name="[metadata].[Orchestrators].[Description]">
						<Relationship Name="TypeSpecifier">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Property Name="IsMax" Value="True" />
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[nvarchar]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
			</Relationship>
			<Relationship Name="Schema">
				<Entry>
					<References Name="[metadata]" />
				</Entry>
			</Relationship>
			<Annotation Type="SqlInlineConstraintAnnotation" Disambiguator="45" />
			<AttachedAnnotation Disambiguator="31" />
			<Annotation Type="SqlInlineConstraintAnnotation" Disambiguator="46" />
		</Element>
		<Element Type="SqlCheckConstraint" Name="[metadata].[OrchestratorType]">
			<Property Name="CheckExpressionScript">
				<Value><![CDATA[[OrchestratorType] IN ('ADF','SYN')]]></Value>
			</Property>
			<Relationship Name="CheckExpressionDependencies">
				<Entry>
					<References Name="[metadata].[Orchestrators].[OrchestratorType]" />
				</Entry>
			</Relationship>
			<Relationship Name="DefiningTable">
				<Entry>
					<References Name="[metadata].[Orchestrators]" />
				</Entry>
			</Relationship>
			<AttachedAnnotation Disambiguator="45" />
		</Element>
		<Element Type="SqlTable" Name="[metadata].[PipelineAlertLink]">
			<Property Name="IsAnsiNullsOn" Value="True" />
			<Relationship Name="Columns">
				<Entry>
					<Element Type="SqlSimpleColumn" Name="[metadata].[PipelineAlertLink].[AlertId]">
						<Property Name="IsNullable" Value="False" />
						<Property Name="IsIdentity" Value="True" />
						<Relationship Name="TypeSpecifier">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[int]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlSimpleColumn" Name="[metadata].[PipelineAlertLink].[PipelineId]">
						<Property Name="IsNullable" Value="False" />
						<Relationship Name="TypeSpecifier">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[int]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlSimpleColumn" Name="[metadata].[PipelineAlertLink].[RecipientId]">
						<Property Name="IsNullable" Value="False" />
						<Relationship Name="TypeSpecifier">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[int]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlSimpleColumn" Name="[metadata].[PipelineAlertLink].[OutcomesBitValue]">
						<Property Name="IsNullable" Value="False" />
						<Relationship Name="TypeSpecifier">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[int]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlSimpleColumn" Name="[metadata].[PipelineAlertLink].[Enabled]">
						<Property Name="IsNullable" Value="False" />
						<Relationship Name="TypeSpecifier">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[bit]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
						<AttachedAnnotation Disambiguator="12" />
					</Element>
				</Entry>
			</Relationship>
			<Relationship Name="Schema">
				<Entry>
					<References Name="[metadata]" />
				</Entry>
			</Relationship>
			<Annotation Type="SqlInlineConstraintAnnotation" Disambiguator="47" />
			<AttachedAnnotation Disambiguator="32" />
			<AttachedAnnotation Disambiguator="33" />
		</Element>
		<Element Type="SqlTable" Name="[metadata].[PipelineAuthLink]">
			<Property Name="IsAnsiNullsOn" Value="True" />
			<Relationship Name="Columns">
				<Entry>
					<Element Type="SqlSimpleColumn" Name="[metadata].[PipelineAuthLink].[AuthId]">
						<Property Name="IsNullable" Value="False" />
						<Property Name="IsIdentity" Value="True" />
						<Relationship Name="TypeSpecifier">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[int]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlSimpleColumn" Name="[metadata].[PipelineAuthLink].[PipelineId]">
						<Property Name="IsNullable" Value="False" />
						<Relationship Name="TypeSpecifier">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[int]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlSimpleColumn" Name="[metadata].[PipelineAuthLink].[OrchestratorId]">
						<Property Name="IsNullable" Value="False" />
						<Relationship Name="TypeSpecifier">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[int]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlSimpleColumn" Name="[metadata].[PipelineAuthLink].[CredentialId]">
						<Property Name="IsNullable" Value="False" />
						<Relationship Name="TypeSpecifier">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[int]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
			</Relationship>
			<Relationship Name="Schema">
				<Entry>
					<References Name="[metadata]" />
				</Entry>
			</Relationship>
			<Annotation Type="SqlInlineConstraintAnnotation" Disambiguator="48" />
			<AttachedAnnotation Disambiguator="34" />
			<AttachedAnnotation Disambiguator="35" />
			<AttachedAnnotation Disambiguator="36" />
		</Element>
		<Element Type="SqlTable" Name="[metadata].[PipelineDependencies]">
			<Property Name="IsAnsiNullsOn" Value="True" />
			<Relationship Name="Columns">
				<Entry>
					<Element Type="SqlSimpleColumn" Name="[metadata].[PipelineDependencies].[DependencyId]">
						<Property Name="IsNullable" Value="False" />
						<Property Name="IsIdentity" Value="True" />
						<Relationship Name="TypeSpecifier">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[int]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlSimpleColumn" Name="[metadata].[PipelineDependencies].[PipelineId]">
						<Property Name="IsNullable" Value="False" />
						<Relationship Name="TypeSpecifier">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[int]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlSimpleColumn" Name="[metadata].[PipelineDependencies].[DependantPipelineId]">
						<Property Name="IsNullable" Value="False" />
						<Relationship Name="TypeSpecifier">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[int]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
			</Relationship>
			<Relationship Name="Schema">
				<Entry>
					<References Name="[metadata]" />
				</Entry>
			</Relationship>
			<Annotation Type="SqlInlineConstraintAnnotation" Disambiguator="49" />
			<AttachedAnnotation Disambiguator="37" />
			<AttachedAnnotation Disambiguator="38" />
			<Annotation Type="SqlInlineConstraintAnnotation" Disambiguator="50" />
			<AttachedAnnotation Disambiguator="28" />
		</Element>
		<Element Type="SqlSynonym" Name="[metadata].[PipelineDependencyChains]">
			<Property Name="ForObjectScript">
				<Value><![CDATA[[metadataHelpers].[PipelineDependencyChains]]]></Value>
			</Property>
			<Relationship Name="ForObject">
				<Entry>
					<References Name="[metadataHelpers].[PipelineDependencyChains]" />
					<Annotation Type="PersistedResolvableAnnotation" Name="[metadataHelpers].[PipelineDependencyChains]">
						<Property Name="TargetTypeStorage" Value="ISqlSynonymTarget" />
						<Property Name="Length" Value="44" />
						<Property Name="Offset" Value="58" />
					</Annotation>
				</Entry>
			</Relationship>
			<Relationship Name="Schema">
				<Entry>
					<References Name="[metadata]" />
				</Entry>
			</Relationship>
		</Element>
		<Element Type="SqlView" Name="[metadata].[PipelineParameterDataSizes]">
			<Property Name="QueryScript">
				<Value><![CDATA[

SELECT 
	[PipelineId],
	SUM(
		(CAST(
			DATALENGTH(
				STRING_ESCAPE([ParameterName] + [ParameterValue],'json')) AS DECIMAL)
			/1024) --KB
			/1024 --MB
		) AS Size
FROM 
	[metadata].[PipelineParameters]
GROUP BY
	[PipelineId]]]></Value>
			</Property>
			<Property Name="IsAnsiNullsOn" Value="True" />
			<Relationship Name="Columns">
				<Entry>
					<Element Type="SqlComputedColumn" Name="[metadata].[PipelineParameterDataSizes].[PipelineId]">
						<Relationship Name="ExpressionDependencies">
							<Entry>
								<References Name="[metadata].[PipelineParameters].[PipelineId]" />
							</Entry>
						</Relationship>
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlComputedColumn" Name="[metadata].[PipelineParameterDataSizes].[Size]" />
				</Entry>
			</Relationship>
			<Relationship Name="QueryDependencies">
				<Entry>
					<References Name="[metadata].[PipelineParameters]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[PipelineParameters].[PipelineId]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[decimal]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[PipelineParameters].[ParameterName]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[PipelineParameters].[ParameterValue]" />
				</Entry>
			</Relationship>
			<Relationship Name="Schema">
				<Entry>
					<References Name="[metadata]" />
				</Entry>
			</Relationship>
			<Annotation Type="SysCommentsObjectAnnotation">
				<Property Name="Length" Value="301" />
				<Property Name="StartLine" Value="1" />
				<Property Name="StartColumn" Value="1" />
				<Property Name="HeaderContents" Value="CREATE VIEW [metadata].[PipelineParameterDataSizes]&#xD;&#xA;AS" />
				<Property Name="FooterContents" Value=";" />
			</Annotation>
		</Element>
		<Element Type="SqlTable" Name="[metadata].[PipelineParameters]">
			<Property Name="IsAnsiNullsOn" Value="True" />
			<Relationship Name="Columns">
				<Entry>
					<Element Type="SqlSimpleColumn" Name="[metadata].[PipelineParameters].[ParameterId]">
						<Property Name="IsNullable" Value="False" />
						<Property Name="IsIdentity" Value="True" />
						<Relationship Name="TypeSpecifier">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[int]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlSimpleColumn" Name="[metadata].[PipelineParameters].[PipelineId]">
						<Property Name="IsNullable" Value="False" />
						<Relationship Name="TypeSpecifier">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[int]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlSimpleColumn" Name="[metadata].[PipelineParameters].[ParameterName]">
						<Property Name="IsNullable" Value="False" />
						<Relationship Name="TypeSpecifier">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Property Name="Length" Value="128" />
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[varchar]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlSimpleColumn" Name="[metadata].[PipelineParameters].[ParameterValue]">
						<Relationship Name="TypeSpecifier">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Property Name="IsMax" Value="True" />
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[nvarchar]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlSimpleColumn" Name="[metadata].[PipelineParameters].[ParameterValueLastUsed]">
						<Relationship Name="TypeSpecifier">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Property Name="IsMax" Value="True" />
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[nvarchar]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
			</Relationship>
			<Relationship Name="Schema">
				<Entry>
					<References Name="[metadata]" />
				</Entry>
			</Relationship>
			<Annotation Type="SqlInlineConstraintAnnotation" Disambiguator="51" />
			<AttachedAnnotation Disambiguator="39" />
		</Element>
		<Element Type="SqlSynonym" Name="[metadata].[PipelineProcesses]">
			<Property Name="ForObjectScript">
				<Value><![CDATA[[metadata].[Pipelines]]]></Value>
			</Property>
			<Relationship Name="ForObject">
				<Entry>
					<References Name="[metadata].[Pipelines]" />
					<Annotation Type="PersistedResolvableAnnotation" Name="[metadata].[Pipelines]">
						<Property Name="TargetTypeStorage" Value="ISqlSynonymTarget" />
						<Property Name="Length" Value="22" />
						<Property Name="Offset" Value="51" />
					</Annotation>
				</Entry>
			</Relationship>
			<Relationship Name="Schema">
				<Entry>
					<References Name="[metadata]" />
				</Entry>
			</Relationship>
		</Element>
		<Element Type="SqlTable" Name="[metadata].[Pipelines]">
			<Property Name="IsAnsiNullsOn" Value="True" />
			<Relationship Name="Columns">
				<Entry>
					<Element Type="SqlSimpleColumn" Name="[metadata].[Pipelines].[PipelineId]">
						<Property Name="IsNullable" Value="False" />
						<Property Name="IsIdentity" Value="True" />
						<Relationship Name="TypeSpecifier">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[int]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlSimpleColumn" Name="[metadata].[Pipelines].[OrchestratorId]">
						<Property Name="IsNullable" Value="False" />
						<Relationship Name="TypeSpecifier">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[int]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlSimpleColumn" Name="[metadata].[Pipelines].[StageId]">
						<Property Name="IsNullable" Value="False" />
						<Relationship Name="TypeSpecifier">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[int]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlSimpleColumn" Name="[metadata].[Pipelines].[PipelineName]">
						<Property Name="IsNullable" Value="False" />
						<Relationship Name="TypeSpecifier">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Property Name="Length" Value="200" />
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[nvarchar]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlSimpleColumn" Name="[metadata].[Pipelines].[LogicalPredecessorId]">
						<Relationship Name="TypeSpecifier">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[int]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlSimpleColumn" Name="[metadata].[Pipelines].[Enabled]">
						<Property Name="IsNullable" Value="False" />
						<Relationship Name="TypeSpecifier">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[bit]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
						<AttachedAnnotation Disambiguator="25" />
					</Element>
				</Entry>
			</Relationship>
			<Relationship Name="Schema">
				<Entry>
					<References Name="[metadata]" />
				</Entry>
			</Relationship>
			<Annotation Type="SqlInlineConstraintAnnotation" Disambiguator="52" />
			<AttachedAnnotation Disambiguator="42" />
			<AttachedAnnotation Disambiguator="40" />
			<AttachedAnnotation Disambiguator="41" />
		</Element>
		<Element Type="SqlPrimaryKeyConstraint" Name="[metadata].[PK_AlertOutcomes]">
			<Relationship Name="ColumnSpecifications">
				<Entry>
					<Element Type="SqlIndexedColumnSpecification">
						<Relationship Name="Column">
							<Entry>
								<References Name="[metadata].[AlertOutcomes].[OutcomeBitPosition]" />
							</Entry>
						</Relationship>
					</Element>
				</Entry>
			</Relationship>
			<Relationship Name="DefiningTable">
				<Entry>
					<References Name="[metadata].[AlertOutcomes]" />
				</Entry>
			</Relationship>
			<AttachedAnnotation Disambiguator="17" />
		</Element>
		<Element Type="SqlPrimaryKeyConstraint" Name="[metadata].[PK_Batches]">
			<Relationship Name="ColumnSpecifications">
				<Entry>
					<Element Type="SqlIndexedColumnSpecification">
						<Relationship Name="Column">
							<Entry>
								<References Name="[metadata].[Batches].[BatchId]" />
							</Entry>
						</Relationship>
					</Element>
				</Entry>
			</Relationship>
			<Relationship Name="DefiningTable">
				<Entry>
					<References Name="[metadata].[Batches]" />
				</Entry>
			</Relationship>
			<AttachedAnnotation Disambiguator="19" />
		</Element>
		<Element Type="SqlPrimaryKeyConstraint" Name="[metadata].[PK_BatchExecution]">
			<Relationship Name="ColumnSpecifications">
				<Entry>
					<Element Type="SqlIndexedColumnSpecification">
						<Relationship Name="Column">
							<Entry>
								<References Name="[metadata].[BatchExecution].[BatchId]" />
							</Entry>
						</Relationship>
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlIndexedColumnSpecification">
						<Relationship Name="Column">
							<Entry>
								<References Name="[metadata].[BatchExecution].[ExecutionId]" />
							</Entry>
						</Relationship>
					</Element>
				</Entry>
			</Relationship>
			<Relationship Name="DefiningTable">
				<Entry>
					<References Name="[metadata].[BatchExecution]" />
				</Entry>
			</Relationship>
			<AttachedAnnotation Disambiguator="20" />
		</Element>
		<Element Type="SqlPrimaryKeyConstraint" Name="[metadata].[PK_BatchStageLink]">
			<Relationship Name="ColumnSpecifications">
				<Entry>
					<Element Type="SqlIndexedColumnSpecification">
						<Relationship Name="Column">
							<Entry>
								<References Name="[metadata].[BatchStageLink].[BatchId]" />
							</Entry>
						</Relationship>
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlIndexedColumnSpecification">
						<Relationship Name="Column">
							<Entry>
								<References Name="[metadata].[BatchStageLink].[StageId]" />
							</Entry>
						</Relationship>
					</Element>
				</Entry>
			</Relationship>
			<Relationship Name="DefiningTable">
				<Entry>
					<References Name="[metadata].[BatchStageLink]" />
				</Entry>
			</Relationship>
			<AttachedAnnotation Disambiguator="21" />
		</Element>
		<Element Type="SqlPrimaryKeyConstraint" Name="[metadata].[PK_CurrentExecution]">
			<Relationship Name="ColumnSpecifications">
				<Entry>
					<Element Type="SqlIndexedColumnSpecification">
						<Relationship Name="Column">
							<Entry>
								<References Name="[metadata].[CurrentExecution].[LocalExecutionId]" />
							</Entry>
						</Relationship>
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlIndexedColumnSpecification">
						<Relationship Name="Column">
							<Entry>
								<References Name="[metadata].[CurrentExecution].[StageId]" />
							</Entry>
						</Relationship>
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlIndexedColumnSpecification">
						<Relationship Name="Column">
							<Entry>
								<References Name="[metadata].[CurrentExecution].[PipelineId]" />
							</Entry>
						</Relationship>
					</Element>
				</Entry>
			</Relationship>
			<Relationship Name="DefiningTable">
				<Entry>
					<References Name="[metadata].[CurrentExecution]" />
				</Entry>
			</Relationship>
			<AttachedAnnotation Disambiguator="24" />
		</Element>
		<Element Type="SqlPrimaryKeyConstraint" Name="[metadata].[PK_ErrorLog]">
			<Relationship Name="ColumnSpecifications">
				<Entry>
					<Element Type="SqlIndexedColumnSpecification">
						<Relationship Name="Column">
							<Entry>
								<References Name="[metadata].[ErrorLog].[LogId]" />
							</Entry>
						</Relationship>
					</Element>
				</Entry>
			</Relationship>
			<Relationship Name="DefiningTable">
				<Entry>
					<References Name="[metadata].[ErrorLog]" />
				</Entry>
			</Relationship>
			<AttachedAnnotation Disambiguator="29" />
		</Element>
		<Element Type="SqlPrimaryKeyConstraint" Name="[metadata].[PK_ExecutionLog]">
			<Relationship Name="ColumnSpecifications">
				<Entry>
					<Element Type="SqlIndexedColumnSpecification">
						<Relationship Name="Column">
							<Entry>
								<References Name="[metadata].[ExecutionLog].[LogId]" />
							</Entry>
						</Relationship>
					</Element>
				</Entry>
			</Relationship>
			<Relationship Name="DefiningTable">
				<Entry>
					<References Name="[metadata].[ExecutionLog]" />
				</Entry>
			</Relationship>
			<AttachedAnnotation Disambiguator="30" />
		</Element>
		<Element Type="SqlPrimaryKeyConstraint" Name="[metadata].[PK_Orchestrators]">
			<Relationship Name="ColumnSpecifications">
				<Entry>
					<Element Type="SqlIndexedColumnSpecification">
						<Relationship Name="Column">
							<Entry>
								<References Name="[metadata].[Orchestrators].[OrchestratorId]" />
							</Entry>
						</Relationship>
					</Element>
				</Entry>
			</Relationship>
			<Relationship Name="DefiningTable">
				<Entry>
					<References Name="[metadata].[Orchestrators]" />
				</Entry>
			</Relationship>
			<AttachedAnnotation Disambiguator="46" />
		</Element>
		<Element Type="SqlPrimaryKeyConstraint" Name="[metadata].[PK_PipelineAlertLink]">
			<Relationship Name="ColumnSpecifications">
				<Entry>
					<Element Type="SqlIndexedColumnSpecification">
						<Relationship Name="Column">
							<Entry>
								<References Name="[metadata].[PipelineAlertLink].[AlertId]" />
							</Entry>
						</Relationship>
					</Element>
				</Entry>
			</Relationship>
			<Relationship Name="DefiningTable">
				<Entry>
					<References Name="[metadata].[PipelineAlertLink]" />
				</Entry>
			</Relationship>
			<AttachedAnnotation Disambiguator="47" />
		</Element>
		<Element Type="SqlPrimaryKeyConstraint" Name="[metadata].[PK_PipelineAuthLink]">
			<Relationship Name="ColumnSpecifications">
				<Entry>
					<Element Type="SqlIndexedColumnSpecification">
						<Relationship Name="Column">
							<Entry>
								<References Name="[metadata].[PipelineAuthLink].[AuthId]" />
							</Entry>
						</Relationship>
					</Element>
				</Entry>
			</Relationship>
			<Relationship Name="DefiningTable">
				<Entry>
					<References Name="[metadata].[PipelineAuthLink]" />
				</Entry>
			</Relationship>
			<AttachedAnnotation Disambiguator="48" />
		</Element>
		<Element Type="SqlPrimaryKeyConstraint" Name="[metadata].[PK_PipelineDependencies]">
			<Relationship Name="ColumnSpecifications">
				<Entry>
					<Element Type="SqlIndexedColumnSpecification">
						<Relationship Name="Column">
							<Entry>
								<References Name="[metadata].[PipelineDependencies].[DependencyId]" />
							</Entry>
						</Relationship>
					</Element>
				</Entry>
			</Relationship>
			<Relationship Name="DefiningTable">
				<Entry>
					<References Name="[metadata].[PipelineDependencies]" />
				</Entry>
			</Relationship>
			<AttachedAnnotation Disambiguator="49" />
		</Element>
		<Element Type="SqlPrimaryKeyConstraint" Name="[metadata].[PK_PipelineParameters]">
			<Relationship Name="ColumnSpecifications">
				<Entry>
					<Element Type="SqlIndexedColumnSpecification">
						<Relationship Name="Column">
							<Entry>
								<References Name="[metadata].[PipelineParameters].[ParameterId]" />
							</Entry>
						</Relationship>
					</Element>
				</Entry>
			</Relationship>
			<Relationship Name="DefiningTable">
				<Entry>
					<References Name="[metadata].[PipelineParameters]" />
				</Entry>
			</Relationship>
			<AttachedAnnotation Disambiguator="51" />
		</Element>
		<Element Type="SqlPrimaryKeyConstraint" Name="[metadata].[PK_Pipelines]">
			<Relationship Name="ColumnSpecifications">
				<Entry>
					<Element Type="SqlIndexedColumnSpecification">
						<Relationship Name="Column">
							<Entry>
								<References Name="[metadata].[Pipelines].[PipelineId]" />
							</Entry>
						</Relationship>
					</Element>
				</Entry>
			</Relationship>
			<Relationship Name="DefiningTable">
				<Entry>
					<References Name="[metadata].[Pipelines]" />
				</Entry>
			</Relationship>
			<AttachedAnnotation Disambiguator="52" />
		</Element>
		<Element Type="SqlPrimaryKeyConstraint" Name="[metadata].[PK_Properties]">
			<Relationship Name="ColumnSpecifications">
				<Entry>
					<Element Type="SqlIndexedColumnSpecification">
						<Relationship Name="Column">
							<Entry>
								<References Name="[metadata].[Properties].[PropertyId]" />
							</Entry>
						</Relationship>
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlIndexedColumnSpecification">
						<Relationship Name="Column">
							<Entry>
								<References Name="[metadata].[Properties].[PropertyName]" />
							</Entry>
						</Relationship>
					</Element>
				</Entry>
			</Relationship>
			<Relationship Name="DefiningTable">
				<Entry>
					<References Name="[metadata].[Properties]" />
				</Entry>
			</Relationship>
			<Annotation Type="SqlInlineConstraintAnnotation" Disambiguator="53" />
		</Element>
		<Element Type="SqlPrimaryKeyConstraint" Name="[metadata].[PK_Recipients]">
			<Relationship Name="ColumnSpecifications">
				<Entry>
					<Element Type="SqlIndexedColumnSpecification">
						<Relationship Name="Column">
							<Entry>
								<References Name="[metadata].[Recipients].[RecipientId]" />
							</Entry>
						</Relationship>
					</Element>
				</Entry>
			</Relationship>
			<Relationship Name="DefiningTable">
				<Entry>
					<References Name="[metadata].[Recipients]" />
				</Entry>
			</Relationship>
			<Annotation Type="SqlInlineConstraintAnnotation" Disambiguator="54" />
		</Element>
		<Element Type="SqlPrimaryKeyConstraint" Name="[metadata].[PK_Stages]">
			<Relationship Name="ColumnSpecifications">
				<Entry>
					<Element Type="SqlIndexedColumnSpecification">
						<Relationship Name="Column">
							<Entry>
								<References Name="[metadata].[Stages].[StageId]" />
							</Entry>
						</Relationship>
					</Element>
				</Entry>
			</Relationship>
			<Relationship Name="DefiningTable">
				<Entry>
					<References Name="[metadata].[Stages]" />
				</Entry>
			</Relationship>
			<Annotation Type="SqlInlineConstraintAnnotation" Disambiguator="55" />
		</Element>
		<Element Type="SqlPrimaryKeyConstraint" Name="[metadata].[PK_Subscriptions]">
			<Relationship Name="ColumnSpecifications">
				<Entry>
					<Element Type="SqlIndexedColumnSpecification">
						<Relationship Name="Column">
							<Entry>
								<References Name="[metadata].[Subscriptions].[SubscriptionId]" />
							</Entry>
						</Relationship>
					</Element>
				</Entry>
			</Relationship>
			<Relationship Name="DefiningTable">
				<Entry>
					<References Name="[metadata].[Subscriptions]" />
				</Entry>
			</Relationship>
			<Annotation Type="SqlInlineConstraintAnnotation" Disambiguator="56" />
		</Element>
		<Element Type="SqlPrimaryKeyConstraint" Name="[metadata].[PK_Tenants]">
			<Relationship Name="ColumnSpecifications">
				<Entry>
					<Element Type="SqlIndexedColumnSpecification">
						<Relationship Name="Column">
							<Entry>
								<References Name="[metadata].[Tenants].[TenantId]" />
							</Entry>
						</Relationship>
					</Element>
				</Entry>
			</Relationship>
			<Relationship Name="DefiningTable">
				<Entry>
					<References Name="[metadata].[Tenants]" />
				</Entry>
			</Relationship>
			<Annotation Type="SqlInlineConstraintAnnotation" Disambiguator="57" />
		</Element>
		<Element Type="SqlSynonym" Name="[metadata].[ProcessingStageDetails]">
			<Property Name="ForObjectScript">
				<Value><![CDATA[[metadata].[Stages]]]></Value>
			</Property>
			<Relationship Name="ForObject">
				<Entry>
					<References Name="[metadata].[Stages]" />
					<Annotation Type="PersistedResolvableAnnotation" Name="[metadata].[Stages]">
						<Property Name="TargetTypeStorage" Value="ISqlSynonymTarget" />
						<Property Name="Length" Value="19" />
						<Property Name="Offset" Value="56" />
					</Annotation>
				</Entry>
			</Relationship>
			<Relationship Name="Schema">
				<Entry>
					<References Name="[metadata]" />
				</Entry>
			</Relationship>
		</Element>
		<Element Type="SqlTable" Name="[metadata].[Properties]">
			<Property Name="IsAnsiNullsOn" Value="True" />
			<Relationship Name="Columns">
				<Entry>
					<Element Type="SqlSimpleColumn" Name="[metadata].[Properties].[PropertyId]">
						<Property Name="IsNullable" Value="False" />
						<Property Name="IsIdentity" Value="True" />
						<Relationship Name="TypeSpecifier">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[int]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlSimpleColumn" Name="[metadata].[Properties].[PropertyName]">
						<Property Name="IsNullable" Value="False" />
						<Relationship Name="TypeSpecifier">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Property Name="Length" Value="128" />
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[varchar]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlSimpleColumn" Name="[metadata].[Properties].[PropertyValue]">
						<Property Name="IsNullable" Value="False" />
						<Relationship Name="TypeSpecifier">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Property Name="IsMax" Value="True" />
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[nvarchar]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlSimpleColumn" Name="[metadata].[Properties].[Description]">
						<Relationship Name="TypeSpecifier">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Property Name="IsMax" Value="True" />
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[nvarchar]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlSimpleColumn" Name="[metadata].[Properties].[ValidFrom]">
						<Property Name="IsNullable" Value="False" />
						<Relationship Name="TypeSpecifier">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[datetime]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
						<AttachedAnnotation Disambiguator="26" />
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlSimpleColumn" Name="[metadata].[Properties].[ValidTo]">
						<Relationship Name="TypeSpecifier">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[datetime]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
			</Relationship>
			<Relationship Name="Schema">
				<Entry>
					<References Name="[metadata]" />
				</Entry>
			</Relationship>
			<AttachedAnnotation Disambiguator="53" />
		</Element>
		<Element Type="SqlTable" Name="[metadata].[Recipients]">
			<Property Name="IsAnsiNullsOn" Value="True" />
			<Relationship Name="Columns">
				<Entry>
					<Element Type="SqlSimpleColumn" Name="[metadata].[Recipients].[RecipientId]">
						<Property Name="IsNullable" Value="False" />
						<Property Name="IsIdentity" Value="True" />
						<Relationship Name="TypeSpecifier">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[int]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlSimpleColumn" Name="[metadata].[Recipients].[Name]">
						<Relationship Name="TypeSpecifier">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Property Name="Length" Value="255" />
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[varchar]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlSimpleColumn" Name="[metadata].[Recipients].[EmailAddress]">
						<Property Name="IsNullable" Value="False" />
						<Relationship Name="TypeSpecifier">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Property Name="Length" Value="500" />
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[nvarchar]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlSimpleColumn" Name="[metadata].[Recipients].[MessagePreference]">
						<Property Name="IsNullable" Value="False" />
						<Relationship Name="TypeSpecifier">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Property Name="Length" Value="3" />
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[char]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
						<AttachedAnnotation Disambiguator="5" />
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlSimpleColumn" Name="[metadata].[Recipients].[Enabled]">
						<Property Name="IsNullable" Value="False" />
						<Relationship Name="TypeSpecifier">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[bit]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
						<AttachedAnnotation Disambiguator="7" />
					</Element>
				</Entry>
			</Relationship>
			<Relationship Name="Schema">
				<Entry>
					<References Name="[metadata]" />
				</Entry>
			</Relationship>
			<AttachedAnnotation Disambiguator="44" />
			<AttachedAnnotation Disambiguator="54" />
			<Annotation Type="SqlInlineConstraintAnnotation" Disambiguator="58" />
		</Element>
		<Element Type="SqlProcedure" Name="[metadata].[ResetExecution]">
			<Property Name="BodyScript">
				<Value><![CDATA[
BEGIN 
	SET NOCOUNT	ON;

	IF([metadata].[GetPropertyValueInternal]('UseExecutionBatches')) = '0'
		BEGIN
			--capture any pipelines that might be in an unexpected state
			INSERT INTO [metadata].[ExecutionLog]
				(
				[LocalExecutionId],
				[StageId],
				[PipelineId],
				[CallingOrchestratorName],
				[ResourceGroupName],
				[OrchestratorType],
				[OrchestratorName],
				[PipelineName],
				[StartDateTime],
				[PipelineStatus],
				[EndDateTime]
				)
			SELECT
				[LocalExecutionId],
				[StageId],
				[PipelineId],
				[CallingOrchestratorName],
				[ResourceGroupName],
				[OrchestratorType],
				[OrchestratorName],
				[PipelineName],
				[StartDateTime],
				'Unknown',
				[EndDateTime]
			FROM
				[metadata].[CurrentExecution]
			WHERE
				--these are predicted states
				[PipelineStatus] NOT IN
					(
					'Success',
					'Failed',
					'Blocked',
					'Cancelled'
					);
		
			--reset status ready for next attempt
			UPDATE
				[metadata].[CurrentExecution]
			SET
				[StartDateTime] = NULL,
				[EndDateTime] = NULL,
				[PipelineStatus] = NULL,
				[LastStatusCheckDateTime] = NULL,
				[PipelineRunId] = NULL,
				[PipelineParamsUsed] = NULL,
				[IsBlocked] = 0
			WHERE
				ISNULL([PipelineStatus],'') <> 'Success'
				OR [IsBlocked] = 1;
	
			--return current execution id
			SELECT DISTINCT
				[LocalExecutionId] AS ExecutionId
			FROM
				[metadata].[CurrentExecution];
		END
	ELSE IF ([metadata].[GetPropertyValueInternal]('UseExecutionBatches')) = '1'
		BEGIN
			--capture any pipelines that might be in an unexpected state
			INSERT INTO [metadata].[ExecutionLog]
				(
				[LocalExecutionId],
				[StageId],
				[PipelineId],
				[CallingOrchestratorName],
				[ResourceGroupName],
				[OrchestratorType],
				[OrchestratorName],
				[PipelineName],
				[StartDateTime],
				[PipelineStatus],
				[EndDateTime]
				)
			SELECT
				[LocalExecutionId],
				[StageId],
				[PipelineId],
				[CallingOrchestratorName],
				[ResourceGroupName],
				[OrchestratorType],
				[OrchestratorName],
				[PipelineName],
				[StartDateTime],
				'Unknown',
				[EndDateTime]
			FROM
				[metadata].[CurrentExecution]
			WHERE
				[LocalExecutionId] = @LocalExecutionId
				--these are predicted states
				AND [PipelineStatus] NOT IN
					(
					'Success',
					'Failed',
					'Blocked',
					'Cancelled'
					);
		
			--reset status ready for next attempt
			UPDATE
				[metadata].[CurrentExecution]
			SET
				[StartDateTime] = NULL,
				[EndDateTime] = NULL,
				[PipelineStatus] = NULL,
				[LastStatusCheckDateTime] = NULL,
				[PipelineRunId] = NULL,
				[PipelineParamsUsed] = NULL,
				[IsBlocked] = 0
			WHERE
				[LocalExecutionId] = @LocalExecutionId
				AND ISNULL([PipelineStatus],'') <> 'Success'
				OR [IsBlocked] = 1;
				
			UPDATE
				[metadata].[BatchExecution]
			SET
				[EndDateTime] = NULL,
				[BatchStatus] = 'Running'
			WHERE
				[ExecutionId] = @LocalExecutionId;

			SELECT 
				@LocalExecutionId AS ExecutionId
		END;
END;]]></Value>
			</Property>
			<Property Name="IsAnsiNullsOn" Value="True" />
			<Relationship Name="BodyDependencies">
				<Entry>
					<References Name="[metadata].[GetPropertyValueInternal]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[ExecutionLog]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[ExecutionLog].[LocalExecutionId]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[ExecutionLog].[StageId]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[ExecutionLog].[PipelineId]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[ExecutionLog].[CallingOrchestratorName]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[ExecutionLog].[ResourceGroupName]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[ExecutionLog].[OrchestratorType]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[ExecutionLog].[OrchestratorName]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[ExecutionLog].[PipelineName]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[ExecutionLog].[StartDateTime]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[ExecutionLog].[PipelineStatus]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[ExecutionLog].[EndDateTime]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[CurrentExecution]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[CurrentExecution].[LocalExecutionId]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[CurrentExecution].[StageId]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[CurrentExecution].[PipelineId]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[CurrentExecution].[CallingOrchestratorName]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[CurrentExecution].[ResourceGroupName]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[CurrentExecution].[OrchestratorType]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[CurrentExecution].[OrchestratorName]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[CurrentExecution].[PipelineName]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[CurrentExecution].[StartDateTime]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[CurrentExecution].[EndDateTime]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[CurrentExecution].[PipelineStatus]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[CurrentExecution].[LastStatusCheckDateTime]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[CurrentExecution].[PipelineRunId]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[CurrentExecution].[PipelineParamsUsed]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[CurrentExecution].[IsBlocked]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[ResetExecution].[@LocalExecutionId]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[BatchExecution]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[BatchExecution].[EndDateTime]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[BatchExecution].[BatchStatus]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[BatchExecution].[ExecutionId]" />
				</Entry>
			</Relationship>
			<Relationship Name="Parameters">
				<Entry>
					<Element Type="SqlSubroutineParameter" Name="[metadata].[ResetExecution].[@LocalExecutionId]">
						<Property Name="DefaultExpressionScript">
							<Value><![CDATA[NULL]]></Value>
						</Property>
						<Relationship Name="Type">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[uniqueidentifier]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
			</Relationship>
			<Relationship Name="Schema">
				<Entry>
					<References Name="[metadata]" />
				</Entry>
			</Relationship>
			<Annotation Type="SysCommentsObjectAnnotation">
				<Property Name="Length" Value="3220" />
				<Property Name="StartLine" Value="1" />
				<Property Name="StartColumn" Value="1" />
				<Property Name="HeaderContents" Value="CREATE PROCEDURE [metadata].[ResetExecution]&#xD;&#xA;&#x9;(&#xD;&#xA;&#x9;@LocalExecutionId UNIQUEIDENTIFIER = NULL&#xD;&#xA;&#x9;)&#xD;&#xA;AS" />
			</Annotation>
		</Element>
		<Element Type="SqlProcedure" Name="[metadata].[SetErrorLogDetails]">
			<Property Name="BodyScript">
				<Value><![CDATA[
BEGIN
	SET NOCOUNT ON;

	INSERT INTO [metadata].[ErrorLog]
		(
		[LocalExecutionId],
		[PipelineRunId],
		[ActivityRunId],
		[ActivityName],
		[ActivityType],
		[ErrorCode],
		[ErrorType],
		[ErrorMessage]
		)
	SELECT
		@LocalExecutionId,
		Base.[RunId],
		ErrorDetail.[ActivityRunId],
		ErrorDetail.[ActivityName],
		ErrorDetail.[ActivityType],
		ErrorDetail.[ErrorCode],
		ErrorDetail.[ErrorType],
		ErrorDetail.[ErrorMessage]
	FROM 
		OPENJSON(@JsonErrorDetails) WITH
			( 
			[RunId] UNIQUEIDENTIFIER,
			[Errors] NVARCHAR(MAX) AS JSON
			) AS Base
		CROSS APPLY OPENJSON (Base.[Errors]) WITH
			(
			[ActivityRunId] UNIQUEIDENTIFIER,
			[ActivityName] VARCHAR(100),
			[ActivityType] VARCHAR(100),
			[ErrorCode] VARCHAR(100),
			[ErrorType] VARCHAR(100),
			[ErrorMessage] VARCHAR(MAX)
			) AS ErrorDetail
END;]]></Value>
			</Property>
			<Property Name="IsAnsiNullsOn" Value="True" />
			<Relationship Name="BodyDependencies">
				<Entry>
					<References Name="[metadata].[ErrorLog]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[ErrorLog].[LocalExecutionId]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[ErrorLog].[PipelineRunId]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[ErrorLog].[ActivityRunId]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[ErrorLog].[ActivityName]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[ErrorLog].[ActivityType]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[ErrorLog].[ErrorCode]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[ErrorLog].[ErrorType]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[ErrorLog].[ErrorMessage]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[SetErrorLogDetails].[@LocalExecutionId]" />
				</Entry>
			</Relationship>
			<Relationship Name="Parameters">
				<Entry>
					<Element Type="SqlSubroutineParameter" Name="[metadata].[SetErrorLogDetails].[@LocalExecutionId]">
						<Relationship Name="Type">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[uniqueidentifier]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlSubroutineParameter" Name="[metadata].[SetErrorLogDetails].[@JsonErrorDetails]">
						<Relationship Name="Type">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Property Name="IsMax" Value="True" />
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[varchar]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
			</Relationship>
			<Relationship Name="Schema">
				<Entry>
					<References Name="[metadata]" />
				</Entry>
			</Relationship>
			<Annotation Type="SysCommentsObjectAnnotation">
				<Property Name="Length" Value="987" />
				<Property Name="StartLine" Value="1" />
				<Property Name="StartColumn" Value="1" />
				<Property Name="HeaderContents" Value="CREATE PROCEDURE [metadata].[SetErrorLogDetails]&#xD;&#xA;&#x9;(&#xD;&#xA;&#x9;@LocalExecutionId UNIQUEIDENTIFIER,&#xD;&#xA;&#x9;@JsonErrorDetails VARCHAR(MAX)&#xD;&#xA;&#x9;)&#xD;&#xA;AS" />
			</Annotation>
		</Element>
		<Element Type="SqlProcedure" Name="[metadata].[SetExecutionBlockDependants]">
			<Property Name="BodyScript">
				<Value><![CDATA[
BEGIN
	--update dependents status
	UPDATE
		ce
	SET
		ce.[PipelineStatus] = 'Blocked',
		ce.[IsBlocked] = 1
	FROM
		[metadata].[PipelineDependencies] pe
		INNER JOIN [metadata].[CurrentExecution] ce
			ON pe.[DependantPipelineId] = ce.[PipelineId]
	WHERE
		ce.[LocalExecutionId] = @ExecutionId
		AND pe.[PipelineId] = @PipelineId
END;]]></Value>
			</Property>
			<Property Name="IsAnsiNullsOn" Value="True" />
			<Relationship Name="BodyDependencies">
				<Entry>
					<References Name="[metadata].[PipelineDependencies]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[CurrentExecution]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[PipelineDependencies].[DependantPipelineId]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[CurrentExecution].[PipelineId]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[CurrentExecution].[PipelineStatus]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[CurrentExecution].[IsBlocked]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[CurrentExecution].[LocalExecutionId]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[SetExecutionBlockDependants].[@ExecutionId]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[PipelineDependencies].[PipelineId]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[SetExecutionBlockDependants].[@PipelineId]" />
				</Entry>
			</Relationship>
			<Relationship Name="Parameters">
				<Entry>
					<Element Type="SqlSubroutineParameter" Name="[metadata].[SetExecutionBlockDependants].[@ExecutionId]">
						<Property Name="DefaultExpressionScript">
							<Value><![CDATA[NULL]]></Value>
						</Property>
						<Relationship Name="Type">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[uniqueidentifier]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlSubroutineParameter" Name="[metadata].[SetExecutionBlockDependants].[@PipelineId]">
						<Relationship Name="Type">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[int]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
			</Relationship>
			<Relationship Name="Schema">
				<Entry>
					<References Name="[metadata]" />
				</Entry>
			</Relationship>
			<Annotation Type="SysCommentsObjectAnnotation">
				<Property Name="Length" Value="477" />
				<Property Name="StartLine" Value="1" />
				<Property Name="StartColumn" Value="1" />
				<Property Name="HeaderContents" Value="CREATE PROCEDURE [metadata].[SetExecutionBlockDependants]&#xD;&#xA;&#x9;(&#xD;&#xA;&#x9;@ExecutionId UNIQUEIDENTIFIER = NULL,&#xD;&#xA;&#x9;@PipelineId INT&#xD;&#xA;&#x9;)&#xD;&#xA;AS" />
			</Annotation>
		</Element>
		<Element Type="SqlProcedure" Name="[metadata].[SetLogActivityFailed]">
			<Property Name="BodyScript">
				<Value><![CDATA[

BEGIN
	SET NOCOUNT ON;
	
	--mark specific failure pipeline
	UPDATE
		[metadata].[CurrentExecution]
	SET
		[PipelineStatus] = @CallingActivity + 'Error'
	WHERE
		[LocalExecutionId] = @ExecutionId
		AND [StageId] = @StageId
		AND [PipelineId] = @PipelineId

	--persist failed pipeline records to long term log
	INSERT INTO [metadata].[ExecutionLog]
		(
		[LocalExecutionId],
		[StageId],
		[PipelineId],
		[CallingOrchestratorName],
		[ResourceGroupName],
		[OrchestratorType],
		[OrchestratorName],
		[PipelineName],
		[StartDateTime],
		[PipelineStatus],
		[EndDateTime],
		[PipelineRunId],
		[PipelineParamsUsed]
		)
	SELECT
		[LocalExecutionId],
		[StageId],
		[PipelineId],
		[CallingOrchestratorName],
		[ResourceGroupName],
		[OrchestratorType],
		[OrchestratorName],
		[PipelineName],
		[StartDateTime],
		[PipelineStatus],
		[EndDateTime],
		[PipelineRunId],
		[PipelineParamsUsed]
	FROM
		[metadata].[CurrentExecution]
	WHERE
		[LocalExecutionId] = @ExecutionId
		AND [PipelineStatus] = @CallingActivity + 'Error'
		AND [StageId] = @StageId
		AND [PipelineId] = @PipelineId
	
	--decide how to proceed with error/failure depending on framework property configuration
	IF ([metadata].[GetPropertyValueInternal]('FailureHandling')) = 'None'
		BEGIN
			--do nothing allow processing to carry on regardless
			RETURN 0;
		END;
		
	ELSE IF ([metadata].[GetPropertyValueInternal]('FailureHandling')) = 'Simple'
		BEGIN
			--flag all downstream stages as blocked
			UPDATE
				[metadata].[CurrentExecution]
			SET
				[PipelineStatus] = 'Blocked',
				[IsBlocked] = 1
			WHERE
				[LocalExecutionId] = @ExecutionId
				AND [StageId] > @StageId;

			--update batch if applicable
			IF ([metadata].[GetPropertyValueInternal]('UseExecutionBatches')) = '1'
				BEGIN
					UPDATE
						[metadata].[BatchExecution]
					SET
						[BatchStatus] = 'Stopping' --special case when its an activity failure to call stop ready for restart
					WHERE
						[ExecutionId] = @ExecutionId
						AND [BatchStatus] = 'Running';
				END;			
		END;
	
	ELSE IF ([metadata].[GetPropertyValueInternal]('FailureHandling')) = 'DependencyChain'
		BEGIN
			EXEC [metadata].[SetExecutionBlockDependants]
				@ExecutionId = @ExecutionId,
				@PipelineId = @PipelineId
		END;
	ELSE
		BEGIN
			RAISERROR('Unknown failure handling state.',16,1);
			RETURN 0;
		END;
END;]]></Value>
			</Property>
			<Property Name="IsAnsiNullsOn" Value="True" />
			<Relationship Name="BodyDependencies">
				<Entry>
					<References Name="[metadata].[CurrentExecution]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[CurrentExecution].[PipelineStatus]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[SetLogActivityFailed].[@CallingActivity]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[CurrentExecution].[LocalExecutionId]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[SetLogActivityFailed].[@ExecutionId]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[CurrentExecution].[StageId]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[SetLogActivityFailed].[@StageId]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[CurrentExecution].[PipelineId]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[SetLogActivityFailed].[@PipelineId]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[ExecutionLog]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[ExecutionLog].[LocalExecutionId]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[ExecutionLog].[StageId]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[ExecutionLog].[PipelineId]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[ExecutionLog].[CallingOrchestratorName]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[ExecutionLog].[ResourceGroupName]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[ExecutionLog].[OrchestratorType]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[ExecutionLog].[OrchestratorName]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[ExecutionLog].[PipelineName]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[ExecutionLog].[StartDateTime]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[ExecutionLog].[PipelineStatus]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[ExecutionLog].[EndDateTime]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[ExecutionLog].[PipelineRunId]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[ExecutionLog].[PipelineParamsUsed]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[CurrentExecution].[CallingOrchestratorName]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[CurrentExecution].[ResourceGroupName]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[CurrentExecution].[OrchestratorType]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[CurrentExecution].[OrchestratorName]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[CurrentExecution].[PipelineName]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[CurrentExecution].[StartDateTime]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[CurrentExecution].[EndDateTime]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[CurrentExecution].[PipelineRunId]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[CurrentExecution].[PipelineParamsUsed]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[GetPropertyValueInternal]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[CurrentExecution].[IsBlocked]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[BatchExecution]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[BatchExecution].[BatchStatus]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[BatchExecution].[ExecutionId]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[SetExecutionBlockDependants]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[SetExecutionBlockDependants].[@ExecutionId]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[SetExecutionBlockDependants].[@PipelineId]" />
				</Entry>
			</Relationship>
			<Relationship Name="Parameters">
				<Entry>
					<Element Type="SqlSubroutineParameter" Name="[metadata].[SetLogActivityFailed].[@ExecutionId]">
						<Relationship Name="Type">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[uniqueidentifier]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlSubroutineParameter" Name="[metadata].[SetLogActivityFailed].[@StageId]">
						<Relationship Name="Type">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[int]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlSubroutineParameter" Name="[metadata].[SetLogActivityFailed].[@PipelineId]">
						<Relationship Name="Type">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[int]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlSubroutineParameter" Name="[metadata].[SetLogActivityFailed].[@CallingActivity]">
						<Relationship Name="Type">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Property Name="Length" Value="255" />
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[varchar]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
			</Relationship>
			<Relationship Name="Schema">
				<Entry>
					<References Name="[metadata]" />
				</Entry>
			</Relationship>
			<Annotation Type="SysCommentsObjectAnnotation">
				<Property Name="Length" Value="2598" />
				<Property Name="StartLine" Value="1" />
				<Property Name="StartColumn" Value="1" />
				<Property Name="HeaderContents" Value="CREATE PROCEDURE [metadata].[SetLogActivityFailed]&#xD;&#xA;&#x9;(&#xD;&#xA;&#x9;@ExecutionId UNIQUEIDENTIFIER,&#xD;&#xA;&#x9;@StageId INT,&#xD;&#xA;&#x9;@PipelineId INT,&#xD;&#xA;&#x9;@CallingActivity VARCHAR(255)&#xD;&#xA;&#x9;)&#xD;&#xA;AS" />
			</Annotation>
		</Element>
		<Element Type="SqlProcedure" Name="[metadata].[SetLogPipelineCancelled]">
			<Property Name="BodyScript">
				<Value><![CDATA[
BEGIN
	SET NOCOUNT ON;

	DECLARE @ErrorDetail VARCHAR(500);

	--mark specific failure pipeline
	UPDATE
		[metadata].[CurrentExecution]
	SET
		[PipelineStatus] = 'Cancelled'
	WHERE
		[LocalExecutionId] = @ExecutionId
		AND [StageId] = @StageId
		AND [PipelineId] = @PipelineId
	
	--no need to block and log if done during a clean up cycle
	IF @CleanUpRun = 1 RETURN 0;

	--persist cancelled pipeline records to long term log
	INSERT INTO [metadata].[ExecutionLog]
		(
		[LocalExecutionId],
		[StageId],
		[PipelineId],
		[CallingOrchestratorName],
		[ResourceGroupName],
		[OrchestratorType],
		[OrchestratorName],
		[PipelineName],
		[StartDateTime],
		[PipelineStatus],
		[EndDateTime],
		[PipelineRunId],
		[PipelineParamsUsed]
		)
	SELECT
		[LocalExecutionId],
		[StageId],
		[PipelineId],
		[CallingOrchestratorName],
		[ResourceGroupName],
		[OrchestratorType],
		[OrchestratorName],
		[PipelineName],
		[StartDateTime],
		[PipelineStatus],
		[EndDateTime],
		[PipelineRunId],
		[PipelineParamsUsed]
	FROM
		[metadata].[CurrentExecution]
	WHERE
		[LocalExecutionId] = @ExecutionId
		AND [PipelineStatus] = 'Cancelled'
		AND [StageId] = @StageId
		AND [PipelineId] = @PipelineId;

	--block down stream stages?
	IF ([metadata].[GetPropertyValueInternal]('CancelledWorkerResultBlocks')) = 1
	BEGIN	
		--decide how to proceed with error/failure depending on framework property configuration
		IF ([metadata].[GetPropertyValueInternal]('FailureHandling')) = 'None'
			BEGIN
				--do nothing allow processing to carry on regardless
				RETURN 0;
			END;

		ELSE IF ([metadata].[GetPropertyValueInternal]('FailureHandling')) = 'Simple'
			BEGIN
				--flag all downstream stages as blocked
				UPDATE
					[metadata].[CurrentExecution]
				SET
					[PipelineStatus] = 'Blocked',
					[IsBlocked] = 1
				WHERE
					[LocalExecutionId] = @ExecutionId
					AND [StageId] > @StageId
				
				--update batch if applicable
				IF ([metadata].[GetPropertyValueInternal]('UseExecutionBatches')) = '1'
					BEGIN
						UPDATE
							[metadata].[BatchExecution]
						SET
							[BatchStatus] = 'Stopping'
						WHERE
							[ExecutionId] = @ExecutionId
							AND [BatchStatus] = 'Running';
					END;

				SET @ErrorDetail = 'Pipeline execution has a cancelled status. Blocking downstream stages as a precaution.'

				RAISERROR(@ErrorDetail,16,1);
				RETURN 0;
			END;
		ELSE IF ([metadata].[GetPropertyValueInternal]('FailureHandling')) = 'DependencyChain'
			BEGIN
				EXEC [metadata].[SetExecutionBlockDependants]
					@ExecutionId = @ExecutionId,
					@PipelineId = @PipelineId
			END;
		ELSE
			BEGIN
				RAISERROR('Cancelled execution failure handling state.',16,1);
				RETURN 0;
			END;
	END;
END;]]></Value>
			</Property>
			<Property Name="IsAnsiNullsOn" Value="True" />
			<Relationship Name="BodyDependencies">
				<Entry>
					<References ExternalSource="BuiltIns" Name="[varchar]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[CurrentExecution]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[CurrentExecution].[PipelineStatus]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[CurrentExecution].[LocalExecutionId]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[SetLogPipelineCancelled].[@ExecutionId]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[CurrentExecution].[StageId]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[SetLogPipelineCancelled].[@StageId]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[CurrentExecution].[PipelineId]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[SetLogPipelineCancelled].[@PipelineId]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[SetLogPipelineCancelled].[@CleanUpRun]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[ExecutionLog]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[ExecutionLog].[LocalExecutionId]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[ExecutionLog].[StageId]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[ExecutionLog].[PipelineId]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[ExecutionLog].[CallingOrchestratorName]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[ExecutionLog].[ResourceGroupName]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[ExecutionLog].[OrchestratorType]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[ExecutionLog].[OrchestratorName]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[ExecutionLog].[PipelineName]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[ExecutionLog].[StartDateTime]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[ExecutionLog].[PipelineStatus]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[ExecutionLog].[EndDateTime]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[ExecutionLog].[PipelineRunId]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[ExecutionLog].[PipelineParamsUsed]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[CurrentExecution].[CallingOrchestratorName]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[CurrentExecution].[ResourceGroupName]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[CurrentExecution].[OrchestratorType]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[CurrentExecution].[OrchestratorName]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[CurrentExecution].[PipelineName]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[CurrentExecution].[StartDateTime]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[CurrentExecution].[EndDateTime]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[CurrentExecution].[PipelineRunId]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[CurrentExecution].[PipelineParamsUsed]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[GetPropertyValueInternal]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[CurrentExecution].[IsBlocked]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[BatchExecution]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[BatchExecution].[BatchStatus]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[BatchExecution].[ExecutionId]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[SetExecutionBlockDependants]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[SetExecutionBlockDependants].[@ExecutionId]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[SetExecutionBlockDependants].[@PipelineId]" />
				</Entry>
			</Relationship>
			<Relationship Name="Parameters">
				<Entry>
					<Element Type="SqlSubroutineParameter" Name="[metadata].[SetLogPipelineCancelled].[@ExecutionId]">
						<Relationship Name="Type">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[uniqueidentifier]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlSubroutineParameter" Name="[metadata].[SetLogPipelineCancelled].[@StageId]">
						<Relationship Name="Type">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[int]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlSubroutineParameter" Name="[metadata].[SetLogPipelineCancelled].[@PipelineId]">
						<Relationship Name="Type">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[int]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlSubroutineParameter" Name="[metadata].[SetLogPipelineCancelled].[@CleanUpRun]">
						<Property Name="DefaultExpressionScript">
							<Value><![CDATA[0]]></Value>
						</Property>
						<Relationship Name="Type">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[bit]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
			</Relationship>
			<Relationship Name="Schema">
				<Entry>
					<References Name="[metadata]" />
				</Entry>
			</Relationship>
			<Annotation Type="SysCommentsObjectAnnotation">
				<Property Name="Length" Value="2960" />
				<Property Name="StartLine" Value="1" />
				<Property Name="StartColumn" Value="1" />
				<Property Name="HeaderContents" Value="CREATE PROCEDURE [metadata].[SetLogPipelineCancelled]&#xD;&#xA;&#x9;(&#xD;&#xA;&#x9;@ExecutionId UNIQUEIDENTIFIER,&#xD;&#xA;&#x9;@StageId INT,&#xD;&#xA;&#x9;@PipelineId INT,&#xD;&#xA;&#x9;@CleanUpRun BIT = 0&#xD;&#xA;&#x9;)&#xD;&#xA;AS" />
			</Annotation>
		</Element>
		<Element Type="SqlProcedure" Name="[metadata].[SetLogPipelineChecking]">
			<Property Name="BodyScript">
				<Value><![CDATA[
BEGIN
	SET NOCOUNT ON;

	UPDATE
		[metadata].[CurrentExecution]
	SET
		[PipelineStatus] = 'Checking'
	WHERE
		[LocalExecutionId] = @ExecutionId
		AND [StageId] = @StageId
		AND [PipelineId] = @PipelineId
END;]]></Value>
			</Property>
			<Property Name="IsAnsiNullsOn" Value="True" />
			<Relationship Name="BodyDependencies">
				<Entry>
					<References Name="[metadata].[CurrentExecution]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[CurrentExecution].[PipelineStatus]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[CurrentExecution].[LocalExecutionId]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[SetLogPipelineChecking].[@ExecutionId]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[CurrentExecution].[StageId]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[SetLogPipelineChecking].[@StageId]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[CurrentExecution].[PipelineId]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[SetLogPipelineChecking].[@PipelineId]" />
				</Entry>
			</Relationship>
			<Relationship Name="Parameters">
				<Entry>
					<Element Type="SqlSubroutineParameter" Name="[metadata].[SetLogPipelineChecking].[@ExecutionId]">
						<Relationship Name="Type">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[uniqueidentifier]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlSubroutineParameter" Name="[metadata].[SetLogPipelineChecking].[@StageId]">
						<Relationship Name="Type">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[int]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlSubroutineParameter" Name="[metadata].[SetLogPipelineChecking].[@PipelineId]">
						<Relationship Name="Type">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[int]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
			</Relationship>
			<Relationship Name="Schema">
				<Entry>
					<References Name="[metadata]" />
				</Entry>
			</Relationship>
			<Annotation Type="SysCommentsObjectAnnotation">
				<Property Name="Length" Value="352" />
				<Property Name="StartLine" Value="1" />
				<Property Name="StartColumn" Value="1" />
				<Property Name="HeaderContents" Value="CREATE PROCEDURE [metadata].[SetLogPipelineChecking]&#xD;&#xA;&#x9;(&#xD;&#xA;&#x9;@ExecutionId UNIQUEIDENTIFIER,&#xD;&#xA;&#x9;@StageId INT,&#xD;&#xA;&#x9;@PipelineId INT&#xD;&#xA;&#x9;)&#xD;&#xA;AS" />
			</Annotation>
		</Element>
		<Element Type="SqlProcedure" Name="[metadata].[SetLogPipelineFailed]">
			<Property Name="BodyScript">
				<Value><![CDATA[
BEGIN
	SET NOCOUNT ON;

	DECLARE @ErrorDetail VARCHAR(500)

	--mark specific failure pipeline
	UPDATE
		[metadata].[CurrentExecution]
	SET
		[PipelineStatus] = 'Failed'
	WHERE
		[LocalExecutionId] = @ExecutionId
		AND [StageId] = @StageId
		AND [PipelineId] = @PipelineId

	--persist failed pipeline records to long term log
	INSERT INTO [metadata].[ExecutionLog]
		(
		[LocalExecutionId],
		[StageId],
		[PipelineId],
		[CallingOrchestratorName],
		[ResourceGroupName],
		[OrchestratorType],
		[OrchestratorName],
		[PipelineName],
		[StartDateTime],
		[PipelineStatus],
		[EndDateTime],
		[PipelineRunId],
		[PipelineParamsUsed]
		)
	SELECT
		[LocalExecutionId],
		[StageId],
		[PipelineId],
		[CallingOrchestratorName],
		[ResourceGroupName],
		[OrchestratorType],
		[OrchestratorName],
		[PipelineName],
		[StartDateTime],
		[PipelineStatus],
		[EndDateTime],
		[PipelineRunId],
		[PipelineParamsUsed]
	FROM
		[metadata].[CurrentExecution]
	WHERE
		[LocalExecutionId] = @ExecutionId
		AND [PipelineStatus] = 'Failed'
		AND [StageId] = @StageId
		AND [PipelineId] = @PipelineId;
	
	IF ([metadata].[GetPropertyValueInternal]('FailureHandling')) = 'None'
		BEGIN
			--do nothing allow processing to carry on regardless
			RETURN 0;
		END;
		
	ELSE IF ([metadata].[GetPropertyValueInternal]('FailureHandling')) = 'Simple'
		BEGIN
			--flag all downstream stages as blocked
			UPDATE
				[metadata].[CurrentExecution]
			SET
				[PipelineStatus] = 'Blocked',
				[IsBlocked] = 1
			WHERE
				[LocalExecutionId] = @ExecutionId
				AND [StageId] > @StageId
			
			--raise error to stop processing
			IF @RunId IS NOT NULL
				BEGIN
					SET @ErrorDetail = 'Pipeline execution failed. Check Run ID: ' + CAST(@RunId AS CHAR(36)) + ' in ADF monitoring for details.'
				END;
			ELSE
				BEGIN
					SET @ErrorDetail = 'Pipeline execution failed. See ADF monitoring for details.'
				END;

			--update batch if applicable
			IF ([metadata].[GetPropertyValueInternal]('UseExecutionBatches')) = '1'
				BEGIN
					UPDATE
						[metadata].[BatchExecution]
					SET
						[BatchStatus] = 'Stopping'
					WHERE
						[ExecutionId] = @ExecutionId
						AND [BatchStatus] = 'Running';
				END;

			RAISERROR(@ErrorDetail,16,1);
			RETURN 0;
		END;
	
	ELSE IF ([metadata].[GetPropertyValueInternal]('FailureHandling')) = 'DependencyChain'
		BEGIN
			EXEC [metadata].[SetExecutionBlockDependants]
				@ExecutionId = @ExecutionId,
				@PipelineId = @PipelineId
		END;
	ELSE
		BEGIN
			RAISERROR('Unknown failure handling state.',16,1);
			RETURN 0;
		END;
END;]]></Value>
			</Property>
			<Property Name="IsAnsiNullsOn" Value="True" />
			<Relationship Name="BodyDependencies">
				<Entry>
					<References ExternalSource="BuiltIns" Name="[varchar]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[CurrentExecution]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[CurrentExecution].[PipelineStatus]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[CurrentExecution].[LocalExecutionId]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[SetLogPipelineFailed].[@ExecutionId]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[CurrentExecution].[StageId]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[SetLogPipelineFailed].[@StageId]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[CurrentExecution].[PipelineId]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[SetLogPipelineFailed].[@PipelineId]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[ExecutionLog]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[ExecutionLog].[LocalExecutionId]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[ExecutionLog].[StageId]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[ExecutionLog].[PipelineId]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[ExecutionLog].[CallingOrchestratorName]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[ExecutionLog].[ResourceGroupName]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[ExecutionLog].[OrchestratorType]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[ExecutionLog].[OrchestratorName]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[ExecutionLog].[PipelineName]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[ExecutionLog].[StartDateTime]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[ExecutionLog].[PipelineStatus]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[ExecutionLog].[EndDateTime]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[ExecutionLog].[PipelineRunId]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[ExecutionLog].[PipelineParamsUsed]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[CurrentExecution].[CallingOrchestratorName]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[CurrentExecution].[ResourceGroupName]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[CurrentExecution].[OrchestratorType]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[CurrentExecution].[OrchestratorName]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[CurrentExecution].[PipelineName]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[CurrentExecution].[StartDateTime]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[CurrentExecution].[EndDateTime]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[CurrentExecution].[PipelineRunId]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[CurrentExecution].[PipelineParamsUsed]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[GetPropertyValueInternal]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[CurrentExecution].[IsBlocked]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[SetLogPipelineFailed].[@RunId]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[char]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[BatchExecution]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[BatchExecution].[BatchStatus]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[BatchExecution].[ExecutionId]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[SetExecutionBlockDependants]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[SetExecutionBlockDependants].[@ExecutionId]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[SetExecutionBlockDependants].[@PipelineId]" />
				</Entry>
			</Relationship>
			<Relationship Name="Parameters">
				<Entry>
					<Element Type="SqlSubroutineParameter" Name="[metadata].[SetLogPipelineFailed].[@ExecutionId]">
						<Relationship Name="Type">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[uniqueidentifier]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlSubroutineParameter" Name="[metadata].[SetLogPipelineFailed].[@StageId]">
						<Relationship Name="Type">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[int]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlSubroutineParameter" Name="[metadata].[SetLogPipelineFailed].[@PipelineId]">
						<Relationship Name="Type">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[int]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlSubroutineParameter" Name="[metadata].[SetLogPipelineFailed].[@RunId]">
						<Property Name="DefaultExpressionScript">
							<Value><![CDATA[NULL]]></Value>
						</Property>
						<Relationship Name="Type">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[uniqueidentifier]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
			</Relationship>
			<Relationship Name="Schema">
				<Entry>
					<References Name="[metadata]" />
				</Entry>
			</Relationship>
			<Annotation Type="SysCommentsObjectAnnotation">
				<Property Name="Length" Value="2816" />
				<Property Name="StartLine" Value="1" />
				<Property Name="StartColumn" Value="1" />
				<Property Name="HeaderContents" Value="CREATE PROCEDURE [metadata].[SetLogPipelineFailed]&#xD;&#xA;&#x9;(&#xD;&#xA;&#x9;@ExecutionId UNIQUEIDENTIFIER,&#xD;&#xA;&#x9;@StageId INT,&#xD;&#xA;&#x9;@PipelineId INT,&#xD;&#xA;&#x9;@RunId UNIQUEIDENTIFIER = NULL&#xD;&#xA;&#x9;)&#xD;&#xA;AS" />
			</Annotation>
		</Element>
		<Element Type="SqlProcedure" Name="[metadata].[SetLogPipelineLastStatusCheck]">
			<Property Name="BodyScript">
				<Value><![CDATA[
BEGIN
	SET NOCOUNT ON;

	UPDATE
		[metadata].[CurrentExecution]
	SET
		[LastStatusCheckDateTime] = GETUTCDATE()
	WHERE
		[LocalExecutionId] = @ExecutionId
		AND [StageId] = @StageId
		AND [PipelineId] = @PipelineId
END;]]></Value>
			</Property>
			<Property Name="IsAnsiNullsOn" Value="True" />
			<Relationship Name="BodyDependencies">
				<Entry>
					<References Name="[metadata].[CurrentExecution]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[CurrentExecution].[LastStatusCheckDateTime]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[CurrentExecution].[LocalExecutionId]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[SetLogPipelineLastStatusCheck].[@ExecutionId]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[CurrentExecution].[StageId]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[SetLogPipelineLastStatusCheck].[@StageId]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[CurrentExecution].[PipelineId]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[SetLogPipelineLastStatusCheck].[@PipelineId]" />
				</Entry>
			</Relationship>
			<Relationship Name="Parameters">
				<Entry>
					<Element Type="SqlSubroutineParameter" Name="[metadata].[SetLogPipelineLastStatusCheck].[@ExecutionId]">
						<Relationship Name="Type">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[uniqueidentifier]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlSubroutineParameter" Name="[metadata].[SetLogPipelineLastStatusCheck].[@StageId]">
						<Relationship Name="Type">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[int]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlSubroutineParameter" Name="[metadata].[SetLogPipelineLastStatusCheck].[@PipelineId]">
						<Relationship Name="Type">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[int]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
			</Relationship>
			<Relationship Name="Schema">
				<Entry>
					<References Name="[metadata]" />
				</Entry>
			</Relationship>
			<Annotation Type="SysCommentsObjectAnnotation">
				<Property Name="Length" Value="370" />
				<Property Name="StartLine" Value="1" />
				<Property Name="StartColumn" Value="1" />
				<Property Name="HeaderContents" Value="CREATE PROCEDURE [metadata].[SetLogPipelineLastStatusCheck]&#xD;&#xA;&#x9;(&#xD;&#xA;&#x9;@ExecutionId UNIQUEIDENTIFIER,&#xD;&#xA;&#x9;@StageId INT,&#xD;&#xA;&#x9;@PipelineId INT&#xD;&#xA;&#x9;)&#xD;&#xA;AS" />
			</Annotation>
		</Element>
		<Element Type="SqlProcedure" Name="[metadata].[SetLogPipelineRunId]">
			<Property Name="BodyScript">
				<Value><![CDATA[
BEGIN
	SET NOCOUNT ON;

	UPDATE
		[metadata].[CurrentExecution]
	SET
		[PipelineRunId] = LOWER(@RunId)
	WHERE
		[LocalExecutionId] = @ExecutionId
		AND [StageId] = @StageId
		AND [PipelineId] = @PipelineId
END;]]></Value>
			</Property>
			<Property Name="IsAnsiNullsOn" Value="True" />
			<Relationship Name="BodyDependencies">
				<Entry>
					<References Name="[metadata].[CurrentExecution]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[CurrentExecution].[PipelineRunId]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[SetLogPipelineRunId].[@RunId]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[CurrentExecution].[LocalExecutionId]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[SetLogPipelineRunId].[@ExecutionId]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[CurrentExecution].[StageId]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[SetLogPipelineRunId].[@StageId]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[CurrentExecution].[PipelineId]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[SetLogPipelineRunId].[@PipelineId]" />
				</Entry>
			</Relationship>
			<Relationship Name="Parameters">
				<Entry>
					<Element Type="SqlSubroutineParameter" Name="[metadata].[SetLogPipelineRunId].[@ExecutionId]">
						<Relationship Name="Type">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[uniqueidentifier]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlSubroutineParameter" Name="[metadata].[SetLogPipelineRunId].[@StageId]">
						<Relationship Name="Type">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[int]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlSubroutineParameter" Name="[metadata].[SetLogPipelineRunId].[@PipelineId]">
						<Relationship Name="Type">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[int]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlSubroutineParameter" Name="[metadata].[SetLogPipelineRunId].[@RunId]">
						<Property Name="DefaultExpressionScript">
							<Value><![CDATA[NULL]]></Value>
						</Property>
						<Relationship Name="Type">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[uniqueidentifier]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
			</Relationship>
			<Relationship Name="Schema">
				<Entry>
					<References Name="[metadata]" />
				</Entry>
			</Relationship>
			<Annotation Type="SysCommentsObjectAnnotation">
				<Property Name="Length" Value="385" />
				<Property Name="StartLine" Value="1" />
				<Property Name="StartColumn" Value="1" />
				<Property Name="HeaderContents" Value="CREATE PROCEDURE [metadata].[SetLogPipelineRunId]&#xD;&#xA;&#x9;(&#xD;&#xA;&#x9;@ExecutionId UNIQUEIDENTIFIER,&#xD;&#xA;&#x9;@StageId INT,&#xD;&#xA;&#x9;@PipelineId INT,&#xD;&#xA;&#x9;@RunId UNIQUEIDENTIFIER = NULL&#xD;&#xA;&#x9;)&#xD;&#xA;AS" />
			</Annotation>
		</Element>
		<Element Type="SqlProcedure" Name="[metadata].[SetLogPipelineRunning]">
			<Property Name="BodyScript">
				<Value><![CDATA[
BEGIN
	SET NOCOUNT ON;

	UPDATE
		[metadata].[CurrentExecution]
	SET
		--case for clean up runs
		[StartDateTime] = CASE WHEN [StartDateTime] IS NULL THEN GETUTCDATE() ELSE [StartDateTime] END,
		[PipelineStatus] = 'Running'
	WHERE
		[LocalExecutionId] = @ExecutionId
		AND [StageId] = @StageId
		AND [PipelineId] = @PipelineId
END;]]></Value>
			</Property>
			<Property Name="IsAnsiNullsOn" Value="True" />
			<Relationship Name="BodyDependencies">
				<Entry>
					<References Name="[metadata].[CurrentExecution]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[CurrentExecution].[StartDateTime]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[CurrentExecution].[PipelineStatus]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[CurrentExecution].[LocalExecutionId]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[SetLogPipelineRunning].[@ExecutionId]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[CurrentExecution].[StageId]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[SetLogPipelineRunning].[@StageId]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[CurrentExecution].[PipelineId]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[SetLogPipelineRunning].[@PipelineId]" />
				</Entry>
			</Relationship>
			<Relationship Name="Parameters">
				<Entry>
					<Element Type="SqlSubroutineParameter" Name="[metadata].[SetLogPipelineRunning].[@ExecutionId]">
						<Relationship Name="Type">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[uniqueidentifier]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlSubroutineParameter" Name="[metadata].[SetLogPipelineRunning].[@StageId]">
						<Relationship Name="Type">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[int]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlSubroutineParameter" Name="[metadata].[SetLogPipelineRunning].[@PipelineId]">
						<Relationship Name="Type">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[int]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
			</Relationship>
			<Relationship Name="Schema">
				<Entry>
					<References Name="[metadata]" />
				</Entry>
			</Relationship>
			<Annotation Type="SysCommentsObjectAnnotation">
				<Property Name="Length" Value="473" />
				<Property Name="StartLine" Value="1" />
				<Property Name="StartColumn" Value="1" />
				<Property Name="HeaderContents" Value="CREATE PROCEDURE metadata.SetLogPipelineRunning&#xD;&#xA;&#x9;(&#xD;&#xA;&#x9;@ExecutionId UNIQUEIDENTIFIER,&#xD;&#xA;&#x9;@StageId INT,&#xD;&#xA;&#x9;@PipelineId INT&#xD;&#xA;&#x9;)&#xD;&#xA;AS" />
			</Annotation>
		</Element>
		<Element Type="SqlProcedure" Name="[metadata].[SetLogPipelineSuccess]">
			<Property Name="BodyScript">
				<Value><![CDATA[
BEGIN
	SET NOCOUNT ON;

	UPDATE
		[metadata].[CurrentExecution]
	SET
		--case for clean up runs
		[EndDateTime] = CASE WHEN [EndDateTime] IS NULL THEN GETUTCDATE() ELSE [EndDateTime] END,
		[PipelineStatus] = 'Success'
	WHERE
		[LocalExecutionId] = @ExecutionId
		AND [StageId] = @StageId
		AND [PipelineId] = @PipelineId
END;]]></Value>
			</Property>
			<Property Name="IsAnsiNullsOn" Value="True" />
			<Relationship Name="BodyDependencies">
				<Entry>
					<References Name="[metadata].[CurrentExecution]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[CurrentExecution].[EndDateTime]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[CurrentExecution].[PipelineStatus]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[CurrentExecution].[LocalExecutionId]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[SetLogPipelineSuccess].[@ExecutionId]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[CurrentExecution].[StageId]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[SetLogPipelineSuccess].[@StageId]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[CurrentExecution].[PipelineId]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[SetLogPipelineSuccess].[@PipelineId]" />
				</Entry>
			</Relationship>
			<Relationship Name="Parameters">
				<Entry>
					<Element Type="SqlSubroutineParameter" Name="[metadata].[SetLogPipelineSuccess].[@ExecutionId]">
						<Relationship Name="Type">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[uniqueidentifier]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlSubroutineParameter" Name="[metadata].[SetLogPipelineSuccess].[@StageId]">
						<Relationship Name="Type">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[int]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlSubroutineParameter" Name="[metadata].[SetLogPipelineSuccess].[@PipelineId]">
						<Relationship Name="Type">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[int]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
			</Relationship>
			<Relationship Name="Schema">
				<Entry>
					<References Name="[metadata]" />
				</Entry>
			</Relationship>
			<Annotation Type="SysCommentsObjectAnnotation">
				<Property Name="Length" Value="467" />
				<Property Name="StartLine" Value="1" />
				<Property Name="StartColumn" Value="1" />
				<Property Name="HeaderContents" Value="CREATE PROCEDURE metadata.SetLogPipelineSuccess&#xD;&#xA;&#x9;(&#xD;&#xA;&#x9;@ExecutionId UNIQUEIDENTIFIER,&#xD;&#xA;&#x9;@StageId INT,&#xD;&#xA;&#x9;@PipelineId INT&#xD;&#xA;&#x9;)&#xD;&#xA;AS" />
			</Annotation>
		</Element>
		<Element Type="SqlProcedure" Name="[metadata].[SetLogPipelineUnknown]">
			<Property Name="BodyScript">
				<Value><![CDATA[
BEGIN
	SET NOCOUNT ON;

	DECLARE @ErrorDetail VARCHAR(500);

	--mark specific failure pipeline
	UPDATE
		[metadata].[CurrentExecution]
	SET
		[PipelineStatus] = 'Unknown'
	WHERE
		[LocalExecutionId] = @ExecutionId
		AND [StageId] = @StageId
		AND [PipelineId] = @PipelineId

	--no need to block and log if done during a clean up cycle
	IF @CleanUpRun = 1 RETURN 0;

	--persist unknown pipeline records to long term log
	INSERT INTO [metadata].[ExecutionLog]
		(
		[LocalExecutionId],
		[StageId],
		[PipelineId],
		[CallingOrchestratorName],
		[ResourceGroupName],
		[OrchestratorType],
		[OrchestratorName],
		[PipelineName],
		[StartDateTime],
		[PipelineStatus],
		[EndDateTime],
		[PipelineRunId],
		[PipelineParamsUsed]
		)
	SELECT
		[LocalExecutionId],
		[StageId],
		[PipelineId],
		[CallingOrchestratorName],
		[ResourceGroupName],
		[OrchestratorType],
		[OrchestratorName],
		[PipelineName],
		[StartDateTime],
		[PipelineStatus],
		[EndDateTime],
		[PipelineRunId],
		[PipelineParamsUsed]
	FROM
		[metadata].[CurrentExecution]
	WHERE
		[PipelineStatus] = 'Unknown'
		AND [StageId] = @StageId
		AND [PipelineId] = @PipelineId;

	--block down stream stages?
	IF ([metadata].[GetPropertyValueInternal]('UnknownWorkerResultBlocks')) = 1
	BEGIN	
		--decide how to proceed with error/failure depending on framework property configuration
		IF ([metadata].[GetPropertyValueInternal]('FailureHandling')) = 'None'
			BEGIN
				--do nothing allow processing to carry on regardless
				RETURN 0;
			END;
		
		ELSE IF ([metadata].[GetPropertyValueInternal]('FailureHandling')) = 'Simple'
			BEGIN
				--flag all downstream stages as blocked
				UPDATE
					[metadata].[CurrentExecution]
				SET
					[PipelineStatus] = 'Blocked',
					[IsBlocked] = 1
				WHERE
					[LocalExecutionId] = @ExecutionId
					AND [StageId] > @StageId

				UPDATE
					[metadata].[BatchExecution]
				SET
					[BatchStatus] = 'Stopping'
				WHERE
					[ExecutionId] = @ExecutionId
					AND [BatchStatus] = 'Running';

				SET @ErrorDetail = 'Pipeline execution has an unknown status. Blocking downstream stages as a precaution.'

				RAISERROR(@ErrorDetail,16,1);
				RETURN 0;
			END;
		ELSE IF ([metadata].[GetPropertyValueInternal]('FailureHandling')) = 'DependencyChain'
			BEGIN
				EXEC [metadata].[SetExecutionBlockDependants]
					@ExecutionId = @ExecutionId,
					@PipelineId = @PipelineId
			END;
		ELSE
			BEGIN
				RAISERROR('Unknown failure handling state.',16,1);
				RETURN 0;
			END;
	END;
END;]]></Value>
			</Property>
			<Property Name="IsAnsiNullsOn" Value="True" />
			<Relationship Name="BodyDependencies">
				<Entry>
					<References ExternalSource="BuiltIns" Name="[varchar]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[CurrentExecution]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[CurrentExecution].[PipelineStatus]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[CurrentExecution].[LocalExecutionId]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[SetLogPipelineUnknown].[@ExecutionId]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[CurrentExecution].[StageId]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[SetLogPipelineUnknown].[@StageId]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[CurrentExecution].[PipelineId]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[SetLogPipelineUnknown].[@PipelineId]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[SetLogPipelineUnknown].[@CleanUpRun]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[ExecutionLog]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[ExecutionLog].[LocalExecutionId]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[ExecutionLog].[StageId]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[ExecutionLog].[PipelineId]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[ExecutionLog].[CallingOrchestratorName]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[ExecutionLog].[ResourceGroupName]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[ExecutionLog].[OrchestratorType]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[ExecutionLog].[OrchestratorName]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[ExecutionLog].[PipelineName]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[ExecutionLog].[StartDateTime]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[ExecutionLog].[PipelineStatus]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[ExecutionLog].[EndDateTime]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[ExecutionLog].[PipelineRunId]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[ExecutionLog].[PipelineParamsUsed]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[CurrentExecution].[CallingOrchestratorName]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[CurrentExecution].[ResourceGroupName]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[CurrentExecution].[OrchestratorType]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[CurrentExecution].[OrchestratorName]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[CurrentExecution].[PipelineName]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[CurrentExecution].[StartDateTime]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[CurrentExecution].[EndDateTime]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[CurrentExecution].[PipelineRunId]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[CurrentExecution].[PipelineParamsUsed]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[GetPropertyValueInternal]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[CurrentExecution].[IsBlocked]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[BatchExecution]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[BatchExecution].[BatchStatus]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[BatchExecution].[ExecutionId]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[SetExecutionBlockDependants]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[SetExecutionBlockDependants].[@ExecutionId]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[SetExecutionBlockDependants].[@PipelineId]" />
				</Entry>
			</Relationship>
			<Relationship Name="Parameters">
				<Entry>
					<Element Type="SqlSubroutineParameter" Name="[metadata].[SetLogPipelineUnknown].[@ExecutionId]">
						<Relationship Name="Type">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[uniqueidentifier]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlSubroutineParameter" Name="[metadata].[SetLogPipelineUnknown].[@StageId]">
						<Relationship Name="Type">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[int]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlSubroutineParameter" Name="[metadata].[SetLogPipelineUnknown].[@PipelineId]">
						<Relationship Name="Type">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[int]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlSubroutineParameter" Name="[metadata].[SetLogPipelineUnknown].[@CleanUpRun]">
						<Property Name="DefaultExpressionScript">
							<Value><![CDATA[0]]></Value>
						</Property>
						<Relationship Name="Type">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[bit]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
			</Relationship>
			<Relationship Name="Schema">
				<Entry>
					<References Name="[metadata]" />
				</Entry>
			</Relationship>
			<Annotation Type="SysCommentsObjectAnnotation">
				<Property Name="Length" Value="2745" />
				<Property Name="StartLine" Value="1" />
				<Property Name="StartColumn" Value="1" />
				<Property Name="HeaderContents" Value="CREATE PROCEDURE [metadata].[SetLogPipelineUnknown]&#xD;&#xA;&#x9;(&#xD;&#xA;&#x9;@ExecutionId UNIQUEIDENTIFIER,&#xD;&#xA;&#x9;@StageId INT,&#xD;&#xA;&#x9;@PipelineId INT,&#xD;&#xA;&#x9;@CleanUpRun BIT = 0&#xD;&#xA;&#x9;)&#xD;&#xA;AS" />
			</Annotation>
		</Element>
		<Element Type="SqlProcedure" Name="[metadata].[SetLogPipelineValidating]">
			<Property Name="BodyScript">
				<Value><![CDATA[
BEGIN
	SET NOCOUNT ON;

	UPDATE
		[metadata].[CurrentExecution]
	SET
		[PipelineStatus] = 'Validating'
	WHERE
		[LocalExecutionId] = @ExecutionId
		AND [StageId] = @StageId
		AND [PipelineId] = @PipelineId
END;]]></Value>
			</Property>
			<Property Name="IsAnsiNullsOn" Value="True" />
			<Relationship Name="BodyDependencies">
				<Entry>
					<References Name="[metadata].[CurrentExecution]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[CurrentExecution].[PipelineStatus]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[CurrentExecution].[LocalExecutionId]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[SetLogPipelineValidating].[@ExecutionId]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[CurrentExecution].[StageId]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[SetLogPipelineValidating].[@StageId]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[CurrentExecution].[PipelineId]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[SetLogPipelineValidating].[@PipelineId]" />
				</Entry>
			</Relationship>
			<Relationship Name="Parameters">
				<Entry>
					<Element Type="SqlSubroutineParameter" Name="[metadata].[SetLogPipelineValidating].[@ExecutionId]">
						<Relationship Name="Type">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[uniqueidentifier]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlSubroutineParameter" Name="[metadata].[SetLogPipelineValidating].[@StageId]">
						<Relationship Name="Type">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[int]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlSubroutineParameter" Name="[metadata].[SetLogPipelineValidating].[@PipelineId]">
						<Relationship Name="Type">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[int]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
			</Relationship>
			<Relationship Name="Schema">
				<Entry>
					<References Name="[metadata]" />
				</Entry>
			</Relationship>
			<Annotation Type="SysCommentsObjectAnnotation">
				<Property Name="Length" Value="356" />
				<Property Name="StartLine" Value="1" />
				<Property Name="StartColumn" Value="1" />
				<Property Name="HeaderContents" Value="CREATE PROCEDURE [metadata].[SetLogPipelineValidating]&#xD;&#xA;&#x9;(&#xD;&#xA;&#x9;@ExecutionId UNIQUEIDENTIFIER,&#xD;&#xA;&#x9;@StageId INT,&#xD;&#xA;&#x9;@PipelineId INT&#xD;&#xA;&#x9;)&#xD;&#xA;AS" />
			</Annotation>
		</Element>
		<Element Type="SqlProcedure" Name="[metadata].[SetLogStagePreparing]">
			<Property Name="BodyScript">
				<Value><![CDATA[
BEGIN
	SET NOCOUNT ON;
	
	UPDATE
		[metadata].[CurrentExecution]
	SET
		[PipelineStatus] = 'Preparing'
	WHERE
		[LocalExecutionId] = @ExecutionId
		AND [StageId] = @StageId
		AND [StartDateTime] IS NULL
		AND [IsBlocked] <> 1;
END;]]></Value>
			</Property>
			<Property Name="IsAnsiNullsOn" Value="True" />
			<Relationship Name="BodyDependencies">
				<Entry>
					<References Name="[metadata].[CurrentExecution]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[CurrentExecution].[PipelineStatus]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[CurrentExecution].[LocalExecutionId]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[SetLogStagePreparing].[@ExecutionId]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[CurrentExecution].[StageId]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[SetLogStagePreparing].[@StageId]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[CurrentExecution].[StartDateTime]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[CurrentExecution].[IsBlocked]" />
				</Entry>
			</Relationship>
			<Relationship Name="Parameters">
				<Entry>
					<Element Type="SqlSubroutineParameter" Name="[metadata].[SetLogStagePreparing].[@ExecutionId]">
						<Relationship Name="Type">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[uniqueidentifier]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlSubroutineParameter" Name="[metadata].[SetLogStagePreparing].[@StageId]">
						<Relationship Name="Type">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[int]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
			</Relationship>
			<Relationship Name="Schema">
				<Entry>
					<References Name="[metadata]" />
				</Entry>
			</Relationship>
			<Annotation Type="SysCommentsObjectAnnotation">
				<Property Name="Length" Value="355" />
				<Property Name="StartLine" Value="1" />
				<Property Name="StartColumn" Value="1" />
				<Property Name="HeaderContents" Value="CREATE PROCEDURE [metadata].[SetLogStagePreparing]&#xD;&#xA;&#x9;(&#xD;&#xA;&#x9;@ExecutionId UNIQUEIDENTIFIER,&#xD;&#xA;&#x9;@StageId INT&#xD;&#xA;&#x9;)&#xD;&#xA;AS" />
			</Annotation>
		</Element>
		<Element Type="SqlTable" Name="[metadata].[Stages]">
			<Property Name="IsAnsiNullsOn" Value="True" />
			<Relationship Name="Columns">
				<Entry>
					<Element Type="SqlSimpleColumn" Name="[metadata].[Stages].[StageId]">
						<Property Name="IsNullable" Value="False" />
						<Property Name="IsIdentity" Value="True" />
						<Relationship Name="TypeSpecifier">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[int]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlSimpleColumn" Name="[metadata].[Stages].[StageName]">
						<Property Name="IsNullable" Value="False" />
						<Relationship Name="TypeSpecifier">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Property Name="Length" Value="225" />
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[varchar]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlSimpleColumn" Name="[metadata].[Stages].[StageDescription]">
						<Relationship Name="TypeSpecifier">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Property Name="Length" Value="4000" />
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[varchar]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlSimpleColumn" Name="[metadata].[Stages].[Enabled]">
						<Property Name="IsNullable" Value="False" />
						<Relationship Name="TypeSpecifier">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[bit]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
						<AttachedAnnotation Disambiguator="27" />
					</Element>
				</Entry>
			</Relationship>
			<Relationship Name="Schema">
				<Entry>
					<References Name="[metadata]" />
				</Entry>
			</Relationship>
			<AttachedAnnotation Disambiguator="55" />
		</Element>
		<Element Type="SqlTable" Name="[metadata].[Subscriptions]">
			<Property Name="IsAnsiNullsOn" Value="True" />
			<Relationship Name="Columns">
				<Entry>
					<Element Type="SqlSimpleColumn" Name="[metadata].[Subscriptions].[SubscriptionId]">
						<Property Name="IsNullable" Value="False" />
						<Relationship Name="TypeSpecifier">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[uniqueidentifier]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlSimpleColumn" Name="[metadata].[Subscriptions].[Name]">
						<Property Name="IsNullable" Value="False" />
						<Relationship Name="TypeSpecifier">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Property Name="Length" Value="200" />
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[nvarchar]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlSimpleColumn" Name="[metadata].[Subscriptions].[Description]">
						<Relationship Name="TypeSpecifier">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Property Name="IsMax" Value="True" />
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[nvarchar]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlSimpleColumn" Name="[metadata].[Subscriptions].[TenantId]">
						<Property Name="IsNullable" Value="False" />
						<Relationship Name="TypeSpecifier">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[uniqueidentifier]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
			</Relationship>
			<Relationship Name="Schema">
				<Entry>
					<References Name="[metadata]" />
				</Entry>
			</Relationship>
			<AttachedAnnotation Disambiguator="56" />
			<AttachedAnnotation Disambiguator="43" />
		</Element>
		<Element Type="SqlTable" Name="[metadata].[Tenants]">
			<Property Name="IsAnsiNullsOn" Value="True" />
			<Relationship Name="Columns">
				<Entry>
					<Element Type="SqlSimpleColumn" Name="[metadata].[Tenants].[TenantId]">
						<Property Name="IsNullable" Value="False" />
						<Relationship Name="TypeSpecifier">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[uniqueidentifier]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlSimpleColumn" Name="[metadata].[Tenants].[Name]">
						<Property Name="IsNullable" Value="False" />
						<Relationship Name="TypeSpecifier">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Property Name="Length" Value="200" />
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[nvarchar]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlSimpleColumn" Name="[metadata].[Tenants].[Description]">
						<Relationship Name="TypeSpecifier">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Property Name="IsMax" Value="True" />
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[nvarchar]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
			</Relationship>
			<Relationship Name="Schema">
				<Entry>
					<References Name="[metadata]" />
				</Entry>
			</Relationship>
			<AttachedAnnotation Disambiguator="57" />
		</Element>
		<Element Type="SqlUniqueConstraint" Name="[metadata].[UK_EmailAddressMessagePreference]">
			<Relationship Name="ColumnSpecifications">
				<Entry>
					<Element Type="SqlIndexedColumnSpecification">
						<Relationship Name="Column">
							<Entry>
								<References Name="[metadata].[Recipients].[EmailAddress]" />
							</Entry>
						</Relationship>
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlIndexedColumnSpecification">
						<Relationship Name="Column">
							<Entry>
								<References Name="[metadata].[Recipients].[MessagePreference]" />
							</Entry>
						</Relationship>
					</Element>
				</Entry>
			</Relationship>
			<Relationship Name="DefiningTable">
				<Entry>
					<References Name="[metadata].[Recipients]" />
				</Entry>
			</Relationship>
			<AttachedAnnotation Disambiguator="58" />
		</Element>
		<Element Type="SqlUniqueConstraint" Name="[metadata].[UK_PipelineOutcomeStatus]">
			<Relationship Name="ColumnSpecifications">
				<Entry>
					<Element Type="SqlIndexedColumnSpecification">
						<Relationship Name="Column">
							<Entry>
								<References Name="[metadata].[AlertOutcomes].[PipelineOutcomeStatus]" />
							</Entry>
						</Relationship>
					</Element>
				</Entry>
			</Relationship>
			<Relationship Name="DefiningTable">
				<Entry>
					<References Name="[metadata].[AlertOutcomes]" />
				</Entry>
			</Relationship>
			<AttachedAnnotation Disambiguator="18" />
		</Element>
		<Element Type="SqlUniqueConstraint" Name="[metadata].[UK_PipelinesToDependantPipelines]">
			<Relationship Name="ColumnSpecifications">
				<Entry>
					<Element Type="SqlIndexedColumnSpecification">
						<Relationship Name="Column">
							<Entry>
								<References Name="[metadata].[PipelineDependencies].[PipelineId]" />
							</Entry>
						</Relationship>
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlIndexedColumnSpecification">
						<Relationship Name="Column">
							<Entry>
								<References Name="[metadata].[PipelineDependencies].[DependantPipelineId]" />
							</Entry>
						</Relationship>
					</Element>
				</Entry>
			</Relationship>
			<Relationship Name="DefiningTable">
				<Entry>
					<References Name="[metadata].[PipelineDependencies]" />
				</Entry>
			</Relationship>
			<AttachedAnnotation Disambiguator="50" />
		</Element>
		<Element Type="SqlProcedure" Name="[metadata].[UpdateExecutionLog]">
			<Property Name="BodyScript">
				<Value><![CDATA[
BEGIN
	SET NOCOUNT ON;
		
	DECLARE @AllCount INT
	DECLARE @SuccessCount INT

	IF([metadata].[GetPropertyValueInternal]('UseExecutionBatches')) = '0'
		BEGIN
			IF @PerformErrorCheck = 1
			BEGIN
				--Check current execution
				SELECT @AllCount = COUNT(0) FROM [metadata].[CurrentExecution]
				SELECT @SuccessCount = COUNT(0) FROM [metadata].[CurrentExecution] WHERE [PipelineStatus] = 'Success'

				IF @AllCount <> @SuccessCount
					BEGIN
						RAISERROR('Framework execution complete but not all Worker pipelines succeeded. See the [metadata].[CurrentExecution] table for details',16,1);
						RETURN 0;
					END;
			END;

			--Do this if no error raised and when called by the execution wrapper (OverideRestart = 1).
			INSERT INTO [metadata].[ExecutionLog]
				(
				[LocalExecutionId],
				[StageId],
				[PipelineId],
				[CallingOrchestratorName],
				[ResourceGroupName],
				[OrchestratorType],
				[OrchestratorName],
				[PipelineName],
				[StartDateTime],
				[PipelineStatus],
				[EndDateTime],
				[PipelineRunId],
				[PipelineParamsUsed]
				)
			SELECT
				[LocalExecutionId],
				[StageId],
				[PipelineId],
				[CallingOrchestratorName],
				[ResourceGroupName],
				[OrchestratorType],
				[OrchestratorName],
				[PipelineName],
				[StartDateTime],
				[PipelineStatus],
				[EndDateTime],
				[PipelineRunId],
				[PipelineParamsUsed]
			FROM
				[metadata].[CurrentExecution];

			TRUNCATE TABLE [metadata].[CurrentExecution];
		END
	ELSE IF ([metadata].[GetPropertyValueInternal]('UseExecutionBatches')) = '1'
		BEGIN
			IF @PerformErrorCheck = 1
			BEGIN
				--Check current execution
				SELECT 
					@AllCount = COUNT(0) 
				FROM 
					[metadata].[CurrentExecution]
				WHERE 
					[LocalExecutionId] = @ExecutionId;
				
				SELECT 
					@SuccessCount = COUNT(0) 
				FROM 
					[metadata].[CurrentExecution]
				WHERE 
					[LocalExecutionId] = @ExecutionId 
					AND [PipelineStatus] = 'Success';

				IF @AllCount <> @SuccessCount
					BEGIN
						UPDATE
							[metadata].[BatchExecution]
						SET
							[BatchStatus] = 'Stopped',
							[EndDateTime] = GETUTCDATE()
						WHERE
							[ExecutionId] = @ExecutionId;
						
						RAISERROR('Framework execution complete for batch but not all Worker pipelines succeeded. See the [metadata].[CurrentExecution] table for details',16,1);
						RETURN 0;
					END;
				ELSE
					BEGIN
						UPDATE
							[metadata].[BatchExecution]
						SET
							[BatchStatus] = 'Success',
							[EndDateTime] = GETUTCDATE()
						WHERE
							[ExecutionId] = @ExecutionId;
					END;
			END; --end check

			--Do this if no error raised and when called by the execution wrapper (OverideRestart = 1).
			INSERT INTO [metadata].[ExecutionLog]
				(
				[LocalExecutionId],
				[StageId],
				[PipelineId],
				[CallingOrchestratorName],
				[ResourceGroupName],
				[OrchestratorType],
				[OrchestratorName],
				[PipelineName],
				[StartDateTime],
				[PipelineStatus],
				[EndDateTime],
				[PipelineRunId],
				[PipelineParamsUsed]
				)
			SELECT
				[LocalExecutionId],
				[StageId],
				[PipelineId],
				[CallingOrchestratorName],
				[ResourceGroupName],
				[OrchestratorType],
				[OrchestratorName],
				[PipelineName],
				[StartDateTime],
				[PipelineStatus],
				[EndDateTime],
				[PipelineRunId],
				[PipelineParamsUsed]
			FROM
				[metadata].[CurrentExecution]
			WHERE 
				[LocalExecutionId] = @ExecutionId;

			DELETE FROM
				[metadata].[CurrentExecution]
			WHERE
				[LocalExecutionId] = @ExecutionId;
		END;
END;]]></Value>
			</Property>
			<Property Name="IsAnsiNullsOn" Value="True" />
			<Relationship Name="BodyDependencies">
				<Entry>
					<References ExternalSource="BuiltIns" Name="[int]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[int]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[GetPropertyValueInternal]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[UpdateExecutionLog].[@PerformErrorCheck]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[CurrentExecution]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[CurrentExecution].[PipelineStatus]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[ExecutionLog]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[ExecutionLog].[LocalExecutionId]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[ExecutionLog].[StageId]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[ExecutionLog].[PipelineId]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[ExecutionLog].[CallingOrchestratorName]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[ExecutionLog].[ResourceGroupName]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[ExecutionLog].[OrchestratorType]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[ExecutionLog].[OrchestratorName]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[ExecutionLog].[PipelineName]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[ExecutionLog].[StartDateTime]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[ExecutionLog].[PipelineStatus]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[ExecutionLog].[EndDateTime]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[ExecutionLog].[PipelineRunId]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[ExecutionLog].[PipelineParamsUsed]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[CurrentExecution].[LocalExecutionId]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[CurrentExecution].[StageId]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[CurrentExecution].[PipelineId]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[CurrentExecution].[CallingOrchestratorName]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[CurrentExecution].[ResourceGroupName]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[CurrentExecution].[OrchestratorType]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[CurrentExecution].[OrchestratorName]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[CurrentExecution].[PipelineName]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[CurrentExecution].[StartDateTime]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[CurrentExecution].[EndDateTime]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[CurrentExecution].[PipelineRunId]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[CurrentExecution].[PipelineParamsUsed]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[UpdateExecutionLog].[@ExecutionId]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[BatchExecution]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[BatchExecution].[BatchStatus]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[BatchExecution].[EndDateTime]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[BatchExecution].[ExecutionId]" />
				</Entry>
			</Relationship>
			<Relationship Name="Parameters">
				<Entry>
					<Element Type="SqlSubroutineParameter" Name="[metadata].[UpdateExecutionLog].[@PerformErrorCheck]">
						<Property Name="DefaultExpressionScript">
							<Value><![CDATA[1]]></Value>
						</Property>
						<Relationship Name="Type">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[bit]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlSubroutineParameter" Name="[metadata].[UpdateExecutionLog].[@ExecutionId]">
						<Property Name="DefaultExpressionScript">
							<Value><![CDATA[NULL]]></Value>
						</Property>
						<Relationship Name="Type">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[uniqueidentifier]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
			</Relationship>
			<Relationship Name="Schema">
				<Entry>
					<References Name="[metadata]" />
				</Entry>
			</Relationship>
			<Annotation Type="SysCommentsObjectAnnotation">
				<Property Name="Length" Value="3790" />
				<Property Name="StartLine" Value="1" />
				<Property Name="StartColumn" Value="1" />
				<Property Name="HeaderContents" Value="CREATE PROCEDURE [metadata].[UpdateExecutionLog]&#xD;&#xA;&#x9;(&#xD;&#xA;&#x9;@PerformErrorCheck BIT = 1,&#xD;&#xA;&#x9;@ExecutionId UNIQUEIDENTIFIER = NULL&#xD;&#xA;&#x9;)&#xD;&#xA;AS" />
			</Annotation>
		</Element>
		<Element Type="SqlSynonym" Name="[metadata].[WorkerParallelismOverTime]">
			<Property Name="ForObjectScript">
				<Value><![CDATA[[metadataReporting].[WorkerParallelismOverTime]]]></Value>
			</Property>
			<Relationship Name="ForObject">
				<Entry>
					<References Name="[metadataReporting].[WorkerParallelismOverTime]" />
					<Annotation Type="PersistedResolvableAnnotation" Name="[metadataReporting].[WorkerParallelismOverTime]">
						<Property Name="TargetTypeStorage" Value="ISqlSynonymTarget" />
						<Property Name="Length" Value="47" />
						<Property Name="Offset" Value="59" />
					</Annotation>
				</Entry>
			</Relationship>
			<Relationship Name="Schema">
				<Entry>
					<References Name="[metadata]" />
				</Entry>
			</Relationship>
		</Element>
		<Element Type="SqlSchema" Name="[metadataHelpers]">
			<Relationship Name="Authorizer">
				<Entry>
					<References ExternalSource="BuiltIns" Name="[dbo]" />
				</Entry>
			</Relationship>
		</Element>
		<Element Type="SqlProcedure" Name="[metadataHelpers].[AddPipelineDependant]">
			<Property Name="BodyScript">
				<Value><![CDATA[
BEGIN
	SET NOCOUNT ON;

	DECLARE @PipelineId INT;
	DECLARE @DependantPipelineId INT;

	--get pipeline ids
	SELECT
		@PipelineId = [PipelineId]
	FROM
		[metadata].[Pipelines]
	WHERE
		[PipelineName] = @PipelineName;

	SELECT
		@DependantPipelineId = [PipelineId]
	FROM
		[metadata].[Pipelines]
	WHERE
		[PipelineName] = @DependantPipelineName;

	--defensive checks
	IF @PipelineId IS NULL
	BEGIN
		RAISERROR('Pipeline not found in pipelines table.', 16,1);
		RETURN 0;
	END;

	IF @DependantPipelineId IS NULL
	BEGIN
		RAISERROR('Dependant pipeline not found in pipelines table.', 16,1);
		RETURN 0;
	END;

	IF @PipelineId = @DependantPipelineId
	BEGIN
		RAISERROR('Pipeline cannot be dependant on itself.', 16,1);
		RETURN 0;
	END;

	IF EXISTS
		(
		SELECT 
			*
		FROM 
			[metadata].[Pipelines] pp
			INNER JOIN [metadata].[Pipelines] dp
				ON dp.[PipelineId] = @DependantPipelineId
		WHERE
			pp.[PipelineId] = @PipelineId
			AND pp.[StageId] = dp.[StageId]
		)
		BEGIN
			RAISERROR('Pipeline and dependent pipeline cannot be in the same execution stage.', 16,1);
			RETURN 0;
		END;

	--final soft check and insert
	IF EXISTS
		(
		SELECT 
			* 
		FROM 
			[metadata].[PipelineDependencies]
		WHERE
			[PipelineId] = @PipelineId
			AND [DependantPipelineId] = @DependantPipelineId
		)
		BEGIN
			PRINT 'Dependency already exists. Nothing added.'
			RETURN 0;
		END
	ELSE
		BEGIN
			INSERT INTO [metadata].[PipelineDependencies]
				(
				[PipelineId],
				[DependantPipelineId]
				)
			VALUES
				(
				@PipelineId,
				@DependantPipelineId
				)
		END;
END;]]></Value>
			</Property>
			<Property Name="IsAnsiNullsOn" Value="True" />
			<Relationship Name="BodyDependencies">
				<Entry>
					<References ExternalSource="BuiltIns" Name="[int]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[int]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[Pipelines]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[Pipelines].[PipelineId]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[Pipelines].[PipelineName]" />
				</Entry>
				<Entry>
					<References Name="[metadataHelpers].[AddPipelineDependant].[@PipelineName]" />
				</Entry>
				<Entry>
					<References Name="[metadataHelpers].[AddPipelineDependant].[@DependantPipelineName]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[Pipelines].[PipelineId]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[Pipelines].[PipelineId]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[Pipelines].[StageId]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[Pipelines].[StageId]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[PipelineDependencies]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[PipelineDependencies].[PipelineId]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[PipelineDependencies].[DependantPipelineId]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[PipelineDependencies].[PipelineId]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[PipelineDependencies].[DependantPipelineId]" />
				</Entry>
			</Relationship>
			<Relationship Name="Parameters">
				<Entry>
					<Element Type="SqlSubroutineParameter" Name="[metadataHelpers].[AddPipelineDependant].[@PipelineName]">
						<Relationship Name="Type">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Property Name="Length" Value="200" />
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[nvarchar]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlSubroutineParameter" Name="[metadataHelpers].[AddPipelineDependant].[@DependantPipelineName]">
						<Relationship Name="Type">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Property Name="Length" Value="200" />
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[nvarchar]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
			</Relationship>
			<Relationship Name="Schema">
				<Entry>
					<References Name="[metadataHelpers]" />
				</Entry>
			</Relationship>
			<Annotation Type="SysCommentsObjectAnnotation">
				<Property Name="Length" Value="1789" />
				<Property Name="StartLine" Value="1" />
				<Property Name="StartColumn" Value="1" />
				<Property Name="HeaderContents" Value="CREATE PROCEDURE [metadataHelpers].[AddPipelineDependant]&#xD;&#xA;&#x9;(&#xD;&#xA;&#x9;@PipelineName NVARCHAR(200),&#xD;&#xA;&#x9;@DependantPipelineName NVARCHAR(200)&#xD;&#xA;&#x9;)&#xD;&#xA;AS" />
			</Annotation>
		</Element>
		<Element Type="SqlProcedure" Name="[metadataHelpers].[AddPipelineViaPowerShell]">
			<Property Name="BodyScript">
				<Value><![CDATA[
BEGIN
	SET NOCOUNT ON;

	DECLARE @OrchestratorId INT
	DECLARE @StageId INT
	DECLARE @StageName VARCHAR(255) = 'PoShAdded'

	--get/set orchestrator
	IF EXISTS
		(
		SELECT * FROM [metadata].[Orchestrators] WHERE [OrchestratorName] = @OrchestratorName AND [ResourceGroupName] = @ResourceGroup AND [OrchestratorType] = @OrchestratorType
		)
		BEGIN
			SELECT @OrchestratorId = [OrchestratorId] FROM [metadata].[Orchestrators] WHERE [OrchestratorName] = @OrchestratorName AND [ResourceGroupName] = @ResourceGroup AND [OrchestratorType] = @OrchestratorType;
		END
	ELSE
		BEGIN
			INSERT INTO [metadata].[Orchestrators]
				(
				[OrchestratorName],
				[OrchestratorType],
				[ResourceGroupName],
				[Description],
				[SubscriptionId]
				)
			VALUES
				(
				@OrchestratorName,
				@OrchestratorType,
				@ResourceGroup,
				'Added via PowerShell.',
				'12345678-1234-1234-1234-012345678910'
				)

			SELECT
				@OrchestratorId = SCOPE_IDENTITY();
		END

	--get/set stage
	IF EXISTS
		(
		SELECT * FROM [metadata].[Stages] WHERE [StageName] = @StageName
		)
		BEGIN
			SELECT @StageId = [StageId] FROM [metadata].[Stages] WHERE [StageName] = @StageName;
		END;
	ELSE
		BEGIN
			INSERT INTO [metadata].[Stages]
				(
				[StageName],
				[StageDescription],
				[Enabled]
				)
			VALUES
				(
				@StageName,
				'Added via PowerShell.',
				1
				);

			SELECT
				@StageId = SCOPE_IDENTITY();
		END;

	--upsert pipeline
	;WITH sourceData AS
		(
		SELECT
			@OrchestratorId AS OrchestratorId,
			@PipelineName AS PipelineName,
			@StageId AS StageId,
			NULL AS LogicalPredecessorId,
			1 AS [Enabled]
		)
	MERGE INTO [metadata].[Pipelines] AS tgt
	USING 
		sourceData AS src
			ON tgt.[OrchestratorId] = src.[OrchestratorId]
				AND tgt.[PipelineName] = src.[PipelineName]
	WHEN MATCHED THEN
		UPDATE
		SET
			tgt.[StageId] = src.[StageId],
			tgt.[LogicalPredecessorId] = src.[LogicalPredecessorId],
			tgt.[Enabled] = src.[Enabled]
	WHEN NOT MATCHED BY TARGET THEN
		INSERT
			(
			[OrchestratorId],
			[StageId],
			[PipelineName], 
			[LogicalPredecessorId],
			[Enabled]
			)
		VALUES
			(
			src.[OrchestratorId],
			src.[StageId],
			src.[PipelineName], 
			src.[LogicalPredecessorId],
			src.[Enabled]
			);
END;]]></Value>
			</Property>
			<Property Name="IsAnsiNullsOn" Value="True" />
			<Relationship Name="BodyDependencies">
				<Entry>
					<References ExternalSource="BuiltIns" Name="[int]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[int]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[varchar]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[Orchestrators]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[Orchestrators].[OrchestratorName]" />
				</Entry>
				<Entry>
					<References Name="[metadataHelpers].[AddPipelineViaPowerShell].[@OrchestratorName]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[Orchestrators].[ResourceGroupName]" />
				</Entry>
				<Entry>
					<References Name="[metadataHelpers].[AddPipelineViaPowerShell].[@ResourceGroup]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[Orchestrators].[OrchestratorType]" />
				</Entry>
				<Entry>
					<References Name="[metadataHelpers].[AddPipelineViaPowerShell].[@OrchestratorType]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[Orchestrators].[OrchestratorId]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[Orchestrators].[OrchestratorName]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[Orchestrators].[ResourceGroupName]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[Orchestrators].[OrchestratorType]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[Orchestrators].[Description]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[Orchestrators].[SubscriptionId]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[Stages]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[Stages].[StageName]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[Stages].[StageId]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[Stages].[StageName]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[Stages].[StageDescription]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[Stages].[Enabled]" />
				</Entry>
				<Entry>
					<References Name="[metadataHelpers].[AddPipelineViaPowerShell].[@PipelineName]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[Pipelines]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[Pipelines].[OrchestratorId]" />
				</Entry>
				<Entry />
				<Entry>
					<References Name="[metadata].[Pipelines].[PipelineName]" />
				</Entry>
				<Entry>
					<References Name="[metadataHelpers].[AddPipelineViaPowerShell].[@PipelineName]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[Pipelines].[StageId]" />
				</Entry>
				<Entry />
				<Entry>
					<References Name="[metadata].[Pipelines].[LogicalPredecessorId]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[Pipelines].[Enabled]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[Pipelines].[OrchestratorId]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[Pipelines].[StageId]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[Pipelines].[PipelineName]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[Pipelines].[LogicalPredecessorId]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[Pipelines].[Enabled]" />
				</Entry>
			</Relationship>
			<Relationship Name="DynamicObjects">
				<Entry>
					<Element Type="SqlDynamicColumnSource" Name="[metadataHelpers].[AddPipelineViaPowerShell].[CTE1].[sourceData]">
						<Relationship Name="Columns">
							<Entry>
								<Element Type="SqlComputedColumn" Name="[metadataHelpers].[AddPipelineViaPowerShell].[CTE1].[sourceData].[OrchestratorId]">
									<Relationship Name="ExpressionDependencies">
										<Entry />
									</Relationship>
								</Element>
							</Entry>
							<Entry>
								<Element Type="SqlComputedColumn" Name="[metadataHelpers].[AddPipelineViaPowerShell].[CTE1].[sourceData].[PipelineName]">
									<Relationship Name="ExpressionDependencies">
										<Entry>
											<References Name="[metadataHelpers].[AddPipelineViaPowerShell].[@PipelineName]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
							<Entry>
								<Element Type="SqlComputedColumn" Name="[metadataHelpers].[AddPipelineViaPowerShell].[CTE1].[sourceData].[StageId]">
									<Relationship Name="ExpressionDependencies">
										<Entry />
									</Relationship>
								</Element>
							</Entry>
							<Entry>
								<Element Type="SqlComputedColumn" Name="[metadataHelpers].[AddPipelineViaPowerShell].[CTE1].[sourceData].[LogicalPredecessorId]" />
							</Entry>
							<Entry>
								<Element Type="SqlComputedColumn" Name="[metadataHelpers].[AddPipelineViaPowerShell].[CTE1].[sourceData].[Enabled]" />
							</Entry>
						</Relationship>
					</Element>
				</Entry>
			</Relationship>
			<Relationship Name="Parameters">
				<Entry>
					<Element Type="SqlSubroutineParameter" Name="[metadataHelpers].[AddPipelineViaPowerShell].[@ResourceGroup]">
						<Relationship Name="Type">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Property Name="Length" Value="200" />
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[nvarchar]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlSubroutineParameter" Name="[metadataHelpers].[AddPipelineViaPowerShell].[@OrchestratorName]">
						<Relationship Name="Type">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Property Name="Length" Value="200" />
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[nvarchar]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlSubroutineParameter" Name="[metadataHelpers].[AddPipelineViaPowerShell].[@OrchestratorType]">
						<Property Name="DefaultExpressionScript">
							<Value><![CDATA['ADF']]></Value>
						</Property>
						<Relationship Name="Type">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Property Name="Length" Value="3" />
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[char]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlSubroutineParameter" Name="[metadataHelpers].[AddPipelineViaPowerShell].[@PipelineName]">
						<Relationship Name="Type">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Property Name="Length" Value="200" />
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[nvarchar]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
			</Relationship>
			<Relationship Name="Schema">
				<Entry>
					<References Name="[metadataHelpers]" />
				</Entry>
			</Relationship>
			<Annotation Type="SysCommentsObjectAnnotation">
				<Property Name="Length" Value="2537" />
				<Property Name="StartLine" Value="1" />
				<Property Name="StartColumn" Value="1" />
				<Property Name="HeaderContents" Value="CREATE PROCEDURE [metadataHelpers].[AddPipelineViaPowerShell]&#xD;&#xA;&#x9;(&#xD;&#xA;&#x9;@ResourceGroup NVARCHAR(200),&#xD;&#xA;&#x9;@OrchestratorName NVARCHAR(200),&#xD;&#xA;&#x9;@OrchestratorType CHAR(3) = 'ADF',&#xD;&#xA;&#x9;@PipelineName NVARCHAR(200)&#xD;&#xA;&#x9;)&#xD;&#xA;AS" />
			</Annotation>
		</Element>
		<Element Type="SqlProcedure" Name="[metadataHelpers].[AddProperty]">
			<Property Name="BodyScript">
				<Value><![CDATA[
BEGIN
	
	SET NOCOUNT ON;

	--defensive check
	IF EXISTS
		(
		SELECT * FROM [metadata].[Properties] WHERE [PropertyName] = @PropertyName AND [ValidTo] IS NOT NULL
		)
		AND NOT EXISTS
		(
		SELECT * FROM [metadata].[Properties] WHERE [PropertyName] = @PropertyName AND [ValidTo] IS NULL
		)
		BEGIN
			WITH lastValue AS
				(
				SELECT
					[PropertyId],
					ROW_NUMBER() OVER (PARTITION BY [PropertyName] ORDER BY [ValidTo] ASC) AS Rn
				FROM
					[metadata].[Properties]
				WHERE
					[PropertyName] = @PropertyName
				)
			--reset property if valid to date has been incorrectly set
			UPDATE
				prop
			SET
				[ValidTo] = NULL
			FROM
				[metadata].[Properties] prop
				INNER JOIN lastValue
					ON prop.[PropertyId] = lastValue.[PropertyId]
			WHERE
				lastValue.[Rn] = 1
		END
	

	--upsert property
	;WITH sourceTable AS
		(
		SELECT
			@PropertyName AS PropertyName,
			@PropertyValue AS PropertyValue,
			@Description AS [Description],
			GETUTCDATE() AS StartEndDate
		)
	--insert new version of existing property from MERGE OUTPUT
	INSERT INTO [metadata].[Properties]
		(
		[PropertyName],
		[PropertyValue],
		[Description],
		[ValidFrom]
		)
	SELECT
		[PropertyName],
		[PropertyValue],
		[Description],
		GETUTCDATE()
	FROM
		(
		MERGE INTO
			[metadata].[Properties] targetTable
		USING
			sourceTable
				ON sourceTable.[PropertyName] = targetTable.[PropertyName]	
		--set valid to date on existing property
		WHEN MATCHED AND [ValidTo] IS NULL THEN 
			UPDATE
			SET
				targetTable.[ValidTo] = sourceTable.[StartEndDate]
		--add new property
		WHEN NOT MATCHED BY TARGET THEN
			INSERT
				(
				[PropertyName],
				[PropertyValue],
				[Description],
				[ValidFrom]
				)
			VALUES
				(
				sourceTable.[PropertyName],
				sourceTable.[PropertyValue],
				sourceTable.[Description],
				sourceTable.[StartEndDate]
				)
			--for new entry of existing record
			OUTPUT
				$action AS [Action],
				sourceTable.*
			) AS MergeOutput
		WHERE
			MergeOutput.[Action] = 'UPDATE';
END;]]></Value>
			</Property>
			<Property Name="IsAnsiNullsOn" Value="True" />
			<Relationship Name="BodyDependencies">
				<Entry>
					<References Name="[metadata].[Properties]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[Properties].[PropertyName]" />
				</Entry>
				<Entry>
					<References Name="[metadataHelpers].[AddProperty].[@PropertyName]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[Properties].[ValidTo]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[Properties].[PropertyId]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[Properties].[PropertyName]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[Properties].[ValidTo]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[Properties].[PropertyId]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[Properties].[PropertyId]" />
				</Entry>
				<Entry>
					<References Name="[metadataHelpers].[AddProperty].[@PropertyValue]" />
				</Entry>
				<Entry>
					<References Name="[metadataHelpers].[AddProperty].[@Description]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[Properties].[PropertyValue]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[Properties].[Description]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[Properties].[ValidFrom]" />
				</Entry>
				<Entry>
					<References Name="[metadataHelpers].[AddProperty].[@PropertyName]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[Properties].[PropertyName]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[Properties].[ValidTo]" />
				</Entry>
			</Relationship>
			<Relationship Name="DynamicObjects">
				<Entry>
					<Element Type="SqlDynamicColumnSource" Name="[metadataHelpers].[AddProperty].[CTE1].[lastValue]">
						<Relationship Name="Columns">
							<Entry>
								<Element Type="SqlComputedColumn" Name="[metadataHelpers].[AddProperty].[CTE1].[lastValue].[PropertyId]">
									<Relationship Name="ExpressionDependencies">
										<Entry>
											<References Name="[metadata].[Properties].[PropertyId]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
							<Entry>
								<Element Type="SqlComputedColumn" Name="[metadataHelpers].[AddProperty].[CTE1].[lastValue].[Rn]" />
							</Entry>
						</Relationship>
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlDynamicColumnSource" Name="[metadataHelpers].[AddProperty].[CTE2].[sourceTable]">
						<Relationship Name="Columns">
							<Entry>
								<Element Type="SqlComputedColumn" Name="[metadataHelpers].[AddProperty].[CTE2].[sourceTable].[PropertyName]">
									<Relationship Name="ExpressionDependencies">
										<Entry>
											<References Name="[metadataHelpers].[AddProperty].[@PropertyName]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
							<Entry>
								<Element Type="SqlComputedColumn" Name="[metadataHelpers].[AddProperty].[CTE2].[sourceTable].[PropertyValue]">
									<Relationship Name="ExpressionDependencies">
										<Entry>
											<References Name="[metadataHelpers].[AddProperty].[@PropertyValue]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
							<Entry>
								<Element Type="SqlComputedColumn" Name="[metadataHelpers].[AddProperty].[CTE2].[sourceTable].[Description]">
									<Relationship Name="ExpressionDependencies">
										<Entry>
											<References Name="[metadataHelpers].[AddProperty].[@Description]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
							<Entry>
								<Element Type="SqlComputedColumn" Name="[metadataHelpers].[AddProperty].[CTE2].[sourceTable].[StartEndDate]" />
							</Entry>
						</Relationship>
					</Element>
				</Entry>
			</Relationship>
			<Relationship Name="Parameters">
				<Entry>
					<Element Type="SqlSubroutineParameter" Name="[metadataHelpers].[AddProperty].[@PropertyName]">
						<Relationship Name="Type">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Property Name="Length" Value="128" />
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[varchar]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlSubroutineParameter" Name="[metadataHelpers].[AddProperty].[@PropertyValue]">
						<Relationship Name="Type">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Property Name="IsMax" Value="True" />
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[nvarchar]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlSubroutineParameter" Name="[metadataHelpers].[AddProperty].[@Description]">
						<Property Name="DefaultExpressionScript">
							<Value><![CDATA[NULL]]></Value>
						</Property>
						<Relationship Name="Type">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Property Name="IsMax" Value="True" />
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[nvarchar]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
			</Relationship>
			<Relationship Name="Schema">
				<Entry>
					<References Name="[metadataHelpers]" />
				</Entry>
			</Relationship>
			<Annotation Type="SysCommentsObjectAnnotation">
				<Property Name="Length" Value="2263" />
				<Property Name="StartLine" Value="1" />
				<Property Name="StartColumn" Value="1" />
				<Property Name="HeaderContents" Value="CREATE PROCEDURE [metadataHelpers].[AddProperty]&#xD;&#xA;&#x9;(&#xD;&#xA;&#x9;@PropertyName VARCHAR(128),&#xD;&#xA;&#x9;@PropertyValue NVARCHAR(MAX),&#xD;&#xA;&#x9;@Description NVARCHAR(MAX) = NULL&#xD;&#xA;&#x9;)&#xD;&#xA;AS" />
			</Annotation>
		</Element>
		<Element Type="SqlProcedure" Name="[metadataHelpers].[AddRecipientPipelineAlerts]">
			<Property Name="BodyScript">
				<Value><![CDATA[
BEGIN
	SET NOCOUNT ON;

	DECLARE @ActualBitValue INT
	DECLARE @SQL NVARCHAR(MAX) = ''
	DECLARE @BitValue TABLE ([TotalBitValue] INT NOT NULL);

	--get alert status bit value
	SET @AlertForStatus = LTRIM(RTRIM(@AlertForStatus))
	SET @AlertForStatus = REPLACE(@AlertForStatus,' ','')
	SET @AlertForStatus = '''' + REPLACE(@AlertForStatus,',',''',''') + ''''

	SET @SQL = 
		'
		SELECT
			SUM([BitValue]) AS ''TotalBitValue''
		FROM
			[metadata].[AlertOutcomes]
		WHERE
			[PipelineOutcomeStatus] IN (' + @AlertForStatus + ')
		'

	INSERT INTO @BitValue ([TotalBitValue]) EXECUTE(@SQL)
	SELECT @ActualBitValue = [TotalBitValue] FROM @BitValue
	
	--set link table
	IF @PipelineName IS NOT NULL
		BEGIN
			--add alert for specific pipeline if doesn't exist
			INSERT INTO [metadata].[PipelineAlertLink]
				(
				[PipelineId],
				[RecipientId],
				[OutcomesBitValue]
				)			
			SELECT
				p.[PipelineId],
				r.[RecipientId],
				@ActualBitValue
			FROM
				[metadata].[Pipelines] p
				INNER JOIN [metadata].[Recipients] r
					ON r.[Name] = @RecipientName
				LEFT OUTER JOIN [metadata].[PipelineAlertLink] al
					ON p.[PipelineId] = al.[PipelineId]
						AND r.[RecipientId] = al.[RecipientId]
			WHERE
				p.[PipelineName] = @PipelineName
				AND al.[PipelineId] IS NULL
				AND al.[RecipientId] IS NULL;
		END
	ELSE IF @PipelineName IS NULL
		BEGIN
			--remove and re-add alerts for all pipelines
			DELETE 
				al
			FROM 
				[metadata].[PipelineAlertLink] al
				INNER JOIN [metadata].[Recipients] r
					ON al.[RecipientId] = r.[RecipientId]
			WHERE
				r.[Name] = @RecipientName;
						
			INSERT INTO [metadata].[PipelineAlertLink]
				(
				[PipelineId],
				[RecipientId],
				[OutcomesBitValue]
				)
			SELECT
				p.[PipelineId],
				r.[RecipientId],
				@ActualBitValue
			FROM
				[metadata].[Recipients] r
				CROSS JOIN [metadata].[Pipelines] p
			WHERE
				r.[Name] = @RecipientName;
		END;
END]]></Value>
			</Property>
			<Property Name="IsAnsiNullsOn" Value="True" />
			<Relationship Name="BodyDependencies">
				<Entry>
					<References ExternalSource="BuiltIns" Name="[int]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[nvarchar]" />
				</Entry>
				<Entry>
					<References Name="[metadataHelpers].[AddRecipientPipelineAlerts].[@AlertForStatus]" />
				</Entry>
				<Entry>
					<References Name="[metadataHelpers].[AddRecipientPipelineAlerts].[@BitValue].[TotalBitValue]" />
				</Entry>
				<Entry>
					<References Name="[metadataHelpers].[AddRecipientPipelineAlerts].[@PipelineName]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[PipelineAlertLink]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[PipelineAlertLink].[PipelineId]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[PipelineAlertLink].[RecipientId]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[PipelineAlertLink].[OutcomesBitValue]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[Pipelines]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[Recipients]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[Recipients].[Name]" />
				</Entry>
				<Entry>
					<References Name="[metadataHelpers].[AddRecipientPipelineAlerts].[@RecipientName]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[Pipelines].[PipelineId]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[PipelineAlertLink].[PipelineId]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[Recipients].[RecipientId]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[PipelineAlertLink].[RecipientId]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[Pipelines].[PipelineName]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[PipelineAlertLink].[RecipientId]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[Recipients].[RecipientId]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[Recipients].[Name]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[Pipelines].[PipelineId]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[Recipients].[RecipientId]" />
				</Entry>
			</Relationship>
			<Relationship Name="DynamicObjects">
				<Entry>
					<Element Type="SqlDynamicColumnSource" Name="[metadataHelpers].[AddRecipientPipelineAlerts].[@BitValue]">
						<Relationship Name="Columns">
							<Entry>
								<Element Type="SqlSimpleColumn" Name="[metadataHelpers].[AddRecipientPipelineAlerts].[@BitValue].[TotalBitValue]">
									<Property Name="IsNullable" Value="False" />
									<Relationship Name="TypeSpecifier">
										<Entry>
											<Element Type="SqlTypeSpecifier">
												<Relationship Name="Type">
													<Entry>
														<References ExternalSource="BuiltIns" Name="[int]" />
													</Entry>
												</Relationship>
											</Element>
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
			</Relationship>
			<Relationship Name="Parameters">
				<Entry>
					<Element Type="SqlSubroutineParameter" Name="[metadataHelpers].[AddRecipientPipelineAlerts].[@RecipientName]">
						<Relationship Name="Type">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Property Name="Length" Value="255" />
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[varchar]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlSubroutineParameter" Name="[metadataHelpers].[AddRecipientPipelineAlerts].[@PipelineName]">
						<Property Name="DefaultExpressionScript">
							<Value><![CDATA[NULL]]></Value>
						</Property>
						<Relationship Name="Type">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Property Name="Length" Value="200" />
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[nvarchar]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlSubroutineParameter" Name="[metadataHelpers].[AddRecipientPipelineAlerts].[@AlertForStatus]">
						<Property Name="DefaultExpressionScript">
							<Value><![CDATA['All']]></Value>
						</Property>
						<Relationship Name="Type">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Property Name="Length" Value="500" />
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[nvarchar]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
			</Relationship>
			<Relationship Name="Schema">
				<Entry>
					<References Name="[metadataHelpers]" />
				</Entry>
			</Relationship>
			<Annotation Type="SysCommentsObjectAnnotation">
				<Property Name="Length" Value="2180" />
				<Property Name="StartLine" Value="1" />
				<Property Name="StartColumn" Value="1" />
				<Property Name="HeaderContents" Value="CREATE PROCEDURE [metadataHelpers].[AddRecipientPipelineAlerts]&#xD;&#xA;&#x9;(&#xD;&#xA;&#x9;@RecipientName VARCHAR(255),&#xD;&#xA;&#x9;@PipelineName NVARCHAR(200) = NULL,&#xD;&#xA;&#x9;@AlertForStatus NVARCHAR(500) = 'All'&#xD;&#xA;&#x9;)&#xD;&#xA;AS" />
			</Annotation>
		</Element>
		<Element Type="SqlProcedure" Name="[metadataHelpers].[AddServicePrincipal]">
			<Property Name="BodyScript">
				<Value><![CDATA[
BEGIN

	SET NOCOUNT ON;

	DECLARE @ErrorDetails NVARCHAR(500) = ''
	DECLARE @CredentialId INT
	DECLARE @LocalPrincipalId UNIQUEIDENTIFIER

	--defensive checks
	BEGIN TRY
		SELECT --assigned to variable just to supress output of SELECT
			@LocalPrincipalId = CAST(@PrincipalId AS UNIQUEIDENTIFIER)
	END TRY
	BEGIN CATCH
			SET @ErrorDetails = 'Invalid @PrincipalId provided. The format must be a UNIQUEIDENTIFIER.'
			RAISERROR(@ErrorDetails, 16, 1);
			RETURN 0;
	END CATCH

	IF NOT EXISTS
		(
		SELECT [OrchestratorName] FROM [metadata].[Orchestrators] WHERE [OrchestratorName] = @OrchestratorName AND [OrchestratorType] = @OrchestratorType
		)
		BEGIN
			SET @ErrorDetails = 'Invalid Orchestrator name. Please ensure the Orchestrator metadata exists before trying to add authentication for it.'
			RAISERROR(@ErrorDetails, 16, 1);
			RETURN 0;
		END
	
	IF EXISTS
		(
		SELECT
			*
		FROM
			[metadata].[PipelineAuthLink] AL
			INNER JOIN [metadata].[Orchestrators] DF
				ON AL.[OrchestratorId] = DF.[OrchestratorId]
			INNER JOIN [metadata].[Pipelines] PP
				ON AL.[PipelineId] = PP.[PipelineId]
		WHERE
			DF.[OrchestratorName] = @OrchestratorName
			AND DF.[OrchestratorType] = @OrchestratorType
			AND PP.[PipelineName] = @SpecificPipelineName
		)
		BEGIN
			SET @ErrorDetails = 'The provided Pipeline or Orchestrator combination already have a Service Principal. Delete the existing record using the procedure [metadata].[DeleteServicePrincipal].'
			RAISERROR(@ErrorDetails, 16, 1);
			RETURN 0;
		END
		
	--add SPN for specific pipeline
	IF @SpecificPipelineName IS NOT NULL
		BEGIN
			--secondary defensive check for pipeline optional param
			IF NOT EXISTS
				( 
				SELECT [PipelineName] FROM [metadata].[Pipelines] WHERE [PipelineName] = @SpecificPipelineName
				)
				BEGIN
					SET @ErrorDetails = 'Invalid Pipeline name. Please ensure the Pipeline metadata exists before trying to add authentication for it.'
					RAISERROR(@ErrorDetails, 16, 1);
					RETURN 0;
				END
			
			--spn may already exist for other pipelines
			IF NOT EXISTS
				(
				SELECT [PrincipalId] FROM [dbo].[ServicePrincipals] WHERE [PrincipalId] = @PrincipalId
				)
				BEGIN
					--add service principal
					INSERT INTO [dbo].[ServicePrincipals]
						( 
						[PrincipalName],
						[PrincipalId],
						[PrincipalSecret]
						)
					SELECT
						ISNULL(@PrincipalName, 'Unknown'),
						@PrincipalId,
						ENCRYPTBYPASSPHRASE(CONCAT(@OrchestratorName, @OrchestratorType, @SpecificPipelineName), @PrincipalSecret)

					SET @CredentialId = SCOPE_IDENTITY()
				END
			ELSE
				BEGIN
					SELECT @CredentialId = [CredentialId] FROM [dbo].[ServicePrincipals] WHERE [PrincipalId] = @PrincipalId
				END

			--add single pipeline to SPN link
			INSERT INTO [metadata].[PipelineAuthLink]
				(
				[PipelineId],
				[OrchestratorId],
				[CredentialId]
				)
			SELECT
				P.[PipelineId],
				D.[OrchestratorId],
				@CredentialId
			FROM
				[metadata].[Pipelines] P
				INNER JOIN [metadata].[Orchestrators] D
					ON P.[OrchestratorId] = D.[OrchestratorId]
			WHERE
				P.[PipelineName] = @SpecificPipelineName
				AND D.[OrchestratorType] = @OrchestratorType
				AND D.[OrchestratorName] = @OrchestratorName;
		END
	ELSE
		--add SPN for all pipelines in Orchestrator
		BEGIN
			--add service principal
			INSERT INTO [dbo].[ServicePrincipals]
				( 
				[PrincipalName],
				[PrincipalId],
				[PrincipalSecret]
				)
			SELECT
				ISNULL(@PrincipalName, 'Unknown'),
				@PrincipalId,
				ENCRYPTBYPASSPHRASE(CONCAT(@OrchestratorName, @OrchestratorType), @PrincipalSecret)

			SET @CredentialId = SCOPE_IDENTITY()

			--add link
			INSERT INTO [metadata].[PipelineAuthLink]
				(
				[PipelineId],
				[OrchestratorId],
				[CredentialId]
				)
			SELECT
				P.[PipelineId],
				D.[OrchestratorId],
				@CredentialId
			FROM
				[metadata].[Pipelines] P
				INNER JOIN [metadata].[Orchestrators] D
					ON P.[OrchestratorId] = D.[OrchestratorId]
				LEFT OUTER JOIN [metadata].[PipelineAuthLink] L
					ON P.[PipelineId] = L.[PipelineId]
			WHERE
				D.[OrchestratorName] = @OrchestratorName
				AND D.[OrchestratorType] = @OrchestratorType
				AND L.[PipelineId] IS NULL;
		END
END;]]></Value>
			</Property>
			<Property Name="IsAnsiNullsOn" Value="True" />
			<Relationship Name="BodyDependencies">
				<Entry>
					<References ExternalSource="BuiltIns" Name="[nvarchar]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[int]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[uniqueidentifier]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[uniqueidentifier]" />
				</Entry>
				<Entry>
					<References Name="[metadataHelpers].[AddServicePrincipal].[@PrincipalId]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[Orchestrators]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[Orchestrators].[OrchestratorName]" />
				</Entry>
				<Entry>
					<References Name="[metadataHelpers].[AddServicePrincipal].[@OrchestratorName]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[Orchestrators].[OrchestratorType]" />
				</Entry>
				<Entry>
					<References Name="[metadataHelpers].[AddServicePrincipal].[@OrchestratorType]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[PipelineAuthLink]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[PipelineAuthLink].[OrchestratorId]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[Orchestrators].[OrchestratorId]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[Pipelines]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[PipelineAuthLink].[PipelineId]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[Pipelines].[PipelineId]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[Orchestrators].[OrchestratorName]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[Orchestrators].[OrchestratorType]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[Pipelines].[PipelineName]" />
				</Entry>
				<Entry>
					<References Name="[metadataHelpers].[AddServicePrincipal].[@SpecificPipelineName]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[Pipelines].[PipelineName]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[ServicePrincipals]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[ServicePrincipals].[PrincipalId]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[ServicePrincipals].[PrincipalName]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[ServicePrincipals].[PrincipalId]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[ServicePrincipals].[PrincipalSecret]" />
				</Entry>
				<Entry>
					<References Name="[metadataHelpers].[AddServicePrincipal].[@PrincipalName]" />
				</Entry>
				<Entry>
					<References Name="[metadataHelpers].[AddServicePrincipal].[@PrincipalSecret]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[ServicePrincipals].[CredentialId]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[PipelineAuthLink].[PipelineId]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[PipelineAuthLink].[OrchestratorId]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[PipelineAuthLink].[CredentialId]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[Pipelines].[OrchestratorId]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[Orchestrators].[OrchestratorId]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[Pipelines].[PipelineId]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[Pipelines].[PipelineName]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[Orchestrators].[OrchestratorType]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[Orchestrators].[OrchestratorName]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[Pipelines].[PipelineId]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[PipelineAuthLink].[PipelineId]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[Orchestrators].[OrchestratorId]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[Orchestrators].[OrchestratorName]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[Orchestrators].[OrchestratorType]" />
				</Entry>
			</Relationship>
			<Relationship Name="Parameters">
				<Entry>
					<Element Type="SqlSubroutineParameter" Name="[metadataHelpers].[AddServicePrincipal].[@OrchestratorName]">
						<Relationship Name="Type">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Property Name="Length" Value="200" />
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[nvarchar]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlSubroutineParameter" Name="[metadataHelpers].[AddServicePrincipal].[@OrchestratorType]">
						<Relationship Name="Type">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Property Name="Length" Value="3" />
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[char]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlSubroutineParameter" Name="[metadataHelpers].[AddServicePrincipal].[@PrincipalId]">
						<Relationship Name="Type">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Property Name="Length" Value="256" />
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[nvarchar]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlSubroutineParameter" Name="[metadataHelpers].[AddServicePrincipal].[@PrincipalSecret]">
						<Relationship Name="Type">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Property Name="IsMax" Value="True" />
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[nvarchar]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlSubroutineParameter" Name="[metadataHelpers].[AddServicePrincipal].[@SpecificPipelineName]">
						<Property Name="DefaultExpressionScript">
							<Value><![CDATA[NULL]]></Value>
						</Property>
						<Relationship Name="Type">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Property Name="Length" Value="200" />
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[nvarchar]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlSubroutineParameter" Name="[metadataHelpers].[AddServicePrincipal].[@PrincipalName]">
						<Property Name="DefaultExpressionScript">
							<Value><![CDATA[NULL]]></Value>
						</Property>
						<Relationship Name="Type">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Property Name="Length" Value="256" />
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[nvarchar]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
			</Relationship>
			<Relationship Name="Schema">
				<Entry>
					<References Name="[metadataHelpers]" />
				</Entry>
			</Relationship>
			<Annotation Type="SysCommentsObjectAnnotation">
				<Property Name="Length" Value="4611" />
				<Property Name="StartLine" Value="1" />
				<Property Name="StartColumn" Value="1" />
				<Property Name="HeaderContents" Value="CREATE PROCEDURE [metadataHelpers].[AddServicePrincipal]&#xD;&#xA;&#x9;(&#xD;&#xA;&#x9;@OrchestratorName NVARCHAR(200),&#xD;&#xA;&#x9;@OrchestratorType CHAR(3),&#xD;&#xA;&#x9;@PrincipalId NVARCHAR(256),&#xD;&#xA;&#x9;@PrincipalSecret NVARCHAR(MAX),&#xD;&#xA;&#x9;@SpecificPipelineName NVARCHAR(200) = NULL,&#xD;&#xA;&#x9;@PrincipalName NVARCHAR(256) = NULL&#xD;&#xA;&#x9;)&#xD;&#xA;AS" />
			</Annotation>
		</Element>
		<Element Type="SqlProcedure" Name="[metadataHelpers].[AddServicePrincipalUrls]">
			<Property Name="BodyScript">
				<Value><![CDATA[
BEGIN

	SET NOCOUNT ON;

	DECLARE @ErrorDetails NVARCHAR(500) = ''
	DECLARE @CredentialId INT

	--defensive checks
	IF NOT EXISTS
		(
		SELECT [OrchestratorName] FROM [metadata].[Orchestrators] WHERE [OrchestratorName] = @OrchestratorName AND [OrchestratorType] = @OrchestratorType
		)
		BEGIN
			SET @ErrorDetails = 'Invalid Orchestrator name. Please ensure the Orchestrator metadata exists before trying to add authentication for it.'
			RAISERROR(@ErrorDetails, 16, 1);
			RETURN 0;
		END
	
	IF EXISTS
		(
		SELECT
			*
		FROM
			[metadata].[PipelineAuthLink] AL
			INNER JOIN [metadata].[Orchestrators] DF
				ON AL.[OrchestratorId] = DF.[OrchestratorId]
			INNER JOIN [metadata].[Pipelines] PP
				ON AL.[PipelineId] = PP.[PipelineId]
		WHERE
			DF.[OrchestratorName] = @OrchestratorName
			AND DF.[OrchestratorType] = @OrchestratorType
			AND PP.[PipelineName] = @SpecificPipelineName
		)
		BEGIN
			SET @ErrorDetails = 'The provided Pipeline or Orchestrator combination already have a Service Principal. Delete the existing record using the procedure [metadata].[DeleteServicePrincipal].'
			RAISERROR(@ErrorDetails, 16, 1);
			RETURN 0;
		END
	
	IF ([metadataHelpers].[CheckForValidURL](@PrincipalIdUrl)) = 0
	BEGIN
		SET @ErrorDetails = 'PrincipalIdUrl value is not in the expected format. . Please confirm the URL follows the structure https://{YourKeyVaultName}.vault.azure.net/secrets/{YourSecretName} and does not include the secret version guid.'
		PRINT @ErrorDetails;
	END

	IF ([metadataHelpers].[CheckForValidURL](@PrincipalSecretUrl)) = 0
	BEGIN
		SET @ErrorDetails = 'PrincipalSecretUrl value is not in the expected format. Please confirm the URL follows the structure https://{YourKeyVaultName}.vault.azure.net/secrets/{YourSecretName} and does not include the secret version guid.'
		PRINT @ErrorDetails;		
	END

	--add SPN for specific pipeline
	IF @SpecificPipelineName IS NOT NULL
		BEGIN
			--secondary defensive check for pipeline optional param
			IF NOT EXISTS
				( 
				SELECT [PipelineName] FROM [metadata].[Pipelines] WHERE [PipelineName] = @SpecificPipelineName
				)
				BEGIN
					SET @ErrorDetails = 'Invalid Pipeline name. Please ensure the Pipeline metadata exists before trying to add authentication for it.'
					RAISERROR(@ErrorDetails, 16, 1);
					RETURN 0;
				END
			
			--spn may already exist for other pipelines
			IF NOT EXISTS
				(				
				SELECT [PrincipalIdUrl] FROM [dbo].[ServicePrincipals] WHERE [PrincipalIdUrl] = @PrincipalIdUrl
				)
				BEGIN
					--add service principal
					INSERT INTO [dbo].[ServicePrincipals]
						( 
						[PrincipalName],
						[PrincipalIdUrl],
						[PrincipalSecretUrl]
						)
					SELECT
						ISNULL(@PrincipalName, 'Unknown'),
						@PrincipalIdUrl,
						@PrincipalSecretUrl

					SET @CredentialId = SCOPE_IDENTITY()
				END
			ELSE
				BEGIN
					SELECT @CredentialId = [CredentialId] FROM [dbo].[ServicePrincipals] WHERE [PrincipalIdUrl] = @PrincipalIdUrl
				END

			--add single pipeline to SPN link
			INSERT INTO [metadata].[PipelineAuthLink]
				(
				[PipelineId],
				[OrchestratorId],
				[CredentialId]
				)
			SELECT
				P.[PipelineId],
				D.[OrchestratorId],
				@CredentialId
			FROM
				[metadata].[Pipelines] P
				INNER JOIN [metadata].[Orchestrators] D
					ON P.[OrchestratorId] = D.[OrchestratorId]
			WHERE
				P.[PipelineName] = @SpecificPipelineName
				AND D.[OrchestratorType] = @OrchestratorType
				AND D.[OrchestratorName] = @OrchestratorName;
		END
	ELSE
		--add SPN for all pipelines in Orchestrator
		BEGIN
			--add service principal
			INSERT INTO [dbo].[ServicePrincipals]
				( 
				[PrincipalName],
				[PrincipalIdUrl],
				[PrincipalSecretUrl]
				)
			SELECT
				ISNULL(@PrincipalName, 'Unknown'),
				@PrincipalIdUrl,
				@PrincipalSecretUrl

			SET @CredentialId = SCOPE_IDENTITY()

			--add link
			INSERT INTO [metadata].[PipelineAuthLink]
				(
				[PipelineId],
				[OrchestratorId],
				[CredentialId]
				)
			SELECT
				P.[PipelineId],
				D.[OrchestratorId],
				@CredentialId
			FROM
				[metadata].[Pipelines] P
				INNER JOIN [metadata].[Orchestrators] D
					ON P.[OrchestratorId] = D.[OrchestratorId]
				LEFT OUTER JOIN [metadata].[PipelineAuthLink] L
					ON P.[PipelineId] = L.[PipelineId]
			WHERE
				D.[OrchestratorName] = @OrchestratorName
				AND D.[OrchestratorType] = @OrchestratorType
				AND L.[PipelineId] IS NULL;
		END
END;]]></Value>
			</Property>
			<Property Name="IsAnsiNullsOn" Value="True" />
			<Relationship Name="BodyDependencies">
				<Entry>
					<References ExternalSource="BuiltIns" Name="[nvarchar]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[int]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[Orchestrators]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[Orchestrators].[OrchestratorName]" />
				</Entry>
				<Entry>
					<References Name="[metadataHelpers].[AddServicePrincipalUrls].[@OrchestratorName]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[Orchestrators].[OrchestratorType]" />
				</Entry>
				<Entry>
					<References Name="[metadataHelpers].[AddServicePrincipalUrls].[@OrchestratorType]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[PipelineAuthLink]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[PipelineAuthLink].[OrchestratorId]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[Orchestrators].[OrchestratorId]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[Pipelines]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[PipelineAuthLink].[PipelineId]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[Pipelines].[PipelineId]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[Orchestrators].[OrchestratorName]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[Orchestrators].[OrchestratorType]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[Pipelines].[PipelineName]" />
				</Entry>
				<Entry>
					<References Name="[metadataHelpers].[AddServicePrincipalUrls].[@SpecificPipelineName]" />
				</Entry>
				<Entry>
					<References Name="[metadataHelpers].[CheckForValidURL]" />
				</Entry>
				<Entry>
					<References Name="[metadataHelpers].[AddServicePrincipalUrls].[@PrincipalIdUrl]" />
				</Entry>
				<Entry>
					<References Name="[metadataHelpers].[AddServicePrincipalUrls].[@PrincipalSecretUrl]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[Pipelines].[PipelineName]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[ServicePrincipals]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[ServicePrincipals].[PrincipalIdUrl]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[ServicePrincipals].[PrincipalName]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[ServicePrincipals].[PrincipalIdUrl]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[ServicePrincipals].[PrincipalSecretUrl]" />
				</Entry>
				<Entry>
					<References Name="[metadataHelpers].[AddServicePrincipalUrls].[@PrincipalName]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[ServicePrincipals].[CredentialId]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[PipelineAuthLink].[PipelineId]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[PipelineAuthLink].[OrchestratorId]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[PipelineAuthLink].[CredentialId]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[Pipelines].[OrchestratorId]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[Orchestrators].[OrchestratorId]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[Pipelines].[PipelineId]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[Pipelines].[PipelineName]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[Orchestrators].[OrchestratorType]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[Orchestrators].[OrchestratorName]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[Pipelines].[PipelineId]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[PipelineAuthLink].[PipelineId]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[Orchestrators].[OrchestratorId]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[Orchestrators].[OrchestratorName]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[Orchestrators].[OrchestratorType]" />
				</Entry>
			</Relationship>
			<Relationship Name="Parameters">
				<Entry>
					<Element Type="SqlSubroutineParameter" Name="[metadataHelpers].[AddServicePrincipalUrls].[@OrchestratorName]">
						<Relationship Name="Type">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Property Name="Length" Value="200" />
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[nvarchar]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlSubroutineParameter" Name="[metadataHelpers].[AddServicePrincipalUrls].[@OrchestratorType]">
						<Relationship Name="Type">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Property Name="Length" Value="3" />
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[char]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlSubroutineParameter" Name="[metadataHelpers].[AddServicePrincipalUrls].[@PrincipalIdUrl]">
						<Relationship Name="Type">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Property Name="IsMax" Value="True" />
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[nvarchar]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlSubroutineParameter" Name="[metadataHelpers].[AddServicePrincipalUrls].[@PrincipalSecretUrl]">
						<Relationship Name="Type">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Property Name="IsMax" Value="True" />
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[nvarchar]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlSubroutineParameter" Name="[metadataHelpers].[AddServicePrincipalUrls].[@SpecificPipelineName]">
						<Property Name="DefaultExpressionScript">
							<Value><![CDATA[NULL]]></Value>
						</Property>
						<Relationship Name="Type">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Property Name="Length" Value="200" />
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[nvarchar]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlSubroutineParameter" Name="[metadataHelpers].[AddServicePrincipalUrls].[@PrincipalName]">
						<Property Name="DefaultExpressionScript">
							<Value><![CDATA[NULL]]></Value>
						</Property>
						<Relationship Name="Type">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Property Name="Length" Value="256" />
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[nvarchar]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
			</Relationship>
			<Relationship Name="Schema">
				<Entry>
					<References Name="[metadataHelpers]" />
				</Entry>
			</Relationship>
			<Annotation Type="SysCommentsObjectAnnotation">
				<Property Name="Length" Value="4829" />
				<Property Name="StartLine" Value="1" />
				<Property Name="StartColumn" Value="1" />
				<Property Name="HeaderContents" Value="CREATE PROCEDURE [metadataHelpers].[AddServicePrincipalUrls]&#xD;&#xA;&#x9;(&#xD;&#xA;&#x9;@OrchestratorName NVARCHAR(200),&#xD;&#xA;&#x9;@OrchestratorType CHAR(3),&#xD;&#xA;&#x9;@PrincipalIdUrl NVARCHAR(MAX),&#xD;&#xA;&#x9;@PrincipalSecretUrl NVARCHAR(MAX),&#xD;&#xA;&#x9;@SpecificPipelineName NVARCHAR(200) = NULL,&#xD;&#xA;&#x9;@PrincipalName NVARCHAR(256) = NULL&#xD;&#xA;&#x9;)&#xD;&#xA;AS" />
			</Annotation>
		</Element>
		<Element Type="SqlProcedure" Name="[metadataHelpers].[AddServicePrincipalWrapper]">
			<Property Name="BodyScript">
				<Value><![CDATA[
BEGIN
	
	IF ([metadata].[GetPropertyValueInternal]('SPNHandlingMethod')) = 'StoreInDatabase'
		BEGIN
			EXEC [metadata].[AddServicePrincipal]
				@OrchestratorName = @OrchestratorName,
				@OrchestratorType = @OrchestratorType,
				@PrincipalId = @PrincipalIdValue,
				@PrincipalSecret = @PrincipalSecretValue,
				@PrincipalName = @PrincipalName,
				@SpecificPipelineName = @SpecificPipelineName			
		END
	ELSE IF ([metadata].[GetPropertyValueInternal]('SPNHandlingMethod')) = 'StoreInKeyVault'
		BEGIN
			EXEC [metadata].[AddServicePrincipalUrls]
				@OrchestratorName = @OrchestratorName,
				@OrchestratorType = @OrchestratorType,
				@PrincipalIdUrl = @PrincipalIdValue,
				@PrincipalSecretUrl = @PrincipalSecretValue,
				@PrincipalName = @PrincipalName,
				@SpecificPipelineName = @SpecificPipelineName		
		END
	ELSE
		BEGIN
			RAISERROR('Unknown SPN insert method.',16,1);
			RETURN 0;
		END
END;]]></Value>
			</Property>
			<Property Name="IsAnsiNullsOn" Value="True" />
			<Relationship Name="BodyDependencies">
				<Entry>
					<References Name="[metadata].[GetPropertyValueInternal]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[AddServicePrincipal]" />
				</Entry>
				<Entry>
					<References Name="[metadataHelpers].[AddServicePrincipal].[@OrchestratorName]" />
				</Entry>
				<Entry>
					<References Name="[metadataHelpers].[AddServicePrincipalWrapper].[@OrchestratorName]" />
				</Entry>
				<Entry>
					<References Name="[metadataHelpers].[AddServicePrincipal].[@OrchestratorType]" />
				</Entry>
				<Entry>
					<References Name="[metadataHelpers].[AddServicePrincipalWrapper].[@OrchestratorType]" />
				</Entry>
				<Entry>
					<References Name="[metadataHelpers].[AddServicePrincipal].[@PrincipalId]" />
				</Entry>
				<Entry>
					<References Name="[metadataHelpers].[AddServicePrincipalWrapper].[@PrincipalIdValue]" />
				</Entry>
				<Entry>
					<References Name="[metadataHelpers].[AddServicePrincipal].[@PrincipalSecret]" />
				</Entry>
				<Entry>
					<References Name="[metadataHelpers].[AddServicePrincipalWrapper].[@PrincipalSecretValue]" />
				</Entry>
				<Entry>
					<References Name="[metadataHelpers].[AddServicePrincipal].[@PrincipalName]" />
				</Entry>
				<Entry>
					<References Name="[metadataHelpers].[AddServicePrincipalWrapper].[@PrincipalName]" />
				</Entry>
				<Entry>
					<References Name="[metadataHelpers].[AddServicePrincipal].[@SpecificPipelineName]" />
				</Entry>
				<Entry>
					<References Name="[metadataHelpers].[AddServicePrincipalWrapper].[@SpecificPipelineName]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[AddServicePrincipalUrls]" />
				</Entry>
				<Entry>
					<References Name="[metadataHelpers].[AddServicePrincipalUrls].[@OrchestratorName]" />
				</Entry>
				<Entry>
					<References Name="[metadataHelpers].[AddServicePrincipalUrls].[@OrchestratorType]" />
				</Entry>
				<Entry>
					<References Name="[metadataHelpers].[AddServicePrincipalUrls].[@PrincipalIdUrl]" />
				</Entry>
				<Entry>
					<References Name="[metadataHelpers].[AddServicePrincipalUrls].[@PrincipalSecretUrl]" />
				</Entry>
				<Entry>
					<References Name="[metadataHelpers].[AddServicePrincipalUrls].[@PrincipalName]" />
				</Entry>
				<Entry>
					<References Name="[metadataHelpers].[AddServicePrincipalUrls].[@SpecificPipelineName]" />
				</Entry>
			</Relationship>
			<Relationship Name="Parameters">
				<Entry>
					<Element Type="SqlSubroutineParameter" Name="[metadataHelpers].[AddServicePrincipalWrapper].[@OrchestratorName]">
						<Relationship Name="Type">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Property Name="Length" Value="200" />
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[nvarchar]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlSubroutineParameter" Name="[metadataHelpers].[AddServicePrincipalWrapper].[@OrchestratorType]">
						<Relationship Name="Type">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Property Name="Length" Value="3" />
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[char]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlSubroutineParameter" Name="[metadataHelpers].[AddServicePrincipalWrapper].[@PrincipalIdValue]">
						<Relationship Name="Type">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Property Name="IsMax" Value="True" />
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[nvarchar]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlSubroutineParameter" Name="[metadataHelpers].[AddServicePrincipalWrapper].[@PrincipalSecretValue]">
						<Relationship Name="Type">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Property Name="IsMax" Value="True" />
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[nvarchar]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlSubroutineParameter" Name="[metadataHelpers].[AddServicePrincipalWrapper].[@SpecificPipelineName]">
						<Property Name="DefaultExpressionScript">
							<Value><![CDATA[NULL]]></Value>
						</Property>
						<Relationship Name="Type">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Property Name="Length" Value="200" />
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[nvarchar]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlSubroutineParameter" Name="[metadataHelpers].[AddServicePrincipalWrapper].[@PrincipalName]">
						<Property Name="DefaultExpressionScript">
							<Value><![CDATA[NULL]]></Value>
						</Property>
						<Relationship Name="Type">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Property Name="Length" Value="256" />
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[nvarchar]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
			</Relationship>
			<Relationship Name="Schema">
				<Entry>
					<References Name="[metadataHelpers]" />
				</Entry>
			</Relationship>
			<Annotation Type="SysCommentsObjectAnnotation">
				<Property Name="Length" Value="1234" />
				<Property Name="StartLine" Value="1" />
				<Property Name="StartColumn" Value="1" />
				<Property Name="HeaderContents" Value="CREATE PROCEDURE [metadataHelpers].[AddServicePrincipalWrapper]&#xD;&#xA;&#x9;(&#xD;&#xA;&#x9;@OrchestratorName NVARCHAR(200),&#xD;&#xA;&#x9;@OrchestratorType CHAR(3),&#xD;&#xA;&#x9;@PrincipalIdValue NVARCHAR(MAX),&#xD;&#xA;&#x9;@PrincipalSecretValue NVARCHAR(MAX),&#xD;&#xA;&#x9;@SpecificPipelineName NVARCHAR(200) = NULL,&#xD;&#xA;&#x9;@PrincipalName NVARCHAR(256) = NULL&#xD;&#xA;&#x9;)&#xD;&#xA;AS" />
			</Annotation>
		</Element>
		<Element Type="SqlScalarFunction" Name="[metadataHelpers].[CheckForValidURL]">
			<Property Name="IsAnsiNullsOn" Value="True" />
			<Relationship Name="BodyDependencies">
				<Entry>
					<References ExternalSource="BuiltIns" Name="[varchar]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[varchar]" />
				</Entry>
				<Entry>
					<References Name="[metadataHelpers].[CheckForValidURL].[@Url]" />
				</Entry>
			</Relationship>
			<Relationship Name="FunctionBody">
				<Entry>
					<Element Type="SqlScriptFunctionImplementation">
						<Property Name="BodyScript">
							<Value><![CDATA[
BEGIN
    DECLARE @Ending VARCHAR(50)
	DECLARE @TempString VARCHAR(50)

	--check URL start
	IF CHARINDEX('https://', @Url) <> 1
    BEGIN
        RETURN 0;
    END

	--check for expected sub domains
    IF CHARINDEX('vault.azure.net', @Url) = 0
    BEGIN
        RETURN 0;
    END

	--check for expected value type
    IF CHARINDEX('secrets', @Url) = 0
    BEGIN
		RETURN 0;
    END
    
	--attempt to check for secret version 
	SELECT 
		@Ending = 
			CASE
				WHEN RIGHT(@Url,1) = '/' THEN REVERSE(LEFT(@Url,LEN(@Url)-1))
				ELSE REVERSE(@Url)
			END,
		@Ending = REVERSE(LEFT(@Ending,CHARINDEX('/',@Ending)-1))

		IF LEN(@Ending) = 32            
		BEGIN            
    		SET @TempString = 
				SUBSTRING(@Ending, 1, 8) + '-' + 
				SUBSTRING(@Ending, 9, 4) + '-' +             
    			SUBSTRING(@Ending, 13, 4) + '-' + 
				SUBSTRING(@Ending, 13, 4) + '-' + 
				SUBSTRING(@Ending, 20, 12)            
		END
	
		IF TRY_CAST(@TempString AS UNIQUEIDENTIFIER) IS NOT NULL 
		BEGIN
			RETURN 0;
		END;

	-- It is a valid URL
    RETURN 1;
END;]]></Value>
						</Property>
						<Annotation Type="SysCommentsObjectAnnotation">
							<Property Name="Length" Value="1185" />
							<Property Name="StartLine" Value="1" />
							<Property Name="StartColumn" Value="1" />
							<Property Name="HeaderContents" Value="CREATE FUNCTION [metadataHelpers].[CheckForValidURL] (@Url NVARCHAR(MAX))&#xD;&#xA;RETURNS INT&#xD;&#xA;AS" />
						</Annotation>
					</Element>
				</Entry>
			</Relationship>
			<Relationship Name="Parameters">
				<Entry>
					<Element Type="SqlSubroutineParameter" Name="[metadataHelpers].[CheckForValidURL].[@Url]">
						<Relationship Name="Type">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Property Name="IsMax" Value="True" />
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[nvarchar]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
			</Relationship>
			<Relationship Name="Schema">
				<Entry>
					<References Name="[metadataHelpers]" />
				</Entry>
			</Relationship>
			<Relationship Name="Type">
				<Entry>
					<Element Type="SqlTypeSpecifier">
						<Relationship Name="Type">
							<Entry>
								<References ExternalSource="BuiltIns" Name="[int]" />
							</Entry>
						</Relationship>
					</Element>
				</Entry>
			</Relationship>
		</Element>
		<Element Type="SqlProcedure" Name="[metadataHelpers].[CheckStageAndPiplineIntegrity]">
			<Property Name="BodyScript">
				<Value><![CDATA[

BEGIN

	DECLARE @TempCheckStageAndPiplineIntegrity TABLE
		(
		[ResourceGroupName] NVARCHAR(200) NOT NULL,
		[OrchestratorName] NVARCHAR(200) NOT NULL,
		[StageId] INT NOT NULL,
		[StageName] VARCHAR(225) NOT NULL,
		[PipelineId] INT NOT NULL,
		[PipelineName] NVARCHAR(200) NOT NULL,
		[Enabled] BIT NOT NULL,
		[SuccessorStageId] INT NULL,
		[SuccessorStage] VARCHAR(225) NULL,
		[SuccessorId] INT NULL,
		[SuccessorName] NVARCHAR(200) NULL,
		[Information] VARCHAR(92) NULL
		)	
	
	--get min execution stage
	;WITH firstStage AS
		(
		SELECT
			MIN([StageId]) AS firstStageId
		FROM
			[metadata].[Stages]
		)
	--query metadata
	INSERT INTO @TempCheckStageAndPiplineIntegrity
	SELECT
		adf.[ResourceGroupName],
		adf.[OrchestratorName],	
		base.[StageId],
		baseStage.[StageName],
		base.[PipelineId],
		base.[PipelineName],
		base.[Enabled],
		preds.[StageId] AS SuccessorStageId,
		predsStage.[StageName] AS SuccessorStage,
		preds.[PipelineId] AS SuccessorId,
		preds.[PipelineName] AS SuccessorName,
		CASE
			WHEN preds.[StageId] > base.[StageId] +1 THEN 'Successor pipeline could be moved to an earlier stage.'
			WHEN preds.[StageId] = base.[StageId] THEN 'Dependency issue, predeccessor pipeline is currently running in the same stage as successor.'
			WHEN preds.[PipelineId] IS NOT NULL AND base.[Enabled] = 0 THEN 'Disabled pipeline has downstream successors.'
			WHEN preds.[PipelineId] IS NOT NULL AND baseStage.[Enabled] = 0 THEN 'Disabled stage has downstream successors.'
			WHEN base.[LogicalPredecessorId] IS NULL AND base.[StageId] <> firstStage.[firstStageId] THEN 'Pipeline could be moved to an earlier stage.'
			ELSE NULL
		END AS Information
	FROM 
		--get base pipeline details
		[metadata].[Pipelines] base
		INNER JOIN [metadata].[Orchestrators] adf
			ON base.[OrchestratorId] = adf.[OrchestratorId]
		INNER JOIN [metadata].[Stages] baseStage
			ON base.[StageId] = baseStage.[StageId]	
		--get successor details
		LEFT OUTER JOIN [metadata].[Pipelines] preds
			ON base.[PipelineId] = preds.[LogicalPredecessorId]
		LEFT OUTER JOIN [metadata].[Stages] predsStage
			ON preds.[StageId] = predsStage.[StageId]
		--other details for checking
		CROSS JOIN firstStage

	--provide outcome
	IF EXISTS
		(
		SELECT [Information] FROM @TempCheckStageAndPiplineIntegrity
		)
		BEGIN
			SELECT * FROM @TempCheckStageAndPiplineIntegrity
		END
	ELSE
		BEGIN
			PRINT 'No pipeline integrity issues to report. Nice work! :-)'
		END
END;]]></Value>
			</Property>
			<Property Name="IsAnsiNullsOn" Value="True" />
			<Relationship Name="BodyDependencies">
				<Entry>
					<References Name="[metadata].[Stages]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[Stages].[StageId]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[Pipelines]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[Orchestrators]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[Pipelines].[OrchestratorId]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[Orchestrators].[OrchestratorId]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[Pipelines].[StageId]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[Stages].[StageId]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[Pipelines].[PipelineId]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[Pipelines].[LogicalPredecessorId]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[Pipelines].[StageId]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[Stages].[StageId]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[Orchestrators].[ResourceGroupName]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[Orchestrators].[OrchestratorName]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[Stages].[StageName]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[Pipelines].[PipelineName]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[Pipelines].[Enabled]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[Pipelines].[StageId]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[Stages].[StageName]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[Pipelines].[PipelineId]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[Pipelines].[PipelineName]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[Pipelines].[PipelineId]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[Stages].[Enabled]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[Pipelines].[LogicalPredecessorId]" />
				</Entry>
				<Entry>
					<References Name="[metadataHelpers].[CheckStageAndPiplineIntegrity].[@TempCheckStageAndPiplineIntegrity].[Information]" />
				</Entry>
			</Relationship>
			<Relationship Name="DynamicObjects">
				<Entry>
					<Element Type="SqlDynamicColumnSource" Name="[metadataHelpers].[CheckStageAndPiplineIntegrity].[@TempCheckStageAndPiplineIntegrity]">
						<Relationship Name="Columns">
							<Entry>
								<Element Type="SqlSimpleColumn" Name="[metadataHelpers].[CheckStageAndPiplineIntegrity].[@TempCheckStageAndPiplineIntegrity].[ResourceGroupName]">
									<Property Name="IsNullable" Value="False" />
									<Relationship Name="TypeSpecifier">
										<Entry>
											<Element Type="SqlTypeSpecifier">
												<Property Name="Length" Value="200" />
												<Relationship Name="Type">
													<Entry>
														<References ExternalSource="BuiltIns" Name="[nvarchar]" />
													</Entry>
												</Relationship>
											</Element>
										</Entry>
									</Relationship>
								</Element>
							</Entry>
							<Entry>
								<Element Type="SqlSimpleColumn" Name="[metadataHelpers].[CheckStageAndPiplineIntegrity].[@TempCheckStageAndPiplineIntegrity].[OrchestratorName]">
									<Property Name="IsNullable" Value="False" />
									<Relationship Name="TypeSpecifier">
										<Entry>
											<Element Type="SqlTypeSpecifier">
												<Property Name="Length" Value="200" />
												<Relationship Name="Type">
													<Entry>
														<References ExternalSource="BuiltIns" Name="[nvarchar]" />
													</Entry>
												</Relationship>
											</Element>
										</Entry>
									</Relationship>
								</Element>
							</Entry>
							<Entry>
								<Element Type="SqlSimpleColumn" Name="[metadataHelpers].[CheckStageAndPiplineIntegrity].[@TempCheckStageAndPiplineIntegrity].[StageId]">
									<Property Name="IsNullable" Value="False" />
									<Relationship Name="TypeSpecifier">
										<Entry>
											<Element Type="SqlTypeSpecifier">
												<Relationship Name="Type">
													<Entry>
														<References ExternalSource="BuiltIns" Name="[int]" />
													</Entry>
												</Relationship>
											</Element>
										</Entry>
									</Relationship>
								</Element>
							</Entry>
							<Entry>
								<Element Type="SqlSimpleColumn" Name="[metadataHelpers].[CheckStageAndPiplineIntegrity].[@TempCheckStageAndPiplineIntegrity].[StageName]">
									<Property Name="IsNullable" Value="False" />
									<Relationship Name="TypeSpecifier">
										<Entry>
											<Element Type="SqlTypeSpecifier">
												<Property Name="Length" Value="225" />
												<Relationship Name="Type">
													<Entry>
														<References ExternalSource="BuiltIns" Name="[varchar]" />
													</Entry>
												</Relationship>
											</Element>
										</Entry>
									</Relationship>
								</Element>
							</Entry>
							<Entry>
								<Element Type="SqlSimpleColumn" Name="[metadataHelpers].[CheckStageAndPiplineIntegrity].[@TempCheckStageAndPiplineIntegrity].[PipelineId]">
									<Property Name="IsNullable" Value="False" />
									<Relationship Name="TypeSpecifier">
										<Entry>
											<Element Type="SqlTypeSpecifier">
												<Relationship Name="Type">
													<Entry>
														<References ExternalSource="BuiltIns" Name="[int]" />
													</Entry>
												</Relationship>
											</Element>
										</Entry>
									</Relationship>
								</Element>
							</Entry>
							<Entry>
								<Element Type="SqlSimpleColumn" Name="[metadataHelpers].[CheckStageAndPiplineIntegrity].[@TempCheckStageAndPiplineIntegrity].[PipelineName]">
									<Property Name="IsNullable" Value="False" />
									<Relationship Name="TypeSpecifier">
										<Entry>
											<Element Type="SqlTypeSpecifier">
												<Property Name="Length" Value="200" />
												<Relationship Name="Type">
													<Entry>
														<References ExternalSource="BuiltIns" Name="[nvarchar]" />
													</Entry>
												</Relationship>
											</Element>
										</Entry>
									</Relationship>
								</Element>
							</Entry>
							<Entry>
								<Element Type="SqlSimpleColumn" Name="[metadataHelpers].[CheckStageAndPiplineIntegrity].[@TempCheckStageAndPiplineIntegrity].[Enabled]">
									<Property Name="IsNullable" Value="False" />
									<Relationship Name="TypeSpecifier">
										<Entry>
											<Element Type="SqlTypeSpecifier">
												<Relationship Name="Type">
													<Entry>
														<References ExternalSource="BuiltIns" Name="[bit]" />
													</Entry>
												</Relationship>
											</Element>
										</Entry>
									</Relationship>
								</Element>
							</Entry>
							<Entry>
								<Element Type="SqlSimpleColumn" Name="[metadataHelpers].[CheckStageAndPiplineIntegrity].[@TempCheckStageAndPiplineIntegrity].[SuccessorStageId]">
									<Relationship Name="TypeSpecifier">
										<Entry>
											<Element Type="SqlTypeSpecifier">
												<Relationship Name="Type">
													<Entry>
														<References ExternalSource="BuiltIns" Name="[int]" />
													</Entry>
												</Relationship>
											</Element>
										</Entry>
									</Relationship>
								</Element>
							</Entry>
							<Entry>
								<Element Type="SqlSimpleColumn" Name="[metadataHelpers].[CheckStageAndPiplineIntegrity].[@TempCheckStageAndPiplineIntegrity].[SuccessorStage]">
									<Relationship Name="TypeSpecifier">
										<Entry>
											<Element Type="SqlTypeSpecifier">
												<Property Name="Length" Value="225" />
												<Relationship Name="Type">
													<Entry>
														<References ExternalSource="BuiltIns" Name="[varchar]" />
													</Entry>
												</Relationship>
											</Element>
										</Entry>
									</Relationship>
								</Element>
							</Entry>
							<Entry>
								<Element Type="SqlSimpleColumn" Name="[metadataHelpers].[CheckStageAndPiplineIntegrity].[@TempCheckStageAndPiplineIntegrity].[SuccessorId]">
									<Relationship Name="TypeSpecifier">
										<Entry>
											<Element Type="SqlTypeSpecifier">
												<Relationship Name="Type">
													<Entry>
														<References ExternalSource="BuiltIns" Name="[int]" />
													</Entry>
												</Relationship>
											</Element>
										</Entry>
									</Relationship>
								</Element>
							</Entry>
							<Entry>
								<Element Type="SqlSimpleColumn" Name="[metadataHelpers].[CheckStageAndPiplineIntegrity].[@TempCheckStageAndPiplineIntegrity].[SuccessorName]">
									<Relationship Name="TypeSpecifier">
										<Entry>
											<Element Type="SqlTypeSpecifier">
												<Property Name="Length" Value="200" />
												<Relationship Name="Type">
													<Entry>
														<References ExternalSource="BuiltIns" Name="[nvarchar]" />
													</Entry>
												</Relationship>
											</Element>
										</Entry>
									</Relationship>
								</Element>
							</Entry>
							<Entry>
								<Element Type="SqlSimpleColumn" Name="[metadataHelpers].[CheckStageAndPiplineIntegrity].[@TempCheckStageAndPiplineIntegrity].[Information]">
									<Relationship Name="TypeSpecifier">
										<Entry>
											<Element Type="SqlTypeSpecifier">
												<Property Name="Length" Value="92" />
												<Relationship Name="Type">
													<Entry>
														<References ExternalSource="BuiltIns" Name="[varchar]" />
													</Entry>
												</Relationship>
											</Element>
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlDynamicColumnSource" Name="[metadataHelpers].[CheckStageAndPiplineIntegrity].[CTE1].[firstStage]">
						<Relationship Name="Columns">
							<Entry>
								<Element Type="SqlComputedColumn" Name="[metadataHelpers].[CheckStageAndPiplineIntegrity].[CTE1].[firstStage].[firstStageId]" />
							</Entry>
						</Relationship>
					</Element>
				</Entry>
			</Relationship>
			<Relationship Name="Schema">
				<Entry>
					<References Name="[metadataHelpers]" />
				</Entry>
			</Relationship>
			<Annotation Type="SysCommentsObjectAnnotation">
				<Property Name="Length" Value="2602" />
				<Property Name="StartLine" Value="1" />
				<Property Name="StartColumn" Value="1" />
				<Property Name="HeaderContents" Value="CREATE PROCEDURE [metadataHelpers].[CheckStageAndPiplineIntegrity]&#xD;&#xA;AS" />
			</Annotation>
		</Element>
		<Element Type="SqlProcedure" Name="[metadataHelpers].[DeleteMetadataWithIntegrity]">
			<Property Name="BodyScript">
				<Value><![CDATA[
BEGIN
	/*
	DELETE ORDER IMPORTANT FOR REFERENTIAL INTEGRITY
	*/

	--BatchExecution
	IF OBJECT_ID(N'[metadata].[BatchExecution]') IS NOT NULL
		BEGIN
			TRUNCATE TABLE [metadata].[BatchExecution];
		END;

	--CurrentExecution
	IF OBJECT_ID(N'[metadata].[CurrentExecution]') IS NOT NULL
		BEGIN
			TRUNCATE TABLE [metadata].[CurrentExecution];
		END;

	--ExecutionLog
	IF OBJECT_ID(N'[metadata].[ExecutionLog]') IS NOT NULL
		BEGIN
			TRUNCATE TABLE [metadata].[ExecutionLog];
		END

	--ErrorLog
	IF OBJECT_ID(N'[metadata].[ExecutionLog]') IS NOT NULL
		BEGIN
			TRUNCATE TABLE [metadata].[ErrorLog];
		END

	--BatchStageLink
	IF OBJECT_ID(N'[metadata].[BatchStageLink]') IS NOT NULL
		BEGIN
			DELETE FROM [metadata].[BatchStageLink];
		END;

	--Batches
	IF OBJECT_ID(N'[metadata].[Batches]') IS NOT NULL
		BEGIN
			DELETE FROM [metadata].[Batches];
		END;

	--PipelineDependencies
	IF OBJECT_ID(N'[metadata].[PipelineDependencies]') IS NOT NULL
		BEGIN
			DELETE FROM [metadata].[PipelineDependencies];
			DBCC CHECKIDENT ('[metadata].[PipelineDependencies]', RESEED, 0);
		END;

	--PipelineAlertLink
	IF OBJECT_ID(N'[metadata].[PipelineAlertLink]') IS NOT NULL
		BEGIN
			DELETE FROM [metadata].[PipelineAlertLink];
			DBCC CHECKIDENT ('[metadata].[PipelineAlertLink]', RESEED, 0);
		END;

	--Recipients
	IF OBJECT_ID(N'[metadata].[Recipients]') IS NOT NULL
		BEGIN
			DELETE FROM [metadata].[Recipients];
			DBCC CHECKIDENT ('[metadata].[Recipients]', RESEED, 0);
		END;

	--AlertOutcomes
	IF OBJECT_ID(N'[metadata].[AlertOutcomes]') IS NOT NULL
		BEGIN
			TRUNCATE TABLE [metadata].[AlertOutcomes];
		END;

	--PipelineAuthLink
	IF OBJECT_ID(N'[metadata].[PipelineAuthLink]') IS NOT NULL
		BEGIN
			DELETE FROM [metadata].[PipelineAuthLink];
			DBCC CHECKIDENT ('[metadata].[PipelineAuthLink]', RESEED, 0);
		END;

	--ServicePrincipals
	IF OBJECT_ID(N'[dbo].[ServicePrincipals]') IS NOT NULL 
		BEGIN
			DELETE FROM [dbo].[ServicePrincipals];
			DBCC CHECKIDENT ('[dbo].[ServicePrincipals]', RESEED, 0);
		END;

	--Properties
	IF OBJECT_ID(N'[metadata].[Properties]') IS NOT NULL
		BEGIN
			DELETE FROM [metadata].[Properties];
			DBCC CHECKIDENT ('[metadata].[Properties]', RESEED, 0);
		END;

	--PipelineParameters
	IF OBJECT_ID(N'[metadata].[PipelineParameters]') IS NOT NULL
		BEGIN
			DELETE FROM [metadata].[PipelineParameters];
			DBCC CHECKIDENT ('[metadata].[PipelineParameters]', RESEED, 0);
		END;

	--Pipelines
	IF OBJECT_ID(N'[metadata].[Pipelines]') IS NOT NULL
		BEGIN
			DELETE FROM [metadata].[Pipelines];
			DBCC CHECKIDENT ('[metadata].[Pipelines]', RESEED, 0);
		END;

	--Orchestrators
	IF OBJECT_ID(N'[metadata].[Orchestrators]') IS NOT NULL
		BEGIN
			DELETE FROM [metadata].[Orchestrators];
			DBCC CHECKIDENT ('[metadata].[Orchestrators]', RESEED, 0);
		END;

	--Stages
	IF OBJECT_ID(N'[metadata].[Stages]') IS NOT NULL
		BEGIN
			DELETE FROM [metadata].[Stages];
			DBCC CHECKIDENT ('[metadata].[Stages]', RESEED, 0);
		END;

	--Subscriptions
	IF OBJECT_ID(N'[metadata].[Subscriptions]') IS NOT NULL
		BEGIN
			DELETE FROM [metadata].[Subscriptions];
		END;
	
	--Tenants
	IF OBJECT_ID(N'[metadata].[Tenants]') IS NOT NULL
		BEGIN
			DELETE FROM [metadata].[Tenants];
		END;
END;]]></Value>
			</Property>
			<Property Name="IsAnsiNullsOn" Value="True" />
			<Relationship Name="BodyDependencies">
				<Entry>
					<References Name="[metadata].[BatchExecution]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[CurrentExecution]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[ExecutionLog]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[ErrorLog]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[BatchStageLink]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[Batches]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[PipelineDependencies]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[PipelineAlertLink]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[Recipients]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[AlertOutcomes]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[PipelineAuthLink]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[ServicePrincipals]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[Properties]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[PipelineParameters]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[Pipelines]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[Orchestrators]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[Stages]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[Subscriptions]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[Tenants]" />
				</Entry>
			</Relationship>
			<Relationship Name="Schema">
				<Entry>
					<References Name="[metadataHelpers]" />
				</Entry>
			</Relationship>
			<Annotation Type="SysCommentsObjectAnnotation">
				<Property Name="Length" Value="3402" />
				<Property Name="StartLine" Value="1" />
				<Property Name="StartColumn" Value="1" />
				<Property Name="HeaderContents" Value="CREATE PROCEDURE [metadataHelpers].[DeleteMetadataWithIntegrity]&#xD;&#xA;AS" />
			</Annotation>
		</Element>
		<Element Type="SqlProcedure" Name="[metadataHelpers].[DeleteMetadataWithoutIntegrity]">
			<Property Name="BodyScript">
				<Value><![CDATA[
BEGIN

	DECLARE @SQL NVARCHAR(MAX) = ''

	;WITH metadataTables AS
		(
		SELECT
			QUOTENAME(s.[name]) + '.' + QUOTENAME(o.[name]) AS FullName
		FROM
			sys.objects o
			INNER JOIN sys.schemas s
				ON o.[schema_id] = s.[schema_id]
		WHERE
			s.[name] LIKE 'metadata%'
			AND o.[type] = 'U'

		UNION 

		SELECT
			QUOTENAME(s.[name]) + '.' + QUOTENAME(o.[name]) AS FullName
		FROM
			sys.objects o
			INNER JOIN sys.schemas s
				ON o.[schema_id] = s.[schema_id]
		WHERE
			o.[name] = 'ServicePrincipals'
			AND o.[type] = 'U'
		)

	SELECT --tables must exist or wouldnt appear in sys.objects query
		@SQL += 'DELETE FROM ' + [FullName] + ';' + CHAR(13)
	FROM 
		metadataTables

	EXEC(@SQL);
END;]]></Value>
			</Property>
			<Property Name="IsAnsiNullsOn" Value="True" />
			<Relationship Name="BodyDependencies">
				<Entry>
					<References ExternalSource="BuiltIns" Name="[nvarchar]" />
				</Entry>
				<Entry>
					<References ExternalSource="master.dacpac" Name="[master]|[sys].[objects]" />
				</Entry>
				<Entry>
					<References ExternalSource="master.dacpac" Name="[master]|[sys].[schemas]" />
				</Entry>
				<Entry>
					<References ExternalSource="master.dacpac" Name="[master]|[sys].[objects].[schema_id]" />
				</Entry>
				<Entry>
					<References ExternalSource="master.dacpac" Name="[master]|[sys].[schemas].[schema_id]" />
				</Entry>
				<Entry>
					<References ExternalSource="master.dacpac" Name="[master]|[sys].[schemas].[name]" />
				</Entry>
				<Entry>
					<References ExternalSource="master.dacpac" Name="[master]|[sys].[objects].[name]" />
				</Entry>
				<Entry>
					<References ExternalSource="master.dacpac" Name="[master]|[sys].[objects].[type]" />
				</Entry>
			</Relationship>
			<Relationship Name="DynamicObjects">
				<Entry>
					<Element Type="SqlDynamicColumnSource" Name="[metadataHelpers].[DeleteMetadataWithoutIntegrity].[CTE1].[metadataTables]">
						<Relationship Name="Columns">
							<Entry>
								<Element Type="SqlComputedColumn" Name="[metadataHelpers].[DeleteMetadataWithoutIntegrity].[CTE1].[metadataTables].[FullName]" />
							</Entry>
						</Relationship>
					</Element>
				</Entry>
			</Relationship>
			<Relationship Name="Schema">
				<Entry>
					<References Name="[metadataHelpers]" />
				</Entry>
			</Relationship>
			<Annotation Type="SysCommentsObjectAnnotation">
				<Property Name="Length" Value="803" />
				<Property Name="StartLine" Value="1" />
				<Property Name="StartColumn" Value="1" />
				<Property Name="HeaderContents" Value="CREATE PROCEDURE [metadataHelpers].[DeleteMetadataWithoutIntegrity]&#xD;&#xA;AS" />
			</Annotation>
		</Element>
		<Element Type="SqlProcedure" Name="[metadataHelpers].[DeleteRecipientAlerts]">
			<Property Name="BodyScript">
				<Value><![CDATA[
BEGIN
	SET NOCOUNT ON;

	--defensive check
	IF NOT EXISTS
		(
		SELECT [RecipientId] FROM [metadata].[Recipients] WHERE [EmailAddress] = @EmailAddress
		)
		BEGIN
			RAISERROR('Recipient email address does not exists in [metadata].[Recipients] table.',16,1);
			RETURN 0;
		END;

	--update/delete
	IF @SoftDeleteOnly = 1
		BEGIN
			--disable links
			UPDATE
				al
			SET
				al.[Enabled] = 0
			FROM
				[metadata].[PipelineAlertLink] al
				INNER JOIN [metadata].[Recipients] r
					ON al.[RecipientId] = r.[RecipientId]
			WHERE
				r.[EmailAddress] = @EmailAddress;
	
			--disable recipient(s)
			UPDATE
				[metadata].[Recipients]
			SET
				[Enabled] = 0
			WHERE
				[EmailAddress] = @EmailAddress;

		END
	ELSE
		BEGIN
			--delete links
			DELETE		
				al
			FROM
				[metadata].[PipelineAlertLink] al
				INNER JOIN [metadata].[Recipients] r
					ON al.[RecipientId] = r.[RecipientId]
			WHERE
				r.[EmailAddress] = @EmailAddress;

			--delete recipient(s)
			DELETE FROM
				[metadata].[Recipients]
			WHERE
				[EmailAddress] = @EmailAddress;
		END;
END;]]></Value>
			</Property>
			<Property Name="IsAnsiNullsOn" Value="True" />
			<Relationship Name="BodyDependencies">
				<Entry>
					<References Name="[metadata].[Recipients]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[Recipients].[RecipientId]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[Recipients].[EmailAddress]" />
				</Entry>
				<Entry>
					<References Name="[metadataHelpers].[DeleteRecipientAlerts].[@EmailAddress]" />
				</Entry>
				<Entry>
					<References Name="[metadataHelpers].[DeleteRecipientAlerts].[@SoftDeleteOnly]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[PipelineAlertLink]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[PipelineAlertLink].[RecipientId]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[Recipients].[RecipientId]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[PipelineAlertLink].[Enabled]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[Recipients].[EmailAddress]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[Recipients].[Enabled]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[Recipients].[EmailAddress]" />
				</Entry>
			</Relationship>
			<Relationship Name="Parameters">
				<Entry>
					<Element Type="SqlSubroutineParameter" Name="[metadataHelpers].[DeleteRecipientAlerts].[@EmailAddress]">
						<Relationship Name="Type">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Property Name="Length" Value="500" />
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[nvarchar]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlSubroutineParameter" Name="[metadataHelpers].[DeleteRecipientAlerts].[@SoftDeleteOnly]">
						<Property Name="DefaultExpressionScript">
							<Value><![CDATA[1]]></Value>
						</Property>
						<Relationship Name="Type">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[bit]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
			</Relationship>
			<Relationship Name="Schema">
				<Entry>
					<References Name="[metadataHelpers]" />
				</Entry>
			</Relationship>
			<Annotation Type="SysCommentsObjectAnnotation">
				<Property Name="Length" Value="1250" />
				<Property Name="StartLine" Value="1" />
				<Property Name="StartColumn" Value="1" />
				<Property Name="HeaderContents" Value="CREATE PROCEDURE [metadataHelpers].[DeleteRecipientAlerts]&#xD;&#xA;&#x9;(&#xD;&#xA;&#x9;@EmailAddress NVARCHAR(500),&#xD;&#xA;&#x9;@SoftDeleteOnly BIT = 1&#xD;&#xA;&#x9;)&#xD;&#xA;AS" />
			</Annotation>
		</Element>
		<Element Type="SqlProcedure" Name="[metadataHelpers].[DeleteServicePrincipal]">
			<Property Name="BodyScript">
				<Value><![CDATA[
BEGIN
	SET NOCOUNT ON;

	DECLARE @ErrorDetails NVARCHAR(500) = ''
	DECLARE @CredentialId INT

	--resolve principal Id or Url to credential Id
	IF ([metadata].[GetPropertyValueInternal]('SPNHandlingMethod')) = 'StoreInDatabase'
		BEGIN
			--defensive checks
			BEGIN TRY
				DECLARE @LocalPrincipalId UNIQUEIDENTIFIER

				SELECT --assigned to variable just to supress output of SELECT
					@LocalPrincipalId = CAST(@PrincipalIdValue AS UNIQUEIDENTIFIER)
			END TRY
			BEGIN CATCH
					SET @ErrorDetails = 'Invalid @PrincipalId provided. The format must be a UNIQUEIDENTIFIER.'
					RAISERROR(@ErrorDetails, 16, 1);
					RETURN 0;
			END CATCH	
			
			--get cred id using principal id
			SELECT
				@CredentialId = [CredentialId]
			FROM
				[dbo].[ServicePrincipals]
			WHERE
				[PrincipalId] = @PrincipalIdValue
		END
	ELSE IF ([metadata].[GetPropertyValueInternal]('SPNHandlingMethod')) = 'StoreInKeyVault'
		BEGIN
			--get cred id using principal id url
			SELECT
				@CredentialId = [CredentialId]
			FROM
				[dbo].[ServicePrincipals]
			WHERE
				[PrincipalIdUrl] = @PrincipalIdValue
		END;
	ELSE
		BEGIN
			RAISERROR('Unknown SPN deletion method.',16,1);
			RETURN 0;
		END;

	--secondary defensive checks
	IF NOT EXISTS
		(
		SELECT [OrchestratorName] FROM [metadata].[Orchestrators] WHERE [OrchestratorName] = @OrchestratorName AND [OrchestratorType] = @OrchestratorType
		)
		BEGIN
			SET @ErrorDetails = 'Invalid Orchestrator name. Please ensure the Orchestrator metadata exists.'
			RAISERROR(@ErrorDetails, 16, 1);
			RETURN 0;
		END

	IF @CredentialId IS NULL
		BEGIN
			SET @ErrorDetails = 'Invalid Service Principal Id Value provided. Please ensure the Service Principal exists.'
			RAISERROR(@ErrorDetails, 16, 1);
			RETURN 0;
		END

	--delete SPN for specific pipeline
	IF @SpecificPipelineName IS NOT NULL
		BEGIN
			IF NOT EXISTS
				( 
				SELECT [PipelineName] FROM [metadata].[Pipelines] WHERE [PipelineName] = @SpecificPipelineName
				)
				BEGIN
					SET @ErrorDetails = 'Invalid Pipeline name. Please ensure the Pipeline metadata exists.'
					RAISERROR(@ErrorDetails, 16, 1);
					RETURN 0;
				END
			
			--delete links
			DELETE
				L
			FROM
				[metadata].[PipelineAuthLink] L
				INNER JOIN [metadata].[Pipelines] P
					ON L.[PipelineId] = P.[PipelineId]
				INNER JOIN [metadata].[Orchestrators] D
					ON P.[OrchestratorId] = D.[OrchestratorId]
						AND L.[OrchestratorId] = D.[OrchestratorId]
				INNER JOIN [dbo].[ServicePrincipals] S
					ON L.[CredentialId] = S.[CredentialId]
			WHERE
				P.[PipelineName] = @SpecificPipelineName
				AND D.[OrchestratorName] = @OrchestratorName
				AND D.[OrchestratorType] = @OrchestratorType
				AND S.[CredentialId] = @CredentialId;
		END
	ELSE
		BEGIN
			--delete links
			DELETE
				L
			FROM
				[metadata].[PipelineAuthLink] L
				INNER JOIN [metadata].[Orchestrators] D
					ON L.[OrchestratorId] = D.[OrchestratorId]
				INNER JOIN [dbo].[ServicePrincipals] S
					ON L.[CredentialId] = S.[CredentialId]
			WHERE
				D.[OrchestratorName] = @OrchestratorName
				AND D.[OrchestratorType] = @OrchestratorType
				AND S.[CredentialId] = @CredentialId;
		END

	--finall, delete principal only if not still used by other pipelines
	DELETE 
		SP
	FROM 
		[dbo].[ServicePrincipals] SP
		LEFT OUTER JOIN [metadata].[PipelineAuthLink] AL
			ON SP.[CredentialId] = AL.[CredentialId]
	WHERE 
		SP.[CredentialId] = @CredentialId
		AND AL.[CredentialId] IS NULL;
END;]]></Value>
			</Property>
			<Property Name="IsAnsiNullsOn" Value="True" />
			<Relationship Name="BodyDependencies">
				<Entry>
					<References ExternalSource="BuiltIns" Name="[nvarchar]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[int]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[uniqueidentifier]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[GetPropertyValueInternal]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[uniqueidentifier]" />
				</Entry>
				<Entry>
					<References Name="[metadataHelpers].[DeleteServicePrincipal].[@PrincipalIdValue]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[ServicePrincipals]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[ServicePrincipals].[CredentialId]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[ServicePrincipals].[PrincipalId]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[ServicePrincipals].[PrincipalIdUrl]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[Orchestrators]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[Orchestrators].[OrchestratorName]" />
				</Entry>
				<Entry>
					<References Name="[metadataHelpers].[DeleteServicePrincipal].[@OrchestratorName]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[Orchestrators].[OrchestratorType]" />
				</Entry>
				<Entry>
					<References Name="[metadataHelpers].[DeleteServicePrincipal].[@OrchestratorType]" />
				</Entry>
				<Entry>
					<References Name="[metadataHelpers].[DeleteServicePrincipal].[@SpecificPipelineName]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[Pipelines]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[Pipelines].[PipelineName]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[PipelineAuthLink]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[PipelineAuthLink].[PipelineId]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[Pipelines].[PipelineId]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[Pipelines].[OrchestratorId]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[Orchestrators].[OrchestratorId]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[PipelineAuthLink].[OrchestratorId]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[PipelineAuthLink].[CredentialId]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[ServicePrincipals].[CredentialId]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[Pipelines].[PipelineName]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[Orchestrators].[OrchestratorName]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[Orchestrators].[OrchestratorType]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[PipelineAuthLink].[OrchestratorId]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[Orchestrators].[OrchestratorId]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[PipelineAuthLink].[CredentialId]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[ServicePrincipals].[CredentialId]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[Orchestrators].[OrchestratorName]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[Orchestrators].[OrchestratorType]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[ServicePrincipals].[CredentialId]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[PipelineAuthLink].[CredentialId]" />
				</Entry>
			</Relationship>
			<Relationship Name="Parameters">
				<Entry>
					<Element Type="SqlSubroutineParameter" Name="[metadataHelpers].[DeleteServicePrincipal].[@OrchestratorName]">
						<Relationship Name="Type">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Property Name="Length" Value="200" />
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[nvarchar]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlSubroutineParameter" Name="[metadataHelpers].[DeleteServicePrincipal].[@OrchestratorType]">
						<Relationship Name="Type">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Property Name="Length" Value="3" />
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[char]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlSubroutineParameter" Name="[metadataHelpers].[DeleteServicePrincipal].[@PrincipalIdValue]">
						<Relationship Name="Type">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Property Name="Length" Value="256" />
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[nvarchar]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlSubroutineParameter" Name="[metadataHelpers].[DeleteServicePrincipal].[@SpecificPipelineName]">
						<Property Name="DefaultExpressionScript">
							<Value><![CDATA[NULL]]></Value>
						</Property>
						<Relationship Name="Type">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Property Name="Length" Value="200" />
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[nvarchar]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
			</Relationship>
			<Relationship Name="Schema">
				<Entry>
					<References Name="[metadataHelpers]" />
				</Entry>
			</Relationship>
			<Annotation Type="SysCommentsObjectAnnotation">
				<Property Name="Length" Value="3780" />
				<Property Name="StartLine" Value="1" />
				<Property Name="StartColumn" Value="1" />
				<Property Name="HeaderContents" Value="CREATE PROCEDURE [metadataHelpers].[DeleteServicePrincipal]&#xD;&#xA;&#x9;(&#xD;&#xA;&#x9;@OrchestratorName NVARCHAR(200),&#xD;&#xA;&#x9;@OrchestratorType CHAR(3),&#xD;&#xA;&#x9;@PrincipalIdValue NVARCHAR(256),&#xD;&#xA;&#x9;@SpecificPipelineName NVARCHAR(200) = NULL&#xD;&#xA;&#x9;)&#xD;&#xA;AS" />
			</Annotation>
		</Element>
		<Element Type="SqlProcedure" Name="[metadataHelpers].[GetExecutionDetails]">
			<Property Name="BodyScript">
				<Value><![CDATA[
BEGIN

	--Get last execution ID
	IF @LocalExecutionId IS NULL
	BEGIN
		WITH maxLog AS
			(
			SELECT
				MAX([LogId]) AS MaxLogId
			FROM
				[metadata].[ExecutionLog]
			)
		SELECT
			@LocalExecutionId = el1.[LocalExecutionId]
		FROM
			[metadata].[ExecutionLog] el1
			INNER JOIN maxLog
				ON maxLog.[MaxLogId] = el1.[LogId];
	END;

	--Execution Summary
	SELECT
		CAST(el2.[StageId] AS VARCHAR(5)) + ' - ' + stgs.[StageName] AS Stage,
		COUNT(0) AS RecordCount,
		DATEDIFF(MINUTE, MIN(el2.[StartDateTime]), MAX(el2.[EndDateTime])) DurationMinutes
	FROM
		[metadata].[ExecutionLog] el2
		INNER JOIN [metadata].[Stages] stgs
			ON el2.[StageId] = stgs.[StageId]
	WHERE
		el2.[LocalExecutionId] = @LocalExecutionId
	GROUP BY
		CAST(el2.[StageId] AS VARCHAR(5)) + ' - ' + stgs.[StageName]
	ORDER BY
		CAST(el2.[StageId] AS VARCHAR(5)) + ' - ' + stgs.[StageName];

	--Full execution details
	SELECT
		el3.[LogId],
		el3.[LocalExecutionId],
		el3.[OrchestratorType],
		el3.[OrchestratorName],
		el3.[StageId],
		stgs.[StageName],
		el3.[PipelineId],
		el3.[PipelineName],
		el3.[StartDateTime],
		el3.[EndDateTime],
		ISNULL(DATEDIFF(MINUTE, el3.[StartDateTime], el3.[EndDateTime]),0) AS DurationMinutes,
		el3.[PipelineStatus],
		el3.[PipelineRunId],
		el3.[PipelineParamsUsed],
		errLog.[ActivityRunId],
		errLog.[ActivityName],
		errLog.[ActivityType],
		errLog.[ErrorCode],
		errLog.[ErrorType],
		errLog.[ErrorMessage]
	FROM 
		[metadata].[ExecutionLog] el3
		LEFT OUTER JOIN [metadata].[ErrorLog] errLog
			ON el3.[LocalExecutionId] = errLog.[LocalExecutionId]
				AND el3.[PipelineRunId] = errLog.[PipelineRunId]
		INNER JOIN [metadata].[Stages] stgs
			ON el3.[StageId] = stgs.[StageId]
	WHERE
		el3.[LocalExecutionId] = @LocalExecutionId
	ORDER BY
		el3.[PipelineId],
		el3.[StartDateTime];
END;]]></Value>
			</Property>
			<Property Name="IsAnsiNullsOn" Value="True" />
			<Relationship Name="BodyDependencies">
				<Entry>
					<References Name="[metadataHelpers].[GetExecutionDetails].[@LocalExecutionId]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[ExecutionLog]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[ExecutionLog].[LogId]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[ExecutionLog].[LogId]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[ExecutionLog].[LocalExecutionId]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[Stages]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[ExecutionLog].[StageId]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[Stages].[StageId]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[varchar]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[Stages].[StageName]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[ExecutionLog].[StartDateTime]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[ExecutionLog].[EndDateTime]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[ExecutionLog].[LocalExecutionId]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[varchar]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[varchar]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[ErrorLog]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[ExecutionLog].[LocalExecutionId]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[ErrorLog].[LocalExecutionId]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[ExecutionLog].[PipelineRunId]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[ErrorLog].[PipelineRunId]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[ExecutionLog].[StageId]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[Stages].[StageId]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[ExecutionLog].[LogId]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[ExecutionLog].[LocalExecutionId]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[ExecutionLog].[OrchestratorType]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[ExecutionLog].[OrchestratorName]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[Stages].[StageName]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[ExecutionLog].[PipelineId]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[ExecutionLog].[PipelineName]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[ExecutionLog].[StartDateTime]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[ExecutionLog].[EndDateTime]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[ExecutionLog].[PipelineStatus]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[ExecutionLog].[PipelineRunId]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[ExecutionLog].[PipelineParamsUsed]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[ErrorLog].[ActivityRunId]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[ErrorLog].[ActivityName]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[ErrorLog].[ActivityType]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[ErrorLog].[ErrorCode]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[ErrorLog].[ErrorType]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[ErrorLog].[ErrorMessage]" />
				</Entry>
			</Relationship>
			<Relationship Name="DynamicObjects">
				<Entry>
					<Element Type="SqlDynamicColumnSource" Name="[metadataHelpers].[GetExecutionDetails].[CTE1].[maxLog]">
						<Relationship Name="Columns">
							<Entry>
								<Element Type="SqlComputedColumn" Name="[metadataHelpers].[GetExecutionDetails].[CTE1].[maxLog].[MaxLogId]" />
							</Entry>
						</Relationship>
					</Element>
				</Entry>
			</Relationship>
			<Relationship Name="Parameters">
				<Entry>
					<Element Type="SqlSubroutineParameter" Name="[metadataHelpers].[GetExecutionDetails].[@LocalExecutionId]">
						<Property Name="DefaultExpressionScript">
							<Value><![CDATA[NULL]]></Value>
						</Property>
						<Relationship Name="Type">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[uniqueidentifier]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
			</Relationship>
			<Relationship Name="Schema">
				<Entry>
					<References Name="[metadataHelpers]" />
				</Entry>
			</Relationship>
			<Annotation Type="SysCommentsObjectAnnotation">
				<Property Name="Length" Value="1985" />
				<Property Name="StartLine" Value="1" />
				<Property Name="StartColumn" Value="1" />
				<Property Name="HeaderContents" Value="CREATE PROCEDURE [metadataHelpers].[GetExecutionDetails]&#xD;&#xA;&#x9;(&#xD;&#xA;&#x9;@LocalExecutionId UNIQUEIDENTIFIER = NULL&#xD;&#xA;&#x9;)&#xD;&#xA;AS" />
			</Annotation>
		</Element>
		<Element Type="SqlProcedure" Name="[metadataHelpers].[GetServicePrincipal]">
			<Property Name="BodyScript">
				<Value><![CDATA[
BEGIN
	SET NOCOUNT ON;

	DECLARE @Id NVARCHAR(MAX)
	DECLARE @Secret NVARCHAR(MAX)

	IF ([metadata].[GetPropertyValueInternal]('SPNHandlingMethod')) = 'StoreInDatabase'
		BEGIN
			--get auth details regardless of being pipeline specific and regardless of a pipeline param being passed
			;WITH cte AS
				(
				SELECT DISTINCT
					S.[PrincipalId] AS Id,
					CAST(DECRYPTBYPASSPHRASE(CONCAT(@OrchestratorName, @PipelineName), S.[PrincipalSecret]) AS NVARCHAR(MAX)) AS [Secret]
				FROM
					[dbo].[ServicePrincipals] S
					INNER JOIN  [metadata].[PipelineAuthLink] L
						ON S.[CredentialId] = L.[CredentialId]
					INNER JOIN [metadata].[Pipelines] P
						ON L.[PipelineId] = P.[PipelineId]
					INNER JOIN [metadata].[Orchestrators] D
						ON P.[OrchestratorId] = D.[OrchestratorId]
							AND L.[OrchestratorId] = D.[OrchestratorId]
				WHERE
					P.[PipelineName] = @PipelineName
					AND D.[OrchestratorName] = @OrchestratorName
					AND D.[OrchestratorType] = @OrchestratorType
			
				UNION

				SELECT DISTINCT
					S.[PrincipalId] AS Id,
					CAST(DECRYPTBYPASSPHRASE(@OrchestratorName, S.[PrincipalSecret]) AS NVARCHAR(MAX)) AS [Secret]
				FROM
					[dbo].[ServicePrincipals] S
					INNER JOIN  [metadata].[PipelineAuthLink] L
						ON S.[CredentialId] = L.[CredentialId]
					INNER JOIN [metadata].[Orchestrators] D
						ON L.[OrchestratorId] = D.[OrchestratorId]
				WHERE
					D.[OrchestratorName] = @OrchestratorName
					AND D.[OrchestratorType] = @OrchestratorType
				)
			SELECT TOP 1
				@Id = [Id],
				@Secret = [Secret]
			FROM
				cte
			WHERE
				[Secret] IS NOT NULL
		END
	ELSE IF ([metadata].[GetPropertyValueInternal]('SPNHandlingMethod')) = 'StoreInKeyVault'
		BEGIN
			--get auth details regardless of being pipeline specific and regardless of a pipeline param being passed
			;WITH cte AS
				(
				SELECT DISTINCT
					S.[PrincipalIdUrl] AS Id,
					S.[PrincipalSecretUrl] AS [Secret]
				FROM
					[dbo].[ServicePrincipals] S
					INNER JOIN  [metadata].[PipelineAuthLink] L
						ON S.[CredentialId] = L.[CredentialId]
					INNER JOIN [metadata].[Pipelines] P
						ON L.[PipelineId] = P.[PipelineId]
					INNER JOIN [metadata].[Orchestrators] D
						ON P.[OrchestratorId] = D.[OrchestratorId]
							AND L.[OrchestratorId] = D.[OrchestratorId]
				WHERE
					P.[PipelineName] = @PipelineName
					AND D.[OrchestratorName] = @OrchestratorName
					AND D.[OrchestratorType] = @OrchestratorType
			
				UNION

				SELECT DISTINCT
					S.[PrincipalIdUrl] AS Id,
					S.[PrincipalSecretUrl] AS [Secret]
				FROM
					[dbo].[ServicePrincipals] S
					INNER JOIN  [metadata].[PipelineAuthLink] L
						ON S.[CredentialId] = L.[CredentialId]
					INNER JOIN [metadata].[Orchestrators] D
						ON L.[OrchestratorId] = D.[OrchestratorId]
				WHERE
					D.[OrchestratorName] = @OrchestratorName
					AND D.[OrchestratorType] = @OrchestratorType
				)
			SELECT TOP 1
				@Id = [Id],
				@Secret = [Secret]
			FROM
				cte
			WHERE
				[Secret] IS NOT NULL
		END
	ELSE
		BEGIN
			RAISERROR('Unknown SPN retrieval method.',16,1);
			RETURN 0;
		END

	--return usable values
	SELECT
		@Id AS Id,
		@Secret AS [Secret]
END;]]></Value>
			</Property>
			<Property Name="IsAnsiNullsOn" Value="True" />
			<Relationship Name="BodyDependencies">
				<Entry>
					<References ExternalSource="BuiltIns" Name="[nvarchar]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[nvarchar]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[GetPropertyValueInternal]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[ServicePrincipals]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[PipelineAuthLink]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[ServicePrincipals].[CredentialId]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[PipelineAuthLink].[CredentialId]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[Pipelines]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[PipelineAuthLink].[PipelineId]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[Pipelines].[PipelineId]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[Orchestrators]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[Pipelines].[OrchestratorId]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[Orchestrators].[OrchestratorId]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[PipelineAuthLink].[OrchestratorId]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[ServicePrincipals].[PrincipalId]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[nvarchar]" />
				</Entry>
				<Entry>
					<References Name="[metadataHelpers].[GetServicePrincipal].[@OrchestratorName]" />
				</Entry>
				<Entry>
					<References Name="[metadataHelpers].[GetServicePrincipal].[@PipelineName]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[ServicePrincipals].[PrincipalSecret]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[Pipelines].[PipelineName]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[Orchestrators].[OrchestratorName]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[Orchestrators].[OrchestratorType]" />
				</Entry>
				<Entry>
					<References Name="[metadataHelpers].[GetServicePrincipal].[@OrchestratorType]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[PipelineAuthLink].[OrchestratorId]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[Orchestrators].[OrchestratorId]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[ServicePrincipals].[PrincipalId]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[nvarchar]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[ServicePrincipals].[PrincipalSecret]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[Orchestrators].[OrchestratorName]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[Orchestrators].[OrchestratorType]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[ServicePrincipals].[PrincipalId]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[ServicePrincipals].[PrincipalIdUrl]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[ServicePrincipals].[PrincipalSecretUrl]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[ServicePrincipals].[PrincipalIdUrl]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[ServicePrincipals].[PrincipalSecretUrl]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[ServicePrincipals].[PrincipalIdUrl]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[ServicePrincipals].[PrincipalSecretUrl]" />
				</Entry>
			</Relationship>
			<Relationship Name="DynamicObjects">
				<Entry>
					<Element Type="SqlDynamicColumnSource" Name="[metadataHelpers].[GetServicePrincipal].[CTE1].[cte]">
						<Relationship Name="Columns">
							<Entry>
								<Element Type="SqlComputedColumn" Name="[metadataHelpers].[GetServicePrincipal].[CTE1].[cte].[Id]">
									<Relationship Name="ExpressionDependencies">
										<Entry>
											<References Name="[dbo].[ServicePrincipals].[PrincipalId]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
							<Entry>
								<Element Type="SqlComputedColumn" Name="[metadataHelpers].[GetServicePrincipal].[CTE1].[cte].[Secret]" />
							</Entry>
						</Relationship>
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlDynamicColumnSource" Name="[metadataHelpers].[GetServicePrincipal].[CTE2].[cte]">
						<Relationship Name="Columns">
							<Entry>
								<Element Type="SqlComputedColumn" Name="[metadataHelpers].[GetServicePrincipal].[CTE2].[cte].[Id]">
									<Relationship Name="ExpressionDependencies">
										<Entry>
											<References Name="[dbo].[ServicePrincipals].[PrincipalIdUrl]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
							<Entry>
								<Element Type="SqlComputedColumn" Name="[metadataHelpers].[GetServicePrincipal].[CTE2].[cte].[Secret]">
									<Relationship Name="ExpressionDependencies">
										<Entry>
											<References Name="[dbo].[ServicePrincipals].[PrincipalSecretUrl]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
			</Relationship>
			<Relationship Name="Parameters">
				<Entry>
					<Element Type="SqlSubroutineParameter" Name="[metadataHelpers].[GetServicePrincipal].[@OrchestratorName]">
						<Relationship Name="Type">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Property Name="Length" Value="200" />
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[nvarchar]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlSubroutineParameter" Name="[metadataHelpers].[GetServicePrincipal].[@OrchestratorType]">
						<Relationship Name="Type">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Property Name="Length" Value="3" />
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[char]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlSubroutineParameter" Name="[metadataHelpers].[GetServicePrincipal].[@PipelineName]">
						<Property Name="DefaultExpressionScript">
							<Value><![CDATA[NULL]]></Value>
						</Property>
						<Relationship Name="Type">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Property Name="Length" Value="200" />
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[nvarchar]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
			</Relationship>
			<Relationship Name="Schema">
				<Entry>
					<References Name="[metadataHelpers]" />
				</Entry>
			</Relationship>
			<Annotation Type="SysCommentsObjectAnnotation">
				<Property Name="Length" Value="3427" />
				<Property Name="StartLine" Value="1" />
				<Property Name="StartColumn" Value="1" />
				<Property Name="HeaderContents" Value="CREATE PROCEDURE [metadataHelpers].[GetServicePrincipal]&#xD;&#xA;&#x9;(&#xD;&#xA;&#x9;@OrchestratorName NVARCHAR(200),&#xD;&#xA;&#x9;@OrchestratorType CHAR(3),&#xD;&#xA;&#x9;@PipelineName NVARCHAR(200) = NULL&#xD;&#xA;&#x9;)&#xD;&#xA;AS" />
			</Annotation>
		</Element>
		<Element Type="SqlView" Name="[metadataHelpers].[PipelineDependencyChains]">
			<Property Name="QueryScript">
				<Value><![CDATA[

SELECT 
	ps.[StageName] AS PredecessorStage,
	pp.[PipelineName] AS PredecessorPipeline,
	ds.[StageName] AS DependantStage,
	dp.[PipelineName] AS DependantPipeline
FROM 
	[metadata].[PipelineDependencies]					pd --pipeline dependencies
	INNER JOIN [metadata].[Pipelines]					pp --predecessor pipelines
		ON pd.[PipelineId] = pp.[PipelineId]
	INNER JOIN [metadata].[Pipelines]					dp --dependant pipelines
		ON pd.[DependantPipelineId] = dp.[PipelineId]
	INNER JOIN [metadata].[Stages]						ps --predecessor stage
		ON pp.[StageId] = ps.[StageId]
	INNER JOIN [metadata].[Stages]						ds --dependant stage
		ON dp.[StageId] = ds.[StageId]]]></Value>
			</Property>
			<Property Name="IsAnsiNullsOn" Value="True" />
			<Relationship Name="Columns">
				<Entry>
					<Element Type="SqlComputedColumn" Name="[metadataHelpers].[PipelineDependencyChains].[PredecessorStage]">
						<Relationship Name="ExpressionDependencies">
							<Entry>
								<References Name="[metadata].[Stages].[StageName]" />
							</Entry>
						</Relationship>
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlComputedColumn" Name="[metadataHelpers].[PipelineDependencyChains].[PredecessorPipeline]">
						<Relationship Name="ExpressionDependencies">
							<Entry>
								<References Name="[metadata].[Pipelines].[PipelineName]" />
							</Entry>
						</Relationship>
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlComputedColumn" Name="[metadataHelpers].[PipelineDependencyChains].[DependantStage]">
						<Relationship Name="ExpressionDependencies">
							<Entry>
								<References Name="[metadata].[Stages].[StageName]" />
							</Entry>
						</Relationship>
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlComputedColumn" Name="[metadataHelpers].[PipelineDependencyChains].[DependantPipeline]">
						<Relationship Name="ExpressionDependencies">
							<Entry>
								<References Name="[metadata].[Pipelines].[PipelineName]" />
							</Entry>
						</Relationship>
					</Element>
				</Entry>
			</Relationship>
			<Relationship Name="QueryDependencies">
				<Entry>
					<References Name="[metadata].[PipelineDependencies]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[Pipelines]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[PipelineDependencies].[PipelineId]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[Pipelines].[PipelineId]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[PipelineDependencies].[DependantPipelineId]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[Pipelines].[PipelineId]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[Stages]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[Pipelines].[StageId]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[Stages].[StageId]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[Pipelines].[StageId]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[Stages].[StageId]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[Stages].[StageName]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[Pipelines].[PipelineName]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[Stages].[StageName]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[Pipelines].[PipelineName]" />
				</Entry>
			</Relationship>
			<Relationship Name="Schema">
				<Entry>
					<References Name="[metadataHelpers]" />
				</Entry>
			</Relationship>
			<Annotation Type="SysCommentsObjectAnnotation">
				<Property Name="Length" Value="714" />
				<Property Name="StartLine" Value="1" />
				<Property Name="StartColumn" Value="1" />
				<Property Name="HeaderContents" Value="CREATE VIEW [metadataHelpers].[PipelineDependencyChains]&#xD;&#xA;AS" />
				<Property Name="FooterContents" Value=";" />
			</Annotation>
		</Element>
		<Element Type="SqlProcedure" Name="[metadataHelpers].[SetDefaultAlertOutcomes]">
			<Property Name="BodyScript">
				<Value><![CDATA[
BEGIN
	TRUNCATE TABLE [metadata].[AlertOutcomes];

	INSERT INTO [metadata].[AlertOutcomes]
		(
		[PipelineOutcomeStatus]
		)
	VALUES 
		('All'),
		('Success'),
		('Failed'),
		('Unknown'),
		('Cancelled');
END;]]></Value>
			</Property>
			<Property Name="IsAnsiNullsOn" Value="True" />
			<Relationship Name="BodyDependencies">
				<Entry>
					<References Name="[metadata].[AlertOutcomes]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[AlertOutcomes].[PipelineOutcomeStatus]" />
				</Entry>
			</Relationship>
			<Relationship Name="Schema">
				<Entry>
					<References Name="[metadataHelpers]" />
				</Entry>
			</Relationship>
			<Annotation Type="SysCommentsObjectAnnotation">
				<Property Name="Length" Value="289" />
				<Property Name="StartLine" Value="1" />
				<Property Name="StartColumn" Value="1" />
				<Property Name="HeaderContents" Value="CREATE PROCEDURE [metadataHelpers].[SetDefaultAlertOutcomes]&#xD;&#xA;AS" />
			</Annotation>
		</Element>
		<Element Type="SqlProcedure" Name="[metadataHelpers].[SetDefaultBatches]">
			<Property Name="BodyScript">
				<Value><![CDATA[
BEGIN
	DECLARE @Batches TABLE
		(
		[BatchName] [VARCHAR](225) NOT NULL,
		[BatchDescription] [VARCHAR](4000) NULL,
		[Enabled] [BIT] NOT NULL
		)
	
	INSERT @Batches
		(
		[BatchName], 
		[BatchDescription], 
		[Enabled]
		) 
	VALUES 
		('Daily', N'Daily Worker Pipelines.', 1),
		('Hourly', N'Hourly Worker Pipelines.', 1);	

	MERGE INTO [metadata].[Batches] AS tgt
	USING 
		@Batches AS src
			ON tgt.[BatchName] = src.[BatchName]
	WHEN MATCHED THEN
		UPDATE
		SET
			tgt.[BatchDescription] = src.[BatchDescription],
			tgt.[Enabled] = src.[Enabled]
	WHEN NOT MATCHED BY TARGET THEN
		INSERT
			(
			[BatchName],
			[BatchDescription],
			[Enabled]
			)
		VALUES
			(
			src.[BatchName],
			src.[BatchDescription],
			src.[Enabled]
			)
	WHEN NOT MATCHED BY SOURCE THEN
		DELETE;	
END;]]></Value>
			</Property>
			<Property Name="IsAnsiNullsOn" Value="True" />
			<Relationship Name="BodyDependencies">
				<Entry>
					<References Name="[metadataHelpers].[SetDefaultBatches].[@Batches].[BatchName]" />
				</Entry>
				<Entry>
					<References Name="[metadataHelpers].[SetDefaultBatches].[@Batches].[BatchDescription]" />
				</Entry>
				<Entry>
					<References Name="[metadataHelpers].[SetDefaultBatches].[@Batches].[Enabled]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[Batches]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[Batches].[BatchName]" />
				</Entry>
				<Entry>
					<References Name="[metadataHelpers].[SetDefaultBatches].[@Batches].[BatchName]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[Batches].[BatchDescription]" />
				</Entry>
				<Entry>
					<References Name="[metadataHelpers].[SetDefaultBatches].[@Batches].[BatchDescription]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[Batches].[Enabled]" />
				</Entry>
				<Entry>
					<References Name="[metadataHelpers].[SetDefaultBatches].[@Batches].[Enabled]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[Batches].[BatchName]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[Batches].[BatchDescription]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[Batches].[Enabled]" />
				</Entry>
				<Entry>
					<References Name="[metadataHelpers].[SetDefaultBatches].[@Batches].[BatchName]" />
				</Entry>
				<Entry>
					<References Name="[metadataHelpers].[SetDefaultBatches].[@Batches].[BatchDescription]" />
				</Entry>
				<Entry>
					<References Name="[metadataHelpers].[SetDefaultBatches].[@Batches].[Enabled]" />
				</Entry>
			</Relationship>
			<Relationship Name="DynamicObjects">
				<Entry>
					<Element Type="SqlDynamicColumnSource" Name="[metadataHelpers].[SetDefaultBatches].[@Batches]">
						<Relationship Name="Columns">
							<Entry>
								<Element Type="SqlSimpleColumn" Name="[metadataHelpers].[SetDefaultBatches].[@Batches].[BatchName]">
									<Property Name="IsNullable" Value="False" />
									<Relationship Name="TypeSpecifier">
										<Entry>
											<Element Type="SqlTypeSpecifier">
												<Property Name="Length" Value="225" />
												<Relationship Name="Type">
													<Entry>
														<References ExternalSource="BuiltIns" Name="[varchar]" />
													</Entry>
												</Relationship>
											</Element>
										</Entry>
									</Relationship>
								</Element>
							</Entry>
							<Entry>
								<Element Type="SqlSimpleColumn" Name="[metadataHelpers].[SetDefaultBatches].[@Batches].[BatchDescription]">
									<Relationship Name="TypeSpecifier">
										<Entry>
											<Element Type="SqlTypeSpecifier">
												<Property Name="Length" Value="4000" />
												<Relationship Name="Type">
													<Entry>
														<References ExternalSource="BuiltIns" Name="[varchar]" />
													</Entry>
												</Relationship>
											</Element>
										</Entry>
									</Relationship>
								</Element>
							</Entry>
							<Entry>
								<Element Type="SqlSimpleColumn" Name="[metadataHelpers].[SetDefaultBatches].[@Batches].[Enabled]">
									<Property Name="IsNullable" Value="False" />
									<Relationship Name="TypeSpecifier">
										<Entry>
											<Element Type="SqlTypeSpecifier">
												<Relationship Name="Type">
													<Entry>
														<References ExternalSource="BuiltIns" Name="[bit]" />
													</Entry>
												</Relationship>
											</Element>
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
			</Relationship>
			<Relationship Name="Schema">
				<Entry>
					<References Name="[metadataHelpers]" />
				</Entry>
			</Relationship>
			<Annotation Type="SysCommentsObjectAnnotation">
				<Property Name="Length" Value="889" />
				<Property Name="StartLine" Value="1" />
				<Property Name="StartColumn" Value="1" />
				<Property Name="HeaderContents" Value="CREATE PROCEDURE [metadataHelpers].[SetDefaultBatches]&#xD;&#xA;AS" />
			</Annotation>
		</Element>
		<Element Type="SqlProcedure" Name="[metadataHelpers].[SetDefaultBatchStageLink]">
			<Property Name="BodyScript">
				<Value><![CDATA[
BEGIN
	TRUNCATE TABLE [metadata].[BatchStageLink]

	INSERT INTO [metadata].[BatchStageLink]
		(
		[BatchId],
		[StageId]
		)
	SELECT
		b.[BatchId],
		s.[StageId]
	FROM
		[metadata].[Batches] b
		INNER JOIN [metadata].[Stages] s
			ON s.[StageName] <> 'Speed'
	WHERE
		b.[BatchName] = 'Daily'

	UNION ALL

	SELECT
		b.[BatchId],
		s.[StageId]
	FROM
		[metadata].[Batches] b
		INNER JOIN [metadata].[Stages] s
			ON s.[StageName] = 'Speed'
	WHERE
		b.[BatchName] = 'Hourly'
END;]]></Value>
			</Property>
			<Property Name="IsAnsiNullsOn" Value="True" />
			<Relationship Name="BodyDependencies">
				<Entry>
					<References Name="[metadata].[BatchStageLink]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[BatchStageLink].[BatchId]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[BatchStageLink].[StageId]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[Batches]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[Stages]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[Stages].[StageName]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[Batches].[BatchId]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[Stages].[StageId]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[Batches].[BatchName]" />
				</Entry>
			</Relationship>
			<Relationship Name="Schema">
				<Entry>
					<References Name="[metadataHelpers]" />
				</Entry>
			</Relationship>
			<Annotation Type="SysCommentsObjectAnnotation">
				<Property Name="Length" Value="572" />
				<Property Name="StartLine" Value="1" />
				<Property Name="StartColumn" Value="1" />
				<Property Name="HeaderContents" Value="CREATE PROCEDURE [metadataHelpers].[SetDefaultBatchStageLink]&#xD;&#xA;AS" />
			</Annotation>
		</Element>
		<Element Type="SqlProcedure" Name="[metadataHelpers].[SetDefaultOrchestrators]">
			<Property Name="BodyScript">
				<Value><![CDATA[
BEGIN
	DECLARE @Orchestrators TABLE 
		(
		[OrchestratorName] NVARCHAR(200) NOT NULL,
		[OrchestratorType] CHAR(3) NOT NULL,
		[IsFrameworkOrchestrator] BIT NOT NULL,
		[ResourceGroupName] NVARCHAR(200) NOT NULL,
		[SubscriptionId] UNIQUEIDENTIFIER NOT NULL,
		[Description] NVARCHAR(MAX) NULL
		)
	
	INSERT INTO @Orchestrators
		(
		[OrchestratorName],
		[OrchestratorType],
		[IsFrameworkOrchestrator],
		[Description],
		[ResourceGroupName],
		[SubscriptionId]
		)
	VALUES
		('ADFUniversalOrchestratorFramework','ADF',1,'Example Data Factory used for development.','adf.framework','930d2a20-dc22-431d-bdde-4a2916d0096b')--,
		--('FrameworkFactoryDev','ADF',0,'Example Data Factory used for development deployments.','ADF.metadata','12345678-1234-1234-1234-012345678910'),
		--('FrameworkFactoryTest','ADF',0,'Example Data Factory used for testing.','ADF.metadata','12345678-1234-1234-1234-012345678910'),
		--('WorkersFactory','ADF',0,'Example Data Factory used to house worker pipelines.','ADF.metadata','12345678-1234-1234-1234-012345678910'),
		--('metadataforsynapse','SYN',0,'Example Synapse instance used to house all pipelines.','ADF.metadata','12345678-1234-1234-1234-012345678910')
		;

	MERGE INTO [metadata].[Orchestrators] AS tgt
	USING 
		@Orchestrators AS src
			ON tgt.[OrchestratorName] = src.[OrchestratorName]
				AND tgt.[OrchestratorType] = src.[OrchestratorType]
	WHEN MATCHED THEN
		UPDATE
		SET
			tgt.[IsFrameworkOrchestrator] = src.[IsFrameworkOrchestrator],
			tgt.[Description] = src.[Description],
			tgt.[ResourceGroupName] = src.[ResourceGroupName],
			tgt.[SubscriptionId] = src.[SubscriptionId]
	WHEN NOT MATCHED BY TARGET THEN
		INSERT
			(
			[OrchestratorName],
			[OrchestratorType],
			[IsFrameworkOrchestrator],
			[Description],
			[ResourceGroupName],
			[SubscriptionId]
			)
		VALUES
			(
			src.[OrchestratorName],
			src.[OrchestratorType],
			src.[IsFrameworkOrchestrator],
			src.[Description],
			src.[ResourceGroupName],
			src.[SubscriptionId]
			)
	WHEN NOT MATCHED BY SOURCE THEN
		DELETE;
END;]]></Value>
			</Property>
			<Property Name="IsAnsiNullsOn" Value="True" />
			<Relationship Name="BodyDependencies">
				<Entry>
					<References Name="[metadataHelpers].[SetDefaultOrchestrators].[@Orchestrators].[OrchestratorName]" />
				</Entry>
				<Entry>
					<References Name="[metadataHelpers].[SetDefaultOrchestrators].[@Orchestrators].[OrchestratorType]" />
				</Entry>
				<Entry>
					<References Name="[metadataHelpers].[SetDefaultOrchestrators].[@Orchestrators].[IsFrameworkOrchestrator]" />
				</Entry>
				<Entry>
					<References Name="[metadataHelpers].[SetDefaultOrchestrators].[@Orchestrators].[Description]" />
				</Entry>
				<Entry>
					<References Name="[metadataHelpers].[SetDefaultOrchestrators].[@Orchestrators].[ResourceGroupName]" />
				</Entry>
				<Entry>
					<References Name="[metadataHelpers].[SetDefaultOrchestrators].[@Orchestrators].[SubscriptionId]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[Orchestrators]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[Orchestrators].[OrchestratorName]" />
				</Entry>
				<Entry>
					<References Name="[metadataHelpers].[SetDefaultOrchestrators].[@Orchestrators].[OrchestratorName]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[Orchestrators].[OrchestratorType]" />
				</Entry>
				<Entry>
					<References Name="[metadataHelpers].[SetDefaultOrchestrators].[@Orchestrators].[OrchestratorType]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[Orchestrators].[IsFrameworkOrchestrator]" />
				</Entry>
				<Entry>
					<References Name="[metadataHelpers].[SetDefaultOrchestrators].[@Orchestrators].[IsFrameworkOrchestrator]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[Orchestrators].[Description]" />
				</Entry>
				<Entry>
					<References Name="[metadataHelpers].[SetDefaultOrchestrators].[@Orchestrators].[Description]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[Orchestrators].[ResourceGroupName]" />
				</Entry>
				<Entry>
					<References Name="[metadataHelpers].[SetDefaultOrchestrators].[@Orchestrators].[ResourceGroupName]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[Orchestrators].[SubscriptionId]" />
				</Entry>
				<Entry>
					<References Name="[metadataHelpers].[SetDefaultOrchestrators].[@Orchestrators].[SubscriptionId]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[Orchestrators].[OrchestratorName]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[Orchestrators].[OrchestratorType]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[Orchestrators].[IsFrameworkOrchestrator]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[Orchestrators].[Description]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[Orchestrators].[ResourceGroupName]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[Orchestrators].[SubscriptionId]" />
				</Entry>
				<Entry>
					<References Name="[metadataHelpers].[SetDefaultOrchestrators].[@Orchestrators].[OrchestratorName]" />
				</Entry>
				<Entry>
					<References Name="[metadataHelpers].[SetDefaultOrchestrators].[@Orchestrators].[OrchestratorType]" />
				</Entry>
				<Entry>
					<References Name="[metadataHelpers].[SetDefaultOrchestrators].[@Orchestrators].[IsFrameworkOrchestrator]" />
				</Entry>
				<Entry>
					<References Name="[metadataHelpers].[SetDefaultOrchestrators].[@Orchestrators].[Description]" />
				</Entry>
				<Entry>
					<References Name="[metadataHelpers].[SetDefaultOrchestrators].[@Orchestrators].[ResourceGroupName]" />
				</Entry>
				<Entry>
					<References Name="[metadataHelpers].[SetDefaultOrchestrators].[@Orchestrators].[SubscriptionId]" />
				</Entry>
			</Relationship>
			<Relationship Name="DynamicObjects">
				<Entry>
					<Element Type="SqlDynamicColumnSource" Name="[metadataHelpers].[SetDefaultOrchestrators].[@Orchestrators]">
						<Relationship Name="Columns">
							<Entry>
								<Element Type="SqlSimpleColumn" Name="[metadataHelpers].[SetDefaultOrchestrators].[@Orchestrators].[OrchestratorName]">
									<Property Name="IsNullable" Value="False" />
									<Relationship Name="TypeSpecifier">
										<Entry>
											<Element Type="SqlTypeSpecifier">
												<Property Name="Length" Value="200" />
												<Relationship Name="Type">
													<Entry>
														<References ExternalSource="BuiltIns" Name="[nvarchar]" />
													</Entry>
												</Relationship>
											</Element>
										</Entry>
									</Relationship>
								</Element>
							</Entry>
							<Entry>
								<Element Type="SqlSimpleColumn" Name="[metadataHelpers].[SetDefaultOrchestrators].[@Orchestrators].[OrchestratorType]">
									<Property Name="IsNullable" Value="False" />
									<Relationship Name="TypeSpecifier">
										<Entry>
											<Element Type="SqlTypeSpecifier">
												<Property Name="Length" Value="3" />
												<Relationship Name="Type">
													<Entry>
														<References ExternalSource="BuiltIns" Name="[char]" />
													</Entry>
												</Relationship>
											</Element>
										</Entry>
									</Relationship>
								</Element>
							</Entry>
							<Entry>
								<Element Type="SqlSimpleColumn" Name="[metadataHelpers].[SetDefaultOrchestrators].[@Orchestrators].[IsFrameworkOrchestrator]">
									<Property Name="IsNullable" Value="False" />
									<Relationship Name="TypeSpecifier">
										<Entry>
											<Element Type="SqlTypeSpecifier">
												<Relationship Name="Type">
													<Entry>
														<References ExternalSource="BuiltIns" Name="[bit]" />
													</Entry>
												</Relationship>
											</Element>
										</Entry>
									</Relationship>
								</Element>
							</Entry>
							<Entry>
								<Element Type="SqlSimpleColumn" Name="[metadataHelpers].[SetDefaultOrchestrators].[@Orchestrators].[ResourceGroupName]">
									<Property Name="IsNullable" Value="False" />
									<Relationship Name="TypeSpecifier">
										<Entry>
											<Element Type="SqlTypeSpecifier">
												<Property Name="Length" Value="200" />
												<Relationship Name="Type">
													<Entry>
														<References ExternalSource="BuiltIns" Name="[nvarchar]" />
													</Entry>
												</Relationship>
											</Element>
										</Entry>
									</Relationship>
								</Element>
							</Entry>
							<Entry>
								<Element Type="SqlSimpleColumn" Name="[metadataHelpers].[SetDefaultOrchestrators].[@Orchestrators].[SubscriptionId]">
									<Property Name="IsNullable" Value="False" />
									<Relationship Name="TypeSpecifier">
										<Entry>
											<Element Type="SqlTypeSpecifier">
												<Relationship Name="Type">
													<Entry>
														<References ExternalSource="BuiltIns" Name="[uniqueidentifier]" />
													</Entry>
												</Relationship>
											</Element>
										</Entry>
									</Relationship>
								</Element>
							</Entry>
							<Entry>
								<Element Type="SqlSimpleColumn" Name="[metadataHelpers].[SetDefaultOrchestrators].[@Orchestrators].[Description]">
									<Relationship Name="TypeSpecifier">
										<Entry>
											<Element Type="SqlTypeSpecifier">
												<Property Name="IsMax" Value="True" />
												<Relationship Name="Type">
													<Entry>
														<References ExternalSource="BuiltIns" Name="[nvarchar]" />
													</Entry>
												</Relationship>
											</Element>
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
			</Relationship>
			<Relationship Name="Schema">
				<Entry>
					<References Name="[metadataHelpers]" />
				</Entry>
			</Relationship>
			<Annotation Type="SysCommentsObjectAnnotation">
				<Property Name="Length" Value="2175" />
				<Property Name="StartLine" Value="1" />
				<Property Name="StartColumn" Value="1" />
				<Property Name="HeaderContents" Value="CREATE PROCEDURE [metadataHelpers].[SetDefaultOrchestrators]&#xD;&#xA;AS" />
			</Annotation>
		</Element>
		<Element Type="SqlProcedure" Name="[metadataHelpers].[SetDefaultPipelineDependants]">
			<Property Name="BodyScript">
				<Value><![CDATA[
BEGIN
	EXEC [metadataHelpers].[AddPipelineDependant]
		@PipelineName = 'task_proj1_api_landing',
		@DependantPipelineName = 'task_proj1_api_malformed';

	EXEC [metadataHelpers].[AddPipelineDependant]
		@PipelineName = 'task_proj1_api_malformed',
		@DependantPipelineName = 'task_proj1_api_interim';

	EXEC [metadataHelpers].[AddPipelineDependant]
		@PipelineName = 'task_proj1_api_interim',
		@DependantPipelineName = 'task_proj1_api_edw';

	EXEC [metadataHelpers].[AddPipelineDependant]
		@PipelineName = 'task_proj1_api_edw',
		@DependantPipelineName = 'task_proj1_api_dm';

	EXEC [metadataHelpers].[AddPipelineDependant]
		@PipelineName = 'task_proj1_api_edw',
		@DependantPipelineName = 'task_proj1_api_dm2';
END;]]></Value>
			</Property>
			<Property Name="IsAnsiNullsOn" Value="True" />
			<Relationship Name="BodyDependencies">
				<Entry>
					<References Name="[metadataHelpers].[AddPipelineDependant]" />
				</Entry>
				<Entry>
					<References Name="[metadataHelpers].[AddPipelineDependant].[@PipelineName]" />
				</Entry>
				<Entry>
					<References Name="[metadataHelpers].[AddPipelineDependant].[@DependantPipelineName]" />
				</Entry>
			</Relationship>
			<Relationship Name="Schema">
				<Entry>
					<References Name="[metadataHelpers]" />
				</Entry>
			</Relationship>
			<Annotation Type="SysCommentsObjectAnnotation">
				<Property Name="Length" Value="808" />
				<Property Name="StartLine" Value="1" />
				<Property Name="StartColumn" Value="1" />
				<Property Name="HeaderContents" Value="CREATE PROCEDURE [metadataHelpers].[SetDefaultPipelineDependants]&#xD;&#xA;AS" />
			</Annotation>
		</Element>
		<Element Type="SqlProcedure" Name="[metadataHelpers].[SetDefaultPipelineParameters]">
			<Property Name="BodyScript">
				<Value><![CDATA[
BEGIN
	DECLARE @PipelineParameters TABLE
		(
		[PipelineId] [INT] NOT NULL,
		[ParameterName] [VARCHAR](128) NOT NULL,
		[ParameterValue] [NVARCHAR](MAX) NULL
		)

	INSERT @PipelineParameters
		(
		[PipelineId], 
		[ParameterName], 
		[ParameterValue]
		) 
	VALUES 
		(1, 'WaitTime', '3'),
		(2, 'WaitTime', '6'),
		(3, 'WaitTime', '9'),
		(4, 'WaitTime', '5'),
		(5, 'WaitTime', '2'),
		(6, 'WaitTime', '2');

	MERGE INTO [metadata].[PipelineParameters]  AS tgt
	USING 
		@PipelineParameters AS src
			ON tgt.[PipelineId] = src.[PipelineId]
				AND tgt.[ParameterName] = src.[ParameterName]
	WHEN MATCHED THEN
		UPDATE
		SET
			tgt.[ParameterValue] = src.[ParameterValue]
	WHEN NOT MATCHED BY TARGET THEN
		INSERT
			(
			[PipelineId], 
			[ParameterName], 
			[ParameterValue]
			) 
		VALUES
			(
			src.[PipelineId], 
			src.[ParameterName], 
			src.[ParameterValue]
			) 
	WHEN NOT MATCHED BY SOURCE THEN
		DELETE;	
END;]]></Value>
			</Property>
			<Property Name="IsAnsiNullsOn" Value="True" />
			<Relationship Name="BodyDependencies">
				<Entry>
					<References Name="[metadataHelpers].[SetDefaultPipelineParameters].[@PipelineParameters].[PipelineId]" />
				</Entry>
				<Entry>
					<References Name="[metadataHelpers].[SetDefaultPipelineParameters].[@PipelineParameters].[ParameterName]" />
				</Entry>
				<Entry>
					<References Name="[metadataHelpers].[SetDefaultPipelineParameters].[@PipelineParameters].[ParameterValue]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[PipelineParameters]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[PipelineParameters].[PipelineId]" />
				</Entry>
				<Entry>
					<References Name="[metadataHelpers].[SetDefaultPipelineParameters].[@PipelineParameters].[PipelineId]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[PipelineParameters].[ParameterName]" />
				</Entry>
				<Entry>
					<References Name="[metadataHelpers].[SetDefaultPipelineParameters].[@PipelineParameters].[ParameterName]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[PipelineParameters].[ParameterValue]" />
				</Entry>
				<Entry>
					<References Name="[metadataHelpers].[SetDefaultPipelineParameters].[@PipelineParameters].[ParameterValue]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[PipelineParameters].[PipelineId]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[PipelineParameters].[ParameterName]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[PipelineParameters].[ParameterValue]" />
				</Entry>
				<Entry>
					<References Name="[metadataHelpers].[SetDefaultPipelineParameters].[@PipelineParameters].[PipelineId]" />
				</Entry>
				<Entry>
					<References Name="[metadataHelpers].[SetDefaultPipelineParameters].[@PipelineParameters].[ParameterName]" />
				</Entry>
				<Entry>
					<References Name="[metadataHelpers].[SetDefaultPipelineParameters].[@PipelineParameters].[ParameterValue]" />
				</Entry>
			</Relationship>
			<Relationship Name="DynamicObjects">
				<Entry>
					<Element Type="SqlDynamicColumnSource" Name="[metadataHelpers].[SetDefaultPipelineParameters].[@PipelineParameters]">
						<Relationship Name="Columns">
							<Entry>
								<Element Type="SqlSimpleColumn" Name="[metadataHelpers].[SetDefaultPipelineParameters].[@PipelineParameters].[PipelineId]">
									<Property Name="IsNullable" Value="False" />
									<Relationship Name="TypeSpecifier">
										<Entry>
											<Element Type="SqlTypeSpecifier">
												<Relationship Name="Type">
													<Entry>
														<References ExternalSource="BuiltIns" Name="[int]" />
													</Entry>
												</Relationship>
											</Element>
										</Entry>
									</Relationship>
								</Element>
							</Entry>
							<Entry>
								<Element Type="SqlSimpleColumn" Name="[metadataHelpers].[SetDefaultPipelineParameters].[@PipelineParameters].[ParameterName]">
									<Property Name="IsNullable" Value="False" />
									<Relationship Name="TypeSpecifier">
										<Entry>
											<Element Type="SqlTypeSpecifier">
												<Property Name="Length" Value="128" />
												<Relationship Name="Type">
													<Entry>
														<References ExternalSource="BuiltIns" Name="[varchar]" />
													</Entry>
												</Relationship>
											</Element>
										</Entry>
									</Relationship>
								</Element>
							</Entry>
							<Entry>
								<Element Type="SqlSimpleColumn" Name="[metadataHelpers].[SetDefaultPipelineParameters].[@PipelineParameters].[ParameterValue]">
									<Relationship Name="TypeSpecifier">
										<Entry>
											<Element Type="SqlTypeSpecifier">
												<Property Name="IsMax" Value="True" />
												<Relationship Name="Type">
													<Entry>
														<References ExternalSource="BuiltIns" Name="[nvarchar]" />
													</Entry>
												</Relationship>
											</Element>
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
			</Relationship>
			<Relationship Name="Schema">
				<Entry>
					<References Name="[metadataHelpers]" />
				</Entry>
			</Relationship>
			<Annotation Type="SysCommentsObjectAnnotation">
				<Property Name="Length" Value="1041" />
				<Property Name="StartLine" Value="1" />
				<Property Name="StartColumn" Value="1" />
				<Property Name="HeaderContents" Value="CREATE PROCEDURE [metadataHelpers].[SetDefaultPipelineParameters]&#xD;&#xA;AS" />
			</Annotation>
		</Element>
		<Element Type="SqlProcedure" Name="[metadataHelpers].[SetDefaultPipelines]">
			<Property Name="BodyScript">
				<Value><![CDATA[
BEGIN
	DECLARE @Pipelines TABLE
		(
		[OrchestratorId] [INT] NOT NULL,
		[StageId] [INT] NOT NULL,
		[PipelineName] [NVARCHAR](200) NOT NULL,
		[LogicalPredecessorId] [INT] NULL,
		[Enabled] [BIT] NOT NULL
		)

	INSERT @Pipelines
		(
		[OrchestratorId],
		[StageId],
		[PipelineName],
		[LogicalPredecessorId],
		[Enabled]
		)
	VALUES
		-- task_<project>_<datasource>_<layer/stage>
		(1, 1	, 'task_proj1_api_landing'    , NULL		, 1),
		(1, 2	, 'task_proj1_api_malformed'  , NULL		, 1),
		(1, 3	, 'task_proj1_api_interim'	  , NULL		, 1),
		(1, 4	, 'task_proj1_api_edw'		  , NULL		, 1),
		--synapse/azure sql database to serve dashboard
		(1, 5	, 'task_proj1_api_dm'		  , NULL		, 1),
		(1, 5	, 'task_proj1_api_dm2'		  , NULL		, 1),
		--speed
		(1, 6	, 'task_proj1_api_speed'	  , NULL		, 0);

	MERGE INTO [metadata].[Pipelines] AS tgt
	USING 
		@Pipelines AS src
			ON tgt.[OrchestratorId] = src.[OrchestratorId]
		AND tgt.[PipelineName] = src.[PipelineName]
		AND tgt.[StageId] = src.[StageId]
	WHEN MATCHED THEN
		UPDATE
		SET
			tgt.[LogicalPredecessorId] = src.[LogicalPredecessorId],
			tgt.[Enabled] = src.[Enabled]
	WHEN NOT MATCHED BY TARGET THEN
		INSERT
			(
			[OrchestratorId],
			[StageId],
			[PipelineName], 
			[LogicalPredecessorId],
			[Enabled]
			)
		VALUES
			(
			src.[OrchestratorId],
			src.[StageId],
			src.[PipelineName], 
			src.[LogicalPredecessorId],
			src.[Enabled]
			)
	WHEN NOT MATCHED BY SOURCE THEN
		DELETE;
END;]]></Value>
			</Property>
			<Property Name="IsAnsiNullsOn" Value="True" />
			<Relationship Name="BodyDependencies">
				<Entry>
					<References Name="[metadataHelpers].[SetDefaultPipelines].[@Pipelines].[OrchestratorId]" />
				</Entry>
				<Entry>
					<References Name="[metadataHelpers].[SetDefaultPipelines].[@Pipelines].[StageId]" />
				</Entry>
				<Entry>
					<References Name="[metadataHelpers].[SetDefaultPipelines].[@Pipelines].[PipelineName]" />
				</Entry>
				<Entry>
					<References Name="[metadataHelpers].[SetDefaultPipelines].[@Pipelines].[LogicalPredecessorId]" />
				</Entry>
				<Entry>
					<References Name="[metadataHelpers].[SetDefaultPipelines].[@Pipelines].[Enabled]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[Pipelines]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[Pipelines].[OrchestratorId]" />
				</Entry>
				<Entry>
					<References Name="[metadataHelpers].[SetDefaultPipelines].[@Pipelines].[OrchestratorId]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[Pipelines].[PipelineName]" />
				</Entry>
				<Entry>
					<References Name="[metadataHelpers].[SetDefaultPipelines].[@Pipelines].[PipelineName]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[Pipelines].[StageId]" />
				</Entry>
				<Entry>
					<References Name="[metadataHelpers].[SetDefaultPipelines].[@Pipelines].[StageId]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[Pipelines].[LogicalPredecessorId]" />
				</Entry>
				<Entry>
					<References Name="[metadataHelpers].[SetDefaultPipelines].[@Pipelines].[LogicalPredecessorId]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[Pipelines].[Enabled]" />
				</Entry>
				<Entry>
					<References Name="[metadataHelpers].[SetDefaultPipelines].[@Pipelines].[Enabled]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[Pipelines].[OrchestratorId]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[Pipelines].[StageId]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[Pipelines].[PipelineName]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[Pipelines].[LogicalPredecessorId]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[Pipelines].[Enabled]" />
				</Entry>
				<Entry>
					<References Name="[metadataHelpers].[SetDefaultPipelines].[@Pipelines].[OrchestratorId]" />
				</Entry>
				<Entry>
					<References Name="[metadataHelpers].[SetDefaultPipelines].[@Pipelines].[StageId]" />
				</Entry>
				<Entry>
					<References Name="[metadataHelpers].[SetDefaultPipelines].[@Pipelines].[PipelineName]" />
				</Entry>
				<Entry>
					<References Name="[metadataHelpers].[SetDefaultPipelines].[@Pipelines].[LogicalPredecessorId]" />
				</Entry>
				<Entry>
					<References Name="[metadataHelpers].[SetDefaultPipelines].[@Pipelines].[Enabled]" />
				</Entry>
			</Relationship>
			<Relationship Name="DynamicObjects">
				<Entry>
					<Element Type="SqlDynamicColumnSource" Name="[metadataHelpers].[SetDefaultPipelines].[@Pipelines]">
						<Relationship Name="Columns">
							<Entry>
								<Element Type="SqlSimpleColumn" Name="[metadataHelpers].[SetDefaultPipelines].[@Pipelines].[OrchestratorId]">
									<Property Name="IsNullable" Value="False" />
									<Relationship Name="TypeSpecifier">
										<Entry>
											<Element Type="SqlTypeSpecifier">
												<Relationship Name="Type">
													<Entry>
														<References ExternalSource="BuiltIns" Name="[int]" />
													</Entry>
												</Relationship>
											</Element>
										</Entry>
									</Relationship>
								</Element>
							</Entry>
							<Entry>
								<Element Type="SqlSimpleColumn" Name="[metadataHelpers].[SetDefaultPipelines].[@Pipelines].[StageId]">
									<Property Name="IsNullable" Value="False" />
									<Relationship Name="TypeSpecifier">
										<Entry>
											<Element Type="SqlTypeSpecifier">
												<Relationship Name="Type">
													<Entry>
														<References ExternalSource="BuiltIns" Name="[int]" />
													</Entry>
												</Relationship>
											</Element>
										</Entry>
									</Relationship>
								</Element>
							</Entry>
							<Entry>
								<Element Type="SqlSimpleColumn" Name="[metadataHelpers].[SetDefaultPipelines].[@Pipelines].[PipelineName]">
									<Property Name="IsNullable" Value="False" />
									<Relationship Name="TypeSpecifier">
										<Entry>
											<Element Type="SqlTypeSpecifier">
												<Property Name="Length" Value="200" />
												<Relationship Name="Type">
													<Entry>
														<References ExternalSource="BuiltIns" Name="[nvarchar]" />
													</Entry>
												</Relationship>
											</Element>
										</Entry>
									</Relationship>
								</Element>
							</Entry>
							<Entry>
								<Element Type="SqlSimpleColumn" Name="[metadataHelpers].[SetDefaultPipelines].[@Pipelines].[LogicalPredecessorId]">
									<Relationship Name="TypeSpecifier">
										<Entry>
											<Element Type="SqlTypeSpecifier">
												<Relationship Name="Type">
													<Entry>
														<References ExternalSource="BuiltIns" Name="[int]" />
													</Entry>
												</Relationship>
											</Element>
										</Entry>
									</Relationship>
								</Element>
							</Entry>
							<Entry>
								<Element Type="SqlSimpleColumn" Name="[metadataHelpers].[SetDefaultPipelines].[@Pipelines].[Enabled]">
									<Property Name="IsNullable" Value="False" />
									<Relationship Name="TypeSpecifier">
										<Entry>
											<Element Type="SqlTypeSpecifier">
												<Relationship Name="Type">
													<Entry>
														<References ExternalSource="BuiltIns" Name="[bit]" />
													</Entry>
												</Relationship>
											</Element>
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
			</Relationship>
			<Relationship Name="Schema">
				<Entry>
					<References Name="[metadataHelpers]" />
				</Entry>
			</Relationship>
			<Annotation Type="SysCommentsObjectAnnotation">
				<Property Name="Length" Value="1569" />
				<Property Name="StartLine" Value="1" />
				<Property Name="StartColumn" Value="1" />
				<Property Name="HeaderContents" Value="CREATE PROCEDURE [metadataHelpers].[SetDefaultPipelines]&#xD;&#xA;AS" />
			</Annotation>
		</Element>
		<Element Type="SqlProcedure" Name="[metadataHelpers].[SetDefaultProperties]">
			<Property Name="BodyScript">
				<Value><![CDATA[
BEGIN
	EXEC [metadataHelpers].[AddProperty]
		@PropertyName = N'OverideRestart',
		@PropertyValue = N'0',
		@Description = N'Should processing not be restarted from the point of failure or should a new execution will be created regardless. 1 = Start New, 0 = Restart. ';

	EXEC [metadataHelpers].[AddProperty]
		@PropertyName = N'PipelineStatusCheckDuration',
		@PropertyValue = N'30',
		@Description = N'Duration applied to the Wait activity within the Infant pipeline Until iterations.';

	EXEC [metadataHelpers].[AddProperty]
		@PropertyName = N'UnknownWorkerResultBlocks',
		@PropertyValue = N'1',
		@Description = N'If a worker pipeline returns an unknown status. Should this block and fail downstream pipeline? 1 = Yes, 0 = No.';

	EXEC [metadataHelpers].[AddProperty]
		@PropertyName = N'CancelledWorkerResultBlocks',
		@PropertyValue = N'1',
		@Description = N'If a worker pipeline returns an cancelled status. Should this block and fail downstream pipeline? 1 = Yes, 0 = No.';

	EXEC [metadataHelpers].[AddProperty]
		@PropertyName = N'UseFrameworkEmailAlerting',
		@PropertyValue = N'0',
		@Description = N'Do you want the framework to handle pipeline email alerts via the database metadata? 1 = Yes, 0 = No.';

	EXEC [metadataHelpers].[AddProperty]
		@PropertyName = N'EmailAlertBodyTemplate',
		@PropertyValue = 
		N'<hr/><strong>Pipeline Name: </strong>##PipelineName###<br/>
	<strong>Status: </strong>##Status###<br/><br/>
	<strong>Execution ID: </strong>##ExecId###<br/>
	<strong>Run ID: </strong>##RunId###<br/><br/>
	<strong>Start Date Time: </strong>##StartDateTime###<br/>
	<strong>End Date Time: </strong>##EndDateTime###<br/>
	<strong>Duration (Minutes): </strong>##Duration###<br/><br/>
	<strong>Called by Orchestrator: </strong>##CalledByOrc###<br/>
	<strong>Executed by Orchestrator Type: </strong>##ExecutedByOrcType###<br/>
	<strong>Executed by Orchestrator: </strong>##ExecutedByOrc###<br/><hr/>',
		@Description = N'Basic HTML template of execution information used as the eventual body in email alerts sent.';

	EXEC [metadataHelpers].[AddProperty]
		@PropertyName = N'FailureHandling',
		@PropertyValue = N'DependencyChain',
		@Description = N'Accepted values: None, Simple, DependencyChain. Controls processing bahaviour in the event of Worker failures. See v1.8 release notes for full details.';

	EXEC [metadataHelpers].[AddProperty]
		@PropertyName = N'SPNHandlingMethod',
		@PropertyValue = N'StoreInKeyVault',
		@Description = N'Accepted values: StoreInDatabase, StoreInKeyVault. See v1.8.2 release notes for full details.';

	EXEC [metadataHelpers].[AddProperty]
		@PropertyName = N'ExecutionPrecursorProc',
		@PropertyValue = N'[dbo].[ExampleCustomExecutionPrecursor]',
		@Description = N'This procedure will be called first in the parent pipeline and can be used to perform/update any required custom behaviour in the framework execution. For example, enable/disable Worker pipelines given a certain run time/day. Invalid proc name values will be ignored.'

	EXEC [metadataHelpers].[AddProperty]
		@PropertyName = N'UseExecutionBatches',
		@PropertyValue = N'1',
		@Description = N'Establishes if execution batches are used as a level above execution stages within the framework. 1 = True, 0 = False.';

	EXEC [metadataHelpers].[AddProperty]
		@PropertyName = N'FrameworkFactoryResourceGroup',
		@PropertyValue = N'adf.framework',
		@Description = N'Supports various queries where the framework factory is inspecting itself and the resource group cant be inferred.';

	EXEC [metadataHelpers].[AddProperty]
		@PropertyName = N'PreviousPipelineRunsQueryRange',
		@PropertyValue = N'-1',
		@Description = N'Used as a date range, today +- this value, when checking for if an execution for a given pipeline is already running. Must include +- symbol in value.';
END;]]></Value>
			</Property>
			<Property Name="IsAnsiNullsOn" Value="True" />
			<Relationship Name="BodyDependencies">
				<Entry>
					<References Name="[metadataHelpers].[AddProperty]" />
				</Entry>
				<Entry>
					<References Name="[metadataHelpers].[AddProperty].[@PropertyName]" />
				</Entry>
				<Entry>
					<References Name="[metadataHelpers].[AddProperty].[@PropertyValue]" />
				</Entry>
				<Entry>
					<References Name="[metadataHelpers].[AddProperty].[@Description]" />
				</Entry>
			</Relationship>
			<Relationship Name="Schema">
				<Entry>
					<References Name="[metadataHelpers]" />
				</Entry>
			</Relationship>
			<Annotation Type="SysCommentsObjectAnnotation">
				<Property Name="Length" Value="3933" />
				<Property Name="StartLine" Value="1" />
				<Property Name="StartColumn" Value="1" />
				<Property Name="HeaderContents" Value="CREATE PROCEDURE [metadataHelpers].[SetDefaultProperties]&#xD;&#xA;AS" />
			</Annotation>
		</Element>
		<Element Type="SqlProcedure" Name="[metadataHelpers].[SetDefaultRecipientPipelineAlerts]">
			<Property Name="BodyScript">
				<Value><![CDATA[
BEGIN
	EXEC [metadataHelpers].[AddRecipientPipelineAlerts]
		@RecipientName = N'Jacky Yang',
		@AlertForStatus = 'All';

	-- EXEC [metadataHelpers].[AddRecipientPipelineAlerts]
	-- 	@RecipientName = N'Test User 2',
	-- 	@PipelineName = 'Intentional Error',
	-- 	@AlertForStatus = 'Failed';

	-- EXEC [metadataHelpers].[AddRecipientPipelineAlerts]
	-- 	@RecipientName = N'Test User 3',
	-- 	@PipelineName = 'Wait 1',
	-- 	@AlertForStatus = 'Success, Failed, Cancelled';	
END;]]></Value>
			</Property>
			<Property Name="IsAnsiNullsOn" Value="True" />
			<Relationship Name="BodyDependencies">
				<Entry>
					<References Name="[metadataHelpers].[AddRecipientPipelineAlerts]" />
				</Entry>
				<Entry>
					<References Name="[metadataHelpers].[AddRecipientPipelineAlerts].[@RecipientName]" />
				</Entry>
				<Entry>
					<References Name="[metadataHelpers].[AddRecipientPipelineAlerts].[@AlertForStatus]" />
				</Entry>
			</Relationship>
			<Relationship Name="Schema">
				<Entry>
					<References Name="[metadataHelpers]" />
				</Entry>
			</Relationship>
			<Annotation Type="SysCommentsObjectAnnotation">
				<Property Name="Length" Value="564" />
				<Property Name="StartLine" Value="1" />
				<Property Name="StartColumn" Value="1" />
				<Property Name="HeaderContents" Value="CREATE PROCEDURE [metadataHelpers].[SetDefaultRecipientPipelineAlerts]&#xD;&#xA;AS" />
			</Annotation>
		</Element>
		<Element Type="SqlProcedure" Name="[metadataHelpers].[SetDefaultRecipients]">
			<Property Name="BodyScript">
				<Value><![CDATA[
BEGIN
	DECLARE @Recipients TABLE
		(
		[Name] [VARCHAR](255) NULL,
		[EmailAddress] [NVARCHAR](500) NOT NULL,
		[MessagePreference] [CHAR](3) NOT NULL,
		[Enabled] [BIT] NOT NULL
		)

	INSERT INTO @Recipients
		(
		[Name],
		[EmailAddress],
		[MessagePreference],--TO/CC/BCC
		[Enabled]
		)
	VALUES
		('Jacky Yang','sixgod2019@outlook.com', 'TO', 1);

	MERGE INTO [metadata].[Recipients] AS tgt
	USING 
		@Recipients AS src
			ON tgt.[Name] = src.[Name]
	WHEN MATCHED THEN
		UPDATE
		SET
			tgt.[EmailAddress] = src.[EmailAddress],
			tgt.[MessagePreference] = src.[MessagePreference],
			tgt.[Enabled] = src.[Enabled]
	WHEN NOT MATCHED BY TARGET THEN
		INSERT
			(
			[Name],
			[EmailAddress],
			[MessagePreference],
			[Enabled]
			)
		VALUES
			(
			src.[Name],
			src.[EmailAddress],
			src.[MessagePreference],
			src.[Enabled]
			)
	WHEN NOT MATCHED BY SOURCE THEN
		DELETE;	
END;]]></Value>
			</Property>
			<Property Name="IsAnsiNullsOn" Value="True" />
			<Relationship Name="BodyDependencies">
				<Entry>
					<References Name="[metadataHelpers].[SetDefaultRecipients].[@Recipients].[Name]" />
				</Entry>
				<Entry>
					<References Name="[metadataHelpers].[SetDefaultRecipients].[@Recipients].[EmailAddress]" />
				</Entry>
				<Entry>
					<References Name="[metadataHelpers].[SetDefaultRecipients].[@Recipients].[MessagePreference]" />
				</Entry>
				<Entry>
					<References Name="[metadataHelpers].[SetDefaultRecipients].[@Recipients].[Enabled]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[Recipients]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[Recipients].[Name]" />
				</Entry>
				<Entry>
					<References Name="[metadataHelpers].[SetDefaultRecipients].[@Recipients].[Name]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[Recipients].[EmailAddress]" />
				</Entry>
				<Entry>
					<References Name="[metadataHelpers].[SetDefaultRecipients].[@Recipients].[EmailAddress]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[Recipients].[MessagePreference]" />
				</Entry>
				<Entry>
					<References Name="[metadataHelpers].[SetDefaultRecipients].[@Recipients].[MessagePreference]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[Recipients].[Enabled]" />
				</Entry>
				<Entry>
					<References Name="[metadataHelpers].[SetDefaultRecipients].[@Recipients].[Enabled]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[Recipients].[Name]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[Recipients].[EmailAddress]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[Recipients].[MessagePreference]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[Recipients].[Enabled]" />
				</Entry>
				<Entry>
					<References Name="[metadataHelpers].[SetDefaultRecipients].[@Recipients].[Name]" />
				</Entry>
				<Entry>
					<References Name="[metadataHelpers].[SetDefaultRecipients].[@Recipients].[EmailAddress]" />
				</Entry>
				<Entry>
					<References Name="[metadataHelpers].[SetDefaultRecipients].[@Recipients].[MessagePreference]" />
				</Entry>
				<Entry>
					<References Name="[metadataHelpers].[SetDefaultRecipients].[@Recipients].[Enabled]" />
				</Entry>
			</Relationship>
			<Relationship Name="DynamicObjects">
				<Entry>
					<Element Type="SqlDynamicColumnSource" Name="[metadataHelpers].[SetDefaultRecipients].[@Recipients]">
						<Relationship Name="Columns">
							<Entry>
								<Element Type="SqlSimpleColumn" Name="[metadataHelpers].[SetDefaultRecipients].[@Recipients].[Name]">
									<Relationship Name="TypeSpecifier">
										<Entry>
											<Element Type="SqlTypeSpecifier">
												<Property Name="Length" Value="255" />
												<Relationship Name="Type">
													<Entry>
														<References ExternalSource="BuiltIns" Name="[varchar]" />
													</Entry>
												</Relationship>
											</Element>
										</Entry>
									</Relationship>
								</Element>
							</Entry>
							<Entry>
								<Element Type="SqlSimpleColumn" Name="[metadataHelpers].[SetDefaultRecipients].[@Recipients].[EmailAddress]">
									<Property Name="IsNullable" Value="False" />
									<Relationship Name="TypeSpecifier">
										<Entry>
											<Element Type="SqlTypeSpecifier">
												<Property Name="Length" Value="500" />
												<Relationship Name="Type">
													<Entry>
														<References ExternalSource="BuiltIns" Name="[nvarchar]" />
													</Entry>
												</Relationship>
											</Element>
										</Entry>
									</Relationship>
								</Element>
							</Entry>
							<Entry>
								<Element Type="SqlSimpleColumn" Name="[metadataHelpers].[SetDefaultRecipients].[@Recipients].[MessagePreference]">
									<Property Name="IsNullable" Value="False" />
									<Relationship Name="TypeSpecifier">
										<Entry>
											<Element Type="SqlTypeSpecifier">
												<Property Name="Length" Value="3" />
												<Relationship Name="Type">
													<Entry>
														<References ExternalSource="BuiltIns" Name="[char]" />
													</Entry>
												</Relationship>
											</Element>
										</Entry>
									</Relationship>
								</Element>
							</Entry>
							<Entry>
								<Element Type="SqlSimpleColumn" Name="[metadataHelpers].[SetDefaultRecipients].[@Recipients].[Enabled]">
									<Property Name="IsNullable" Value="False" />
									<Relationship Name="TypeSpecifier">
										<Entry>
											<Element Type="SqlTypeSpecifier">
												<Relationship Name="Type">
													<Entry>
														<References ExternalSource="BuiltIns" Name="[bit]" />
													</Entry>
												</Relationship>
											</Element>
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
			</Relationship>
			<Relationship Name="Schema">
				<Entry>
					<References Name="[metadataHelpers]" />
				</Entry>
			</Relationship>
			<Annotation Type="SysCommentsObjectAnnotation">
				<Property Name="Length" Value="997" />
				<Property Name="StartLine" Value="1" />
				<Property Name="StartColumn" Value="1" />
				<Property Name="HeaderContents" Value="CREATE PROCEDURE [metadataHelpers].[SetDefaultRecipients]&#xD;&#xA;AS" />
			</Annotation>
		</Element>
		<Element Type="SqlProcedure" Name="[metadataHelpers].[SetDefaultStages]">
			<Property Name="BodyScript">
				<Value><![CDATA[
BEGIN
	DECLARE @Stages TABLE
		(
		[StageName] [VARCHAR](225) NOT NULL,
		[StageDescription] [VARCHAR](4000) NULL,
		[Enabled] [BIT] NOT NULL
		)
	
	INSERT @Stages
		(
		[StageName], 
		[StageDescription], 
		[Enabled]
		) 
	VALUES 
		('Landing', N'The Landing Zone is the initial storage area for raw and unprocessed data as it arrives from various sources. It serves as the first step in the data processing pipeline, often containing data in its original, sometimes unstructured, form.', 1),
		('Malformed', N'The Malformed Data Layer is a stage where data that doesn''t conform to expected formats or quality standards is temporarily stored. This layer is dedicated to identifying, handling, and potentially correcting data anomalies or errors before further processing.', 1),
		('Interim', N'The Interim Data Processing Layer is an intermediate stage where data from the landing and malformed layers undergoes necessary transformations and processing. It prepares the data for integration into the more structured layers of the data warehouse.', 1),
		('EDW', N'The Enterprise Data Warehouse (EDW) is the final repository for cleansed and integrated data. It provides a unified view of the data for analytical purposes, supporting business intelligence, reporting, and decision-making across the organization.', 1),
		('DM', N'Data Marts are subsets of the Enterprise Data Warehouse, focusing on specific business units or departments. They store and manage data tailored to the needs of individual teams, enabling more targeted and efficient analysis.', 1),
		('Speed', N'The "Speed Layer" typically refers to a layer within a data processing architecture that focuses on real-time or near-real-time data processing and analysis. The goal of this layer is to rapidly respond to data generated in real-time, enabling timely decision-making or providing real-time insights.', 1);

	MERGE INTO [metadata].[Stages] AS tgt
	USING 
		@Stages AS src
			ON tgt.[StageName] = src.[StageName]
	WHEN MATCHED THEN
		UPDATE
		SET
			tgt.[StageDescription] = src.[StageDescription],
			tgt.[Enabled] = src.[Enabled]
	WHEN NOT MATCHED BY TARGET THEN
		INSERT
			(
			[StageName],
			[StageDescription],
			[Enabled]
			)
		VALUES
			(
			src.[StageName],
			src.[StageDescription],
			src.[Enabled]
			)
	WHEN NOT MATCHED BY SOURCE THEN
		DELETE;	
END;]]></Value>
			</Property>
			<Property Name="IsAnsiNullsOn" Value="True" />
			<Relationship Name="BodyDependencies">
				<Entry>
					<References Name="[metadataHelpers].[SetDefaultStages].[@Stages].[StageName]" />
				</Entry>
				<Entry>
					<References Name="[metadataHelpers].[SetDefaultStages].[@Stages].[StageDescription]" />
				</Entry>
				<Entry>
					<References Name="[metadataHelpers].[SetDefaultStages].[@Stages].[Enabled]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[Stages]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[Stages].[StageName]" />
				</Entry>
				<Entry>
					<References Name="[metadataHelpers].[SetDefaultStages].[@Stages].[StageName]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[Stages].[StageDescription]" />
				</Entry>
				<Entry>
					<References Name="[metadataHelpers].[SetDefaultStages].[@Stages].[StageDescription]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[Stages].[Enabled]" />
				</Entry>
				<Entry>
					<References Name="[metadataHelpers].[SetDefaultStages].[@Stages].[Enabled]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[Stages].[StageName]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[Stages].[StageDescription]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[Stages].[Enabled]" />
				</Entry>
				<Entry>
					<References Name="[metadataHelpers].[SetDefaultStages].[@Stages].[StageName]" />
				</Entry>
				<Entry>
					<References Name="[metadataHelpers].[SetDefaultStages].[@Stages].[StageDescription]" />
				</Entry>
				<Entry>
					<References Name="[metadataHelpers].[SetDefaultStages].[@Stages].[Enabled]" />
				</Entry>
			</Relationship>
			<Relationship Name="DynamicObjects">
				<Entry>
					<Element Type="SqlDynamicColumnSource" Name="[metadataHelpers].[SetDefaultStages].[@Stages]">
						<Relationship Name="Columns">
							<Entry>
								<Element Type="SqlSimpleColumn" Name="[metadataHelpers].[SetDefaultStages].[@Stages].[StageName]">
									<Property Name="IsNullable" Value="False" />
									<Relationship Name="TypeSpecifier">
										<Entry>
											<Element Type="SqlTypeSpecifier">
												<Property Name="Length" Value="225" />
												<Relationship Name="Type">
													<Entry>
														<References ExternalSource="BuiltIns" Name="[varchar]" />
													</Entry>
												</Relationship>
											</Element>
										</Entry>
									</Relationship>
								</Element>
							</Entry>
							<Entry>
								<Element Type="SqlSimpleColumn" Name="[metadataHelpers].[SetDefaultStages].[@Stages].[StageDescription]">
									<Relationship Name="TypeSpecifier">
										<Entry>
											<Element Type="SqlTypeSpecifier">
												<Property Name="Length" Value="4000" />
												<Relationship Name="Type">
													<Entry>
														<References ExternalSource="BuiltIns" Name="[varchar]" />
													</Entry>
												</Relationship>
											</Element>
										</Entry>
									</Relationship>
								</Element>
							</Entry>
							<Entry>
								<Element Type="SqlSimpleColumn" Name="[metadataHelpers].[SetDefaultStages].[@Stages].[Enabled]">
									<Property Name="IsNullable" Value="False" />
									<Relationship Name="TypeSpecifier">
										<Entry>
											<Element Type="SqlTypeSpecifier">
												<Relationship Name="Type">
													<Entry>
														<References ExternalSource="BuiltIns" Name="[bit]" />
													</Entry>
												</Relationship>
											</Element>
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
			</Relationship>
			<Relationship Name="Schema">
				<Entry>
					<References Name="[metadataHelpers]" />
				</Entry>
			</Relationship>
			<Annotation Type="SysCommentsObjectAnnotation">
				<Property Name="Length" Value="2448" />
				<Property Name="StartLine" Value="1" />
				<Property Name="StartColumn" Value="1" />
				<Property Name="HeaderContents" Value="CREATE PROCEDURE [metadataHelpers].[SetDefaultStages]&#xD;&#xA;AS" />
			</Annotation>
		</Element>
		<Element Type="SqlProcedure" Name="[metadataHelpers].[SetDefaultSubscription]">
			<Property Name="BodyScript">
				<Value><![CDATA[
BEGIN
	DECLARE @Subscriptions TABLE
		(
		[SubscriptionId] UNIQUEIDENTIFIER NOT NULL,
		[Name] NVARCHAR(200) NOT NULL,
		[Description] NVARCHAR(MAX) NULL,
		[TenantId] UNIQUEIDENTIFIER NOT NULL
		)

	INSERT INTO @Subscriptions
		(
		[SubscriptionId],
		[Name],
		[Description],
		[TenantId]
		)
	VALUES
		('930d2a20-dc22-431d-bdde-4a2916d0096b', 'platform', 'Example value for development environment.', '57b4e176-eb21-4c5c-be50-56baf5076018');

	MERGE INTO [metadata].[Subscriptions] AS tgt
	USING 
		@Subscriptions AS src
			ON tgt.[SubscriptionId] = src.[SubscriptionId]
	WHEN MATCHED THEN
		UPDATE
		SET
			tgt.[Name] = src.[Name],
			tgt.[Description] = src.[Description],
			tgt.[TenantId] = src.[TenantId]
	WHEN NOT MATCHED BY TARGET THEN
		INSERT
			(
			[SubscriptionId],
			[Name],
			[Description],
			[TenantId]
			)
		VALUES
			(
			src.[SubscriptionId],
			src.[Name],
			src.[Description],
			src.[TenantId]
			)
	WHEN NOT MATCHED BY SOURCE THEN
		DELETE;
END;]]></Value>
			</Property>
			<Property Name="IsAnsiNullsOn" Value="True" />
			<Relationship Name="BodyDependencies">
				<Entry>
					<References Name="[metadataHelpers].[SetDefaultSubscription].[@Subscriptions].[SubscriptionId]" />
				</Entry>
				<Entry>
					<References Name="[metadataHelpers].[SetDefaultSubscription].[@Subscriptions].[Name]" />
				</Entry>
				<Entry>
					<References Name="[metadataHelpers].[SetDefaultSubscription].[@Subscriptions].[Description]" />
				</Entry>
				<Entry>
					<References Name="[metadataHelpers].[SetDefaultSubscription].[@Subscriptions].[TenantId]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[Subscriptions]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[Subscriptions].[SubscriptionId]" />
				</Entry>
				<Entry>
					<References Name="[metadataHelpers].[SetDefaultSubscription].[@Subscriptions].[SubscriptionId]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[Subscriptions].[Name]" />
				</Entry>
				<Entry>
					<References Name="[metadataHelpers].[SetDefaultSubscription].[@Subscriptions].[Name]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[Subscriptions].[Description]" />
				</Entry>
				<Entry>
					<References Name="[metadataHelpers].[SetDefaultSubscription].[@Subscriptions].[Description]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[Subscriptions].[TenantId]" />
				</Entry>
				<Entry>
					<References Name="[metadataHelpers].[SetDefaultSubscription].[@Subscriptions].[TenantId]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[Subscriptions].[SubscriptionId]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[Subscriptions].[Name]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[Subscriptions].[Description]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[Subscriptions].[TenantId]" />
				</Entry>
				<Entry>
					<References Name="[metadataHelpers].[SetDefaultSubscription].[@Subscriptions].[SubscriptionId]" />
				</Entry>
				<Entry>
					<References Name="[metadataHelpers].[SetDefaultSubscription].[@Subscriptions].[Name]" />
				</Entry>
				<Entry>
					<References Name="[metadataHelpers].[SetDefaultSubscription].[@Subscriptions].[Description]" />
				</Entry>
				<Entry>
					<References Name="[metadataHelpers].[SetDefaultSubscription].[@Subscriptions].[TenantId]" />
				</Entry>
			</Relationship>
			<Relationship Name="DynamicObjects">
				<Entry>
					<Element Type="SqlDynamicColumnSource" Name="[metadataHelpers].[SetDefaultSubscription].[@Subscriptions]">
						<Relationship Name="Columns">
							<Entry>
								<Element Type="SqlSimpleColumn" Name="[metadataHelpers].[SetDefaultSubscription].[@Subscriptions].[SubscriptionId]">
									<Property Name="IsNullable" Value="False" />
									<Relationship Name="TypeSpecifier">
										<Entry>
											<Element Type="SqlTypeSpecifier">
												<Relationship Name="Type">
													<Entry>
														<References ExternalSource="BuiltIns" Name="[uniqueidentifier]" />
													</Entry>
												</Relationship>
											</Element>
										</Entry>
									</Relationship>
								</Element>
							</Entry>
							<Entry>
								<Element Type="SqlSimpleColumn" Name="[metadataHelpers].[SetDefaultSubscription].[@Subscriptions].[Name]">
									<Property Name="IsNullable" Value="False" />
									<Relationship Name="TypeSpecifier">
										<Entry>
											<Element Type="SqlTypeSpecifier">
												<Property Name="Length" Value="200" />
												<Relationship Name="Type">
													<Entry>
														<References ExternalSource="BuiltIns" Name="[nvarchar]" />
													</Entry>
												</Relationship>
											</Element>
										</Entry>
									</Relationship>
								</Element>
							</Entry>
							<Entry>
								<Element Type="SqlSimpleColumn" Name="[metadataHelpers].[SetDefaultSubscription].[@Subscriptions].[Description]">
									<Relationship Name="TypeSpecifier">
										<Entry>
											<Element Type="SqlTypeSpecifier">
												<Property Name="IsMax" Value="True" />
												<Relationship Name="Type">
													<Entry>
														<References ExternalSource="BuiltIns" Name="[nvarchar]" />
													</Entry>
												</Relationship>
											</Element>
										</Entry>
									</Relationship>
								</Element>
							</Entry>
							<Entry>
								<Element Type="SqlSimpleColumn" Name="[metadataHelpers].[SetDefaultSubscription].[@Subscriptions].[TenantId]">
									<Property Name="IsNullable" Value="False" />
									<Relationship Name="TypeSpecifier">
										<Entry>
											<Element Type="SqlTypeSpecifier">
												<Relationship Name="Type">
													<Entry>
														<References ExternalSource="BuiltIns" Name="[uniqueidentifier]" />
													</Entry>
												</Relationship>
											</Element>
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
			</Relationship>
			<Relationship Name="Schema">
				<Entry>
					<References Name="[metadataHelpers]" />
				</Entry>
			</Relationship>
			<Annotation Type="SysCommentsObjectAnnotation">
				<Property Name="Length" Value="1086" />
				<Property Name="StartLine" Value="1" />
				<Property Name="StartColumn" Value="1" />
				<Property Name="HeaderContents" Value="CREATE PROCEDURE [metadataHelpers].[SetDefaultSubscription]&#xD;&#xA;AS" />
			</Annotation>
		</Element>
		<Element Type="SqlProcedure" Name="[metadataHelpers].[SetDefaultTenant]">
			<Property Name="BodyScript">
				<Value><![CDATA[
BEGIN
	DECLARE @Tenants TABLE
		(
		[TenantId] UNIQUEIDENTIFIER NOT NULL,
		[Name] NVARCHAR(200) NOT NULL,
		[Description] NVARCHAR(MAX) NULL
		)

	INSERT INTO @Tenants
		(
		[TenantId],
		[Name],
		[Description]
		)
	VALUES
		('57b4e176-eb21-4c5c-be50-56baf5076018', 'Default', 'Example value for development environment.');

	MERGE INTO [metadata].[Tenants] AS tgt
	USING 
		@Tenants AS src
			ON tgt.[TenantId] = src.[TenantId]
	WHEN MATCHED THEN
		UPDATE
		SET
			tgt.[Name] = src.[Name],
			tgt.[Description] = src.[Description]		
	WHEN NOT MATCHED BY TARGET THEN
		INSERT
			(
			[TenantId],
			[Name],
			[Description]
			)
		VALUES
			(
			src.[TenantId],
			src.[Name],
			src.[Description]
			)
	WHEN NOT MATCHED BY SOURCE THEN
		DELETE;
END;]]></Value>
			</Property>
			<Property Name="IsAnsiNullsOn" Value="True" />
			<Relationship Name="BodyDependencies">
				<Entry>
					<References Name="[metadataHelpers].[SetDefaultTenant].[@Tenants].[TenantId]" />
				</Entry>
				<Entry>
					<References Name="[metadataHelpers].[SetDefaultTenant].[@Tenants].[Name]" />
				</Entry>
				<Entry>
					<References Name="[metadataHelpers].[SetDefaultTenant].[@Tenants].[Description]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[Tenants]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[Tenants].[TenantId]" />
				</Entry>
				<Entry>
					<References Name="[metadataHelpers].[SetDefaultTenant].[@Tenants].[TenantId]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[Tenants].[Name]" />
				</Entry>
				<Entry>
					<References Name="[metadataHelpers].[SetDefaultTenant].[@Tenants].[Name]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[Tenants].[Description]" />
				</Entry>
				<Entry>
					<References Name="[metadataHelpers].[SetDefaultTenant].[@Tenants].[Description]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[Tenants].[TenantId]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[Tenants].[Name]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[Tenants].[Description]" />
				</Entry>
				<Entry>
					<References Name="[metadataHelpers].[SetDefaultTenant].[@Tenants].[TenantId]" />
				</Entry>
				<Entry>
					<References Name="[metadataHelpers].[SetDefaultTenant].[@Tenants].[Name]" />
				</Entry>
				<Entry>
					<References Name="[metadataHelpers].[SetDefaultTenant].[@Tenants].[Description]" />
				</Entry>
			</Relationship>
			<Relationship Name="DynamicObjects">
				<Entry>
					<Element Type="SqlDynamicColumnSource" Name="[metadataHelpers].[SetDefaultTenant].[@Tenants]">
						<Relationship Name="Columns">
							<Entry>
								<Element Type="SqlSimpleColumn" Name="[metadataHelpers].[SetDefaultTenant].[@Tenants].[TenantId]">
									<Property Name="IsNullable" Value="False" />
									<Relationship Name="TypeSpecifier">
										<Entry>
											<Element Type="SqlTypeSpecifier">
												<Relationship Name="Type">
													<Entry>
														<References ExternalSource="BuiltIns" Name="[uniqueidentifier]" />
													</Entry>
												</Relationship>
											</Element>
										</Entry>
									</Relationship>
								</Element>
							</Entry>
							<Entry>
								<Element Type="SqlSimpleColumn" Name="[metadataHelpers].[SetDefaultTenant].[@Tenants].[Name]">
									<Property Name="IsNullable" Value="False" />
									<Relationship Name="TypeSpecifier">
										<Entry>
											<Element Type="SqlTypeSpecifier">
												<Property Name="Length" Value="200" />
												<Relationship Name="Type">
													<Entry>
														<References ExternalSource="BuiltIns" Name="[nvarchar]" />
													</Entry>
												</Relationship>
											</Element>
										</Entry>
									</Relationship>
								</Element>
							</Entry>
							<Entry>
								<Element Type="SqlSimpleColumn" Name="[metadataHelpers].[SetDefaultTenant].[@Tenants].[Description]">
									<Relationship Name="TypeSpecifier">
										<Entry>
											<Element Type="SqlTypeSpecifier">
												<Property Name="IsMax" Value="True" />
												<Relationship Name="Type">
													<Entry>
														<References ExternalSource="BuiltIns" Name="[nvarchar]" />
													</Entry>
												</Relationship>
											</Element>
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
			</Relationship>
			<Relationship Name="Schema">
				<Entry>
					<References Name="[metadataHelpers]" />
				</Entry>
			</Relationship>
			<Annotation Type="SysCommentsObjectAnnotation">
				<Property Name="Length" Value="852" />
				<Property Name="StartLine" Value="1" />
				<Property Name="StartColumn" Value="1" />
				<Property Name="HeaderContents" Value="CREATE PROCEDURE [metadataHelpers].[SetDefaultTenant]&#xD;&#xA;AS" />
			</Annotation>
		</Element>
		<Element Type="SqlSchema" Name="[metadataReporting]">
			<Relationship Name="Authorizer">
				<Entry>
					<References ExternalSource="BuiltIns" Name="[dbo]" />
				</Entry>
			</Relationship>
		</Element>
		<Element Type="SqlView" Name="[metadataReporting].[AverageStageDuration]">
			<Property Name="QueryScript">
				<Value><![CDATA[

WITH stageStartEnd AS
	(
	SELECT
		[LocalExecutionId],
		[StageId],
		MIN([StartDateTime]) AS 'StageStart',
		MAX([EndDateTime]) AS 'StageEnd'
	FROM
		[metadata].[ExecutionLog]
	GROUP BY
		[LocalExecutionId],
		[StageId]
	)

SELECT
	s.[StageId],
	s.[StageName],
	s.[StageDescription],
	AVG(DATEDIFF(MINUTE, stageStartEnd.[StageStart], stageStartEnd.[StageEnd])) 'AvgStageRunDurationMinutes'
FROM
	stageStartEnd
	INNER JOIN [metadata].[Stages] s
		ON stageStartEnd.[StageId] = s.[StageId]
GROUP BY
	s.[StageId],
	s.[StageName],
	s.[StageDescription]]]></Value>
			</Property>
			<Property Name="IsAnsiNullsOn" Value="True" />
			<Relationship Name="Columns">
				<Entry>
					<Element Type="SqlComputedColumn" Name="[metadataReporting].[AverageStageDuration].[StageId]">
						<Relationship Name="ExpressionDependencies">
							<Entry>
								<References Name="[metadata].[Stages].[StageId]" />
							</Entry>
						</Relationship>
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlComputedColumn" Name="[metadataReporting].[AverageStageDuration].[StageName]">
						<Relationship Name="ExpressionDependencies">
							<Entry>
								<References Name="[metadata].[Stages].[StageName]" />
							</Entry>
						</Relationship>
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlComputedColumn" Name="[metadataReporting].[AverageStageDuration].[StageDescription]">
						<Relationship Name="ExpressionDependencies">
							<Entry>
								<References Name="[metadata].[Stages].[StageDescription]" />
							</Entry>
						</Relationship>
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlComputedColumn" Name="[metadataReporting].[AverageStageDuration].[AvgStageRunDurationMinutes]" />
				</Entry>
			</Relationship>
			<Relationship Name="DynamicObjects">
				<Entry>
					<Element Type="SqlDynamicColumnSource" Name="[metadataReporting].[AverageStageDuration].[CTE1].[stageStartEnd]">
						<Relationship Name="Columns">
							<Entry>
								<Element Type="SqlComputedColumn" Name="[metadataReporting].[AverageStageDuration].[CTE1].[stageStartEnd].[LocalExecutionId]">
									<Relationship Name="ExpressionDependencies">
										<Entry>
											<References Name="[metadata].[ExecutionLog].[LocalExecutionId]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
							<Entry>
								<Element Type="SqlComputedColumn" Name="[metadataReporting].[AverageStageDuration].[CTE1].[stageStartEnd].[StageId]">
									<Relationship Name="ExpressionDependencies">
										<Entry>
											<References Name="[metadata].[ExecutionLog].[StageId]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
							<Entry>
								<Element Type="SqlComputedColumn" Name="[metadataReporting].[AverageStageDuration].[CTE1].[stageStartEnd].[StageStart]" />
							</Entry>
							<Entry>
								<Element Type="SqlComputedColumn" Name="[metadataReporting].[AverageStageDuration].[CTE1].[stageStartEnd].[StageEnd]" />
							</Entry>
						</Relationship>
					</Element>
				</Entry>
			</Relationship>
			<Relationship Name="QueryDependencies">
				<Entry>
					<References Name="[metadata].[ExecutionLog]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[ExecutionLog].[LocalExecutionId]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[ExecutionLog].[StageId]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[ExecutionLog].[StartDateTime]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[ExecutionLog].[EndDateTime]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[Stages]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[ExecutionLog].[StageId]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[Stages].[StageId]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[Stages].[StageName]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[Stages].[StageDescription]" />
				</Entry>
			</Relationship>
			<Relationship Name="Schema">
				<Entry>
					<References Name="[metadataReporting]" />
				</Entry>
			</Relationship>
			<Annotation Type="SysCommentsObjectAnnotation">
				<Property Name="Length" Value="636" />
				<Property Name="StartLine" Value="1" />
				<Property Name="StartColumn" Value="1" />
				<Property Name="HeaderContents" Value="CREATE VIEW [metadataReporting].[AverageStageDuration]&#xD;&#xA;AS" />
			</Annotation>
		</Element>
		<Element Type="SqlView" Name="[metadataReporting].[CompleteExecutionErrorLog]">
			<Property Name="QueryScript">
				<Value><![CDATA[

SELECT
	exeLog.[LogId] AS ExecutionLogId,
	errLog.[LogId] AS ErrorLogId,
	exeLog.[LocalExecutionId],
	exeLog.[StartDateTime] AS ProcessingDateTime,
	exeLog.[CallingOrchestratorName],
	exeLog.[OrchestratorType] AS WorkerOrchestartorType,
	exeLog.[OrchestratorName] AS WorkerOrchestrator,
	exeLog.[PipelineName] AS WorkerPipelineName,
	exeLog.[PipelineStatus],
	errLog.[ActivityRunId],
	errLog.[ActivityName],
	errLog.[ActivityType],
	errLog.[ErrorCode],
	errLog.[ErrorType],
	errLog.[ErrorMessage]
FROM
	[metadata].[ExecutionLog] exeLog
	INNER JOIN [metadata].[ErrorLog] errLog
		ON exeLog.[LocalExecutionId] = errLog.[LocalExecutionId]
			AND exeLog.[PipelineRunId] = errLog.[PipelineRunId]
	INNER JOIN [metadata].[Stages] stgs
		ON exeLog.[StageId] = stgs.[StageId]
]]></Value>
			</Property>
			<Property Name="IsAnsiNullsOn" Value="True" />
			<Relationship Name="Columns">
				<Entry>
					<Element Type="SqlComputedColumn" Name="[metadataReporting].[CompleteExecutionErrorLog].[ExecutionLogId]">
						<Relationship Name="ExpressionDependencies">
							<Entry>
								<References Name="[metadata].[ExecutionLog].[LogId]" />
							</Entry>
						</Relationship>
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlComputedColumn" Name="[metadataReporting].[CompleteExecutionErrorLog].[ErrorLogId]">
						<Relationship Name="ExpressionDependencies">
							<Entry>
								<References Name="[metadata].[ErrorLog].[LogId]" />
							</Entry>
						</Relationship>
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlComputedColumn" Name="[metadataReporting].[CompleteExecutionErrorLog].[LocalExecutionId]">
						<Relationship Name="ExpressionDependencies">
							<Entry>
								<References Name="[metadata].[ExecutionLog].[LocalExecutionId]" />
							</Entry>
						</Relationship>
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlComputedColumn" Name="[metadataReporting].[CompleteExecutionErrorLog].[ProcessingDateTime]">
						<Relationship Name="ExpressionDependencies">
							<Entry>
								<References Name="[metadata].[ExecutionLog].[StartDateTime]" />
							</Entry>
						</Relationship>
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlComputedColumn" Name="[metadataReporting].[CompleteExecutionErrorLog].[CallingOrchestratorName]">
						<Relationship Name="ExpressionDependencies">
							<Entry>
								<References Name="[metadata].[ExecutionLog].[CallingOrchestratorName]" />
							</Entry>
						</Relationship>
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlComputedColumn" Name="[metadataReporting].[CompleteExecutionErrorLog].[WorkerOrchestartorType]">
						<Relationship Name="ExpressionDependencies">
							<Entry>
								<References Name="[metadata].[ExecutionLog].[OrchestratorType]" />
							</Entry>
						</Relationship>
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlComputedColumn" Name="[metadataReporting].[CompleteExecutionErrorLog].[WorkerOrchestrator]">
						<Relationship Name="ExpressionDependencies">
							<Entry>
								<References Name="[metadata].[ExecutionLog].[OrchestratorName]" />
							</Entry>
						</Relationship>
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlComputedColumn" Name="[metadataReporting].[CompleteExecutionErrorLog].[WorkerPipelineName]">
						<Relationship Name="ExpressionDependencies">
							<Entry>
								<References Name="[metadata].[ExecutionLog].[PipelineName]" />
							</Entry>
						</Relationship>
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlComputedColumn" Name="[metadataReporting].[CompleteExecutionErrorLog].[PipelineStatus]">
						<Relationship Name="ExpressionDependencies">
							<Entry>
								<References Name="[metadata].[ExecutionLog].[PipelineStatus]" />
							</Entry>
						</Relationship>
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlComputedColumn" Name="[metadataReporting].[CompleteExecutionErrorLog].[ActivityRunId]">
						<Relationship Name="ExpressionDependencies">
							<Entry>
								<References Name="[metadata].[ErrorLog].[ActivityRunId]" />
							</Entry>
						</Relationship>
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlComputedColumn" Name="[metadataReporting].[CompleteExecutionErrorLog].[ActivityName]">
						<Relationship Name="ExpressionDependencies">
							<Entry>
								<References Name="[metadata].[ErrorLog].[ActivityName]" />
							</Entry>
						</Relationship>
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlComputedColumn" Name="[metadataReporting].[CompleteExecutionErrorLog].[ActivityType]">
						<Relationship Name="ExpressionDependencies">
							<Entry>
								<References Name="[metadata].[ErrorLog].[ActivityType]" />
							</Entry>
						</Relationship>
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlComputedColumn" Name="[metadataReporting].[CompleteExecutionErrorLog].[ErrorCode]">
						<Relationship Name="ExpressionDependencies">
							<Entry>
								<References Name="[metadata].[ErrorLog].[ErrorCode]" />
							</Entry>
						</Relationship>
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlComputedColumn" Name="[metadataReporting].[CompleteExecutionErrorLog].[ErrorType]">
						<Relationship Name="ExpressionDependencies">
							<Entry>
								<References Name="[metadata].[ErrorLog].[ErrorType]" />
							</Entry>
						</Relationship>
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlComputedColumn" Name="[metadataReporting].[CompleteExecutionErrorLog].[ErrorMessage]">
						<Relationship Name="ExpressionDependencies">
							<Entry>
								<References Name="[metadata].[ErrorLog].[ErrorMessage]" />
							</Entry>
						</Relationship>
					</Element>
				</Entry>
			</Relationship>
			<Relationship Name="QueryDependencies">
				<Entry>
					<References Name="[metadata].[ExecutionLog]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[ErrorLog]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[ExecutionLog].[LocalExecutionId]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[ErrorLog].[LocalExecutionId]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[ExecutionLog].[PipelineRunId]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[ErrorLog].[PipelineRunId]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[Stages]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[ExecutionLog].[StageId]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[Stages].[StageId]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[ExecutionLog].[LogId]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[ErrorLog].[LogId]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[ExecutionLog].[LocalExecutionId]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[ExecutionLog].[StartDateTime]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[ExecutionLog].[CallingOrchestratorName]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[ExecutionLog].[OrchestratorType]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[ExecutionLog].[OrchestratorName]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[ExecutionLog].[PipelineName]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[ExecutionLog].[PipelineStatus]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[ErrorLog].[ActivityRunId]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[ErrorLog].[ActivityName]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[ErrorLog].[ActivityType]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[ErrorLog].[ErrorCode]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[ErrorLog].[ErrorType]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[ErrorLog].[ErrorMessage]" />
				</Entry>
			</Relationship>
			<Relationship Name="Schema">
				<Entry>
					<References Name="[metadataReporting]" />
				</Entry>
			</Relationship>
			<Annotation Type="SysCommentsObjectAnnotation">
				<Property Name="Length" Value="858" />
				<Property Name="StartLine" Value="1" />
				<Property Name="StartColumn" Value="1" />
				<Property Name="HeaderContents" Value="CREATE VIEW [metadataReporting].[CompleteExecutionErrorLog]&#xD;&#xA;AS" />
				<Property Name="FooterContents" Value=";" />
			</Annotation>
		</Element>
		<Element Type="SqlView" Name="[metadataReporting].[CompleteExecutionLog]">
			<Property Name="QueryScript">
				<Value><![CDATA[

SELECT
	[LogId],
	[LocalExecutionId],
	[StageId],
	[PipelineId],
	[CallingOrchestratorName],
	[ResourceGroupName],
	[OrchestratorType],
	[OrchestratorName],
	[PipelineName],
	[StartDateTime],
	[PipelineStatus],
	[EndDateTime],
	DATEDIFF(MINUTE, [StartDateTime], [EndDateTime]) 'RunDurationMinutes'
FROM 
	[metadata].[ExecutionLog]]]></Value>
			</Property>
			<Property Name="IsAnsiNullsOn" Value="True" />
			<Relationship Name="Columns">
				<Entry>
					<Element Type="SqlComputedColumn" Name="[metadataReporting].[CompleteExecutionLog].[LogId]">
						<Relationship Name="ExpressionDependencies">
							<Entry>
								<References Name="[metadata].[ExecutionLog].[LogId]" />
							</Entry>
						</Relationship>
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlComputedColumn" Name="[metadataReporting].[CompleteExecutionLog].[LocalExecutionId]">
						<Relationship Name="ExpressionDependencies">
							<Entry>
								<References Name="[metadata].[ExecutionLog].[LocalExecutionId]" />
							</Entry>
						</Relationship>
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlComputedColumn" Name="[metadataReporting].[CompleteExecutionLog].[StageId]">
						<Relationship Name="ExpressionDependencies">
							<Entry>
								<References Name="[metadata].[ExecutionLog].[StageId]" />
							</Entry>
						</Relationship>
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlComputedColumn" Name="[metadataReporting].[CompleteExecutionLog].[PipelineId]">
						<Relationship Name="ExpressionDependencies">
							<Entry>
								<References Name="[metadata].[ExecutionLog].[PipelineId]" />
							</Entry>
						</Relationship>
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlComputedColumn" Name="[metadataReporting].[CompleteExecutionLog].[CallingOrchestratorName]">
						<Relationship Name="ExpressionDependencies">
							<Entry>
								<References Name="[metadata].[ExecutionLog].[CallingOrchestratorName]" />
							</Entry>
						</Relationship>
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlComputedColumn" Name="[metadataReporting].[CompleteExecutionLog].[ResourceGroupName]">
						<Relationship Name="ExpressionDependencies">
							<Entry>
								<References Name="[metadata].[ExecutionLog].[ResourceGroupName]" />
							</Entry>
						</Relationship>
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlComputedColumn" Name="[metadataReporting].[CompleteExecutionLog].[OrchestratorType]">
						<Relationship Name="ExpressionDependencies">
							<Entry>
								<References Name="[metadata].[ExecutionLog].[OrchestratorType]" />
							</Entry>
						</Relationship>
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlComputedColumn" Name="[metadataReporting].[CompleteExecutionLog].[OrchestratorName]">
						<Relationship Name="ExpressionDependencies">
							<Entry>
								<References Name="[metadata].[ExecutionLog].[OrchestratorName]" />
							</Entry>
						</Relationship>
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlComputedColumn" Name="[metadataReporting].[CompleteExecutionLog].[PipelineName]">
						<Relationship Name="ExpressionDependencies">
							<Entry>
								<References Name="[metadata].[ExecutionLog].[PipelineName]" />
							</Entry>
						</Relationship>
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlComputedColumn" Name="[metadataReporting].[CompleteExecutionLog].[StartDateTime]">
						<Relationship Name="ExpressionDependencies">
							<Entry>
								<References Name="[metadata].[ExecutionLog].[StartDateTime]" />
							</Entry>
						</Relationship>
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlComputedColumn" Name="[metadataReporting].[CompleteExecutionLog].[PipelineStatus]">
						<Relationship Name="ExpressionDependencies">
							<Entry>
								<References Name="[metadata].[ExecutionLog].[PipelineStatus]" />
							</Entry>
						</Relationship>
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlComputedColumn" Name="[metadataReporting].[CompleteExecutionLog].[EndDateTime]">
						<Relationship Name="ExpressionDependencies">
							<Entry>
								<References Name="[metadata].[ExecutionLog].[EndDateTime]" />
							</Entry>
						</Relationship>
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlComputedColumn" Name="[metadataReporting].[CompleteExecutionLog].[RunDurationMinutes]" />
				</Entry>
			</Relationship>
			<Relationship Name="QueryDependencies">
				<Entry>
					<References Name="[metadata].[ExecutionLog]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[ExecutionLog].[LogId]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[ExecutionLog].[LocalExecutionId]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[ExecutionLog].[StageId]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[ExecutionLog].[PipelineId]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[ExecutionLog].[CallingOrchestratorName]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[ExecutionLog].[ResourceGroupName]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[ExecutionLog].[OrchestratorType]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[ExecutionLog].[OrchestratorName]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[ExecutionLog].[PipelineName]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[ExecutionLog].[StartDateTime]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[ExecutionLog].[PipelineStatus]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[ExecutionLog].[EndDateTime]" />
				</Entry>
			</Relationship>
			<Relationship Name="Schema">
				<Entry>
					<References Name="[metadataReporting]" />
				</Entry>
			</Relationship>
			<Annotation Type="SysCommentsObjectAnnotation">
				<Property Name="Length" Value="407" />
				<Property Name="StartLine" Value="1" />
				<Property Name="StartColumn" Value="1" />
				<Property Name="HeaderContents" Value="CREATE VIEW [metadataReporting].[CompleteExecutionLog]&#xD;&#xA;AS" />
			</Annotation>
		</Element>
		<Element Type="SqlView" Name="[metadataReporting].[CurrentExecutionSummary]">
			<Property Name="QueryScript">
				<Value><![CDATA[

SELECT 
	ISNULL([PipelineStatus], 'Not Started') AS 'PipelineStatus',
	COUNT(0) AS 'RecordCount'
FROM 
	[metadata].[CurrentExecution]
GROUP BY
	[PipelineStatus]]]></Value>
			</Property>
			<Property Name="IsAnsiNullsOn" Value="True" />
			<Relationship Name="Columns">
				<Entry>
					<Element Type="SqlComputedColumn" Name="[metadataReporting].[CurrentExecutionSummary].[PipelineStatus]" />
				</Entry>
				<Entry>
					<Element Type="SqlComputedColumn" Name="[metadataReporting].[CurrentExecutionSummary].[RecordCount]" />
				</Entry>
			</Relationship>
			<Relationship Name="QueryDependencies">
				<Entry>
					<References Name="[metadata].[CurrentExecution]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[CurrentExecution].[PipelineStatus]" />
				</Entry>
			</Relationship>
			<Relationship Name="Schema">
				<Entry>
					<References Name="[metadataReporting]" />
				</Entry>
			</Relationship>
			<Annotation Type="SysCommentsObjectAnnotation">
				<Property Name="Length" Value="231" />
				<Property Name="StartLine" Value="1" />
				<Property Name="StartColumn" Value="1" />
				<Property Name="HeaderContents" Value="CREATE VIEW [metadataReporting].[CurrentExecutionSummary]&#xD;&#xA;AS" />
			</Annotation>
		</Element>
		<Element Type="SqlView" Name="[metadataReporting].[LastExecution]">
			<Property Name="QueryScript">
				<Value><![CDATA[

WITH maxLog AS
	(
	SELECT
		MAX([LogId]) AS 'MaxLogId'
	FROM
		[metadata].[ExecutionLog]
	),
	lastExecutionId AS
	(
	SELECT
		[LocalExecutionId]
	FROM
		[metadata].[ExecutionLog] el1
		INNER JOIN maxLog
			ON maxLog.[MaxLogId] = el1.[LogId]
	)
SELECT
	el2.[LogId],
	el2.[StageId],
	el2.[PipelineId],
	el2.[PipelineName],
	el2.[StartDateTime],
	el2.[PipelineStatus],
	el2.[EndDateTime],
	DATEDIFF(MINUTE, el2.[StartDateTime], el2.[EndDateTime]) AS RunDurationMinutes
FROM 
	[metadata].[ExecutionLog] el2
	INNER JOIN lastExecutionId
		ON el2.[LocalExecutionId] = lastExecutionId.[LocalExecutionId]
WHERE
	el2.[EndDateTime] IS NOT NULL]]></Value>
			</Property>
			<Property Name="IsAnsiNullsOn" Value="True" />
			<Relationship Name="Columns">
				<Entry>
					<Element Type="SqlComputedColumn" Name="[metadataReporting].[LastExecution].[LogId]">
						<Relationship Name="ExpressionDependencies">
							<Entry>
								<References Name="[metadata].[ExecutionLog].[LogId]" />
							</Entry>
						</Relationship>
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlComputedColumn" Name="[metadataReporting].[LastExecution].[StageId]">
						<Relationship Name="ExpressionDependencies">
							<Entry>
								<References Name="[metadata].[ExecutionLog].[StageId]" />
							</Entry>
						</Relationship>
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlComputedColumn" Name="[metadataReporting].[LastExecution].[PipelineId]">
						<Relationship Name="ExpressionDependencies">
							<Entry>
								<References Name="[metadata].[ExecutionLog].[PipelineId]" />
							</Entry>
						</Relationship>
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlComputedColumn" Name="[metadataReporting].[LastExecution].[PipelineName]">
						<Relationship Name="ExpressionDependencies">
							<Entry>
								<References Name="[metadata].[ExecutionLog].[PipelineName]" />
							</Entry>
						</Relationship>
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlComputedColumn" Name="[metadataReporting].[LastExecution].[StartDateTime]">
						<Relationship Name="ExpressionDependencies">
							<Entry>
								<References Name="[metadata].[ExecutionLog].[StartDateTime]" />
							</Entry>
						</Relationship>
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlComputedColumn" Name="[metadataReporting].[LastExecution].[PipelineStatus]">
						<Relationship Name="ExpressionDependencies">
							<Entry>
								<References Name="[metadata].[ExecutionLog].[PipelineStatus]" />
							</Entry>
						</Relationship>
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlComputedColumn" Name="[metadataReporting].[LastExecution].[EndDateTime]">
						<Relationship Name="ExpressionDependencies">
							<Entry>
								<References Name="[metadata].[ExecutionLog].[EndDateTime]" />
							</Entry>
						</Relationship>
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlComputedColumn" Name="[metadataReporting].[LastExecution].[RunDurationMinutes]" />
				</Entry>
			</Relationship>
			<Relationship Name="DynamicObjects">
				<Entry>
					<Element Type="SqlDynamicColumnSource" Name="[metadataReporting].[LastExecution].[CTE1].[maxLog]">
						<Relationship Name="Columns">
							<Entry>
								<Element Type="SqlComputedColumn" Name="[metadataReporting].[LastExecution].[CTE1].[maxLog].[MaxLogId]" />
							</Entry>
						</Relationship>
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlDynamicColumnSource" Name="[metadataReporting].[LastExecution].[CTE1].[lastExecutionId]">
						<Relationship Name="Columns">
							<Entry>
								<Element Type="SqlComputedColumn" Name="[metadataReporting].[LastExecution].[CTE1].[lastExecutionId].[LocalExecutionId]">
									<Relationship Name="ExpressionDependencies">
										<Entry>
											<References Name="[metadata].[ExecutionLog].[LocalExecutionId]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
			</Relationship>
			<Relationship Name="QueryDependencies">
				<Entry>
					<References Name="[metadata].[ExecutionLog]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[ExecutionLog].[LogId]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[ExecutionLog].[LogId]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[ExecutionLog].[LocalExecutionId]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[ExecutionLog].[LocalExecutionId]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[ExecutionLog].[LocalExecutionId]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[ExecutionLog].[LogId]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[ExecutionLog].[StageId]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[ExecutionLog].[PipelineId]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[ExecutionLog].[PipelineName]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[ExecutionLog].[StartDateTime]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[ExecutionLog].[PipelineStatus]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[ExecutionLog].[EndDateTime]" />
				</Entry>
			</Relationship>
			<Relationship Name="Schema">
				<Entry>
					<References Name="[metadataReporting]" />
				</Entry>
			</Relationship>
			<Annotation Type="SysCommentsObjectAnnotation">
				<Property Name="Length" Value="718" />
				<Property Name="StartLine" Value="1" />
				<Property Name="StartColumn" Value="1" />
				<Property Name="HeaderContents" Value="CREATE VIEW [metadataReporting].[LastExecution]&#xD;&#xA;AS" />
				<Property Name="FooterContents" Value=";" />
			</Annotation>
		</Element>
		<Element Type="SqlView" Name="[metadataReporting].[LastExecutionSummary]">
			<Property Name="QueryScript">
				<Value><![CDATA[

WITH maxLog AS
	(
	SELECT
		MAX([LogId]) AS 'MaxLogId'
	FROM
		[metadata].[ExecutionLog]
	),
	lastExecutionId AS
	(
	SELECT
		[LocalExecutionId]
	FROM
		[metadata].[ExecutionLog] el1
		INNER JOIN maxLog
			ON maxLog.[MaxLogId] = el1.[LogId]
	)
SELECT
	el2.[LocalExecutionId],
	DATEDIFF(MINUTE, MIN(el2.[StartDateTime]), MAX(el2.[EndDateTime])) 'RunDurationMinutes'
FROM 
	[metadata].[ExecutionLog] el2
	INNER JOIN lastExecutionId
		ON el2.[LocalExecutionId] = lastExecutionId.[LocalExecutionId]
GROUP BY
	el2.[LocalExecutionId]]]></Value>
			</Property>
			<Property Name="IsAnsiNullsOn" Value="True" />
			<Relationship Name="Columns">
				<Entry>
					<Element Type="SqlComputedColumn" Name="[metadataReporting].[LastExecutionSummary].[LocalExecutionId]">
						<Relationship Name="ExpressionDependencies">
							<Entry>
								<References Name="[metadata].[ExecutionLog].[LocalExecutionId]" />
							</Entry>
						</Relationship>
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlComputedColumn" Name="[metadataReporting].[LastExecutionSummary].[RunDurationMinutes]" />
				</Entry>
			</Relationship>
			<Relationship Name="DynamicObjects">
				<Entry>
					<Element Type="SqlDynamicColumnSource" Name="[metadataReporting].[LastExecutionSummary].[CTE1].[maxLog]">
						<Relationship Name="Columns">
							<Entry>
								<Element Type="SqlComputedColumn" Name="[metadataReporting].[LastExecutionSummary].[CTE1].[maxLog].[MaxLogId]" />
							</Entry>
						</Relationship>
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlDynamicColumnSource" Name="[metadataReporting].[LastExecutionSummary].[CTE1].[lastExecutionId]">
						<Relationship Name="Columns">
							<Entry>
								<Element Type="SqlComputedColumn" Name="[metadataReporting].[LastExecutionSummary].[CTE1].[lastExecutionId].[LocalExecutionId]">
									<Relationship Name="ExpressionDependencies">
										<Entry>
											<References Name="[metadata].[ExecutionLog].[LocalExecutionId]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
			</Relationship>
			<Relationship Name="QueryDependencies">
				<Entry>
					<References Name="[metadata].[ExecutionLog]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[ExecutionLog].[LogId]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[ExecutionLog].[LogId]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[ExecutionLog].[LocalExecutionId]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[ExecutionLog].[LocalExecutionId]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[ExecutionLog].[LocalExecutionId]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[ExecutionLog].[StartDateTime]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[ExecutionLog].[EndDateTime]" />
				</Entry>
			</Relationship>
			<Relationship Name="Schema">
				<Entry>
					<References Name="[metadataReporting]" />
				</Entry>
			</Relationship>
			<Annotation Type="SysCommentsObjectAnnotation">
				<Property Name="Length" Value="613" />
				<Property Name="StartLine" Value="1" />
				<Property Name="StartColumn" Value="1" />
				<Property Name="HeaderContents" Value="CREATE VIEW [metadataReporting].[LastExecutionSummary]&#xD;&#xA;AS" />
			</Annotation>
		</Element>
		<Element Type="SqlView" Name="[metadataReporting].[WorkerParallelismOverTime]">
			<Property Name="QueryScript">
				<Value><![CDATA[

WITH numbers AS
	(
	SELECT TOP 500
		ROW_NUMBER() OVER (ORDER BY s1.[object_id]) - 1 AS 'Number'
	FROM 
		sys.all_columns AS s1
		CROSS JOIN sys.all_columns AS s2
	),
	executionBoundaries AS
	(
	SELECT
		[LocalExecutionId],
		CAST(CONVERT(VARCHAR(16), MIN([StartDateTime]), 120) AS DATETIME)  AS 'ExecutionStart',
		CAST(CONVERT(VARCHAR(16), MAX([EndDateTime]), 120) AS DATETIME) AS 'ExecutionEnd'
	FROM
		[metadata].[ExecutionLog]
	--WHERE
	--	[LocalExecutionId] = '2BB02783-2A2C-4970-9BEA-0543013BFD5E'
	GROUP BY
		[LocalExecutionId]
	),
	wallclockRunning AS
	(
	SELECT
		CAST(DATEADD(MINUTE, n.[Number], eB.[ExecutionStart]) AS DATE) AS 'WallclockDate',
		CAST(DATEADD(MINUTE, n.[Number], eB.[ExecutionStart]) AS TIME) AS 'WallclockTime',
		el.[LocalExecutionId],
		el.[PipelineId],
		el.[PipelineName],
		s.[StageName]
	FROM
		executionBoundaries eB
		CROSS JOIN numbers n
		INNER JOIN [metadata].[ExecutionLog] eL
			ON eB.[LocalExecutionId] = eL.[LocalExecutionId]
				AND DATEADD(MINUTE, n.[Number], eB.[ExecutionStart]) 
					BETWEEN eL.[StartDateTime] AND eL.[EndDateTime]
		INNER JOIN [metadata].[Stages] s
			ON eL.[StageId] = s.[StageId]
	)

SELECT
	[WallclockDate],
	[WallclockTime],
	[LocalExecutionId],
	[StageName],
	STRING_AGG(ISNULL([PipelineName],' '),', ') As 'PipelineName',
	COUNT([PipelineId]) AS 'WorkerCount'
FROM
	wallclockRunning
GROUP BY
	[WallclockDate],
	[WallclockTime],
	[LocalExecutionId],
	[StageName]]]></Value>
			</Property>
			<Property Name="IsAnsiNullsOn" Value="True" />
			<Relationship Name="Columns">
				<Entry>
					<Element Type="SqlComputedColumn" Name="[metadataReporting].[WorkerParallelismOverTime].[WallclockDate]" />
				</Entry>
				<Entry>
					<Element Type="SqlComputedColumn" Name="[metadataReporting].[WorkerParallelismOverTime].[WallclockTime]" />
				</Entry>
				<Entry>
					<Element Type="SqlComputedColumn" Name="[metadataReporting].[WorkerParallelismOverTime].[LocalExecutionId]">
						<Relationship Name="ExpressionDependencies">
							<Entry>
								<References Name="[metadata].[ExecutionLog].[LocalExecutionId]" />
							</Entry>
						</Relationship>
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlComputedColumn" Name="[metadataReporting].[WorkerParallelismOverTime].[StageName]">
						<Relationship Name="ExpressionDependencies">
							<Entry>
								<References Name="[metadata].[Stages].[StageName]" />
							</Entry>
						</Relationship>
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlComputedColumn" Name="[metadataReporting].[WorkerParallelismOverTime].[PipelineName]" />
				</Entry>
				<Entry>
					<Element Type="SqlComputedColumn" Name="[metadataReporting].[WorkerParallelismOverTime].[WorkerCount]" />
				</Entry>
			</Relationship>
			<Relationship Name="DynamicObjects">
				<Entry>
					<Element Type="SqlDynamicColumnSource" Name="[metadataReporting].[WorkerParallelismOverTime].[CTE1].[numbers]">
						<Relationship Name="Columns">
							<Entry>
								<Element Type="SqlComputedColumn" Name="[metadataReporting].[WorkerParallelismOverTime].[CTE1].[numbers].[Number]" />
							</Entry>
						</Relationship>
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlDynamicColumnSource" Name="[metadataReporting].[WorkerParallelismOverTime].[CTE1].[executionBoundaries]">
						<Relationship Name="Columns">
							<Entry>
								<Element Type="SqlComputedColumn" Name="[metadataReporting].[WorkerParallelismOverTime].[CTE1].[executionBoundaries].[LocalExecutionId]">
									<Relationship Name="ExpressionDependencies">
										<Entry>
											<References Name="[metadata].[ExecutionLog].[LocalExecutionId]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
							<Entry>
								<Element Type="SqlComputedColumn" Name="[metadataReporting].[WorkerParallelismOverTime].[CTE1].[executionBoundaries].[ExecutionStart]" />
							</Entry>
							<Entry>
								<Element Type="SqlComputedColumn" Name="[metadataReporting].[WorkerParallelismOverTime].[CTE1].[executionBoundaries].[ExecutionEnd]" />
							</Entry>
						</Relationship>
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlDynamicColumnSource" Name="[metadataReporting].[WorkerParallelismOverTime].[CTE1].[wallclockRunning]">
						<Relationship Name="Columns">
							<Entry>
								<Element Type="SqlComputedColumn" Name="[metadataReporting].[WorkerParallelismOverTime].[CTE1].[wallclockRunning].[WallclockDate]" />
							</Entry>
							<Entry>
								<Element Type="SqlComputedColumn" Name="[metadataReporting].[WorkerParallelismOverTime].[CTE1].[wallclockRunning].[WallclockTime]" />
							</Entry>
							<Entry>
								<Element Type="SqlComputedColumn" Name="[metadataReporting].[WorkerParallelismOverTime].[CTE1].[wallclockRunning].[LocalExecutionId]">
									<Relationship Name="ExpressionDependencies">
										<Entry>
											<References Name="[metadata].[ExecutionLog].[LocalExecutionId]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
							<Entry>
								<Element Type="SqlComputedColumn" Name="[metadataReporting].[WorkerParallelismOverTime].[CTE1].[wallclockRunning].[PipelineId]">
									<Relationship Name="ExpressionDependencies">
										<Entry>
											<References Name="[metadata].[ExecutionLog].[PipelineId]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
							<Entry>
								<Element Type="SqlComputedColumn" Name="[metadataReporting].[WorkerParallelismOverTime].[CTE1].[wallclockRunning].[PipelineName]">
									<Relationship Name="ExpressionDependencies">
										<Entry>
											<References Name="[metadata].[ExecutionLog].[PipelineName]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
							<Entry>
								<Element Type="SqlComputedColumn" Name="[metadataReporting].[WorkerParallelismOverTime].[CTE1].[wallclockRunning].[StageName]">
									<Relationship Name="ExpressionDependencies">
										<Entry>
											<References Name="[metadata].[Stages].[StageName]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
			</Relationship>
			<Relationship Name="QueryDependencies">
				<Entry>
					<References ExternalSource="master.dacpac" Name="[master]|[sys].[all_columns]" />
				</Entry>
				<Entry>
					<References ExternalSource="master.dacpac" Name="[master]|[sys].[all_columns].[object_id]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[ExecutionLog]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[ExecutionLog].[LocalExecutionId]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[datetime]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[varchar]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[ExecutionLog].[StartDateTime]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[ExecutionLog].[EndDateTime]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[ExecutionLog].[LocalExecutionId]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[ExecutionLog].[LocalExecutionId]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[ExecutionLog].[StartDateTime]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[ExecutionLog].[EndDateTime]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[Stages]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[ExecutionLog].[StageId]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[Stages].[StageId]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[date]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[time]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[ExecutionLog].[LocalExecutionId]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[ExecutionLog].[PipelineId]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[ExecutionLog].[PipelineName]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[Stages].[StageName]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[ExecutionLog].[LocalExecutionId]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[Stages].[StageName]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[ExecutionLog].[PipelineName]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[ExecutionLog].[PipelineId]" />
				</Entry>
			</Relationship>
			<Relationship Name="Schema">
				<Entry>
					<References Name="[metadataReporting]" />
				</Entry>
			</Relationship>
			<Annotation Type="SysCommentsObjectAnnotation">
				<Property Name="Length" Value="1556" />
				<Property Name="StartLine" Value="1" />
				<Property Name="StartColumn" Value="1" />
				<Property Name="HeaderContents" Value="CREATE VIEW [metadataReporting].[WorkerParallelismOverTime]&#xD;&#xA;AS" />
			</Annotation>
		</Element>
		<Element Type="SqlSchema" Name="[metadataTesting]">
			<Relationship Name="Authorizer">
				<Entry>
					<References ExternalSource="BuiltIns" Name="[dbo]" />
				</Entry>
			</Relationship>
		</Element>
		<Element Type="SqlProcedure" Name="[metadataTesting].[Add20BatchesFor1000Workers]">
			<Property Name="BodyScript">
				<Value><![CDATA[
BEGIN
	SET NOCOUNT ON;

	--clear default metadata
	DELETE FROM [metadata].[BatchStageLink];
	
	DELETE FROM [metadata].[Batches];

	DELETE FROM [metadata].[PipelineDependencies];
	DBCC CHECKIDENT ('[metadata].[PipelineDependencies]', RESEED, 0);

	DELETE FROM [metadata].[PipelineAlertLink];
	DBCC CHECKIDENT ('[metadata].[PipelineAlertLink]', RESEED, 0);

	DELETE FROM [metadata].[Recipients];
	DBCC CHECKIDENT ('[metadata].[Recipients]', RESEED, 0);

	DELETE FROM [metadata].[PipelineAuthLink];
	DBCC CHECKIDENT ('[metadata].[PipelineAuthLink]', RESEED, 0);

	DELETE FROM [dbo].[ServicePrincipals];
	DBCC CHECKIDENT ('[dbo].[ServicePrincipals]', RESEED, 0);

	DELETE FROM [metadata].[PipelineParameters];
	DBCC CHECKIDENT ('[metadata].[PipelineParameters]', RESEED, 0);

	DELETE FROM [metadata].[Pipelines];
	DBCC CHECKIDENT ('[metadata].[Pipelines]', RESEED, 0);

	--get Orchestrator id
	DECLARE @OrcId INT
	
	SELECT 
		@OrcId = [OrchestratorId] 
	FROM 
		[metadata].[Orchestrators]
	WHERE 
		[OrchestratorName] = 'WorkersFactory'
		AND [OrchestratorType] = 'ADF';

	--tweak properties
	UPDATE
		[metadata].[Properties]
	SET
		[PropertyValue] = '[dbo].[None]'
	WHERE
		[PropertyName] = 'ExecutionPrecursorProc';

	UPDATE
		[metadata].[Properties]
	SET
		[PropertyValue] = '30'
	WHERE
		[PropertyName] = 'PipelineStatusCheckDuration';

	UPDATE
		[metadata].[Properties]
	SET
		[PropertyValue] = '0'
	WHERE
		[PropertyName] = 'UseFrameworkEmailAlerting';

	UPDATE
		[metadata].[Properties]
	SET
		[PropertyValue] = '1'
	WHERE
		[PropertyName] = 'UseExecutionBatches';

	--insert 200 pipelines
	;WITH cte AS
		(
		SELECT TOP 200
			ROW_NUMBER() OVER (ORDER BY s1.[object_id]) AS Number
		FROM 
			sys.all_columns AS s1
			CROSS JOIN sys.all_columns AS s2
		)
	INSERT INTO [metadata].[Pipelines]
		(
		[OrchestratorId],
		[StageId],
		[PipelineName],
		[LogicalPredecessorId],
		[Enabled]
		)
	SELECT
		@OrcId,
		CASE
			WHEN [Number] <= 50 THEN 1
			WHEN [Number] > 50 AND  [Number] <= 100 THEN 2
			WHEN [Number] > 100 AND  [Number] <= 150 THEN 3
			WHEN [Number] > 150 AND  [Number] <= 200 THEN 4
		END,
		'Wait ' + CAST([Number] AS VARCHAR),
		NULL,
		1
	FROM
		cte;

	--disable other execution stages if exist
	UPDATE [metadata].[Stages] SET [Enabled] = 1;
	UPDATE [metadata].[Stages] SET [Enabled] = 0 WHERE [StageId] > 4;

	--insert 200 pipeline parameters
	INSERT INTO [metadata].[PipelineParameters]
		(
		[PipelineId],
		[ParameterName],
		[ParameterValue]
		)
	SELECT
		[PipelineId],
		'WaitTime',
		LEFT(ABS(CAST(CAST(NEWID() AS VARBINARY) AS INT)),1)
	FROM
		[metadata].[Pipelines];
	
	--insert batches
	;WITH batchNames AS
		(
		SELECT 'One' AS [Name]
		UNION SELECT 'Two'
		UNION SELECT 'Three'
		UNION SELECT 'Four'
		UNION SELECT 'Five'
		UNION SELECT 'Six'
		UNION SELECT 'Seven'
		UNION SELECT 'Eight'
		UNION SELECT 'Nine'
		UNION SELECT 'Ten'
		UNION SELECT 'Eleven'
		UNION SELECT 'Twelve'
		UNION SELECT 'Thirteen'
		UNION SELECT 'Fourteen'
		UNION SELECT 'Fifteen'
		UNION SELECT 'Sixteen'
		UNION SELECT 'Seventeen'
		UNION SELECT 'Eighteen'
		UNION SELECT 'Nineteen'
		UNION SELECT 'Twenty'
		)
	INSERT INTO [metadata].[Batches]
		(
		[BatchName],
		[BatchDescription],
		[Enabled]
		)
	SELECT
		[Name],
		'1000 Workers Test',
		1
	FROM
		batchNames
	
	--allocation batches to stages evenly
	;WITH maxStages AS
		(
		SELECT 
			MAX([StageId]) AS Id
		FROM
			[metadata].[Stages]
		WHERE
			[Enabled] = 1
		)
	INSERT INTO [metadata].[BatchStageLink]
	SELECT  
		b.[BatchId],
		CASE
			WHEN (ROW_NUMBER() OVER (ORDER BY b.[BatchName] DESC) * 1) % maxStages.[Id] = 0 THEN maxStages.[Id] 
			ELSE (ROW_NUMBER() OVER (ORDER BY b.[BatchName] DESC) * 1) % maxStages.[Id] 
		END AS Stage
	FROM 
		[metadata].[Batches] b
		CROSS JOIN maxStages;

	/*
	--generate the c# for the NUnit test:

	SELECT
	[BatchName],
	'private GrandparentHelper _helperBatch' + [BatchName] + ';',
    '_helperBatch' + [BatchName] + ' = new GrandparentHelper().WithParameter("BatchName", "' + [BatchName] + '");',
	'var batch' + [BatchName] + ' = _helperBatch' + [BatchName] + '.RunPipeline();',
	'batch' + [BatchName] + ',',
'[Test]' + CHAR(13) +
'public void Then' + [BatchName] + 'BatchPipelineOutcomeIsSucceeded()' + CHAR(13) +
'{' + CHAR(13) +
'    _helperBatch' + [BatchName] + '.RunOutcome.Should().Be("Succeeded");' + CHAR(13) +
'}'
FROM 
	[metadata].[Batches]
	*/
END;]]></Value>
			</Property>
			<Property Name="IsAnsiNullsOn" Value="True" />
			<Relationship Name="BodyDependencies">
				<Entry>
					<References ExternalSource="BuiltIns" Name="[int]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[BatchStageLink]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[Batches]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[PipelineDependencies]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[PipelineAlertLink]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[Recipients]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[PipelineAuthLink]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[ServicePrincipals]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[PipelineParameters]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[Pipelines]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[Orchestrators]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[Orchestrators].[OrchestratorId]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[Orchestrators].[OrchestratorName]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[Orchestrators].[OrchestratorType]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[Properties]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[Properties].[PropertyValue]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[Properties].[PropertyName]" />
				</Entry>
				<Entry>
					<References ExternalSource="master.dacpac" Name="[master]|[sys].[all_columns]" />
				</Entry>
				<Entry>
					<References ExternalSource="master.dacpac" Name="[master]|[sys].[all_columns].[object_id]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[Pipelines].[OrchestratorId]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[Pipelines].[StageId]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[Pipelines].[PipelineName]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[Pipelines].[LogicalPredecessorId]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[Pipelines].[Enabled]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[varchar]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[Stages]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[Stages].[Enabled]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[Stages].[StageId]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[PipelineParameters].[PipelineId]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[PipelineParameters].[ParameterName]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[PipelineParameters].[ParameterValue]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[Pipelines].[PipelineId]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[int]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[varbinary]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[Batches].[BatchName]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[Batches].[BatchDescription]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[Batches].[Enabled]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[Batches].[BatchId]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[Batches].[BatchName]" />
				</Entry>
			</Relationship>
			<Relationship Name="DynamicObjects">
				<Entry>
					<Element Type="SqlDynamicColumnSource" Name="[metadataTesting].[Add20BatchesFor1000Workers].[CTE1].[cte]">
						<Relationship Name="Columns">
							<Entry>
								<Element Type="SqlComputedColumn" Name="[metadataTesting].[Add20BatchesFor1000Workers].[CTE1].[cte].[Number]" />
							</Entry>
						</Relationship>
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlDynamicColumnSource" Name="[metadataTesting].[Add20BatchesFor1000Workers].[CTE2].[batchNames]">
						<Relationship Name="Columns">
							<Entry>
								<Element Type="SqlComputedColumn" Name="[metadataTesting].[Add20BatchesFor1000Workers].[CTE2].[batchNames].[Name]" />
							</Entry>
						</Relationship>
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlDynamicColumnSource" Name="[metadataTesting].[Add20BatchesFor1000Workers].[CTE3].[maxStages]">
						<Relationship Name="Columns">
							<Entry>
								<Element Type="SqlComputedColumn" Name="[metadataTesting].[Add20BatchesFor1000Workers].[CTE3].[maxStages].[Id]" />
							</Entry>
						</Relationship>
					</Element>
				</Entry>
			</Relationship>
			<Relationship Name="Schema">
				<Entry>
					<References Name="[metadataTesting]" />
				</Entry>
			</Relationship>
			<Annotation Type="SysCommentsObjectAnnotation">
				<Property Name="Length" Value="4631" />
				<Property Name="StartLine" Value="1" />
				<Property Name="StartColumn" Value="1" />
				<Property Name="HeaderContents" Value="CREATE PROCEDURE [metadataTesting].[Add20BatchesFor1000Workers]&#xD;&#xA;AS" />
			</Annotation>
		</Element>
		<Element Type="SqlProcedure" Name="[metadataTesting].[Add300WorkerPipelineBatches]">
			<Property Name="BodyScript">
				<Value><![CDATA[
BEGIN
	SET NOCOUNT ON;

	--clear default metadata
	DELETE FROM [metadata].[BatchStageLink];
	DELETE FROM [metadata].[Batches];

	--add batch details
	;WITH sourceData AS
		(
		SELECT
			'0to300' AS BatchName, 
			'The first 300.' AS BatchDescription,
			1 AS [Enabled]
		UNION SELECT
			'301to600',
			'The second 300.',
			1	
		)
	MERGE INTO [metadata].[Batches] AS tgt
	USING 
		sourceData AS src
			ON tgt.[BatchName] = src.[BatchName]
	WHEN MATCHED THEN
		UPDATE
		SET
			tgt.[BatchDescription] = src.[BatchDescription],
			tgt.[Enabled] = src.[Enabled]
	WHEN NOT MATCHED BY TARGET THEN
		INSERT
			(
			[BatchName],
			[BatchDescription],
			[Enabled]
			)
		VALUES
			(
			src.[BatchName],
			src.[BatchDescription],
			src.[Enabled]
			)
	WHEN NOT MATCHED BY SOURCE THEN
		DELETE;	
	
	--link batches to stages
	INSERT INTO [metadata].[BatchStageLink]
		(
		[BatchId],
		[StageId]
		)
	SELECT
		b.[BatchId],
		s.[StageId]
	FROM
		[metadata].[Batches] b
		INNER JOIN [metadata].[Stages] s
			ON s.[Enabled] = 1;
END;]]></Value>
			</Property>
			<Property Name="IsAnsiNullsOn" Value="True" />
			<Relationship Name="BodyDependencies">
				<Entry>
					<References Name="[metadata].[BatchStageLink]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[Batches]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[Batches].[BatchName]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[Batches].[BatchDescription]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[Batches].[Enabled]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[Batches].[BatchName]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[Batches].[BatchDescription]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[Batches].[Enabled]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[BatchStageLink].[BatchId]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[BatchStageLink].[StageId]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[Stages]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[Stages].[Enabled]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[Batches].[BatchId]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[Stages].[StageId]" />
				</Entry>
			</Relationship>
			<Relationship Name="DynamicObjects">
				<Entry>
					<Element Type="SqlDynamicColumnSource" Name="[metadataTesting].[Add300WorkerPipelineBatches].[CTE1].[sourceData]">
						<Relationship Name="Columns">
							<Entry>
								<Element Type="SqlComputedColumn" Name="[metadataTesting].[Add300WorkerPipelineBatches].[CTE1].[sourceData].[BatchName]" />
							</Entry>
							<Entry>
								<Element Type="SqlComputedColumn" Name="[metadataTesting].[Add300WorkerPipelineBatches].[CTE1].[sourceData].[BatchDescription]" />
							</Entry>
							<Entry>
								<Element Type="SqlComputedColumn" Name="[metadataTesting].[Add300WorkerPipelineBatches].[CTE1].[sourceData].[Enabled]" />
							</Entry>
						</Relationship>
					</Element>
				</Entry>
			</Relationship>
			<Relationship Name="Schema">
				<Entry>
					<References Name="[metadataTesting]" />
				</Entry>
			</Relationship>
			<Annotation Type="SysCommentsObjectAnnotation">
				<Property Name="Length" Value="1148" />
				<Property Name="StartLine" Value="1" />
				<Property Name="StartColumn" Value="1" />
				<Property Name="HeaderContents" Value="CREATE PROCEDURE [metadataTesting].[Add300WorkerPipelineBatches]&#xD;&#xA;AS" />
			</Annotation>
		</Element>
		<Element Type="SqlProcedure" Name="[metadataTesting].[Add300WorkerPipelines]">
			<Property Name="BodyScript">
				<Value><![CDATA[
BEGIN
	SET NOCOUNT ON;

	--clear default metadata
	DELETE FROM [metadata].[PipelineDependencies];
	DBCC CHECKIDENT ('[metadata].[PipelineDependencies]', RESEED, 0);

	DELETE FROM [metadata].[PipelineAlertLink];
	DBCC CHECKIDENT ('[metadata].[PipelineAlertLink]', RESEED, 0);

	DELETE FROM [metadata].[Recipients];
	DBCC CHECKIDENT ('[metadata].[Recipients]', RESEED, 0);

	DELETE FROM [metadata].[PipelineAuthLink];
	DBCC CHECKIDENT ('[metadata].[PipelineAuthLink]', RESEED, 0);

	DELETE FROM [dbo].[ServicePrincipals];
	DBCC CHECKIDENT ('[dbo].[ServicePrincipals]', RESEED, 0);

	DELETE FROM [metadata].[PipelineParameters];
	DBCC CHECKIDENT ('[metadata].[PipelineParameters]', RESEED, 0);

	DELETE FROM [metadata].[Pipelines];
	DBCC CHECKIDENT ('[metadata].[Pipelines]', RESEED, 0);

	--get Orchestrator id
	DECLARE @OrcId INT
	
	SELECT 
		@OrcId = [OrchestratorId] 
	FROM 
		[metadata].[Orchestrators]
	WHERE 
		[OrchestratorName] = 'WorkersFactory'
		AND [OrchestratorType] = 'ADF';

	--insert 300 pipelines
	;WITH cte AS
		(
		SELECT TOP 300
			ROW_NUMBER() OVER (ORDER BY s1.[object_id]) AS Number
		FROM 
			sys.all_columns AS s1
			CROSS JOIN sys.all_columns AS s2
		)
	INSERT INTO [metadata].[Pipelines]
		(
		[OrchestratorId],
		[StageId],
		[PipelineName],
		[LogicalPredecessorId],
		[Enabled]
		)
	SELECT
		@OrcId,
		CASE
			WHEN [Number] <= 100 THEN 1
			WHEN [Number] > 100 AND  [Number] <= 200 THEN 2
			WHEN [Number] > 200 AND  [Number] <= 300 THEN 3
		END,
		'Wait ' + CAST([Number] AS VARCHAR),
		NULL,
		1
	FROM
		cte;

	--disable other execution stages if exist
	UPDATE [metadata].[Stages] SET [Enabled] = 0 WHERE [StageId] > 3;

	--insert 300 pipeline parameters
	INSERT INTO [metadata].[PipelineParameters]
		(
		[PipelineId],
		[ParameterName],
		[ParameterValue]
		)
	SELECT
		[PipelineId],
		'WaitTime',
		LEFT(ABS(CAST(CAST(NEWID() AS VARBINARY) AS INT)),2)
	FROM
		[metadata].[Pipelines];
END;]]></Value>
			</Property>
			<Property Name="IsAnsiNullsOn" Value="True" />
			<Relationship Name="BodyDependencies">
				<Entry>
					<References ExternalSource="BuiltIns" Name="[int]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[PipelineDependencies]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[PipelineAlertLink]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[Recipients]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[PipelineAuthLink]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[ServicePrincipals]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[PipelineParameters]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[Pipelines]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[Orchestrators]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[Orchestrators].[OrchestratorId]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[Orchestrators].[OrchestratorName]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[Orchestrators].[OrchestratorType]" />
				</Entry>
				<Entry>
					<References ExternalSource="master.dacpac" Name="[master]|[sys].[all_columns]" />
				</Entry>
				<Entry>
					<References ExternalSource="master.dacpac" Name="[master]|[sys].[all_columns].[object_id]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[Pipelines].[OrchestratorId]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[Pipelines].[StageId]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[Pipelines].[PipelineName]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[Pipelines].[LogicalPredecessorId]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[Pipelines].[Enabled]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[varchar]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[Stages]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[Stages].[Enabled]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[Stages].[StageId]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[PipelineParameters].[PipelineId]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[PipelineParameters].[ParameterName]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[PipelineParameters].[ParameterValue]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[Pipelines].[PipelineId]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[int]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[varbinary]" />
				</Entry>
			</Relationship>
			<Relationship Name="DynamicObjects">
				<Entry>
					<Element Type="SqlDynamicColumnSource" Name="[metadataTesting].[Add300WorkerPipelines].[CTE1].[cte]">
						<Relationship Name="Columns">
							<Entry>
								<Element Type="SqlComputedColumn" Name="[metadataTesting].[Add300WorkerPipelines].[CTE1].[cte].[Number]" />
							</Entry>
						</Relationship>
					</Element>
				</Entry>
			</Relationship>
			<Relationship Name="Schema">
				<Entry>
					<References Name="[metadataTesting]" />
				</Entry>
			</Relationship>
			<Annotation Type="SysCommentsObjectAnnotation">
				<Property Name="Length" Value="2067" />
				<Property Name="StartLine" Value="1" />
				<Property Name="StartColumn" Value="1" />
				<Property Name="HeaderContents" Value="CREATE PROCEDURE [metadataTesting].[Add300WorkerPipelines]&#xD;&#xA;AS" />
			</Annotation>
		</Element>
		<Element Type="SqlProcedure" Name="[metadataTesting].[CleanUpMetadata]">
			<Property Name="BodyScript">
				<Value><![CDATA[
BEGIN
	EXEC [metadataHelpers].[DeleteMetadataWithIntegrity];
	EXEC [metadataHelpers].[DeleteMetadataWithoutIntegrity];
END;]]></Value>
			</Property>
			<Property Name="IsAnsiNullsOn" Value="True" />
			<Relationship Name="BodyDependencies">
				<Entry>
					<References Name="[metadataHelpers].[DeleteMetadataWithIntegrity]" />
				</Entry>
				<Entry>
					<References Name="[metadataHelpers].[DeleteMetadataWithoutIntegrity]" />
				</Entry>
			</Relationship>
			<Relationship Name="Schema">
				<Entry>
					<References Name="[metadataTesting]" />
				</Entry>
			</Relationship>
			<Annotation Type="SysCommentsObjectAnnotation">
				<Property Name="Length" Value="184" />
				<Property Name="StartLine" Value="1" />
				<Property Name="StartColumn" Value="1" />
				<Property Name="HeaderContents" Value="CREATE PROCEDURE [metadataTesting].[CleanUpMetadata]&#xD;&#xA;AS" />
			</Annotation>
		</Element>
		<Element Type="SqlProcedure" Name="[metadataTesting].[GetRunIdWhenAvailable]">
			<Property Name="BodyScript">
				<Value><![CDATA[
BEGIN
	IF @PipelineName IS NULL
		BEGIN
			WHILE 1=1
			BEGIN
				IF EXISTS
					(
					SELECT TOP 1 
						[PipelineRunId] 
					FROM 
						[metadata].[CurrentExecution]
					WHERE 
						[PipelineRunId] IS NOT NULL
					)
				BEGIN
					BREAK;
				END

				WAITFOR DELAY '00:00:10';
			END;

			SELECT TOP 1 
				CAST([PipelineRunId] AS VARCHAR(36)) AS RunId 
			FROM 
				[metadata].[CurrentExecution]
			WHERE 
				[PipelineRunId] IS NOT NULL
		END
	ELSE IF @PipelineName IS NOT NULL
		BEGIN
			WHILE 1=1
			BEGIN
				IF EXISTS
					(
					SELECT TOP 1 
						[PipelineRunId] 
					FROM 
						[metadata].[CurrentExecution]
					WHERE 
						[PipelineRunId] IS NOT NULL 
						AND [PipelineName] = @PipelineName
					)
				BEGIN
					BREAK;
				END

				WAITFOR DELAY '00:00:10';
			END;

			SELECT TOP 1 
				CAST([PipelineRunId] AS VARCHAR(36)) AS RunId 
			FROM 
				[metadata].[CurrentExecution]
			WHERE 
				[PipelineRunId] IS NOT NULL
				AND [PipelineName] = @PipelineName
		END
	ELSE
		BEGIN
			RAISERROR('Unknown use of testing procedure.',16,1);
		END
END;]]></Value>
			</Property>
			<Property Name="IsAnsiNullsOn" Value="True" />
			<Relationship Name="BodyDependencies">
				<Entry>
					<References Name="[metadataTesting].[GetRunIdWhenAvailable].[@PipelineName]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[CurrentExecution]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[CurrentExecution].[PipelineRunId]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[varchar]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[CurrentExecution].[PipelineRunId]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[CurrentExecution].[PipelineName]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[varchar]" />
				</Entry>
				<Entry>
					<References Name="[metadata].[CurrentExecution].[PipelineName]" />
				</Entry>
			</Relationship>
			<Relationship Name="Parameters">
				<Entry>
					<Element Type="SqlSubroutineParameter" Name="[metadataTesting].[GetRunIdWhenAvailable].[@PipelineName]">
						<Property Name="DefaultExpressionScript">
							<Value><![CDATA[NULL]]></Value>
						</Property>
						<Relationship Name="Type">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Property Name="Length" Value="200" />
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[nvarchar]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
			</Relationship>
			<Relationship Name="Schema">
				<Entry>
					<References Name="[metadataTesting]" />
				</Entry>
			</Relationship>
			<Annotation Type="SysCommentsObjectAnnotation">
				<Property Name="Length" Value="1242" />
				<Property Name="StartLine" Value="1" />
				<Property Name="StartColumn" Value="1" />
				<Property Name="HeaderContents" Value="CREATE PROCEDURE [metadataTesting].[GetRunIdWhenAvailable]&#xD;&#xA;&#x9;(&#xD;&#xA;&#x9;@PipelineName NVARCHAR(200) = NULL&#xD;&#xA;&#x9;)&#xD;&#xA;AS" />
			</Annotation>
		</Element>
		<Element Type="SqlProcedure" Name="[metadataTesting].[ResetMetadata]">
			<Property Name="BodyScript">
				<Value><![CDATA[
BEGIN	
	EXEC [metadataHelpers].[SetDefaultProperties];
	EXEC [metadataHelpers].[SetDefaultTenant];
	EXEC [metadataHelpers].[SetDefaultSubscription];
	EXEC [metadataHelpers].[SetDefaultOrchestrators];
	EXEC [metadataHelpers].[SetDefaultBatches];
	EXEC [metadataHelpers].[SetDefaultStages];
	EXEC [metadataHelpers].[SetDefaultBatchStageLink];
	EXEC [metadataHelpers].[SetDefaultPipelines];
	EXEC [metadataHelpers].[SetDefaultPipelineParameters];
	EXEC [metadataHelpers].[SetDefaultPipelineDependants];
	EXEC [metadataHelpers].[SetDefaultRecipients];
	EXEC [metadataHelpers].[SetDefaultAlertOutcomes];
	EXEC [metadataHelpers].[SetDefaultRecipientPipelineAlerts];
END;]]></Value>
			</Property>
			<Property Name="IsAnsiNullsOn" Value="True" />
			<Relationship Name="BodyDependencies">
				<Entry>
					<References Name="[metadataHelpers].[SetDefaultProperties]" />
				</Entry>
				<Entry>
					<References Name="[metadataHelpers].[SetDefaultTenant]" />
				</Entry>
				<Entry>
					<References Name="[metadataHelpers].[SetDefaultSubscription]" />
				</Entry>
				<Entry>
					<References Name="[metadataHelpers].[SetDefaultOrchestrators]" />
				</Entry>
				<Entry>
					<References Name="[metadataHelpers].[SetDefaultBatches]" />
				</Entry>
				<Entry>
					<References Name="[metadataHelpers].[SetDefaultStages]" />
				</Entry>
				<Entry>
					<References Name="[metadataHelpers].[SetDefaultBatchStageLink]" />
				</Entry>
				<Entry>
					<References Name="[metadataHelpers].[SetDefaultPipelines]" />
				</Entry>
				<Entry>
					<References Name="[metadataHelpers].[SetDefaultPipelineParameters]" />
				</Entry>
				<Entry>
					<References Name="[metadataHelpers].[SetDefaultPipelineDependants]" />
				</Entry>
				<Entry>
					<References Name="[metadataHelpers].[SetDefaultRecipients]" />
				</Entry>
				<Entry>
					<References Name="[metadataHelpers].[SetDefaultAlertOutcomes]" />
				</Entry>
				<Entry>
					<References Name="[metadataHelpers].[SetDefaultRecipientPipelineAlerts]" />
				</Entry>
			</Relationship>
			<Relationship Name="Schema">
				<Entry>
					<References Name="[metadataTesting]" />
				</Entry>
			</Relationship>
			<Annotation Type="SysCommentsObjectAnnotation">
				<Property Name="Length" Value="734" />
				<Property Name="StartLine" Value="1" />
				<Property Name="StartColumn" Value="1" />
				<Property Name="HeaderContents" Value="CREATE PROCEDURE [metadataTesting].[ResetMetadata]&#xD;&#xA;AS" />
			</Annotation>
		</Element>
		<Element Type="SqlRole" Name="[metadatauser]">
			<Relationship Name="Authorizer">
				<Entry>
					<References ExternalSource="BuiltIns" Name="[dbo]" />
				</Entry>
			</Relationship>
		</Element>
	</Model>
</DataSchemaModel>